<!DOCTYPE html>
<html lang="et">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ostumenetluse kutse</title>

    <!-- Only include jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Ensure jsPDF is initialized
        window.addEventListener('DOMContentLoaded', function () {
            if (typeof window.jspdf === 'undefined') {
                console.warn('jsPDF not loaded correctly. Attempting to initialize it.');
                try {
                    window.jspdf = { jsPDF: window.jspdf.jsPDF || window.jsPDF };
                } catch (e) {
                    console.error('Failed to initialize jsPDF:', e);
                }
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4F46E5;
            --primary-hover: #4338CA;
            --success-color: #10B981;
            --error-color: #EF4444;
            --info-color: #3B82F6;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --background-color: #f9fafb;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
        }

        .dark body {
            background-color: #1f2937;
            color: #f9fafb;
        }

        .btn {
            @apply rounded-lg font-medium transition-all duration-200 transform px-4 py-2 focus:outline-none focus:ring-2 focus:ring-opacity-50;
        }

        .btn-primary {
            @apply bg-indigo-600 hover:bg-indigo-700 text-white focus:ring-indigo-500;
        }

        .btn-success {
            @apply bg-green-600 hover:bg-green-700 text-white focus:ring-green-500;
        }

        .btn-danger {
            @apply bg-red-500 hover:bg-red-600 text-white focus:ring-red-400;
        }

        .card {
            @apply bg-white rounded-xl shadow-md border border-gray-100 transition-all duration-200 hover:shadow-lg;
        }

        .dark .card {
            @apply bg-gray-800 border-gray-700;
        }

        .toast-success {
            background-color: var(--success-color);
            @apply shadow-lg rounded-lg;
        }

        .toast-error {
            background-color: var(--error-color);
            @apply shadow-lg rounded-lg;
        }

        .toast-info {
            background-color: var(--info-color);
            @apply shadow-lg rounded-lg;
        }

        .drag-active {
            border-color: var(--primary-color);
            background-color: #EFF6FF;
        }

        input[type="text"],
        textarea {
            @apply rounded-lg border-gray-300 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition-all duration-200;
        }

        input[type="checkbox"] {
            @apply rounded text-indigo-600 focus:ring-indigo-500 transition-all duration-200;
        }

        .section-header {
            @apply flex items-center p-3 font-medium cursor-pointer bg-gray-50 hover:bg-gray-100 rounded-lg;
        }

        .dark .section-header {
            @apply bg-gray-700 hover:bg-gray-600;
        }

        .section-content {
            @apply ml-8 mt-2 space-y-2 p-2;
        }

        [x-cloak] {
            display: none !important;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #pdfPreview,
            #pdfPreview * {
                visibility: visible;
            }

            #pdfPreview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('formApp', () => {
                const standardFields = [
                    { key: 'buyer', label: 'Hankija', placeholder: 'Nimi, aadress, registrikood' },
                    { key: 'submission', label: 'Pakkumise esitamise aeg ja koht', placeholder: 'nt 10. aprill, e-post' },
                    { key: 'validity', label: 'Pakkumuse jõusoleku aeg', placeholder: 'nt 30 päeva' },
                    { key: 'requirements', label: 'Nõuded pakkujale', placeholder: 'nt kogemus 3 aastat' },
                    { key: 'criteria', label: 'Väljavaliku alused', placeholder: 'Majanduslikult soodsaim' },
                    { key: 'responsible', label: 'Vastutav isik', placeholder: 'Nimi' }
                ];

                const defaultFields = {};
                standardFields.forEach(field => {
                    defaultFields[field.key] = '';
                });

                return {
                    standardFields,
                    form: {
                        name: '',
                        intro: 'Lisa hankija nimi teeb Teile ettepaneku esitada pakkumus "Lisa ostetav ese/teenus" ostumenetluse kutses sätestatud tingimustele. Ostumenetluse eesmärk on... ',
                        fields: { ...defaultFields },
                        sections: [
                            {
                                title: '1 Üldised tingimused',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Ettevõtjatel on õigus küsida kutse kohta selgitusi, esitades küsimused e-posti teel ostumenetluse eest vastutavale isikule. Hankija vastab ettevõtja küsimustele kolme tööpäeva jooksul. Hankija edastab esitatud küsimused ja antud vastused samaaegselt kõigile ettevõtjatele, kellele tehti ettepanek pakkumuse esitamiseks. Telefoni teel esitatud küsimustele ei vastata.', checked: false },
                                    { text: 'Hankijal on õigus enne pakkumuste esitamise tähtaega muuta vajadusel kutset. Kutse muutmisel teavitab hankija sellest kõiki ettevõtjaid, kellele on tehtud ettepanek pakkumuste esitamiseks ja edastab ettevõtjatele muudetud kutse. Hankija võib pikendada pakkumuste esitamise tähtaega.', checked: false },
                                    { text: 'Iga viidet, mille hankija teeb kutses mõnele standardile, tehnilisele tunnusele, kontrollsüsteemile, ostuallikale, protsessile, kaubamärgile, patendile, tüübile, päritolule või tootmisviisile, tuleb lugeda selliselt, et see on täiendatud märkega „või sellega samaväärne".', checked: false },
                                    { text: 'Hankija ei sõlmi hankelepingut pakkujaga, kellel on maksuvõlg (kohalikud maksud Tallinna linnale ja riiklik maksuvõlg)...', checked: false },
                                    { text: 'Hankija jätab endale õiguse tellida teenust lähtudes oma eelarvelistest vahenditest. Teenuse hankija ei hüvita pakkujale teenuse tellimata jätmise eest tekkinud kahju.', checked: false }
                                ]
                            },
                            {
                                title: '2 Ostumenetluse tehniline kirjeldus',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: '"Hankija lisab siia tehnilise kirjelduse" - Lisada kas viide eraldi failile kui TK on eraldi või kopeerida siia lihtsalt tehniline kirjeldus teenuse/asja kohta, mida soovitakse osta.', checked: false, editable: true }
                                ]
                            },
                            {
                                title: '3 Nõuded pakkumusele',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Pakkumus on pakkuja tahteavaldus tellimuse täitmiseks ja on selle esitamisel pakkujale siduv alates esitamisest kuni pakkumuse jõusoleku minimaalse tähtaja lõpuni. Hankijal on õigus teha ettepanek pakkumuse jõusoleku tähtaja pikendamiseks. Tingimusliku pakkumuse esitamine on keelatud.', checked: false },
                                    { text: 'Hilinenud pakkumusi hankija vastu ei võta.', checked: false },
                                    { text: 'Pakkumus peab sisaldama: Pakkumuse maksumust vastavalt lisale 1;', checked: false },
                                    { text: 'Pakkumus peab sisaldama: Pakkumuse kirjeldust, mis võimaldab hankijal kontrollida kutse punktis 2 sätestatud tingimustele vastavust.', checked: false },
                                    { text: 'Pakkuja kannab kõik pakkumuse ettevalmistamise ja esitamisega seotud kulud ning pakkumuse tähtaegse esitamise riski.', checked: false },
                                    { text: 'Pakkumus on konfidentsiaalne kuni tellimuse tegemiseni.', checked: false },
                                    { text: 'Pakkuja märgib pakkumuses, milline teave pakkumusest on ärisaladus ning põhjendab ärisaladuseks määramist... Hankija ei avalikusta pakkumuse sisu ärisaladusega kaetud osas.', checked: false }
                                ]
                            },
                            {
                                title: '4 Pakkumuste kontrollimine, hindamine ja eduka pakkumuse valik',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Hankija kontrollib tähtaegselt esitatud pakkumuste vastavust kutses esitatud tingimustele...', checked: false },
                                    { text: 'Hankijal on õigus küsida pakkujalt esitatud pakkumuse kohta täpsustavaid andmeid ja täpsustavaid selgitusi.', checked: false },
                                    { text: 'Kutses esitatud tingimustele vastavate pakkumuste seast valib hankija eduka pakkumuse välja madalaima hinna alusel...', checked: false },
                                    { text: 'Kui edukas pakkuja võtab hankijast mitteolenevatel põhjustel oma pakkumuse tagasi...', checked: false },
                                    { text: 'Hankija ei ole kohustatud korra punktis 4.5 nimetatud alusel pakkumusi uuesti hindama...', checked: false }
                                ]
                            },
                            {
                                title: '5 Läbirääkimiste pidamine',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Hankijal on õigus pidada läbirääkimisi esitatud pakkumuse sisu ja maksumuse ning tellimuse tingimuste üle.', checked: false },
                                    { text: 'Hankijal on õigus loobuda ühest või mitmest pakkumuses kirjeldatud teenusest, tööst või asjast või vähendada nende mahtusid või koguseid...', checked: false },
                                    { text: 'Vastavalt läbirääkimiste pidamise vajadusele teatab hankija pakkujatele läbirääkimiste aja... Läbirääkimised on konfidentsiaalsed.', checked: false },
                                    { text: 'Pärast läbirääkimiste toimumist esitab pakkuja vajadusel uue kohandatud pakkumuse...', checked: false }
                                ]
                            },
                            {
                                title: '6 Pakkumuste tagasi lükkamine ja ostumenetluse kehtetuks tunnistamine',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Hankijal on õigus kõik esitatud või kutses toodud tingimustele vastavad pakkumused tagasi lükata...', checked: false },
                                    { text: 'Kui hankijal on tekkinud vajadus pärast pakkumuste esitamise tähtpäeva kutses esitatud tingimusi olulisel määral muuta...', checked: false },
                                    { text: 'Hankija võib ostumenetluse kehtetuks tunnistada, kui peale pakkumuste esitamise tähtpäeva selgub, et hankija on teinud vea...', checked: false }
                                ]
                            },
                            {
                                title: '7 Lisad',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Lisa 1. ', checked: false, editable: true }
                                ]
                            }
                        ]
                    },
                    today: new Date().toLocaleDateString('et-EE'),
                    toasts: [],
                    files: [],
                    isDragging: false,
                    isGeneratingPDF: false,
                    saveTimeout: null,
                    isLoading: false,
                    errorMessage: '',
                    showError: false,
                    isDarkMode: false,
                    currentUser: null,
                    isAdmin: false,
                    showUserMenu: false,

                    init() {
                        // Check authentication
                        const user = JSON.parse(localStorage.getItem('currentUser'));
                        if (!user) {
                            window.location.href = 'login.html';
                            return;
                        }
                        this.currentUser = user;
                        this.isAdmin = user.role === 'admin';

                        this.loadFromStorage();

                        // Initialize Sortable for the sections
                        this.$nextTick(() => {
                            if (this.$refs.draggableSections) {
                                new Sortable(this.$refs.draggableSections, {
                                    animation: 150,
                                    handle: '.drag-handle',
                                    onEnd: (evt) => {
                                        const newOrder = Array.from(evt.from.children).map(child => {
                                            return child.__x.$data.section;
                                        });
                                        this.form.sections = newOrder;
                                    }
                                });
                            }
                        });

                        // Automaatne salvestamine
                        Alpine.effect(() => {
                            Alpine.raw(this.form);
                            Alpine.raw(this.files);
                            this.debouncedSave();
                        });

                        // Veateadete automaatne peitmine
                        setInterval(() => {
                            if (this.showError) {
                                this.showError = false;
                            }
                        }, 5000);
                    },

                    get visibleSections() {
                        return this.form.sections.filter(s => s.enabled && s.options.some(o => o.checked));
                    },

                    validateForm() {
                        if (!this.form.name?.trim()) {
                            this.showToast('Palun sisesta ostumenetluse nimi', 'error');
                            return false;
                        }
                        if (!this.form.fields?.buyer?.trim()) {
                            this.showToast('Palun täida hankija andmed', 'error');
                            return false;
                        }
                        return true;
                    },

                    async generatePDF() {
                        if (!this.validateForm()) return;

                        try {
                            this.isGeneratingPDF = true;
                            this.isLoading = true;

                            // Check if jsPDF is properly loaded
                            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                                if (typeof window.jsPDF !== 'undefined') {
                                    window.jspdf = { jsPDF: window.jsPDF };
                                } else {
                                    throw new Error('jsPDF not properly loaded');
                                }
                            }

                            const { jsPDF } = window.jspdf;
                            const doc = new jsPDF('p', 'mm', 'a4');

                            // Add header with logo and title
                            doc.setFillColor(79, 70, 229); // Indigo color
                            doc.rect(0, 0, 210, 30, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(24);
                            doc.setFont(undefined, 'bold');
                            doc.text(this.form.name || 'Ostumenetluse kutse', 105, 20, { align: 'center' });

                            // Add intro text with modern styling
                            doc.setFontSize(11);
                            doc.setTextColor(0, 0, 0);
                            let yPos = 40;
                            const introLines = doc.splitTextToSize(this.form.intro, 170);
                            doc.text(introLines, 20, yPos);
                            yPos += (introLines.length * 6) + 10;

                            // Add standard fields with modern styling
                            doc.setFontSize(11);
                            this.standardFields.forEach(field => {
                                const fieldValue = this.form.fields[field.key] || '';
                                if (fieldValue.trim() !== '') {
                                    // Add field label with background
                                    doc.setFillColor(243, 244, 246); // Light gray background
                                    doc.rect(20, yPos - 2, 170, 6, 'F');

                                    doc.setFont(undefined, 'bold');
                                    doc.setTextColor(79, 70, 229); // Indigo color for labels
                                    doc.text(`${field.label}: `, 22, yPos);
                                    const textWidth = doc.getTextWidth(`${field.label}: `);

                                    doc.setFont(undefined, 'normal');
                                    doc.setTextColor(0, 0, 0);
                                    const valueLines = doc.splitTextToSize(fieldValue, 150);
                                    doc.text(valueLines, 22 + textWidth, yPos);

                                    yPos += (valueLines.length * 6) + 4;
                                }
                            });

                            // Add sections with modern styling
                            let sectionNumber = 1;
                            this.visibleSections.forEach((section) => {
                                yPos += 5;

                                // Section title with modern styling
                                doc.setFontSize(14);
                                doc.setFont(undefined, 'bold');
                                doc.setTextColor(79, 70, 229); // Indigo color for section titles
                                const originalTitle = section.title;
                                const newTitle = `${sectionNumber} ${originalTitle.split(' ').slice(1).join(' ')}`;

                                // Add underline for section title
                                doc.text(newTitle, 20, yPos);
                                doc.setLineWidth(0.5);
                                doc.line(20, yPos + 1, 190, yPos + 1);

                                yPos += 10;

                                // Section options with modern styling
                                doc.setFontSize(11);
                                doc.setFont(undefined, 'normal');
                                doc.setTextColor(0, 0, 0);

                                section.options.filter(o => o.checked).forEach((opt, i) => {
                                    const optionText = `${sectionNumber}.${i + 1} ${opt.text}`;
                                    const optLines = doc.splitTextToSize(optionText, 160);

                                    // Add bullet point with custom styling
                                    doc.setFillColor(79, 70, 229);
                                    doc.circle(22, yPos + 2, 1.5, 'F');
                                    doc.text(optLines, 25, yPos);

                                    // Calculate total height needed for this option
                                    const optionHeight = optLines.length * 5; // Reduced from 6 to 5
                                    yPos += optionHeight + 2; // Reduced spacing from 5 to 2

                                    // Check if we need a new page
                                    if (yPos > 270) {
                                        doc.addPage();
                                        yPos = 20;
                                    }
                                });

                                sectionNumber++;
                            });

                            // Add footer with modern styling
                            yPos = Math.min(yPos + 10, 270); // Reduced from 15 to 10
                            doc.setLineWidth(0.5);
                            doc.line(20, yPos, 190, yPos);
                            yPos += 10;

                            doc.setFontSize(10);
                            doc.setFont(undefined, 'bold');
                            doc.setTextColor(79, 70, 229);
                            doc.text(`Kuupäev: ${this.today}`, 20, yPos);
                            yPos += 6;
                            doc.text(`Vastutav isik: ${this.form.fields.responsible || ''}`, 20, yPos);

                            // Add attachments with modern styling
                            if (this.files?.length > 0) {
                                yPos += 10;
                                doc.setFontSize(12);
                                doc.setFont(undefined, 'bold');
                                doc.setTextColor(79, 70, 229);
                                doc.text('Manused:', 20, yPos);
                                yPos += 5;

                                doc.setFontSize(10);
                                doc.setFont(undefined, 'normal');
                                doc.setTextColor(0, 0, 0);
                                this.files.forEach((file, i) => {
                                    // Add file icon
                                    doc.setFillColor(79, 70, 229);
                                    doc.rect(22, yPos - 1, 1.5, 1.5, 'F');
                                    doc.text(`${i + 1}. ${file.name} (${this.formatFileSize(file.size)}) ${file.comment || ''}`, 25, yPos);
                                    yPos += 6;
                                });
                            }

                            // Save the PDF
                            const pdfName = `${this.form.name || 'ostumenetlus'}.pdf`;
                            doc.save(pdfName);

                            // Track PDF generation in dashboard stats
                            const recentPdfs = JSON.parse(localStorage.getItem('recentPdfs')) || [];
                            recentPdfs.unshift({
                                id: Date.now(),
                                name: this.form.name || 'Ostumenetlus',
                                responsible: this.form.fields.responsible || '',
                                submissionDate: this.form.fields.submission || '',
                                createdAt: this.today,
                                createdBy: this.currentUser.username,
                                role: this.currentUser.role
                            });

                            // Keep only last 50 PDFs
                            if (recentPdfs.length > 50) {
                                recentPdfs.pop();
                            }

                            localStorage.setItem('recentPdfs', JSON.stringify(recentPdfs));

                            this.showToast('PDF edukalt loodud', 'success');
                        } catch (error) {
                            this.showToast('PDF loomisel tekkis viga: ' + error.message, 'error');
                        } finally {
                            this.isGeneratingPDF = false;
                            this.isLoading = false;
                        }
                    },

                    saveToStorage() {
                        try {
                            const payload = {
                                form: this.form,
                                timestamp: Date.now(),
                                version: '1.4',
                                lastModified: new Date().toISOString()
                            };
                            localStorage.setItem('OM_DRAFT', JSON.stringify(payload));
                            this.showToast('Salvestatud!', 'success');
                        } catch (error) {
                            console.error('Failed to save to storage:', error);
                            this.showToast('Salvestamine ebaõnnestus', 'error');
                        }
                    },

                    loadFromStorage() {
                        try {
                            const raw = localStorage.getItem('OM_DRAFT');
                            if (raw) {
                                const data = JSON.parse(raw);
                                if (data.version === '1.4') {
                                    this.form = {
                                        ...data.form,
                                        fields: {
                                            ...defaultFields,
                                            ...data.form.fields
                                        }
                                    };
                                    this.showToast('Laaditud salvestatud andmed', 'success');
                                } else {
                                    localStorage.removeItem('OM_DRAFT');
                                    this.showToast('Vana versiooni andmed, algandmed laetud', 'info');
                                }
                            }
                        } catch (error) {
                            console.error('Failed to load from storage:', error);
                            localStorage.removeItem('OM_DRAFT');
                        }
                    },

                    addAttachment() {
                        const lisaCount = this.form.sections[6].options.length + 1;
                        this.form.sections[6].options.push({
                            text: `Lisa ${lisaCount}. `,
                            checked: false,
                            editable: true
                        });
                        this.showToast('Lisa lisatud', 'success');
                    },

                    addNewSection() {
                        const nextNum = this.form.sections.length + 1;
                        const title = prompt(`Lisa punktile pealkiri (${nextNum}):`);

                        if (title) {
                            this.form.sections.push({
                                title: `${nextNum} ${title}`,
                                enabled: false,
                                open: true,
                                options: [{ text: 'Lisa tingimus', checked: false, editable: true, isEditing: true }]
                            });
                            this.showToast('Uus sektsioon lisatud', 'success');
                        }
                    },

                    toggleAllSections(open) {
                        this.form.sections.forEach(section => {
                            section.open = open;
                        });
                    },

                    selectAllOptions() {
                        this.form.sections.forEach(section => {
                            section.enabled = true;
                            section.options.forEach(option => {
                                option.checked = true;
                            });
                        });
                        this.showToast('Kõik valikud valitud', 'success');
                    },

                    showToast(message, type = 'info', duration = 3000) {
                        const toast = {
                            id: Date.now(),
                            message,
                            type,
                            duration
                        };
                        this.toasts.push(toast);
                        setTimeout(() => {
                            this.toasts = this.toasts.filter(t => t.id !== toast.id);
                        }, duration);
                    },

                    handleDragOver(e) {
                        e.preventDefault();
                        this.isDragging = true;
                    },

                    handleDragLeave() {
                        this.isDragging = false;
                    },

                    handleDrop(e) {
                        e.preventDefault();
                        this.isDragging = false;
                        const files = Array.from(e.dataTransfer.files);
                        this.processFiles(files);
                    },

                    handleFileInput(e) {
                        const files = Array.from(e.target.files);
                        this.processFiles(files);
                        e.target.value = ''; // Reset input
                    },

                    processFiles(files) {
                        const maxFileSize = 10 * 1024 * 1024; // 10MB
                        const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/gif'];

                        Array.from(files).forEach(file => {
                            if (file.size > maxFileSize) {
                                this.showToast(`Fail ${file.name} on liiga suur. Maksimaalne suurus on 10MB.`, 'error');
                                return;
                            }

                            if (!allowedTypes.includes(file.type)) {
                                this.showToast(`Fail ${file.name} on sobimatu tüüp. Lubatud on PDF ja pildifailid.`, 'error');
                                return;
                            }

                            const reader = new FileReader();
                            reader.onload = (e) => {
                                this.files.push({
                                    name: file.name,
                                    size: file.size,
                                    type: file.type,
                                    data: e.target.result,
                                    comment: ''
                                });
                                this.showToast('Fail lisatud', 'success');
                            };
                            reader.onerror = () => {
                                this.showToast(`Faili ${file.name} lugemisel tekkis viga`, 'error');
                            };
                            reader.readAsDataURL(file);
                        });
                    },

                    removeFile(index) {
                        const fileName = this.files[index].name;
                        this.files.splice(index, 1);
                        this.showToast(`Fail ${fileName} eemaldatud`, 'info');
                    },

                    formatFileSize(bytes) {
                        if (bytes === 0) return '0 Bytes';
                        const k = 1024;
                        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                        const i = Math.floor(Math.log(bytes) / Math.log(k));
                        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                    },

                    resetForm() {
                        if (confirm('Kas oled kindel, et soovid kõik andmed kustutada? Seda tegevust ei saa tagasi võtta.')) {
                            // Reset to default form structure
                            this.form = {
                                name: '',
                                intro: 'Lisa hankija nimi teeb Teile ettepaneku esitada pakkumus "Lisa ostetav ese/teenus" ostumenetluse kutses sätestatud tingimustele. Ostumenetluse eesmärk on... ',
                                fields: { ...defaultFields },
                                sections: [
                                    {
                                        title: '1 Üldised tingimused',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: 'Ettevõtjatel on õigus küsida kutse kohta selgitusi, esitades küsimused e-posti teel ostumenetluse eest vastutavale isikule. Hankija vastab ettevõtja küsimustele kolme tööpäeva jooksul. Hankija edastab esitatud küsimused ja antud vastused samaaegselt kõigile ettevõtjatele, kellele tehti ettepanek pakkumuse esitamiseks. Telefoni teel esitatud küsimustele ei vastata.', checked: false },
                                            { text: 'Hankijal on õigus enne pakkumuste esitamise tähtaega muuta vajadusel kutset. Kutse muutmisel teavitab hankija sellest kõiki ettevõtjaid, kellele on tehtud ettepanek pakkumuste esitamiseks ja edastab ettevõtjatele muudetud kutse. Hankija võib pikendada pakkumuste esitamise tähtaega.', checked: false },
                                            { text: 'Iga viidet, mille hankija teeb kutses mõnele standardile, tehnilisele tunnusele, kontrollsüsteemile, ostuallikale, protsessile, kaubamärgile, patendile, tüübile, päritolule või tootmisviisile, tuleb lugeda selliselt, et see on täiendatud märkega „või sellega samaväärne".', checked: false },
                                            { text: 'Hankija ei sõlmi hankelepingut pakkujaga, kellel on maksuvõlg (kohalikud maksud Tallinna linnale ja riiklik maksuvõlg)...', checked: false },
                                            { text: 'Hankija jätab endale õiguse tellida teenust lähtudes oma eelarvelistest vahenditest. Teenuse hankija ei hüvita pakkujale teenuse tellimata jätmise eest tekkinud kahju.', checked: false },
                                            { text: 'Arve maksetähtaeg peab olema vähemalt 21 päeva.', checked: true }
                                        ]
                                    },
                                    {
                                        title: '2 Ostumenetluse tehniline kirjeldus',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: '"Hankija lisab siia tehnilise kirjelduse" - Lisada kas viide eraldi failile kui TK on eraldi või kopeerida siia lihtsalt tehniline kirjeldus teenuse/asja kohta, mida soovitakse osta.', checked: false, editable: true }
                                        ]
                                    },
                                    {
                                        title: '3 Nõuded pakkumusele',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: 'Pakkumus on pakkuja tahteavaldus tellimuse täitmiseks ja on selle esitamisel pakkujale siduv alates esitamisest kuni pakkumuse jõusoleku minimaalse tähtaja lõpuni. Hankijal on õigus teha ettepanek pakkumuse jõusoleku tähtaja pikendamiseks. Tingimusliku pakkumuse esitamine on keelatud.', checked: false },
                                            { text: 'Hilinenud pakkumusi hankija vastu ei võta.', checked: false },
                                            { text: 'Pakkumus peab sisaldama: Pakkumuse maksumust vastavalt lisale 1;', checked: false },
                                            { text: 'Pakkumus peab sisaldama: Pakkumuse kirjeldust, mis võimaldab hankijal kontrollida kutse punktis 2 sätestatud tingimustele vastavust.', checked: false },
                                            { text: 'Pakkuja kannab kõik pakkumuse ettevalmistamise ja esitamisega seotud kulud ning pakkumuse tähtaegse esitamise riski.', checked: false },
                                            { text: 'Pakkumus on konfidentsiaalne kuni tellimuse tegemiseni.', checked: false },
                                            { text: 'Pakkuja märgib pakkumuses, milline teave pakkumusest on ärisaladus ning põhjendab ärisaladuseks määramist... Hankija ei avalikusta pakkumuse sisu ärisaladusega kaetud osas.', checked: false }
                                        ]
                                    },
                                    {
                                        title: '4 Pakkumuste kontrollimine, hindamine ja eduka pakkumuse valik',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: 'Hankija kontrollib tähtaegselt esitatud pakkumuste vastavust kutses esitatud tingimustele...', checked: false },
                                            { text: 'Hankijal on õigus küsida pakkujalt esitatud pakkumuse kohta täpsustavaid andmeid ja täpsustavaid selgitusi.', checked: false },
                                            { text: 'Kutses esitatud tingimustele vastavate pakkumuste seast valib hankija eduka pakkumuse välja madalaima hinna alusel...', checked: false },
                                            { text: 'Kui edukas pakkuja võtab hankijast mitteolenevatel põhjustel oma pakkumuse tagasi...', checked: false },
                                            { text: 'Hankija ei ole kohustatud korra punktis 4.5 nimetatud alusel pakkumusi uuesti hindama...', checked: false }
                                        ]
                                    },
                                    {
                                        title: '5 Läbirääkimiste pidamine',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: 'Hankijal on õigus pidada läbirääkimisi esitatud pakkumuse sisu ja maksumuse ning tellimuse tingimuste üle.', checked: false },
                                            { text: 'Hankijal on õigus loobuda ühest või mitmest pakkumuses kirjeldatud teenusest, tööst või asjast või vähendada nende mahtusid või koguseid...', checked: false },
                                            { text: 'Vastavalt läbirääkimiste pidamise vajadusele teatab hankija pakkujatele läbirääkimiste aja... Läbirääkimised on konfidentsiaalsed.', checked: false },
                                            { text: 'Pärast läbirääkimiste toimumist esitab pakkuja vajadusel uue kohandatud pakkumuse...', checked: false }
                                        ]
                                    },
                                    {
                                        title: '6 Pakkumuste tagasi lükkamine ja ostumenetluse kehtetuks tunnistamine',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: 'Hankijal on õigus kõik esitatud või kutses toodud tingimustele vastavad pakkumused tagasi lükata...', checked: false },
                                            { text: 'Kui hankijal on tekkinud vajadus pärast pakkumuste esitamise tähtpäeva kutses esitatud tingimusi olulisel määral muuta...', checked: false },
                                            { text: 'Hankija võib ostumenetluse kehtetuks tunnistada, kui peale pakkumuste esitamise tähtpäeva selgub, et hankija on teinud vea...', checked: false }
                                        ]
                                    },
                                    {
                                        title: '7 Lisad',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: 'Lisa 1. ', checked: false, editable: true }
                                        ]
                                    }
                                ]
                            };

                            // Clear files
                            this.files = [];

                            // Remove from local storage
                            localStorage.removeItem('OM_DRAFT');

                            // Show success message
                            this.showToast('Vorm on tühjendatud', 'info');
                        }
                    },

                    removeSection(index) {
                        if (confirm('Kas olete kindel, et soovite selle sektsiooni kustutada?')) {
                            this.form.sections.splice(index, 1);
                            this.showToast('Sektsioon kustutatud', 'success');
                        }
                    },

                    debouncedSave() {
                        clearTimeout(this.saveTimeout);
                        this.saveTimeout = setTimeout(() => {
                            this.saveToStorage();
                        }, 2000);
                    },

                    addOption(sectionIndex) {
                        const section = this.form.sections[sectionIndex];
                        const optionCount = section.options.length + 1;

                        let newOption;
                        if (sectionIndex === 6) { // Lisad section
                            newOption = {
                                text: `Lisa ${optionCount}. `,
                                checked: false,
                                editable: true,
                                isEditing: true
                            };
                        } else if (sectionIndex === 0) { // Üldised tingimused section
                            newOption = {
                                text: `${optionCount}. `,
                                checked: false,
                                editable: true,
                                isEditing: true
                            };
                        } else { // Other sections
                            newOption = {
                                text: `${optionCount}. `,
                                checked: false,
                                editable: true,
                                isEditing: true
                            };
                        }

                        section.options.push(newOption);
                        this.showToast('Punkt lisatud', 'success');
                    },

                    toggleUserMenu() {
                        this.showUserMenu = !this.showUserMenu;
                    },

                    logout() {
                        localStorage.removeItem('currentUser');
                        window.location.href = 'login.html';
                    }
                }
            });
        });
    </script>
</head>

<body class="bg-gray-50 text-gray-800" x-data="formApp" x-cloak :class="{'dark': isDarkMode}">
    <!-- Navbar -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <a href="om.html" class="text-xl font-bold text-indigo-600 dark:text-indigo-400">

                        </a>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="om.html" class="nav-link active inline-flex items-center px-1 pt-1">
                            <i class="fas fa-file-alt mr-2"></i> Ostumenetlus
                        </a>
                        <a href="dashboard.html" class="nav-link inline-flex items-center px-1 pt-1">
                            <i class="fas fa-chart-line mr-2"></i> Dashboard
                        </a>
                        <a href="users.html" class="nav-link inline-flex items-center px-1 pt-1" x-show="isAdmin">
                            <i class="fas fa-users mr-2"></i> Kasutajad
                        </a>
                    </div>
                </div>
                <div class="flex items-center">
                    <button @click="isDarkMode = !isDarkMode"
                        class="p-2 rounded-lg text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas" :class="isDarkMode ? 'fa-sun' : 'fa-moon'"></i>
                    </button>
                    <div class="ml-4 relative">
                        <button @click="toggleUserMenu"
                            class="flex items-center text-gray-700 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400">
                            <span class="mr-2" x-text="currentUser?.username || 'Kasutaja'"></span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div x-show="showUserMenu" @click.away="showUserMenu = false"
                            class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5">
                            <div class="py-1">
                                <a href="#" @click="logout"
                                    class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-sign-out-alt mr-2"></i> Logi välja
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto max-w-7xl p-4">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-center text-indigo-700">Ostumenetluse kutse koostamine</h1>
        </div>

        <div class="flex flex-col md:flex-row gap-6 min-h-screen">
            <!-- Left: Data Input -->
            <div class="w-full md:w-1/2 space-y-5">
                <div class="card p-5">
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Ostumenetluse nimi</label>
                    <input type="text" x-model="form.name" class="w-full border rounded-lg px-3 py-2"
                        placeholder="Näiteks: Haljasala rajamine" />
                </div>

                <div class="card p-5">
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Ostumenetluse kutse
                        lühikirjeldus</label>
                    <textarea x-model="form.intro" class="w-full border rounded-lg px-3 py-2 h-24"></textarea>
                </div>

                <div class="card p-5">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700">Põhiandmed</h2>
                    <div class="grid grid-cols-1 gap-4">
                        <template x-for="field in standardFields" :key="field.key">
                            <div>
                                <label class="block text-sm font-semibold mb-1 text-gray-700"
                                    x-text="field.label"></label>
                                <input type="text" x-model="form.fields[field.key]"
                                    class="w-full border rounded-lg px-3 py-2 mt-1" :placeholder="field.placeholder" />
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Sections 1-7 -->
                <div class="card p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-700">Vali punktid (1–7)</h2>
                        <div class="flex gap-2">
                            <button @click="selectAllOptions"
                                class="text-sm bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-1.5 rounded-lg transition-colors">
                                <i class="fas fa-check-double mr-1"></i> Lisa kõik
                            </button>
                            <button @click="toggleAllSections(true)"
                                class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg transition-colors">
                                <i class="fas fa-chevron-down mr-1"></i> Ava kõik
                            </button>
                            <button @click="toggleAllSections(false)"
                                class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg transition-colors">
                                <i class="fas fa-chevron-up mr-1"></i> Sulge kõik
                            </button>
                        </div>
                    </div>
                    <div id="draggableSections" x-ref="draggableSections" class="space-y-3">
                        <template x-for="(section, index) in form.sections" :key="index">
                            <div class="mb-3 border border-gray-200 rounded-lg overflow-hidden" x-data="{ section }">
                                <div class="section-header" @click="section.open = !section.open">
                                    <input type="checkbox" x-model="section.enabled" class="mr-3" @click.stop>
                                    <span class="drag-handle cursor-move mr-3 text-gray-400"><i
                                            class="fas fa-grip-lines"></i></span>
                                    <span x-text="section.title" class="flex-grow"></span>
                                    <i class="fas" :class="section.open ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
                                </div>
                                <div x-show="section.open" class="section-content" x-transition>
                                    <template x-for="(opt, i) in section.options" :key="i">
                                        <label class="block p-2 hover:bg-gray-50 rounded-md">
                                            <div class="flex items-start">
                                                <input type="checkbox" x-model="opt.checked" class="mt-1 mr-3">
                                                <template x-if="opt.isEditing">
                                                    <input type="text" x-model="opt.text" @blur="opt.isEditing = false"
                                                        @keydown.enter="opt.isEditing = false"
                                                        class="flex-grow border rounded-lg px-3 py-1 text-sm"
                                                        x-ref="editInput">
                                                </template>
                                                <template x-if="!opt.isEditing">
                                                    <span x-text="opt.text"
                                                        class="text-sm cursor-pointer hover:text-indigo-600"
                                                        @dblclick="opt.isEditing = true; $nextTick(() => $refs.editInput?.focus())">
                                                    </span>
                                                </template>
                                            </div>
                                        </label>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div class="flex justify-between mt-4">
                        <button @click="addNewSection"
                            class="text-indigo-600 hover:text-indigo-800 flex items-center text-sm">
                            <i class="fas fa-plus-circle mr-1"></i> Lisa uus punkt
                        </button>
                        <template x-for="(section, index) in form.sections" :key="index">
                            <button @click="addOption(index)" x-show="section.open"
                                class="text-indigo-600 hover:text-indigo-800 flex items-center text-sm">
                                <i class="fas fa-plus-circle mr-1"></i>
                                <span x-text="index === 0 ? 'Lisa tingimus' : 
                                            index === 6 ? 'Lisa lisa' : 
                                            'Lisa punkt'"></span>
                            </button>
                        </template>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-4 mt-6">
                    <button @click="generatePDF" class="btn btn-success flex items-center">
                        <i class="fas fa-file-pdf mr-2"></i> Loo PDF
                    </button>
                    <button @click="saveToStorage" class="btn btn-primary flex items-center">
                        <i class="fas fa-save mr-2"></i> Salvesta
                    </button>
                    <button @click="resetForm" class="btn btn-danger flex items-center">
                        <i class="fas fa-trash mr-2"></i> Tühjenda
                    </button>
                </div>
                <!-- File Upload Section -->
                <div class="card p-5">
                    <label class="block text-sm font-semibold mb-3 text-gray-700">Manused</label>
                    <div @dragover="handleDragOver" @dragleave="handleDragLeave" @drop="handleDrop"
                        :class="{'drag-active': isDragging}"
                        class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer transition-colors">
                        <input type="file" id="fileInput" class="hidden" @change="handleFileInput" multiple>
                        <label for="fileInput" class="cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-3xl text-indigo-500 mb-2"></i>
                            <p class="text-gray-600">Lohista failid siia või <span
                                    class="text-indigo-600 underline">kliki
                                    valimiseks</span></p>
                            <p class="text-sm text-gray-500 mt-1">Max 10MB fail</p>
                        </label>
                    </div>

                    <div class="mt-3 space-y-2" x-show="files.length > 0">
                        <template x-for="(file, index) in files" :key="index">
                            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                                <div class="flex items-center truncate">
                                    <i class="fas fa-file-alt text-indigo-500 mr-2"></i>
                                    <span x-text="file.name" class="truncate"></span>
                                    <span class="text-xs text-gray-500 ml-2" x-text="formatFileSize(file.size)"></span>
                                </div>
                                <button @click="removeFile(index)"
                                    class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Right: PDF Preview -->
            <div class="w-full md:w-1/2">
                <div class="sticky top-4">
                    <div class="flex items-center mb-3">
                        <h2 class="text-lg font-semibold text-gray-700">Eelvaade</h2>
                        <span class="ml-2 px-2 py-1 bg-gray-100 text-gray-600 text-xs font-medium rounded-full"></span>
                    </div>
                    <div id="pdfPreview" class="card p-6 space-y-4 min-h-[70vh] max-h-[85vh] overflow-auto bg-white">
                        <!-- Header -->
                        <div class="bg-indigo-600 text-white p-4 rounded-t-lg -mx-6 -mt-6 mb-6">
                            <h1 class="text-2xl font-bold text-center" x-text="form.name || 'Ostumenetluse kutse'"></h1>
                        </div>

                        <!-- Intro text -->
                        <div class="text-gray-700 text-sm leading-relaxed" x-text="form.intro"></div>

                        <!-- Standard fields -->
                        <div class="space-y-1">
                            <template x-for="field in standardFields">
                                <div x-show="form.fields[field.key]" class="bg-gray-50 p-2 rounded-lg">
                                    <div class="flex items-start">
                                        <span class="font-semibold text-indigo-600 mr-2"
                                            x-text="field.label + ':'"></span>
                                        <span class="text-gray-700" x-text="form.fields[field.key] || ''"></span>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Sections -->
                        <template x-for="(section, idx) in visibleSections" :key="idx">
                            <div class="mt-6">
                                <!-- Section title -->
                                <div class="flex items-center mb-3">
                                    <h2 class="text-lg font-bold text-indigo-600"
                                        x-text="(idx + 1) + ' ' + section.title.split(' ').slice(1).join(' ')"></h2>
                                    <div class="flex-grow h-0.5 bg-indigo-600 ml-3"></div>
                                </div>

                                <!-- Section options -->
                                <ul class="space-y-2">
                                    <template x-for="(opt, i) in section.options.filter(o => o.checked)" :key="i">
                                        <li class="flex items-start">
                                            <div class="w-2 h-2 bg-indigo-600 rounded-full mt-2 mr-3"></div>
                                            <span class="text-sm text-gray-700"
                                                x-text="(idx + 1) + '.' + (i+1) + ' ' + opt.text"></span>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </template>

                        <!-- Footer -->
                        <div class="mt-8 pt-4 border-t border-gray-200">
                            <div class="flex justify-between text-sm">
                                <div class="text-indigo-600 font-semibold">
                                    <p>Kuupäev: <span class="text-gray-700" x-text="today"></span></p>
                                </div>
                                <div class="text-indigo-600 font-semibold">
                                    <p>Vastutav isik: <span class="text-gray-700"
                                            x-text="form.fields.responsible || ''"></span></p>
                                </div>
                            </div>
                        </div>

                        <!-- Attachments -->
                        <template x-if="files.length > 0">
                            <div class="mt-6">
                                <h3 class="text-lg font-bold text-indigo-600 mb-3">Manused</h3>
                                <div class="space-y-2">
                                    <template x-for="(file, index) in files" :key="index">
                                        <div class="flex items-center bg-gray-50 p-3 rounded-lg">
                                            <div class="w-2 h-2 bg-indigo-600 rounded-full mr-3"></div>
                                            <span class="text-sm text-gray-700">
                                                <span x-text="index + 1 + '. '"></span>
                                                <span x-text="file.name"></span>
                                                <span class="text-gray-500"
                                                    x-text="' (' + formatFileSize(file.size) + ')'"></span>
                                                <span x-show="file.comment" class="text-gray-500"
                                                    x-text="' - ' + file.comment"></span>
                                            </span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="fixed bottom-4 right-4 space-y-2 z-50">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 translate-y-2"
                :class="{
                     'toast-success': toast.type === 'success',
                     'toast-error': toast.type === 'error',
                     'toast-info': toast.type === 'info'
                 }" class="text-white px-4 py-3 rounded shadow-lg flex items-center">
                <i class="fas mr-2" :class="{
                    'fa-check-circle': toast.type === 'success',
                    'fa-exclamation-circle': toast.type === 'error',
                    'fa-info-circle': toast.type === 'info'
                }"></i>
                <span x-text="toast.message"></span>
            </div>
        </template>
    </div>

</body>

</html>