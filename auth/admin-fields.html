<!DOCTYPE html>
<html lang="et">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Väljade ja Näidistingimuste Haldus</title>
    <!-- Kasuta samu stiile ja Alpine.js nagu admin.html-s -->
    <link href="../dist/output.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updatePassword, deleteUser, fetchSignInMethodsForEmail } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, orderBy, collection, query, where, getDocs, deleteDoc, updateDoc, arrayUnion, arrayRemove, Timestamp, onSnapshot, serverTimestamp, addDoc, limit, writeBatch } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
        import { firebaseConfig } from "./firebase-config-generated.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const tempAuth = getAuth(initializeApp(firebaseConfig, "temp"));

        window.db = db;
        window.collection = collection;
        window.getDocs = getDocs;
        window.doc = doc;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.addDoc = addDoc;
        window.setDoc = setDoc;
        window.signOut = signOut;
        window.auth = auth;
        window.query = query;
        window.where = where;
        window.limit = limit;
        window.writeBatch = writeBatch;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.updatePassword = updatePassword;
        window.onAuthStateChanged = onAuthStateChanged;
    </script>
</head>

<body class="bg-gray-100" x-data="formManager()">
    <div class="max-w-4xl mx-auto p-6">
        <h1 class="text-3xl font-bold mb-6">Ostumenetluse Vormi Haldus</h1>

        <!-- Standard Fields Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Standardväljad</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <template x-for="(field, index) in standardFields" :key="index">
                    <div class="p-4 bg-white rounded shadow">
                        <div class="flex justify-between items-center mb-2">
                            <input type="text" class="text-lg font-semibold border p-1 flex-grow" x-model="field.label"
                                placeholder="Välja pealkiri">
                            <input type="text" class="border p-1 flex-grow ml-2" x-model="field.placeholder"
                                placeholder="Placeholder tekst">
                            <button class="text-red-500 ml-4" @click="removeStandardField(index)">Kustuta</button>
                        </div>
                    </div>
                </template>
                <button class="mt-2 px-4 py-2 bg-green-500 text-white rounded" @click="addStandardField()">Lisa uus
                    standardväli</button>
            </div>
        </div>

        <!-- Form Sections -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Vormi peatükid</h2>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Sissejuhatus</label>
                <textarea class="w-full border p-2 rounded" x-model="form.intro" rows="3"></textarea>
            </div>
            <template x-for="(section, index) in form.sections" :key="index">
                <div class="mb-4 p-4 bg-white rounded shadow">
                    <div class="flex justify-between items-center mb-2">
                        <input type="text" class="text-xl font-semibold border p-1 flex-grow" x-model="section.title"
                            placeholder="Peatüki pealkiri">
                        <div class="flex items-center ml-4">
                            <label class="mr-2">Aktiivne</label>
                            <input type="checkbox" class="mr-4" x-model="section.enabled">
                            <button class="text-red-500" @click="removeSection(index)">Kustuta</button>
                        </div>
                    </div>
                    <div>
                        <template x-for="(option, oIndex) in section.options" :key="oIndex">
                            <div class="flex items-center mb-2">
                                <input type="text" class="border p-1 flex-grow" x-model="option.text"
                                    placeholder="Valiku tekst">
                                <input type="checkbox" class="ml-2" x-model="option.checked">
                                <div class="ml-2">
                                    <label class="mr-2">Muudetav</label>
                                    <input type="checkbox" class="mr-2" x-model="option.editable">
                                </div>
                                <button class="ml-2 text-red-500" @click="removeOption(index, oIndex)">Kustuta</button>
                            </div>
                        </template>
                        <button class="mt-2 text-blue-500" @click="addOption(index)">Lisa valik</button>
                    </div>
                </div>
            </template>
            <button class="mt-4 px-4 py-2 bg-green-500 text-white rounded" @click="addSection()">Lisa uus
                peatükk</button>
        </div>

        <!-- Save and Backup Buttons -->
        <div class="mt-6">
            <button class="px-4 py-2 bg-indigo-600 text-white rounded" @click="saveChanges()">Salvesta
                muudatused</button>
            <button class="ml-4 px-4 py-2 bg-yellow-500 text-white rounded" @click="backupSettings()">Tee
                varundus</button>
        </div>
    </div>

    <script>
        function formManager() {
            return {
                standardFields: [],
                form: {
                    name: "",
                    intro: "",
                    fields: {},
                    sections: []
                },
                init() {
                    this.loadSettings();
                    this.initializeDefaultData();
                },
                initializeDefaultData() {
                    db.collection("formSettings").doc("main").get()
                        .then(doc => {
                            if (!doc.exists) {
                                // Add default form data if it doesn't exist
                                const defaultFormData = {
                                    standardFields: [
                                        {
                                            key: "buyer",
                                            label: "Hankija",
                                            placeholder: "nt Tallinna Linnavalitsus"
                                        },
                                        {
                                            key: "submission",
                                            label: "Pakkumuse esitamise aeg ja koht",
                                            placeholder: "nt 12.12.2024 kell 12:00, Tallinn"
                                        },
                                        {
                                            key: "validity",
                                            label: "Pakkumuse jõusoleku aeg",
                                            placeholder: "nt 30 päeva"
                                        },
                                        {
                                            key: "requirements",
                                            label: "Nõuded pakkujale",
                                            placeholder: "nt kogemus 3 aastat"
                                        },
                                        {
                                            key: "criteria",
                                            label: "Väljavaliku alused",
                                            placeholder: "Majanduslikult soodsaim"
                                        },
                                        {
                                            key: "responsible",
                                            label: "Vastutav isik",
                                            placeholder: "Nimi"
                                        }
                                    ],
                                    form: {
                                        name: "",
                                        intro: 'Lisa hankija nimi teeb Teile ettepaneku esitada pakkumus "Lisa ostetav ese/teenus" ostumenetluse kutses sätestatud tingimustele. Ostumenetluse eesmärk on... ',
                                        fields: {},
                                        sections: [
                                            {
                                                title: "1. Üldtingimused",
                                                enabled: true,
                                                open: false,
                                                options: [
                                                    {
                                                        text: "Ettevõtjatel on õigus küsida kutse kohta selgitusi, esitades küsimused e-posti teel ostumenetluse eest vastutavale isikule. Hankija vastab ettevõtja küsimustele kolme tööpäeva jooksul. Hankija edastab esitatud küsimused ja antud vastused samaaegselt kõigile ettevõtjatele, kellele tehti ettepanek pakkumuse esitamiseks. Telefoni teel esitatud küsimustele ei vastata.",
                                                        checked: false
                                                    },
                                                    {
                                                        text: "Hankijal on õigus enne pakkumuste esitamise tähtaega muuta vajadusel kutset. Kutse muutmisel teavitab hankija sellest kõiki ettevõtjaid, kellele on tehtud ettepanek pakkumuste esitamiseks ja edastab ettevõtjatele muudetud kutse. Hankija võib pikendada pakkumuste esitamise tähtaega.",
                                                        checked: false
                                                    },
                                                    {
                                                        text: 'Iga viidet, mille hankija teeb kutses mõnele standardile, tehnilisele tunnusele, kontrollsüsteemile, ostuallikale, protsessile, kaubamärgile, patendile, tüübile, päritolule või tootmisviisile, tuleb lugeda selliselt, et see on täiendatud märkega "või sellega samaväärne".',
                                                        checked: false
                                                    },
                                                    {
                                                        text: "Hankija ei sõlmi hankelepingut pakkujaga, kellel on maksuvõlg (kohalikud maksud Tallinna linnale ja riiklik maksuvõlg). Enne hankelepingu sõlmimist kontrollib hankija pakkujal maksuvõla puudumist. Kui pakkujal esineb maksuvõlg, siis teavitab hankija sellest pakkujat ja annab pakkujale kaks tööpäeva maksuvõla tasumiseks või täies ulatuses ajatamiseks. Hankija võib anda ka pikema tähtaja maksuvõla tasumiseks või täies ulatuses ajatamiseks. Kui hankija poolt antud tähtaja jooksul pakkuja maksuvõlga ei tasu või täies ulatuses ei ajata, siis kõrvaldab hankija pakkuja ostumenetluselt. ",
                                                        checked: false
                                                    },
                                                    {
                                                        text: "Arve maksetähtaeg peab olema vähemalt 21 päeva.",
                                                        checked: true
                                                    }
                                                ]
                                            },
                                            {
                                                title: "2. Tehniline kirjeldus",
                                                enabled: true,
                                                open: false,
                                                options: [
                                                    {
                                                        text: '"Hankija lisab siia tehnilise kirjelduse" - Lisada kas viide eraldi failile kui TK on eraldi või kopeerida siia lihtsalt tehniline kirjeldus teenuse/asja kohta, mida soovitakse osta.',
                                                        checked: false,
                                                        editable: true
                                                    }
                                                ]
                                            },
                                            {
                                                title: "3 Nõuded pakkumusele",
                                                enabled: true,
                                                open: false,
                                                options: [
                                                    {
                                                        text: "Pakkumus on pakkuja tahteavaldus tellimuse täitmiseks ja on selle esitamisel pakkujale siduv alates esitamisest kuni pakkumuse jõusoleku minimaalse tähtaja lõpuni. Hankijal on õigus teha ettepanek pakkumuse jõusoleku tähtaja pikendamiseks. Tingimusliku pakkumuse esitamine on keelatud.",
                                                        checked: false
                                                    },
                                                    {
                                                        text: "Hilinenud pakkumusi hankija vastu ei võta.",
                                                        checked: false
                                                    },
                                                    {
                                                        text: "Pakkumus peab sisaldama pakkumuse maksumust vastavalt lisale 1.",
                                                        checked: false
                                                    },
                                                    {
                                                        text: "Pakkumus peab sisaldama pakkumuse kirjeldust, mis võimaldab hankijal kontrollida kutse punktis 2 sätestatud tingimustele vastavust.",
                                                        checked: false
                                                    },
                                                    {
                                                        text: "Pakkuja kannab kõik pakkumuse ettevalmistamise ja esitamisega seotud kulud ning pakkumuse tähtaegse esitamise riski.",
                                                        checked: false
                                                    },
                                                    {
                                                        text: "Pakkumus on konfidentsiaalne kuni tellimuse tegemiseni.",
                                                        checked: false
                                                    },
                                                    {
                                                        text: "Pakkuja märgib pakkumuses, milline teave pakkumusest on ärisaladus ning põhjendab ärisaladuseks määramist. Ärisaladusena ei või märkida pakkumuse maksumust (sh osamaksumusi kui need on hindamise aluseks) (RHS § 46 1 ). Kui põhjendust pakkumuses ei sisaldu, siis eeldab hankija, et ärisaladus puudub. Hankija ei avalikusta pakkumuse sisu ärisaladusega kaetud osas.",
                                                        checked: false
                                                    }
                                                ]
                                            },
                                            {
                                                title: "4 Pakkumuste kontroll, hindamine ja eduka pakkumuse valik",
                                                enabled: true,
                                                open: false,
                                                options: [
                                                    {
                                                        text: "Hankija kontrollib tähtaegselt esitatud pakkumuste vastavust kutses esitatud tingimustele. Juhul, kui pakkumus ei vasta kutses esitatud tingimustele, lükkab hankija pakkumuse tagasi.",
                                                        checked: false
                                                    },
                                                    {
                                                        text: "Hankijal on õigus küsida pakkujalt esitatud pakkumuse kohta täpsustavaid andmeid ja täpsustavaid selgitusi.",
                                                        checked: false
                                                    },
                                                    {
                                                        text: "Kutses esitatud tingimustele vastavate pakkumuste seast valib hankija eduka pakkumuse välja madalaima hinna alusel. Juhul, kui esitatud maksumused on võrdsed, korraldab hankija eduka pakkumuse väljaselgitamiseks liisuheitmise, võimaldades võrdse pakkumuse esitanud pakkujatel liisuheitmise juures viibida.",
                                                        checked: false
                                                    },
                                                    {
                                                        text: "Kui edukas pakkuja võtab hankijast mitteolenevatel põhjustel oma pakkumuse tagasi, ei allkirjasta hankija antud tähtaja jooksul hankelepingut või ei asu nõustumuse andmisega sõlmitud hankelepingut pakkujast tulenevatel põhjustel hankija määratud aja jooksul täitma, hindab hankija kõiki ülejäänud pakkumusi uuesti ja tunnistab edukaks pakkumuse, mis on vastavaks tunnistatud pakkumustest majanduslikult soodsaim.",
                                                        checked: false
                                                    },
                                                    {
                                                        text: "Hankija ei ole kohustatud korra punktis 4.5 nimetatud alusel pakkumusi uuesti hindama ja võib tunnistada edukaks esialgsel hindamisel leitud järjestuselt teise pakkumuse juhul, kui edukaks tunnistatud pakkumuse äralangemine ei saa mõjutada ülejäänud pakkumuste omavahelist järjestust.",
                                                        checked: false
                                                    }
                                                ]
                                            },
                                            {
                                                title: "5 Läbirääkimiste pidamine",
                                                enabled: true,
                                                open: false,
                                                options: [
                                                    {
                                                        text: "Hankijal on õigus pidada läbirääkimisi esitatud pakkumuse sisu, maksumuse ning ostukutsest sätestatud tingimuste üle.",
                                                        checked: false
                                                    },
                                                    {
                                                        text: "Vastavalt läbirääkimiste pidamise vajadusele teatab hankija pakkujatele läbirääkimiste aja. Iga pakkujaga peetakse läbirääkimisi eraldi. Läbirääkimisi võib pidada kirjalikku taasesitamist võimaldavas vormis (nt e-kiri) või suuliselt. Suuliselt peetud läbirääkimised protokollitakse. Läbirääkimised on konfidentsiaalsed. Hankija tagab läbirääkimiste käigus pakkujate võrdse kohtlemise.",
                                                        checked: false
                                                    },
                                                    {
                                                        text: "Pärast läbirääkimiste toimumist esitab pakkuja vajadusel uue kohandatud pakkumuse, mis esitatakse läbirääkimistel kokku lepitud tähtajaks.",
                                                        checked: false
                                                    },
                                                    {
                                                        text: "Hankija ei ole kohustatud läbirääkimisi pidama.",
                                                        checked: false
                                                    }
                                                ]
                                            },
                                            {
                                                title: "6 Pakkumuste tagasi lükkamine ja kehtetuks tunnistamine",
                                                enabled: true,
                                                open: false,
                                                options: [
                                                    {
                                                        text: "Hankijal on õigus kõik esitatud või kutses toodud tingimustele vastavad pakkumused tagasi lükata igal ajal enne lepingu sõlmimist või tellimuse tegemist, kui esitatud pakkumuste maksumused ületavad eeldatavat maksumust. Hankija teavitab pakkujaid kõigi pakkumuste tagasilükkamisest.",
                                                        checked: false
                                                    },
                                                    {
                                                        text: "Kui hankijal on tekkinud vajadus pärast pakkumuste esitamise tähtpäeva kutses esitatud tingimusi olulisel määral muuta või kui ostumenetluse läbiviimise aluseks olevad tingimused on oluliselt muutunud ja seetõttu osutub ostumenetluse esemeks oleva asja või teenuse tellimine mittevajalikuks, saadab hankija pakkujatele sellekohase teavituse.",
                                                        checked: false
                                                    },
                                                    {
                                                        text: "Hankija võib ostumenetluse kehtetuks tunnistada, kui hankija tuvastab peale pakkumuste esitamise tähtpäeva, et on teinud ostumenetluse kutses vea, mida ei ole võimalik enam antud etapis seaduspäraselt parandada.",
                                                        checked: false
                                                    }
                                                ]
                                            },
                                            {
                                                title: "7 Lisad",
                                                enabled: true,
                                                open: false,
                                                options: [
                                                    {
                                                        text: "Lisa 1. ",
                                                        checked: false,
                                                        editable: true
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                };

                                db.collection("formSettings").doc("main").set(defaultFormData)
                                    .then(() => {
                                        console.log("Default form data initialized in Firestore");
                                        this.loadSettings(); // Reload the data after initialization
                                    })
                                    .catch(error => {
                                        console.error("Error initializing default form data:", error);
                                    });
                            }
                        })
                        .catch(error => {
                            console.error("Error checking form settings:", error);
                        });
                },
                loadSettings() {
                    db.collection("formSettings").doc("main").get()
                        .then(doc => {
                            if (doc.exists) {
                                const data = doc.data();
                                this.standardFields = data.standardFields || [];
                                this.form = data.form || {
                                    name: "",
                                    intro: "",
                                    fields: {},
                                    sections: []
                                };
                            }
                        })
                        .catch(error => {
                            console.error("Vormi seadete laadimine ebaõnnestus:", error);
                            alert("Viga seadetega töötamisel: " + error.message);
                        });
                },
                saveChanges() {
                    this.backupSettings().then(() => {
                        db.collection("formSettings").doc("main").set({
                            standardFields: this.standardFields,
                            form: this.form,
                            lastUpdated: new Date().toISOString()
                        })
                            .then(() => {
                                alert("Seaded salvestatud!");
                                db.collection("formSettingsLogs").add({
                                    user: window.currentUser ? window.currentUser.email : "unknown",
                                    action: "Updated form settings",
                                    timestamp: new Date().toISOString()
                                });
                            })
                            .catch(error => {
                                console.error("Seadete salvestamine ebaõnnestus:", error);
                                alert("Seadete salvestamise viga: " + error.message);
                            });
                    });
                },
                backupSettings() {
                    return db.collection("formSettingsBackup").doc("main_backup").set({
                        standardFields: this.standardFields,
                        form: this.form,
                        backupTime: new Date().toISOString()
                    })
                        .then(() => {
                            console.log("Varundus tehtud");
                        })
                        .catch(error => {
                            console.error("Varundamise viga:", error);
                            alert("Varundamise viga: " + error.message);
                        });
                },
                addStandardField() {
                    this.standardFields.push({
                        key: "",
                        label: "",
                        placeholder: ""
                    });
                },
                removeStandardField(index) {
                    if (confirm("Kas soovid välja kustutada?")) {
                        this.standardFields.splice(index, 1);
                    }
                },
                addSection() {
                    this.form.sections.push({
                        title: "Uus peatükk",
                        enabled: true,
                        open: false,
                        options: []
                    });
                },
                removeSection(index) {
                    if (confirm("Kas soovid peatüki kustutada?")) {
                        this.form.sections.splice(index, 1);
                    }
                },
                addOption(sectionIndex) {
                    this.form.sections[sectionIndex].options.push({
                        text: "Uus valik",
                        checked: false,
                        editable: false
                    });
                },
                removeOption(sectionIndex, optionIndex) {
                    if (confirm("Kas soovid valikut kustutada?")) {
                        this.form.sections[sectionIndex].options.splice(optionIndex, 1);
                    }
                }
            }
        }
    </script>
</body>

</html>