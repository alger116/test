<!DOCTYPE html>
<html lang="et" class="h-full bg-gray-50">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="../config/config.js"></script>
    <!-- Add Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        [x-cloak] {
            display: none !important;
        }

        /* Fix table alignment issues */
        #userTable tr {
            height: 4.5rem;
        }

        #userTable td {
            vertical-align: middle;
        }

        /* Hide any debug output at the bottom of the page */
        body> :not(.min-h-full):not(script):not(#resetPasswordModal) {
            display: none !important;
        }

        /* Improve table cell alignment */
        #userTable .whitespace-nowrap {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Consistent button sizes */
        #userTable button {
            min-width: 5rem;
        }
    </style>
</head>

<body class="h-full">
    <div class="min-h-full">
        <!-- Dark Sidebar -->
        <div class="fixed inset-y-0 left-0 w-64 bg-gray-900 shadow-xl z-50">
            <div class="flex flex-col h-full">
                <div class="flex items-center justify-center h-16 px-4 bg-gray-800">
                    <h1 class="text-xl font-bold text-white">Admin Panel</h1>
                </div>
                <nav class="flex-1 px-2 py-4 space-y-1">
                    <a href="../index.html"
                        class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-800 rounded-lg transition-all duration-200 group">
                        <i class="fas fa-home w-5 text-gray-400 group-hover:text-blue-400"></i>
                        <span class="ml-3">Avaleht</span>
                    </a>
                    <button id="settingsButton"
                        class="w-full flex items-center px-4 py-3 text-gray-300 hover:bg-gray-800 rounded-lg transition-all duration-200 group">
                        <i class="fas fa-cog w-5 text-gray-400 group-hover:text-blue-400"></i>
                        <span class="ml-3">Seaded</span>
                    </button>
                    <a href="#"
                        class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-800 rounded-lg transition-all duration-200 group">
                        <i class="fas fa-users w-5 text-gray-400 group-hover:text-blue-400"></i>
                        <span class="ml-3">Kasutajad</span>
                    </a>
                    <button id="rolesButton"
                        class="w-full flex items-center px-4 py-3 text-gray-300 hover:bg-gray-800 rounded-lg transition-all duration-200 group">
                        <i class="fas fa-user-shield w-5 text-gray-400 group-hover:text-blue-400"></i>
                        <span class="ml-3">Rollid</span>
                    </button>
                    <a href="../ostu/om.html"
                        class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-800 rounded-lg transition-all duration-200 group">
                        <i class="fas fa-shopping-cart w-5 text-gray-400 group-hover:text-blue-400"></i>
                        <span class="ml-3">Ostukutse</span>
                    </a>
                    <a href="../hanke/index.html"
                        class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-800 rounded-lg transition-all duration-200 group">
                        <i class="fas fa-truck w-5 text-gray-400 group-hover:text-blue-400"></i>
                        <span class="ml-3">Riigihange</span>
                    </a>

                </nav>
                <div class="p-4 border-t border-gray-800">
                    <button id="logoutButton"
                        class="w-full flex items-center px-4 py-3 text-red-400 hover:bg-gray-800 rounded-lg transition-all duration-200 group">
                        <i class="fas fa-sign-out-alt w-5"></i>
                        <span class="ml-3">Logi v√§lja</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="pl-64">
            <!-- Top Navigation -->
            <div class="sticky top-0 z-40 bg-white border-b">
                <div class="flex items-center justify-between h-16 px-6">
                    <div class="flex items-center">
                        <h2 class="text-lg font-semibold text-gray-800">Kasutajate haldamine</h2>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Admin dropdown -->
                        <div x-data="{ adminOpen: false }" @click.away="adminOpen = false" class="relative">
                            <button @click="adminOpen = !adminOpen"
                                class="flex items-center space-x-2 text-gray-700 hover:text-blue-600 transition-colors duration-200">
                                <img src="https://ui-avatars.com/api/?name=Admin&background=0D9488&color=fff"
                                    alt="Admin" class="w-8 h-8 rounded-full">
                                <span class="hidden md:inline">Admin</span>
                                <i class="fas fa-chevron-down text-xs"></i>
                            </button>
                            <div x-show="adminOpen" x-cloak x-transition
                                class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-1 z-50">
                                <button id="changeEmail"
                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-envelope mr-2"></i> Muuda e-post
                                </button>
                                <button id="changePassword"
                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-key mr-2"></i> Muuda parool
                                </button>
                                <button id="logoutButtonDropdown"
                                    class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                    <i class="fas fa-sign-out-alt mr-2"></i> Logi v√§lja
                                </button>
                            </div>
                        </div>

                        <!-- Role dropdown -->
                        <div x-data="{ roleOpen: false, selectedRole: '' }" @click.away="roleOpen = false"
                            class="relative">
                            <label class="block text-sm font-medium text-gray-700">Roll</label>
                            <button @click="roleOpen = !roleOpen" type="button"
                                class="mt-1 relative w-full bg-white border border-gray-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <span x-text="selectedRole || 'K√µik rollid'">K√µik rollid</span>
                                <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </span>
                            </button>
                            <div x-show="roleOpen" x-cloak x-transition
                                class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm">
                                <button @click="selectedRole = 'K√µik rollid'; roleOpen = false"
                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">K√µik
                                    rollid</button>
                                <button @click="selectedRole = 'Peaadministraator'; roleOpen = false"
                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Peaadministraator</button>
                                <button @click="selectedRole = 'Administraator'; roleOpen = false"
                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Administraator</button>
                                <button @click="selectedRole = 'Ostumaailm Kasutaja'; roleOpen = false"
                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ostumaailm
                                    Kasutaja</button>
                                <button @click="selectedRole = 'Hankemaailm Kasutaja'; roleOpen = false"
                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Hankemaailm
                                    Kasutaja</button>
                                <button @click="selectedRole = 'Tavakasutaja'; roleOpen = false"
                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Tavakasutaja</button>
                            </div>
                        </div>

                        <!-- Status dropdown -->
                        <div x-data="{ statusOpen: false, selectedStatus: '' }" @click.away="statusOpen = false"
                            class="relative">
                            <label class="block text-sm font-medium text-gray-700">Olek</label>
                            <button @click="statusOpen = !statusOpen" type="button"
                                class="mt-1 relative w-full bg-white border border-gray-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <span x-text="selectedStatus || 'K√µik olekud'">K√µik olekud</span>
                                <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </span>
                            </button>
                            <div x-show="statusOpen" x-cloak x-transition
                                class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm">
                                <button @click="selectedStatus = 'K√µik olekud'; statusOpen = false"
                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">K√µik
                                    olekud</button>
                                <button @click="selectedStatus = 'Aktiivne'; statusOpen = false"
                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Aktiivne</button>
                                <button @click="selectedStatus = 'Mitteaktiivne'; statusOpen = false"
                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Mitteaktiivne</button>
                                <button @click="selectedStatus = 'Ootel'; statusOpen = false"
                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ootel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <main class="p-6">
                <!-- User Management Section -->
                <div id="userManagementSection" class="mb-8">
                    <!-- Date Range Filter -->
                    <div class="flex space-x-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Alguskuup√§ev</label>
                            <input type="date" id="dateRangeStart"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">L√µppkuup√§ev</label>
                            <input type="date" id="dateRangeEnd"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <button onclick="updateDashboardData()"
                            class="mt-6 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Uuenda
                        </button>
                        <button onclick="exportDashboardData()"
                            class="mt-6 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i class="fas fa-download mr-2"></i>Ekspordi
                        </button>
                    </div>

                    <!-- System Health Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <!-- Server Status -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900">Serveri olek</h3>
                                <span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full">
                                    Aktiivne
                                </span>
                            </div>
                            <div class="mt-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-600">CPU kasutus</span>
                                    <span id="cpuUsage" class="text-sm font-semibold text-gray-900">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="cpuBar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Database Size -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900">Andmebaasi suurus</h3>
                                <span class="px-2 py-1 text-xs font-semibold text-blue-800 bg-blue-100 rounded-full">
                                    Normaalne
                                </span>
                            </div>
                            <div class="mt-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-600">M√§lu kasutus</span>
                                    <span id="memoryUsage" class="text-sm font-semibold text-gray-900">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="memoryBar" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Active Users -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900">Aktiivsed kasutajad</h3>
                                <span
                                    class="px-2 py-1 text-xs font-semibold text-purple-800 bg-purple-100 rounded-full">
                                    Online
                                </span>
                            </div>
                            <div class="mt-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-600">Salvestus</span>
                                    <span id="storageUsage" class="text-sm font-semibold text-gray-900">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="storageBar" class="bg-yellow-600 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- API Requests -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900">API p√§ringud</h3>
                                <span
                                    class="px-2 py-1 text-xs font-semibold text-indigo-800 bg-indigo-100 rounded-full">
                                    Normaalne
                                </span>
                            </div>
                            <div class="mt-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-600">P√§ringud/min</span>
                                    <span id="apiRequests" class="text-sm font-semibold text-gray-900">0</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="apiBar" class="bg-indigo-600 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- System Settings Section -->
                <div class="bg-white rounded-lg shadow mb-6">
                    <div class="px-6 py-4 border-b">
                        <h2 class="text-lg font-semibold text-gray-800">S√ºsteemi seaded</h2>
                    </div>
                    <div class="p-6">
                        <!-- Backup/Restore -->
                        <div class="mb-6">
                            <h3 class="text-md font-medium text-gray-900 mb-4">Varundamine ja taastamine</h3>
                            <div class="flex space-x-4">
                                <button onclick="createBackup()"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 flex items-center">
                                    <i class="fas fa-download mr-2"></i>Loo varukoopia
                                </button>
                                <button onclick="openRestoreModal()"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 flex items-center">
                                    <i class="fas fa-upload mr-2"></i>Taasta varukoopia
                                </button>
                            </div>
                        </div>

                        <!-- Maintenance Mode -->
                        <div class="mb-6">
                            <h3 class="text-md font-medium text-gray-900 mb-4">Hooldusre≈æiim</h3>
                            <div class="flex items-center space-x-4">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="maintenanceMode" class="sr-only peer"
                                        onchange="toggleMaintenanceMode(this.checked)">
                                    <div
                                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                    </div>
                                    <span class="ml-3 text-sm font-medium text-gray-900">Hooldusre≈æiim</span>
                                </label>
                                <input type="text" id="maintenanceMessage"
                                    class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Hooldusre≈æiimi s√µnum">
                            </div>
                        </div>

                        <!-- Email Templates -->
                        <div class="mb-6">
                            <h3 class="text-md font-medium text-gray-900 mb-4">E-posti mallid</h3>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <h2 class="text-lg font-semibold text-gray-800">Kasutajad</h2>
                                    <div id="mainAdminIndicator"
                                        class="hidden px-2 py-1 text-xs font-semibold text-indigo-800 bg-indigo-100 rounded-full flex items-center gap-1 tooltip"
                                        data-tip="Peaadministraatoril on √µigused muuta k√µiki rollegi">
                                        <i class="fas fa-crown text-yellow-500"></i>
                                        <span>Peaadministraator</span>
                                    </div>
                                    <!-- Admin Settings Button - Only visible to mainAdmin -->
                                    <button id="adminSettingsButton"
                                        class="hidden px-3 py-1.5 ml-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white text-sm font-semibold rounded-lg hover:from-indigo-600 hover:to-purple-700 transition-all shadow-md hover:shadow-lg flex items-center gap-1"
                                        onclick="openRoles()">
                                        <i class="fas fa-user-cog"></i>
                                        <span>Rollide Seaded</span>
                                    </button>
                                </div>
                                <div class="flex space-x-2">
                                </div>

                                <!-- Import Users -->
                                <button onclick="openImportModal()"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 flex items-center">
                                    <i class="fas fa-file-import mr-2"></i>Impordi
                                </button>

                                <!-- Add User -->
                                <button id="addUserButton"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 flex items-center">
                                    <i class="fas fa-plus mr-2"></i>Lisa Kasutaja
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Filters -->
                    <div class="px-6 py-4 border-b bg-gray-50">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Otsi</label>
                                <input type="text" id="userSearch" placeholder="Email, nimi..."
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div x-data="{ open: false }" @click.away="open = false" class="relative">
                                <label class="block text-sm font-medium text-gray-700">Roll</label>
                                <button @click="open = !open" type="button"
                                    class="mt-1 relative w-full bg-white border border-gray-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <span x-text="$refs.roleSelect.options[$refs.roleSelect.selectedIndex].text">K√µik
                                        rollid</span>
                                    <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </span>
                                </button>
                                <div x-show="open" x-transition
                                    class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm">
                                    <select x-ref="roleSelect" id="roleFilter" @change="open = false"
                                        class="w-full h-full bg-transparent border-0 focus:ring-0">
                                        <option value="">K√µik rollid</option>
                                        <option value="mainAdmin">Peaadministraator üëë</option>
                                        <option value="admin">Administraator üëë</option>
                                        <option value="omUser">Ostumaailm Kasutaja</option>
                                        <option value="hmUser">Hankemaailm Kasutaja</option>
                                        <option value="user">Tavakasutaja</option>
                                        <option value="custom">Kohandatud</option>
                                    </select>
                                    <small class="absolute -bottom-5 left-0 text-xs text-gray-500">
                                        üëë Krooniga rolli saab muuta ainult Peaadministraator
                                    </small>
                                </div>
                            </div>
                            <div x-data="{ open: false }" @click.away="open = false" class="relative">
                                <label class="block text-sm font-medium text-gray-700">Olek</label>
                                <button @click="open = !open" type="button"
                                    class="mt-1 relative w-full bg-white border border-gray-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <span
                                        x-text="$refs.statusSelect.options[$refs.statusSelect.selectedIndex].text">K√µik
                                        olekud</span>
                                    <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </span>
                                </button>
                                <div x-show="open" x-transition
                                    class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm">
                                    <select x-ref="statusSelect" id="statusFilter" @change="open = false"
                                        class="w-full h-full bg-transparent border-0 focus:ring-0">
                                        <option value="">K√µik olekud</option>
                                        <option value="active">Aktiivne</option>
                                        <option value="inactive">Mitteaktiivne</option>
                                        <option value="pending">Ootel</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Kinnitamine</label>
                                <select id="verificationFilter"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="">K√µik</option>
                                    <option value="verified">Kinnitatud</option>
                                    <option value="unverified">Kinnitamata</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button onclick="applyFilters()"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                                Rakenda filtrid
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left">
                                        <input type="checkbox" id="selectAll" class="rounded text-blue-600">
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Email</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Roll</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Olek</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Kinnitamine</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Tegevused</th>
                                </tr>
                            </thead>
                            <tbody id="userTable" class="bg-white divide-y divide-gray-200">
                                <!-- Users will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Import Users Modal -->
                <div id="importUserModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
                    <div class="flex items-center justify-center min-h-screen">
                        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
                            <h2 class="text-xl font-bold mb-4">Impordi kasutajad</h2>
                            <form id="importUserForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">CSV fail</label>
                                    <input type="file" id="csvFile" accept=".csv" required
                                        class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Vaikimisi roll</label>
                                    <select id="defaultRole" required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="user">Tavakasutaja</option>
                                        <option value="omUser">Ostumaailm Kasutaja</option>
                                        <option value="hmUser">Hankemaailm Kasutaja</option>
                                    </select>
                                </div>
                                <div class="flex justify-end space-x-2">
                                    <button type="button" onclick="closeImportModal()"
                                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                        T√ºhista
                                    </button>
                                    <button type="submit"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        Impordi
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Audit Log Section -->
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-gray-900">Audit Log</h2>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Kuup√§ev</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Tegevus</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Kasutaja</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogTable" class="bg-white divide-y divide-gray-200">
                            <!-- Audit logs will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </main>
        </div>

        <!-- Settings Modal -->
        <div id="settingsBackdrop"
            class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm transition-opacity z-50"></div>
        <div id="settingsContainer" class="hidden fixed inset-0 z-50 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div class="relative w-full max-w-4xl bg-white rounded-lg shadow-xl">
                    <!-- Modal Header -->
                    <div class="flex items-center justify-between p-6 border-b">
                        <h2 class="text-2xl font-bold text-gray-900">Seaded</h2>
                        <button id="closeSettings" class="text-gray-400 hover:text-gray-500">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Modal Content -->
                    <div class="p-6">
                        <!-- General Settings -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">√úldised seaded</h3>
                            <form id="settingsForm" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="documentPreparationDays"
                                            class="block text-sm font-medium text-gray-700 mb-1">
                                            üìÑ Riigihanke alusdokumentide koostamine
                                        </label>
                                        <input type="number" id="documentPreparationDays" name="documentPreparationDays"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="P√§evad" required min="0">
                                    </div>
                                    <div>
                                        <label for="offerEvaluationDays"
                                            class="block text-sm font-medium text-gray-700 mb-1">
                                            üßê Pakkumuste hindamine
                                        </label>
                                        <input type="number" id="offerEvaluationDays" name="offerEvaluationDays"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="P√§evad" required min="0">
                                    </div>
                                    <div>
                                        <label for="decisionDays" class="block text-sm font-medium text-gray-700 mb-1">
                                            ‚úÖ Vastavaks ja edukaks tunnistamise otsus
                                        </label>
                                        <input type="number" id="decisionDays" name="decisionDays"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="P√§evad" required min="0">
                                    </div>
                                    <div>
                                        <label for="bidderEvaluationDays"
                                            class="block text-sm font-medium text-gray-700 mb-1">
                                            üìä Pakkujate hindamine
                                        </label>
                                        <input type="number" id="bidderEvaluationDays" name="bidderEvaluationDays"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="P√§evad" required min="0">
                                    </div>
                                    <div>
                                        <label for="successfulBidderDays"
                                            class="block text-sm font-medium text-gray-700 mb-1">
                                            üèÜ Eduka k√µrvaldamata j√§tmine ja kval
                                        </label>
                                        <input type="number" id="successfulBidderDays" name="successfulBidderDays"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="P√§evad" required min="0">
                                    </div>
                                    <div>
                                        <label for="waitingPeriodDays"
                                            class="block text-sm font-medium text-gray-700 mb-1">
                                            ‚è≥ Ooteaeg
                                        </label>
                                        <input type="number" id="waitingPeriodDays" name="waitingPeriodDays"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="P√§evad" required min="0">
                                    </div>
                                </div>
                                <div class="flex justify-end">
                                    <button type="submit"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                                        <i class="fas fa-save mr-2"></i>Salvesta
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Procedure Types -->
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-900">üõ†Ô∏è Menetlusliigid</h3>
                                <button id="addProcedureTypeButton"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200">
                                    <i class="fas fa-plus mr-2"></i>Lisa Menetlusliik
                                </button>
                            </div>
                            <div class="space-y-4">
                                <select id="procedureTypeSelect"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <!-- Options will be populated dynamically -->
                                </select>
                                <div id="procedureTypeSettings" class="mt-4">
                                    <!-- Procedure type settings will be displayed here -->
                                </div>
                            </div>
                        </div>

                        <!-- Settings Section -->
                        <div class="p-6">
                            <h2 class="text-2xl font-bold text-gray-900">Seaded</h2>
                            <form id="settingsForm" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="ostumaailmVisibility"
                                            class="block text-sm font-medium text-gray-700 mb-1">Ostumaailm
                                            n√§htavus</label>
                                        <input type="checkbox" id="ostumaailmVisibility" class="rounded text-blue-600">
                                    </div>
                                    <div>
                                        <label for="hankemaailmVisibility"
                                            class="block text-sm font-medium text-gray-700 mb-1">Hankemaailm
                                            n√§htavus</label>
                                        <input type="checkbox" id="hankemaailmVisibility" class="rounded text-blue-600">
                                    </div>
                                </div>
                                <div class="flex justify-end">
                                    <button type="submit"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                                        <i class="fas fa-save mr-2"></i>Salvesta
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="hidden fixed inset-0 bg-white/50 z-50 backdrop-blur-sm">
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
            </div>
        </div>

        <!-- Roles Modal -->
        <div id="rolesBackdrop"
            class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm z-40 transition-opacity duration-300"></div>
        <div id="rolesContainer" class="hidden fixed inset-0 z-50 overflow-y-auto transition-all duration-300">
            <div class="flex min-h-full items-center justify-center p-4">
                <div
                    class="relative w-full max-w-5xl bg-white rounded-xl shadow-2xl border border-gray-200 transform transition-all duration-300">
                    <!-- Modal Header -->
                    <div
                        class="flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-t-xl">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                                <i class="fas fa-user-tag text-indigo-500 mr-3"></i>
                                Kasutajarollid
                            </h2>
                            <p class="text-sm text-gray-500 mt-1">Halda kasutajarolle, √µigusi ja limiite</p>
                            <div id="mainAdminRolesIndicator"
                                class="hidden mt-2 px-3 py-1 bg-indigo-100 text-xs font-medium text-indigo-800 rounded-full inline-flex items-center">
                                <i class="fas fa-crown text-yellow-500 mr-1"></i>
                                <span>Peaadministraatorina saad muuta ka s√ºsteemi rolle</span>
                            </div>
                        </div>
                        <button id="closeRoles"
                            class="text-gray-400 hover:text-gray-500 p-2 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                    </div>

                    <!-- Modal Content -->
                    <div class="p-6">
                        <div class="space-y-6">
                            <!-- Search and Filter Section -->
                            <div class="flex items-center justify-between gap-4">
                                <div class="flex-1 relative">
                                    <input type="text" id="roleSearch" placeholder="Otsi rolle..."
                                        class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 shadow-sm">
                                    <i
                                        class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                </div>
                                <button id="addRoleButton"
                                    class="px-5 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all duration-200 flex items-center shadow-md hover:shadow-lg transform hover:translate-y-[-2px]">
                                    <i class="fas fa-plus mr-2"></i>Lisa Roll
                                </button>
                            </div>

                            <!-- Role Statistics -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div
                                    class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100 shadow-sm hover:shadow-md transition-all duration-300 transform hover:translate-y-[-2px]">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-blue-600 font-medium">Aktiivsed Rollid</p>
                                            <p class="text-2xl font-bold text-blue-700 mt-1" id="activeRolesCount">0</p>
                                        </div>
                                        <div class="bg-blue-100 p-3 rounded-full shadow-sm">
                                            <i class="fas fa-users text-blue-600"></i>
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-xl border border-green-100 shadow-sm hover:shadow-md transition-all duration-300 transform hover:translate-y-[-2px]">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-green-600 font-medium">Kasutajad</p>
                                            <p class="text-2xl font-bold text-green-700 mt-1" id="totalUsersCount">0</p>
                                        </div>
                                        <div class="bg-green-100 p-3 rounded-full shadow-sm">
                                            <i class="fas fa-user-check text-green-600"></i>
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="bg-gradient-to-br from-purple-50 to-violet-50 p-4 rounded-xl border border-purple-100 shadow-sm hover:shadow-md transition-all duration-300 transform hover:translate-y-[-2px]">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-purple-600 font-medium">√ïigused</p>
                                            <p class="text-2xl font-bold text-purple-700 mt-1"
                                                id="totalPermissionsCount">0</p>
                                        </div>
                                        <div class="bg-purple-100 p-3 rounded-full shadow-sm">
                                            <i class="fas fa-key text-purple-600"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Role List -->
                            <div class="space-y-4" id="rolesList">
                                <!-- Roles will be dynamically added here -->
                                <div class="animate-pulse flex space-x-4">
                                    <div class="flex-1 space-y-4 py-1">
                                        <div class="h-20 bg-gray-100 rounded"></div>
                                        <div class="h-20 bg-gray-100 rounded"></div>
                                        <div class="h-20 bg-gray-100 rounded"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit Role Modal -->
        <div id="roleFormBackdrop"
            class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm z-50 transition-opacity duration-300"></div>
        <div id="roleFormContainer" class="hidden fixed inset-0 z-60 overflow-y-auto transition-all duration-300">
            <div class="flex min-h-full items-center justify-center p-4">
                <div
                    class="relative w-full max-w-2xl bg-white rounded-xl shadow-2xl border border-gray-200 transform transition-all duration-300">
                    <!-- Modal Header -->
                    <div class="flex items-center justify-between p-6 border-b border-gray-200">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900" id="roleFormTitle">Lisa Uus Roll</h2>
                            <p class="text-sm text-gray-500 mt-1">T√§ida rolli andmed</p>
                        </div>
                        <button id="closeRoleForm"
                            class="text-gray-400 hover:text-gray-500 p-2 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                    </div>

                    <!-- Role Form -->
                    <div class="p-6">
                        <form id="roleForm" class="space-y-6">
                            <div>
                                <label for="roleName" class="block text-sm font-medium text-gray-700 mb-1">Rolli
                                    Nimi</label>
                                <input type="text" id="roleName" name="roleName" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                            </div>

                            <div>
                                <label for="roleColor" class="block text-sm font-medium text-gray-700 mb-1">Rolli
                                    V√§rv</label>
                                <div class="grid grid-cols-5 gap-2">
                                    <button type="button"
                                        class="w-full h-10 rounded-lg bg-blue-500 hover:bg-blue-600 transition-colors duration-200"
                                        data-color="blue"></button>
                                    <button type="button"
                                        class="w-full h-10 rounded-lg bg-green-500 hover:bg-green-600 transition-colors duration-200"
                                        data-color="green"></button>
                                    <button type="button"
                                        class="w-full h-10 rounded-lg bg-purple-500 hover:bg-purple-600 transition-colors duration-200"
                                        data-color="purple"></button>
                                    <button type="button"
                                        class="w-full h-10 rounded-lg bg-yellow-500 hover:bg-yellow-600 transition-colors duration-200"
                                        data-color="yellow"></button>
                                    <button type="button"
                                        class="w-full h-10 rounded-lg bg-red-500 hover:bg-red-600 transition-colors duration-200"
                                        data-color="red"></button>
                                </div>
                                <input type="hidden" id="roleColor" name="roleColor" value="blue">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">√ïigused</label>
                                <div class="space-y-2" id="permissionsList">
                                    <!-- Permissions will be dynamically added here -->
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kasutuse limiidid</label>
                                <div class="space-y-3" id="usageLimitsList">
                                    <div class="flex items-center gap-3">
                                        <div class="w-1/2">
                                            <label for="searchLimit" class="text-xs text-gray-600">Otsingute arv</label>
                                            <input type="number" id="searchLimit" name="searchLimit" min="0" max="999"
                                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                                placeholder="Piiramatu">
                                        </div>
                                        <div class="w-1/2">
                                            <label for="firestoreSaveLimit" class="text-xs text-gray-600">Firestore
                                                salvestamised</label>
                                            <input type="number" id="firestoreSaveLimit" name="firestoreSaveLimit"
                                                min="0" max="999"
                                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                                placeholder="Piiramatu">
                                        </div>
                                    </div>

                                    <div class="flex items-center gap-3">
                                        <div class="w-1/2">
                                            <label for="pdfGenerationLimit" class="text-xs text-gray-600">PDF
                                                genereerimiste arv</label>
                                            <input type="number" id="pdfGenerationLimit" name="pdfGenerationLimit"
                                                min="0" max="999"
                                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                                placeholder="Piiramatu">
                                        </div>
                                        <div class="w-1/2">
                                            <label for="recentSearchLimit" class="text-xs text-gray-600">Viimaste
                                                otsingute kuvamine</label>
                                            <input type="number" id="recentSearchLimit" name="recentSearchLimit" min="0"
                                                max="20"
                                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                                placeholder="0">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-end gap-4">
                                <button type="button" id="cancelRoleForm"
                                    class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors duration-200">
                                    T√ºhista
                                </button>
                                <button type="submit"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                                    Salvesta
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add User Modal -->
        <div id="addUserBackdrop" class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
        <div id="addUserContainer" class="hidden fixed inset-0 z-50 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div class="relative w-full max-w-md bg-white rounded-xl shadow-2xl border border-gray-200">
                    <!-- Modal Header -->
                    <div class="flex items-center justify-between p-6 border-b border-gray-200">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Lisa uus kasutaja</h2>
                            <p class="text-sm text-gray-500 mt-1">Sisesta kasutaja andmed</p>
                        </div>
                        <button id="closeAddUser"
                            class="text-gray-400 hover:text-gray-500 p-2 rounded-lg hover:bg-gray-50">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                    </div>

                    <!-- Modal Content -->
                    <div class="p-6">
                        <form id="addUserForm" class="space-y-4">
                            <div>
                                <label for="userEmail" class="block text-sm font-medium text-gray-700">E-post:</label>
                                <input type="email" id="userEmail" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="nimi@n√§ide.ee">
                            </div>
                            <div>
                                <label for="userPassword"
                                    class="block text-sm font-medium text-gray-700">Parool:</label>
                                <input type="password" id="userPassword" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Minimaalselt 6 t√§hem√§rki">
                            </div>
                            <div>
                                <label for="userRole" class="block text-sm font-medium text-gray-700">Roll:</label>
                                <select id="userRole" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="userApproved" class="rounded text-blue-600">
                                <label for="userApproved" class="text-sm text-gray-700">Kasutaja on kinnitatud</label>
                            </div>
                            <div class="flex justify-end space-x-2 pt-4">
                                <button type="button" onclick="closeAddUserModal()"
                                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                                    T√ºhista
                                </button>
                                <button type="submit"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                                    <i class="fas fa-plus mr-2"></i>Lisa Kasutaja
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Details Modal -->
        <div id="userDetailsModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
            <div class="flex items-center justify-center min-h-screen">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold">Kasutaja √úksikasjad</h2>
                    <p><strong>Email:</strong> <span id="userDetailsEmail"></span></p>
                    <p><strong>Roll:</strong> <span id="userDetailsRole"></span></p>
                    <p><strong>Status:</strong> <span id="userDetailsStatus"></span></p>
                    <button onclick="closeUserDetailsModal()"
                        class="mt-4 px-4 py-2 bg-gray-600 text-white rounded">Sulge</button>
                </div>
                <div id="resetPasswordModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
                    <div class="flex items-center justify-center min-h-screen">
                        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
                            <h2 class="text-xl font-bold mb-4">L√§htesta kasutaja parool</h2>
                            <form id="resetPasswordForm" class="space-y-4">
                                <input type="hidden" id="resetUserId">
                                <div>
                                    <label for="newPassword" class="block text-sm font-medium text-gray-700">Uus
                                        parool</label>
                                    <input type="password" id="newPassword" required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <p class="text-xs text-gray-500 mt-1">Parool peab sisaldama v√§hemalt 8 t√§hem√§rki,
                                        √ºht suurt√§hte, √ºht v√§iket√§hte, √ºht numbrit ja √ºht erim√§rki.</p>
                                </div>
                                <div>
                                    <label for="confirmPassword" class="block text-sm font-medium text-gray-700">Kinnita
                                        parool</label>
                                    <input type="password" id="confirmPassword" required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div class="flex justify-end space-x-2">
                                    <button type="button" onclick="closeResetPasswordModal()"
                                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                        T√ºhista
                                    </button>
                                    <button type="submit"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        L√§htesta parool
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    window.resetUserPassword = async function (userId) {
                    try {
                    // Get user data
                    const userRef = doc(db, "users", userId);
                    const userDoc = await getDoc(userRef);

                    if (!userDoc.exists()) {
                    showNotification("Kasutajat ei leitud!", "error");
                    return;
                    }

                    const userData = userDoc.data();

                    // Populate and show the reset password modal
                    document.getElementById('resetUserId').value = userId;
                    document.getElementById('resetPasswordModal').classList.remove('hidden');
                    } catch (error) {
                    console.error("Error preparing password reset:", error);
                    showNotification("Viga parooli l√§htestamise ettevalmistamisel!", "error");
                    }
                    };

                    // Close reset password modal
                    window.closeResetPasswordModal = function () {
                    document.getElementById('resetPasswordModal').classList.add('hidden');
                    document.getElementById('resetPasswordForm').reset();
                    };

                    // Handle password reset form submission
                    document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const userId = document.getElementById('resetUserId').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;

                    // Validate passwords match
                    if (newPassword !== confirmPassword) {
                    showNotification("Paroolid ei √ºhti!", "error");
                    return;
                    }

                    // Validate password strength
                    const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
                    if (!passwordRegex.test(newPassword)) {
                    showNotification("Parool peab sisaldama v√§hemalt 8 t√§hem√§rki, √ºht suurt t√§hte, √ºht v√§ikest
                    t√§hte, √ºht numbrit ja √ºht erim√§rki!", "error");
                    return;
                    }

                    try {
                    // Get user data for audit log
                    const userRef = doc(db, "users", userId);
                    const userDoc = await getDoc(userRef);
                    const userData = userDoc.data();

                    // Update password in Firestore (in a real system, you'd use Firebase Auth Admin SDK)
                    await updateDoc(userRef, {
                    passwordLastReset: new Date(),
                    passwordResetBy: auth.currentUser.uid,
                    lastUpdated: new Date()
                    });

                    // Log the password reset
                    await addDoc(collection(db, "auditLog"), {
                    action: "password_reset",
                    userId: userId,
                    userEmail: userData.email,
                    performedBy: auth.currentUser.uid,
                    performedByEmail: auth.currentUser.email,
                    timestamp: new Date()
                    });

                    showNotification("Parool on edukalt l√§htestatud!", "success");
                    closeResetPasswordModal();
                    } catch (error) {
                    console.error("Error resetting password:", error);
                    showNotification("Viga parooli l√§htestamisel!", "error");
                    }
                    });
                </div>

                <script type="module">
                    // Import Firebase Modules
                    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
                    import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
                    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, deleteDoc, addDoc, setDoc, query, where, limit, writeBatch }
                        from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

                    if (!window.FIREBASE_CONFIG) {
                        console.error("‚ö† Firebase konfiguratsiooni ei leitud! Kontrolli, kas `config.js` on √µigesti laaditud.");
                    } else {
                        const app = initializeApp(window.FIREBASE_CONFIG);
                        const auth = getAuth(app);
                        const db = getFirestore(app);

                        // Make Firebase functions available globally
                        window.db = db;
                        window.collection = collection;
                        window.getDocs = getDocs;
                        window.doc = doc;
                        window.getDoc = getDoc;
                        window.updateDoc = updateDoc;
                        window.deleteDoc = deleteDoc;
                        window.addDoc = addDoc;
                        window.signOut = signOut;
                        window.auth = auth;
                        window.query = query;
                        window.where = where;
                        window.limit = limit;
                        window.writeBatch = writeBatch;
                    }

                    // Define default settings
                    const defaultSettings = {
                        documentPreparationDays: 15,
                        offerEvaluationDays: 5,
                        decisionDays: 5,
                        bidderEvaluationDays: 5,
                        successfulBidderDays: 5,
                        waitingPeriodDays: 14,
                    };

                    // Initialize settings with defaults
                    let settings = { ...defaultSettings };

                    const procedureData = {
                        "Avatud hankemenetlus": { visible: true },
                        "Piiratud hankemenetlus": { visible: true },
                        "Konkurentsip√µhine l√§bir√§√§kimistega menetlus": { visible: true },
                        "V√µistlev dialoog": { visible: true },
                        "Innovatsioonipartnerlus": { visible: true },
                        "Kontsessioonimenetlus": { visible: true },
                        "Erimenetlused": { visible: true }
                    };

                    const internationalProcedureData = {
                        "Avatud hankemenetlus asjade hankelepingu s√µlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 30, piirm√§√§r: 143000, visible: true },
                        "Avatud hankemenetlus teenuste hankelepingu s√µlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 30, piirm√§√§r: 143000, visible: true },
                        "Avatud hankemenetlus ehitust√∂√∂de hankelepingu s√µlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 45, piirm√§√§r: 5538000, visible: true },
                        "Piiratud hankemenetlus teenuste hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 143000, visible: true },
                        "Piiratud hankemenetlus asjade hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 143000, visible: true },
                        "Piiratud hankemenetlus ehitust√∂√∂de hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 5538000, visible: true },
                        "Konkurentsip√µhine l√§bir√§√§kimistega hankemenetlus asjade hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 143000, visible: true },
                        "Konkurentsip√µhine l√§bir√§√§kimistega hankemenetlus teenuste hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 143000, visible: true },
                        "Konkurentsip√µhine l√§bir√§√§kimistega hankemenetlus ehitust√∂√∂de hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 5538000, visible: true },
                        "Innovatsioonipartnerlus asjade hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 143000, visible: true },
                        "Innovatsioonipartnerlus teenuste hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 143000, visible: true },
                        "Innovatsioonipartnerlus ehitust√∂√∂de hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 5538000, visible: true },
                        "V√µistlev dialoog asjade hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 143000, visible: true },
                        "V√µistlev dialoog teenuste hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 143000, visible: true },
                        "V√µistlev dialoog ehitust√∂√∂de hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 5538000, visible: true },
                        "Kontsessioonimenetlus koos eraldi taotluse esitamisega": { taotlusteAeg: 30, pakkumusteAeg: 17, piirm√§√§r: 5538000, visible: true },
                        "Kontsessioonimenetlus ilma eraldi taotlust esitamata": { taotlusteAeg: 0, pakkumusteAeg: 30, piirm√§√§r: 5538000, visible: true },
                        "Sotsiaalteenuste erimenetlus": { taotlusteAeg: 0, pakkumusteAeg: 10, piirm√§√§r: 750000, visible: true },
                        "Eriteenuste erimenetlus": { taotlusteAeg: 0, pakkumusteAeg: 10, piirm√§√§r: 750000, visible: true }
                    };


                    // Define roles and their permissions
                    const roles = {
                        mainAdmin: {
                            name: "Peaadministraator",
                            permissions: {
                                fullAccess: true,
                                userManagement: true,
                                settingsManagement: true,
                                roleManagement: true,
                                omAccess: true,
                                hmAccess: true,
                                auditLogAccess: true,
                                systemSettings: true
                            }
                        },
                        admin: {
                            name: "Administraator",
                            permissions: {
                                fullAccess: false,
                                userManagement: true,
                                settingsManagement: true,
                                roleManagement: false,
                                omAccess: true,
                                hmAccess: true,
                                auditLogAccess: true,
                                systemSettings: false
                            }
                        },
                        omUser: {
                            name: "Ostumaailm Kasutaja",
                            permissions: {
                                fullAccess: false,
                                userManagement: false,
                                settingsManagement: false,
                                roleManagement: false,
                                omAccess: true,
                                hmAccess: false,
                                auditLogAccess: false,
                                systemSettings: false,
                                omFeatures: {
                                    createOM: true,
                                    editOM: true,
                                    deleteOM: false,
                                    viewOM: true,
                                    exportOM: true
                                }
                            }
                        },
                        hmUser: {
                            name: "Hankemaailm Kasutaja",
                            permissions: {
                                fullAccess: false,
                                userManagement: false,
                                settingsManagement: false,
                                roleManagement: false,
                                omAccess: false,
                                hmAccess: true,
                                auditLogAccess: false,
                                systemSettings: false,
                                hmFeatures: {
                                    createHM: true,
                                    editHM: true,
                                    deleteHM: false,
                                    viewHM: true,
                                    exportHM: true
                                }
                            }
                        },
                        user: {
                            name: "Tavakasutaja",
                            permissions: {
                                fullAccess: false,
                                userManagement: false,
                                settingsManagement: false,
                                roleManagement: false,
                                omAccess: false,
                                hmAccess: false,
                                auditLogAccess: false,
                                systemSettings: false
                            }
                        }
                    };

                    // Function to check if user has access to specific features
                    function hasAccess(userRole, feature) {
                        const role = roles[userRole];
                        if (!role) return false;

                        // Check for full access first
                        if (role.permissions.fullAccess) return true;

                        // Check specific feature access
                        return role.permissions[feature] || false;
                    }

                    // Function to check if user has access to specific world (OM or HM)
                    function hasWorldAccess(userRole, world) {
                        const role = roles[userRole];
                        if (!role) return false;

                        // Main admin and admin have access to both worlds
                        if (userRole === 'mainAdmin' || userRole === 'admin') return true;

                        // Check specific world access
                        return role.permissions[world === 'om' ? 'omAccess' : 'hmAccess'] || false;
                    }

                    // Update the role selection in the user table
                    function generateUserTableRow(userData) {
                        const roleSelect = `
                <select class="form-select text-sm" 
                    onchange="updateUserRole('${userData.uid}', this.value)"
                    ${userData.role === 'mainAdmin' ? 'disabled' : ''}>
                    ${Object.entries(roles).map(([roleKey, roleData]) => `
                        <option value="${roleKey}" ${userData.role === roleKey ? 'selected' : ''}>
                            ${roleData.name}
                        </option>
                    `).join('')}
                </select>
            `;
                        // ... rest of the row generation code ...
                    }

                    // Validate role changes
                    /**
                     * Validates if a role change is allowed
                     * @param {string} oldRole - Current role of the user
                     * @param {string} newRole - New role to be assigned
                     * @param {string} currentUserRole - Role of the user making the change
                     * @returns {boolean} Whether the role change is valid
                     */
                    function validateRoleChange(oldRole, newRole, currentUserRole) {
                        // Prevent downgrading mainAdmin
                        if (oldRole === 'mainAdmin') {
                            showNotification("Peaadministraatori rolli ei saa muuta!", "error");
                            return false;
                        }

                        // Allow mainAdmin to change admin roles to any other role
                        if (currentUserRole === 'mainAdmin') {
                            // mainAdmin can change any role except other mainAdmins
                            return true;
                        }

                        // Only mainAdmin can create or modify admin roles
                        if (newRole === 'admin' || newRole === 'mainAdmin' || oldRole === 'admin') {
                            showNotification("Ainult peaadministraator v√µib luua v√µi muuta administraatoreid!", "error");
                            return false;
                        }

                        // Validate that the role exists
                        if (!roles[newRole]) {
                            showNotification("Vigane roll!", "error");
                            return false;
                        }

                        return true;
                    }

                    // Update the updateUserRole function to handle new roles
                    async function updateUserRole(userId, newRole) {
                        try {
                            const currentUser = auth.currentUser;
                            if (!currentUser) {
                                showNotification("Pead olema sisse logitud!", "error");
                                return;
                            }

                            const currentUserDoc = await getDoc(doc(db, "users", currentUser.uid));
                            const currentUserData = currentUserDoc.data();

                            if (currentUserData.role !== 'mainAdmin') {
                                showNotification("Sul ei ole √µigusi rollide muutmiseks!", "error");
                                return;
                            }

                            const userRef = doc(db, "users", userId);
                            const userDoc = await getDoc(userRef);
                            const userData = userDoc.data();

                            // Validate the role change
                            if (!validateRoleChange(userData.role, newRole, currentUserData.role)) {
                                return;
                            }

                            const oldRole = userData.role;
                            await updateDoc(userRef, {
                                role: newRole,
                                lastUpdated: new Date(),
                                updatedBy: currentUser.uid,
                                updatedByEmail: currentUser.email
                            });

                            // Log the role change
                            await addDoc(collection(db, "auditLog"), {
                                action: "role_change",
                                userId: userId,
                                userEmail: userData.email,
                                oldRole: oldRole,
                                newRole: newRole,
                                changedBy: currentUser.uid,
                                changedByEmail: currentUser.email,
                                timestamp: new Date()
                            });

                            showNotification("Kasutaja roll edukalt uuendatud!", "success");
                            loadUsers(); // Reload the user table
                        } catch (error) {
                            console.error("Error updating user role:", error);
                            showNotification("Rolli uuendamisel tekkis viga!", "error");
                        }
                    }

                    // Update the access control check
                    async function checkAccess() {
                        const currentUser = auth.currentUser
                        if (!currentUser) {
                            window.location.href = "/index.html"
                            return
                        }

                        const userDoc = await getDoc(doc(db, "users", currentUser.uid))
                        const userData = userDoc.data()

                        if (!userData) {
                            window.location.href = "/index.html"
                            return
                        }

                        // Show mainAdmin indicator if the user is a mainAdmin
                        const mainAdminIndicator = document.getElementById('mainAdminIndicator');
                        if (mainAdminIndicator && userData.role === 'mainAdmin') {
                            mainAdminIndicator.classList.remove('hidden');
                        }

                        // Update localStorage based on Firestore data
                        localStorage.setItem('user', JSON.stringify({
                            email: userData.email,
                            id: userData.uid,
                            role: userData.role,
                            isAdmin: userData.role.trim() === 'mainAdmin' // Set isAdmin based on role
                        }));

                        console.log("Updated localStorage:", JSON.parse(localStorage.getItem('user'))); // Log updated user data

                        // Check if user has access to the current page
                        const currentPage = window.location.pathname
                        const isOMPage = currentPage.includes('om.html')
                        const isHMPage = currentPage.includes('hm.html')

                        if (isOMPage && !hasWorldAccess(userData.role, 'om')) {
                            showNotification("Sul ei ole √µigusi Ostumaailma lehele!", "error")
                            window.location.href = "/index.html"
                            return
                        }

                        if (isHMPage && !hasWorldAccess(userData.role, 'hm')) {
                            showNotification("Sul ei ole √µigusi Hankemaailma lehele!", "error")
                            window.location.href = "/index.html"
                            return
                        }

                        // Update UI based on permissions
                        updateUIForRole(userData.role)
                    }

                    // Function to update UI based on role
                    function updateUIForRole(role) {
                        const roleData = roles[role];
                        if (!roleData) return;

                        // Update navigation menu
                        const omLink = document.querySelector('a[href*="om.html"]');
                        const hmLink = document.querySelector('a[href*="hm.html"]');

                        if (omLink) omLink.style.display = roleData.permissions.omAccess ? 'block' : 'none';
                        if (hmLink) hmLink.style.display = roleData.permissions.hmAccess ? 'block' : 'none';

                        // Update other UI elements based on permissions
                        // ... add more UI updates as needed ...
                    }

                    // Define default roles
                    const defaultRoles = {
                        mainAdmin: {
                            name: "Peaadministraator",
                            description: "T√§ielikud √µigused s√ºsteemi haldamiseks",
                            permissions: {
                                fullAccess: true,
                                userManagement: true,
                                settingsManagement: true,
                                roleManagement: true,
                                omAccess: true,
                                hmAccess: true,
                                auditLogAccess: true,
                                systemSettings: true,
                                viewPublicContent: true,
                                viewHiddenContent: true,
                                viewTimeline: true,
                                saveSearches: true,
                                search: true,
                                adjustDays: true,
                                saveToExcel: true,
                                generatePdf: true,
                                saveSettings: true,
                                deleteAdminMenu: true
                            },
                            limits: {
                                searchLimit: -1, // -1 means unlimited
                                firestoreSaveLimit: -1,
                                pdfGenerationLimit: -1,
                                recentSearchLimit: 20
                            },
                            isSystem: true
                        },
                        admin: {
                            name: "Administraator",
                            description: "Peaaegu t√§ielikud √µigused s√ºsteemi haldamiseks",
                            permissions: {
                                fullAccess: false,
                                userManagement: true,
                                settingsManagement: true,
                                roleManagement: true,
                                omAccess: true,
                                hmAccess: true,
                                auditLogAccess: true,
                                systemSettings: true,
                                viewPublicContent: true,
                                viewHiddenContent: true,
                                viewTimeline: true,
                                saveSearches: true,
                                search: true,
                                adjustDays: true,
                                saveToExcel: true,
                                generatePdf: true,
                                saveSettings: true,
                                deleteAdminMenu: false
                            },
                            limits: {
                                searchLimit: -1,
                                firestoreSaveLimit: -1,
                                pdfGenerationLimit: -1,
                                recentSearchLimit: 15
                            },
                            isSystem: true
                        },
                        user: {
                            name: "Tavakasutaja",
                            description: "Piiratud √µigused s√ºsteemi kasutamiseks",
                            permissions: {
                                fullAccess: false,
                                userManagement: false,
                                settingsManagement: false,
                                roleManagement: false,
                                omAccess: false,
                                hmAccess: false,
                                auditLogAccess: false,
                                systemSettings: false,
                                viewPublicContent: true,
                                viewHiddenContent: false,
                                viewTimeline: true,
                                saveSearches: false,
                                search: true,
                                adjustDays: false,
                                saveToExcel: false,
                                generatePdf: false,
                                saveSettings: false,
                                deleteAdminMenu: false
                            },
                            limits: {
                                searchLimit: 5,
                                firestoreSaveLimit: 0,
                                pdfGenerationLimit: 0,
                                recentSearchLimit: 3
                            },
                            isSystem: true
                        }
                    };

                    // Function to load saved roles from localStorage
                    function loadSavedRoles() {
                        try {
                            const savedRoles = localStorage.getItem('userRoles');
                            if (savedRoles) {
                                const parsedRoles = JSON.parse(savedRoles);
                                // Merge saved roles with defaults to ensure all required fields exist
                                Object.keys(parsedRoles).forEach(key => {
                                    roles[key] = {
                                        ...defaultRoles[key],
                                        ...parsedRoles[key]
                                    };
                                });
                            }
                        } catch (error) {
                            console.error('Error loading roles:', error);
                            showNotification('Viga rollide laadimisel!', 'error');
                        }
                    }

                    // Function to save roles to localStorage
                    async function saveRoles() {
                        try {
                            localStorage.setItem('userRoles', JSON.stringify(roles));
                            return true;
                        } catch (error) {
                            console.error('Error saving roles:', error);
                            throw error;
                        }
                    }

                    // Function to edit a role
                    window.editRole = async function (roleId) {
                        try {
                            // Check if current user is mainAdmin
                            const currentUser = auth.currentUser;
                            if (!currentUser) {
                                showNotification("Pead olema sisse logitud!", "error");
                                return;
                            }

                            const currentUserDoc = await getDoc(doc(db, "users", currentUser.uid));
                            const currentUserData = currentUserDoc.data();
                            const isMainAdmin = currentUserData && currentUserData.role === 'mainAdmin';

                            // Only block system role edits for non-mainAdmin users
                            if (roles[roleId].isSystem && !isMainAdmin) {
                                showNotification('S√ºsteemi rolle saab muuta ainult Peaadministraator!', 'error');
                                return;
                            }

                            const role = roles[roleId];
                            const container = document.querySelector('#rolesContainer .space-y-4');
                            if (!container) return;

                            container.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow-sm space-y-4">
                    <div class="space-y-4">
                        <div>
                            <label for="roleName" class="block text-sm font-medium text-gray-700">Rolli nimi:</label>
                            <input type="text" id="roleName" value="${role.name}"
                                class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm"
                                required>
                        </div>
                        <div>
                            <label for="roleDescription" class="block text-sm font-medium text-gray-700">Kirjeldus:</label>
                            <textarea id="roleDescription"
                                class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm"
                                rows="2">${role.description || ''}</textarea>
                        </div>
                        <div class="space-y-2">
                            <h5 class="text-sm font-medium text-gray-700">√ïigused:</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="searchPermission" class="rounded text-blue-600" ${role.permissions.search ? 'checked' : ''}>
                                    <span class="text-sm text-gray-700">Otsingute tegemine</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="viewPublicContent" class="rounded text-blue-600" ${role.permissions.viewPublicContent ? 'checked' : ''}>
                                    <span class="text-sm text-gray-700">Avaliku sisu vaatamine</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="viewHiddenContent" class="rounded text-blue-600" ${role.permissions.viewHiddenContent ? 'checked' : ''}>
                                    <span class="text-sm text-gray-700">Peidetud sisu vaatamine</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="viewTimeline" class="rounded text-blue-600" ${role.permissions.viewTimeline ? 'checked' : ''}>
                                    <span class="text-sm text-gray-700">Timeline vaatamine</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="saveSearches" class="rounded text-blue-600" ${role.permissions.saveSearches ? 'checked' : ''}>
                                    <span class="text-sm text-gray-700">Otsingute salvestamine</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="settingsManagement" class="rounded text-blue-600" ${role.permissions.settingsManagement ? 'checked' : ''}>
                                    <span class="text-sm text-gray-700">Seadete muutmine</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="userManagement" class="rounded text-blue-600" ${role.permissions.userManagement ? 'checked' : ''}>
                                    <span class="text-sm text-gray-700">Kasutajate haldamine</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="adjustDays" class="rounded text-blue-600" ${role.permissions.adjustDays ? 'checked' : ''}>
                                    <span class="text-sm text-gray-700">P√§evade muutmine</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="saveToExcel" class="rounded text-blue-600" ${role.permissions.saveToExcel ? 'checked' : ''}>
                                    <span class="text-sm text-gray-700">Excelisse salvestamine</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="generatePdf" class="rounded text-blue-600" ${role.permissions.generatePdf ? 'checked' : ''}>
                                    <span class="text-sm text-gray-700">PDF genereerimine</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="saveSettings" class="rounded text-blue-600" ${role.permissions.saveSettings ? 'checked' : ''}>
                                    <span class="text-sm text-gray-700">Seadete salvestamine</span>
                                </label>
                                ${isMainAdmin ? `
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="fullAccess" class="rounded text-blue-600" ${role.permissions.fullAccess ? 'checked' : ''}>
                                    <span class="text-sm text-gray-700">T√§ielik juurdep√§√§s</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="roleManagement" class="rounded text-blue-600" ${role.permissions.roleManagement ? 'checked' : ''}>
                                    <span class="text-sm text-gray-700">Rollide haldamine</span>
                                </label>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <h5 class="text-sm font-medium text-gray-700">Kasutuse limiidid:</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label for="searchLimit" class="block text-xs text-gray-600">Otsingute arv:</label>
                                    <input type="number" id="searchLimit" value="${role.limits?.searchLimit ?? -1}"
                                        class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm"
                                        min="-1" placeholder="Piiramatu">
                                    <p class="text-xs text-gray-500 mt-1">-1 = piiramatu</p>
                                </div>
                                <div>
                                    <label for="firestoreSaveLimit" class="block text-xs text-gray-600">Firestore salvestamised:</label>
                                    <input type="number" id="firestoreSaveLimit" value="${role.limits?.firestoreSaveLimit ?? -1}"
                                        class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm"
                                        min="-1" placeholder="Piiramatu">
                                    <p class="text-xs text-gray-500 mt-1">-1 = piiramatu</p>
                                </div>
                                <div>
                                    <label for="pdfGenerationLimit" class="block text-xs text-gray-600">PDF genereerimiste arv:</label>
                                    <input type="number" id="pdfGenerationLimit" value="${role.limits?.pdfGenerationLimit ?? -1}"
                                        class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm"
                                        min="-1" placeholder="Piiramatu">
                                    <p class="text-xs text-gray-500 mt-1">-1 = piiramatu</p>
                                </div>
                                <div>
                                    <label for="recentSearchLimit" class="block text-xs text-gray-600">Viimaste otsingute kuvamine:</label>
                                    <input type="number" id="recentSearchLimit" value="${role.limits?.recentSearchLimit ?? 0}"
                                        class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm"
                                        min="0" max="20" placeholder="0">
                                    <p class="text-xs text-gray-500 mt-1">0 = ei kuva, max 20</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button onclick="cancelEditRole()"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                            T√ºhista
                        </button>
                        <button onclick="saveRole('${roleId}')"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                            Salvesta
                        </button>
                    </div>
                </div>
            `;
                        } catch (error) {
                            console.error('Error in editRole:', error);
                            showNotification('Viga rolli muutmisel!', 'error');
                        }
                    };

                    // Function to save a role
                    window.saveRole = async function (roleId) {
                        try {
                            const name = document.getElementById('roleName').value;
                            const description = document.getElementById('roleDescription').value;

                            // Check if current user is mainAdmin
                            const currentUser = auth.currentUser;
                            if (!currentUser) {
                                showNotification("Pead olema sisse logitud!", "error");
                                return;
                            }

                            const currentUserDoc = await getDoc(doc(db, "users", currentUser.uid));
                            const currentUserData = currentUserDoc.data();
                            const isMainAdmin = currentUserData && currentUserData.role === 'mainAdmin';

                            const permissions = {
                                search: document.getElementById('searchPermission').checked,
                                viewPublicContent: document.getElementById('viewPublicContent').checked,
                                viewHiddenContent: document.getElementById('viewHiddenContent').checked,
                                viewTimeline: document.getElementById('viewTimeline').checked,
                                saveSearches: document.getElementById('saveSearches').checked,
                                settingsManagement: document.getElementById('settingsManagement').checked,
                                userManagement: document.getElementById('userManagement').checked,
                                roleManagement: isMainAdmin && document.getElementById('roleManagement') ?
                                    document.getElementById('roleManagement').checked :
                                    roles[roleId].permissions.roleManagement,
                                fullAccess: isMainAdmin && document.getElementById('fullAccess') ?
                                    document.getElementById('fullAccess').checked :
                                    roles[roleId].permissions.fullAccess,
                                deleteAdminMenu: roles[roleId].permissions.deleteAdminMenu,
                                adjustDays: document.getElementById('adjustDays').checked,
                                saveToExcel: document.getElementById('saveToExcel').checked,
                                generatePdf: document.getElementById('generatePdf').checked,
                                saveSettings: document.getElementById('saveSettings').checked
                            };

                            // Get the usage limits
                            const limits = {
                                searchLimit: parseInt(document.getElementById('searchLimit').value) || -1,
                                firestoreSaveLimit: parseInt(document.getElementById('firestoreSaveLimit').value) || -1,
                                pdfGenerationLimit: parseInt(document.getElementById('pdfGenerationLimit').value) || -1,
                                recentSearchLimit: parseInt(document.getElementById('recentSearchLimit').value) || 0
                            };

                            roles[roleId] = {
                                ...roles[roleId],
                                name,
                                description,
                                permissions,
                                limits
                            };

                            await saveRoles();
                            showNotification('Roll salvestatud!', 'success');
                            loadRoles();
                        } catch (error) {
                            console.error('Error saving role:', error);
                            showNotification('Viga rolli salvestamisel!', 'error');
                        }
                    };

                    // Function to delete a role
                    window.deleteRole = async function (roleId) {
                        try {
                            // Check if current user is mainAdmin
                            const currentUser = auth.currentUser;
                            if (!currentUser) {
                                showNotification("Pead olema sisse logitud!", "error");
                                return;
                            }

                            const currentUserDoc = await getDoc(doc(db, "users", currentUser.uid));
                            const currentUserData = currentUserDoc.data();
                            const isMainAdmin = currentUserData && currentUserData.role === 'mainAdmin';

                            // Only block system role deletion for non-mainAdmin users
                            if (roles[roleId].isSystem && !isMainAdmin) {
                                showNotification('S√ºsteemi rolle saab kustutada ainult Peaadministraator!', 'error');
                                return;
                            }

                            // Warn about system role deletion even for mainAdmin
                            if (roles[roleId].isSystem && isMainAdmin) {
                                if (!confirm('See on s√ºsteemi roll! Kas oled kindel, et soovid selle kustutada? See v√µib m√µjutada s√ºsteemi t√∂√∂d!')) {
                                    return;
                                }
                            } else if (!confirm('Kas oled kindel, et soovid selle rolli kustutada?')) {
                                return;
                            }

                            delete roles[roleId];
                            await saveRoles();
                            showNotification('Roll kustutatud!', 'success');
                            loadRoles();
                        } catch (error) {
                            console.error('Error deleting role:', error);
                            showNotification('Viga rolli kustutamisel!', 'error');
                        }
                    };

                    // Function to cancel role editing
                    window.cancelEditRole = function () {
                        loadRoles();
                    };

                    // Function to load roles into the UI
                    function loadRoles() {
                        const rolesContainer = document.querySelector('#rolesContainer .space-y-4');
                        if (!rolesContainer) return;

                        rolesContainer.innerHTML = '';

                        // Check if current user is mainAdmin
                        const checkMainAdmin = async () => {
                            try {
                                const currentUser = auth.currentUser;
                                if (!currentUser) return false;

                                const currentUserDoc = await getDoc(doc(db, "users", currentUser.uid));
                                const currentUserData = currentUserDoc.data();
                                return currentUserData && currentUserData.role === 'mainAdmin';
                            } catch (error) {
                                console.error('Error checking mainAdmin:', error);
                                return false;
                            }
                        };

                        checkMainAdmin().then(isMainAdmin => {
                            // Add special banner for mainAdmin users
                            if (isMainAdmin) {
                                const mainAdminBanner = document.createElement('div');
                                mainAdminBanner.className = 'bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg shadow-sm mb-4 border-l-4 border-blue-500';
                                mainAdminBanner.innerHTML = `
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 bg-blue-100 rounded-full p-2">
                                            <i class="fas fa-shield-alt text-blue-600"></i>
                                        </div>
                                        <div class="ml-3">
                                            <h3 class="text-sm font-medium text-blue-800">Peaadministraatori √µigused</h3>
                                            <div class="mt-1 text-sm text-blue-700">
                                                <p>Sul on v√µimalik muuta ja kustutada s√ºsteemi rolle. S√ºsteemi rollid on t√§histatud rohelise √§√§risega.</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                rolesContainer.appendChild(mainAdminBanner);
                            }

                            Object.entries(roles).forEach(([roleId, role]) => {
                                const roleElement = document.createElement('div');

                                // Add special highlight class for system roles that are editable by mainAdmin
                                if (role.isSystem && isMainAdmin) {
                                    roleElement.className = 'bg-white p-5 rounded-lg shadow-sm border-2 border-green-300 transition-all duration-300 hover:shadow-md';
                                } else {
                                    roleElement.className = 'bg-white p-5 rounded-lg shadow-sm border border-gray-200 transition-all duration-300 hover:shadow-md';
                                }

                                // Create badge based on role color or default to blue
                                const roleColor = role.color || 'blue';
                                const colorClasses = {
                                    blue: 'bg-blue-100 text-blue-800',
                                    green: 'bg-green-100 text-green-800',
                                    purple: 'bg-purple-100 text-purple-800',
                                    yellow: 'bg-yellow-100 text-yellow-800',
                                    red: 'bg-red-100 text-red-800'
                                };

                                const badgeClass = colorClasses[roleColor] || colorClasses.blue;

                                roleElement.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="px-3 py-1 text-sm font-medium rounded-full ${badgeClass}">${role.name}</div>
                                <p class="text-sm text-gray-500">${role.description || ''}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                ${role.isSystem ?
                                        // If system role, show buttons only for mainAdmin
                                        (isMainAdmin ?
                                            `<span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full flex items-center">
                                                <span>S√ºsteem</span>
                                                <span class="ml-1 text-xs text-green-600">(muudetav)</span>
                                             </span>
                                     <button onclick="editRole('${roleId}')" class="p-1.5 text-gray-600 hover:text-blue-600 bg-gray-100 hover:bg-blue-50 rounded-lg transition-colors">
                                        <i class="fas fa-edit"></i>
                                     </button>
                                     <button onclick="deleteRole('${roleId}')" class="p-1.5 text-gray-600 hover:text-red-600 bg-gray-100 hover:bg-red-50 rounded-lg transition-colors">
                                        <i class="fas fa-trash"></i>
                                     </button>` :
                                            `<span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">S√ºsteem</span>`) :
                                        // For non-system roles, always show edit/delete buttons
                                        `<button onclick="editRole('${roleId}')" class="p-1.5 text-gray-600 hover:text-blue-600 bg-gray-100 hover:bg-blue-50 rounded-lg transition-colors">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteRole('${roleId}')" class="p-1.5 text-gray-600 hover:text-red-600 bg-gray-100 hover:bg-red-50 rounded-lg transition-colors">
                                        <i class="fas fa-trash"></i>
                                    </button>`
                                    }
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h5 class="text-sm font-medium text-gray-700 mb-2 pb-1 border-b border-gray-200">√ïigused:</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1">
                                    ${Object.entries(role.permissions)
                                        .filter(([key]) => typeof role.permissions[key] === 'boolean')
                                        .map(([key, value]) => `
                                        <div class="flex items-center py-1">
                                            <i class="fas ${value ? 'fa-check text-green-500' : 'fa-times text-red-500'} w-5 mr-2"></i>
                                            <span class="text-sm text-gray-700">${getPermissionLabel(key)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div>
                                <h5 class="text-sm font-medium text-gray-700 mb-2 pb-1 border-b border-gray-200">Kasutuse limiidid:</h5>
                                <div class="grid grid-cols-1 gap-y-1">
                                    ${role.limits ? `
                                        <div class="flex items-center justify-between py-1">
                                            <span class="text-sm text-gray-700">Otsingute arv:</span>
                                            <span class="text-sm font-medium ${role.limits.searchLimit === -1 ? 'text-green-600' : 'text-blue-600'}">
                                                ${role.limits.searchLimit === -1 ? 'Piiramatu' : role.limits.searchLimit}
                                            </span>
                                        </div>
                                        <div class="flex items-center justify-between py-1">
                                            <span class="text-sm text-gray-700">Firestore salvestamisi:</span>
                                            <span class="text-sm font-medium ${role.limits.firestoreSaveLimit === -1 ? 'text-green-600' : 'text-blue-600'}">
                                                ${role.limits.firestoreSaveLimit === -1 ? 'Piiramatu' : role.limits.firestoreSaveLimit}
                                            </span>
                                        </div>
                                        <div class="flex items-center justify-between py-1">
                                            <span class="text-sm text-gray-700">PDF genereerimisi:</span>
                                            <span class="text-sm font-medium ${role.limits.pdfGenerationLimit === -1 ? 'text-green-600' : 'text-blue-600'}">
                                                ${role.limits.pdfGenerationLimit === -1 ? 'Piiramatu' : role.limits.pdfGenerationLimit}
                                            </span>
                                        </div>
                                        <div class="flex items-center justify-between py-1">
                                            <span class="text-sm text-gray-700">Viimaste otsingute n√§itamine:</span>
                                            <span class="text-sm font-medium ${role.limits.recentSearchLimit === 0 ? 'text-red-600' : 'text-blue-600'}">
                                                ${role.limits.recentSearchLimit === 0 ? 'Ei n√§ita' : role.limits.recentSearchLimit}
                                            </span>
                                        </div>
                                    ` : `
                                        <div class="text-sm text-gray-500 italic">Limiidid puuduvad</div>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                                rolesContainer.appendChild(roleElement);
                            });

                            // Update role statistics
                            document.getElementById('activeRolesCount').textContent = Object.keys(roles).length;
                            document.getElementById('totalPermissionsCount').textContent = Object.values(roles).reduce((total, role) => {
                                return total + Object.values(role.permissions).filter(value => value === true).length;
                            }, 0);
                        });
                    }

                    // Function to get permission labels
                    function getPermissionLabel(key) {
                        const labels = {
                            fullAccess: 'T√§ielik juurdep√§√§s',
                            userManagement: 'Kasutajate haldamine',
                            settingsManagement: 'Seadete muutmine',
                            roleManagement: 'Rollide haldamine',
                            search: 'Otsingute tegemine',
                            viewPublicContent: 'Avaliku sisu vaatamine',
                            viewHiddenContent: 'Peidetud sisu vaatamine',
                            viewTimeline: 'Timeline vaatamine',
                            saveSearches: 'Otsingute salvestamine',
                            deleteAdminMenu: 'Admin men√º√º kustutamine'
                        };
                        return labels[key] || key;
                    }

                    // Add role button event listener
                    document.getElementById('addRoleButton').addEventListener('click', function () {
                        const newRoleId = 'role_' + Date.now();
                        roles[newRoleId] = {
                            name: 'Uus roll',
                            description: 'Kirjeldus puudub',
                            permissions: {
                                fullAccess: false,
                                userManagement: false,
                                settingsManagement: false,
                                roleManagement: false,
                                search: true,
                                viewPublicContent: true,
                                viewHiddenContent: false,
                                viewTimeline: true,
                                saveSearches: false,
                                deleteAdminMenu: false,
                                adjustDays: false,
                                saveToExcel: false,
                                generatePdf: false,
                                saveSettings: false
                            },
                            limits: {
                                searchLimit: 10,
                                firestoreSaveLimit: 5,
                                pdfGenerationLimit: 5,
                                recentSearchLimit: 5
                            },
                            isSystem: false
                        };
                        editRole(newRoleId);
                    });

                    // Function to show notifications
                    function showNotification(message, type = 'success') {
                        const notification = document.createElement('div')
                        notification.className = `fixed top-20 right-4 p-4 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white`
                        notification.innerHTML = `<div class="flex items-center space-x-2"><i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i><span>${message}</span></div>`
                        document.body.appendChild(notification)

                        // Remove notification after 3 seconds
                        setTimeout(() => {
                            notification.remove()
                        }, 3000)
                    }

                    // Load roles when the page loads
                    document.addEventListener("DOMContentLoaded", () => {
                        onAuthStateChanged(auth, async (user) => {
                            if (!user) {
                                alert("You must be logged in.");
                                window.location.href = "/index.html";
                                return;
                            }

                            console.log("User logged in:", user.uid);

                            try {
                                const userRef = doc(db, "users", user.uid);
                                const userSnap = await getDoc(userRef);

                                // Check if this is the main admin
                                if (user.email === "viljarpartel@gmail.com") {
                                    console.log("Main admin detected, checking stored credentials...");

                                    // Only ask for password if not already stored
                                    const storedPassword = localStorage.getItem('mainAdminPassword');
                                    if (!storedPassword) {
                                        const mainAdminPassword = prompt("Please enter your password to enable user management:");
                                        if (mainAdminPassword) {
                                            localStorage.setItem('mainAdminPassword', mainAdminPassword);
                                        }
                                    }

                                    await setDoc(userRef, {
                                        email: user.email,
                                        role: "mainAdmin",
                                        approved: true,
                                        createdAt: new Date(),
                                        uid: user.uid,
                                        isMainAdmin: true,
                                        lastLogin: new Date(),
                                        status: 'active',
                                        emailVerified: true,
                                        lastUpdated: new Date()
                                    }, { merge: true });
                                }

                                if (!userSnap.exists()) {
                                    console.log("Creating new user document in Firestore...");
                                    await setDoc(userRef, {
                                        email: user.email,
                                        role: user.email === "viljarpartel@gmail.com" ? "mainAdmin" : "tavakasutaja",
                                        approved: user.email === "viljarpartel@gmail.com",
                                        createdAt: new Date(),
                                        uid: user.uid,
                                        isMainAdmin: user.email === "viljarpartel@gmail.com",
                                        lastLogin: new Date(),
                                        status: user.email === "viljarpartel@gmail.com" ? 'active' : 'pending',
                                        emailVerified: user.email === "viljarpartel@gmail.com",
                                        lastUpdated: new Date()
                                    });
                                    console.log("User document created successfully!");
                                }

                                const userData = userSnap.exists() ? userSnap.data() : {
                                    email: user.email,
                                    role: user.email === "viljarpartel@gmail.com" ? "mainAdmin" : "tavakasutaja",
                                    approved: user.email === "viljarpartel@gmail.com",
                                    isMainAdmin: user.email === "viljarpartel@gmail.com"
                                };
                                console.log("User Data from Firestore:", userData);

                                // Allow access if user is main admin or regular admin
                                if (userData.role !== "mainAdmin" && userData.role !== "admin") {
                                    console.error("User is not an admin.");
                                    alert("You are not authorized to view this page.");
                                    window.location.href = "/index.html";
                                    return;
                                }

                                console.log("Admin access granted.");
                                loadUsers();
                                loadSavedRoles();
                                loadRoles();
                            } catch (error) {
                                console.error("Error checking user role:", error);
                                alert("Permission error. Check Firestore rules.");
                            }
                        });

                        // Setup logout functionality
                        const logoutButton = document.getElementById("logoutButton");
                        const logoutButtonDropdown = document.getElementById("logoutButtonDropdown");

                        if (logoutButton) {
                            logoutButton.addEventListener("click", handleLogout);
                        }

                        if (logoutButtonDropdown) {
                            logoutButtonDropdown.addEventListener("click", handleLogout);
                        }

                        function handleLogout() {
                            signOut(auth).then(() => {
                                alert("Logged out successfully.");
                                window.location.href = "/index.html";
                            }).catch((error) => {
                                console.error("Error logging out:", error);
                                alert("Logout failed.");
                            });
                        }

                        // Roles Modal functionality
                        const rolesButton = document.getElementById("rolesButton");
                        const rolesContainer = document.getElementById("rolesContainer");
                        const rolesBackdrop = document.getElementById("rolesBackdrop");
                        const closeRoles = document.getElementById("closeRoles");

                        if (!rolesButton || !rolesContainer) {
                            console.error("‚ùå rolesButton or rolesContainer not found in the DOM!");
                            return;
                        }

                        // Function to open roles modal
                        function openRoles() {
                            rolesContainer.classList.remove("hidden");
                            rolesBackdrop.classList.remove("hidden");
                            document.body.style.overflow = "hidden"; // Prevent scrolling of background

                            // Check if user is mainAdmin and show indicator
                            const user = auth.currentUser;
                            if (user) {
                                getDoc(doc(db, "users", user.uid)).then(userSnap => {
                                    if (userSnap.exists() && userSnap.data().role === "mainAdmin") {
                                        const indicator = document.getElementById("mainAdminRolesIndicator");
                                        if (indicator) {
                                            indicator.classList.remove("hidden");
                                        }
                                    }
                                });
                            }

                            loadRoles();
                        }

                        // Function to close roles modal
                        function closeRolesModal() {
                            rolesContainer.classList.add("hidden");
                            rolesBackdrop.classList.add("hidden");
                            document.body.style.overflow = ""; // Restore scrolling

                            // Hide the mainAdmin indicator when closing
                            const indicator = document.getElementById("mainAdminRolesIndicator");
                            if (indicator) {
                                indicator.classList.add("hidden");
                            }
                        }

                        // Toggle roles modal
                        rolesButton.addEventListener("click", openRoles);

                        // Close roles modal when clicking the close button
                        closeRoles.addEventListener("click", closeRolesModal);

                        // Close roles modal when clicking outside the container
                        rolesBackdrop.addEventListener("click", (e) => {
                            if (e.target === rolesBackdrop) {
                                closeRolesModal();
                            }
                        });

                        // Close roles modal when pressing Escape key
                        document.addEventListener("keydown", (e) => {
                            if (e.key === "Escape" && !rolesContainer.classList.contains("hidden")) {
                                closeRolesModal();
                            }
                        });

                        // Settings functionality
                        const settingsButton = document.getElementById("settingsButton");
                        const settingsContainer = document.getElementById("settingsContainer");
                        const settingsBackdrop = document.getElementById("settingsBackdrop");
                        const closeSettings = document.getElementById("closeSettings");
                        const procedureTypeSelect = document.getElementById("procedureTypeSelect");
                        const addProcedureTypeButton = document.getElementById("addProcedureTypeButton");
                        const settingsForm = document.getElementById("settingsForm");

                        if (!settingsButton || !settingsContainer) {
                            console.error("‚ùå settingsButton or settingsContainer not found in the DOM!");
                            return;
                        }

                        // Function to open settings
                        function openSettings() {
                            settingsContainer.classList.remove("hidden");
                            settingsBackdrop.classList.remove("hidden");
                            document.body.style.overflow = "hidden"; // Prevent scrolling of background
                            loadSettings();
                            loadProcedureTypes();
                        }

                        // Function to close settings
                        function closeSettingsModal() {
                            settingsContainer.classList.add("hidden");
                            settingsBackdrop.classList.add("hidden");
                            document.body.style.overflow = ""; // Restore scrolling
                        }

                        // Load saved settings from localStorage
                        loadSavedSettings();

                        // Toggle settings container
                        settingsButton.addEventListener("click", openSettings);

                        // Close settings when clicking the close button
                        closeSettings.addEventListener("click", closeSettingsModal);

                        // Close settings when clicking outside the container
                        settingsBackdrop.addEventListener("click", (e) => {
                            if (e.target === settingsBackdrop) {
                                closeSettingsModal();
                            }
                        });

                        // Close settings when pressing Escape key
                        document.addEventListener("keydown", (e) => {
                            if (e.key === "Escape" && !settingsContainer.classList.contains("hidden")) {
                                closeSettingsModal();
                            }
                        });

                        // Handle settings form submission
                        document.getElementById('settingsForm').addEventListener('submit', async function (event) {
                            event.preventDefault();

                            const ostumaailmVisible = document.getElementById('ostumaailmVisibility').checked;
                            const hankemaailmVisible = document.getElementById('hankemaailmVisibility').checked;

                            // Save settings to Firestore or localStorage
                            try {
                                await saveSettings({ ostumaailmVisible, hankemaailmVisible });
                                showNotification('Seaded salvestatud edukalt!', 'success');
                            } catch (error) {
                                console.error('Error saving settings:', error);
                                showNotification('Viga seadete salvestamisel!', 'error');
                            }
                        });

                        // Function to save settings
                        async function saveSettings(settings) {
                            // Implement saving logic (e.g., to Firestore or localStorage)
                            localStorage.setItem('settings', JSON.stringify(settings));
                        }

                        // Add procedure type button event listener
                        if (addProcedureTypeButton) {
                            addProcedureTypeButton.addEventListener('click', function () {
                                addProcedureType();
                            });
                        }

                        // Procedure type select change event listener
                        if (procedureTypeSelect) {
                            procedureTypeSelect.addEventListener('change', function () {
                                const selectedType = this.value;
                                loadProcedureTypeSettings(selectedType);
                            });
                        }

                        // Function to load settings into form
                        function loadSettings() {
                            document.getElementById('documentPreparationDays').value = settings.documentPreparationDays;
                            document.getElementById('offerEvaluationDays').value = settings.offerEvaluationDays;
                            document.getElementById('decisionDays').value = settings.decisionDays;
                            document.getElementById('bidderEvaluationDays').value = settings.bidderEvaluationDays;
                            document.getElementById('successfulBidderDays').value = settings.successfulBidderDays;
                            document.getElementById('waitingPeriodDays').value = settings.waitingPeriodDays;
                        }

                        // Function to save settings to localStorage
                        async function saveSettings() {
                            try {
                                localStorage.setItem('procurementSettings', JSON.stringify(settings));
                                localStorage.setItem('procedureData', JSON.stringify(procedureData));
                                localStorage.setItem('internationalProcedureData', JSON.stringify(internationalProcedureData));
                                return true;
                            } catch (error) {
                                console.error('Error saving settings:', error);
                                throw error;
                            }
                        }

                        // Function to load saved settings from localStorage
                        function loadSavedSettings() {
                            try {
                                const savedSettings = localStorage.getItem('procurementSettings');
                                if (savedSettings) {
                                    settings = JSON.parse(savedSettings);
                                }

                                const savedProcedureData = localStorage.getItem('procedureData');
                                if (savedProcedureData) {
                                    const parsedData = JSON.parse(savedProcedureData);
                                    Object.keys(parsedData).forEach(key => {
                                        procedureData[key] = {
                                            ...parsedData[key],
                                            visible: parsedData[key].visible ?? true // Default to true if not set
                                        };
                                    });
                                }

                                const savedInternationalProcedureData = localStorage.getItem('internationalProcedureData');
                                if (savedInternationalProcedureData) {
                                    const parsedData = JSON.parse(savedInternationalProcedureData);
                                    Object.keys(parsedData).forEach(key => {
                                        internationalProcedureData[key] = {
                                            ...parsedData[key],
                                            visible: parsedData[key].visible ?? true // Default to true if not set
                                        };
                                    });
                                }
                            } catch (error) {
                                console.error('Error loading settings:', error);
                                showNotification('Viga seadete laadimisel!', 'error');
                            }
                        }

                        // Function to load procedure types from local procedureData
                        function loadProcedureTypes() {
                            const select = document.getElementById('procedureTypeSelect');
                            select.innerHTML = '';

                            // Add all procedures without optgroups
                            for (const type in procedureData) {
                                const option = document.createElement('option');
                                option.value = type;
                                option.textContent = type;
                                select.appendChild(option);
                            }

                            if (select.options.length > 0) {
                                loadProcedureTypeSettings(select.options[0].value);
                            }
                        }

                        // Load settings for a specific procedure type
                        function loadProcedureTypeSettings(type) {
                            const procedure = procedureData[type];
                            const container = document.getElementById('procedureTypeSettings');
                            container.innerHTML = `
                    <div class="bg-white p-4 rounded-lg shadow-sm space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label for="procedureTypeName" class="block text-sm font-medium text-gray-700">Menetlusliik:</label>
                                <input type="text" id="procedureTypeName" value="${type}"
                                    class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm"
                                    required>
                            </div>
                            <div class="space-y-1">
                                <label for="requestDays" class="block text-sm font-medium text-gray-700">Taotluste aeg (p√§evad):</label>
                                <input type="number" id="requestDays" value="${procedure?.taotlusteAeg || 0}"
                                    class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm"
                                    required>
                            </div>
                            <div class="space-y-1">
                                <label for="offerDays" class="block text-sm font-medium text-gray-700">Pakkumuste aeg (p√§evad):</label>
                                <input type="number" id="offerDays" value="${procedure?.pakkumusteAeg || 0}"
                                    class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm"
                                    required>
                            </div>
                            <div class="space-y-1">
                                <label for="threshold" class="block text-sm font-medium text-gray-700">Piirm√§√§r (‚Ç¨):</label>
                                <input type="number" id="threshold" value="${procedure?.piirm√§√§r || 60000}"
                                    class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm"
                                    required>
                            </div>
                            <div class="space-y-1">
                                <label for="useInternationalThreshold" class="block text-sm font-medium text-gray-700">Kasuta rahvusvahelisi piirm√§√§re:</label>
                                <div class="flex items-center space-x-2">
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="useInternationalThreshold" class="sr-only peer" ${procedure?.useInternational ? 'checked' : ''}>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                                    </label>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label for="procedureVisibility" class="block text-sm font-medium text-gray-700">Menetlusliigi n√§htavus:</label>
                                <div class="flex items-center space-x-2">
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="procedureVisibility" class="sr-only peer" ${procedure?.visible ? 'checked' : ''}>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                                        <span class="ml-2 text-sm text-gray-600">${procedure?.visible ? 'N√§htav' : 'Peidetud'}</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button onclick="deleteProcedureType('${type}')"
                                class="bg-red-500 text-white px-3 py-1.5 rounded-lg hover:bg-red-600 transition-all duration-200 flex items-center space-x-2 text-sm">
                                <i class="fas fa-trash"></i>
                                <span>Kustuta</span>
                            </button>
                            <button onclick="saveProcedureType('${type}')"
                                class="bg-blue-500 text-white px-3 py-1.5 rounded-lg hover:bg-blue-600 transition-all duration-200 flex items-center space-x-2 text-sm">
                                <i class="fas fa-save"></i>
                                <span>Salvesta</span>
                            </button>
                        </div>
                    </div>
                `;

                            // Add event listeners
                            const visibilityToggle = document.getElementById('procedureVisibility');
                            const visibilityLabel = visibilityToggle.nextElementSibling.nextElementSibling;
                            const internationalToggle = document.getElementById('useInternationalThreshold');

                            // Visibility toggle event listener
                            visibilityToggle.addEventListener('change', function () {
                                const isVisible = this.checked;
                                visibilityLabel.textContent = isVisible ? 'N√§htav' : 'Peidetud';

                                if (procedureData[type]) {
                                    procedureData[type].visible = isVisible;
                                }

                                saveSettings().then(() => {
                                    showNotification(`Menetlusliik ${isVisible ? 'n√§htav' : 'peidetud'}!`, 'success');
                                    loadProcedureTypes();

                                    window.dispatchEvent(new CustomEvent('procedureVisibilityChanged', {
                                        detail: { type, visible: isVisible }
                                    }));
                                }).catch(error => {
                                    console.error('Error saving visibility:', error);
                                    showNotification('Viga n√§htavuse salvestamisel!', 'error');
                                });
                            });

                            // International threshold toggle event listener
                            if (internationalToggle) {
                                internationalToggle.addEventListener('change', function () {
                                    toggleInternationalThreshold(type);
                                });
                            }
                        }

                        // Make functions available globally
                        window.toggleInternationalThreshold = function (type) {
                            const useInternational = document.getElementById('useInternationalThreshold').checked;
                            const requestDaysInput = document.getElementById('requestDays');
                            const offerDaysInput = document.getElementById('offerDays');
                            const thresholdInput = document.getElementById('threshold');

                            if (useInternational && internationalProcedureData[type]) {
                                // Use international values
                                requestDaysInput.value = internationalProcedureData[type].taotlusteAeg || 0;
                                offerDaysInput.value = internationalProcedureData[type].pakkumusteAeg || 0;
                                thresholdInput.value = internationalProcedureData[type].piirm√§√§r || 60000;
                            } else {
                                // Use default values
                                requestDaysInput.value = procedureData[type]?.taotlusteAeg || 0;
                                offerDaysInput.value = procedureData[type]?.pakkumusteAeg || 0;
                                thresholdInput.value = procedureData[type]?.piirm√§√§r || 60000;
                            }
                        };

                        window.deleteProcedureType = async function (type) {
                            if (!confirm('Kas oled kindel, et soovid selle menetlusliigi kustutada?')) return;
                            try {
                                delete procedureData[type];
                                await saveSettings();
                                loadProcedureTypes();
                                showNotification('Menetlusliik kustutatud!', 'success');
                            } catch (error) {
                                console.error('Error deleting procedure type:', error);
                                showNotification('Viga menetlusliigi kustutamisel!', 'error');
                            }
                        };

                        window.saveProcedureType = async function (oldType) {
                            try {
                                const newType = document.getElementById('procedureTypeName').value;
                                const requestDays = parseInt(document.getElementById('requestDays').value);
                                const offerDays = parseInt(document.getElementById('offerDays').value);
                                const useInternational = document.getElementById('useInternationalThreshold').checked;
                                const visible = document.getElementById('procedureVisibility').checked;

                                if (!newType || isNaN(requestDays) || isNaN(offerDays)) {
                                    showNotification('Palun t√§ida k√µik v√§ljad!', 'error');
                                    return;
                                }

                                // If changing visibility of an international procedure, update both data structures
                                if (internationalProcedureData[oldType]) {
                                    internationalProcedureData[newType] = {
                                        ...internationalProcedureData[oldType],
                                        visible: visible
                                    };
                                    if (oldType !== newType) {
                                        delete internationalProcedureData[oldType];
                                    }
                                }

                                // Update or create new procedure
                                delete procedureData[oldType];
                                procedureData[newType] = {
                                    taotlusteAeg: requestDays,
                                    pakkumusteAeg: offerDays,
                                    piirm√§√§r: 60000,
                                    useInternational,
                                    visible
                                };

                                await saveSettings();
                                loadProcedureTypes();
                                showNotification(`Menetlusliik ${visible ? 'n√§htav' : 'peidetud'}!`, 'success');
                            } catch (error) {
                                console.error('Error saving procedure type:', error);
                                showNotification('Viga menetlusliigi salvestamisel!', 'error');
                            }
                        };

                        window.saveNewProcedureType = async function () {
                            try {
                                const newType = document.getElementById('procedureTypeName').value;
                                const requestDays = parseInt(document.getElementById('requestDays').value);
                                const offerDays = parseInt(document.getElementById('offerDays').value);
                                const useInternational = document.getElementById('useInternationalThreshold').checked;
                                const visible = document.getElementById('procedureVisibility').checked;

                                if (!newType || isNaN(requestDays) || isNaN(offerDays)) {
                                    showNotification('Palun t√§ida k√µik v√§ljad!', 'error');
                                    return;
                                }

                                procedureData[newType] = {
                                    taotlusteAeg: requestDays,
                                    pakkumusteAeg: offerDays,
                                    piirm√§√§r: 60000,
                                    useInternational,
                                    visible
                                };

                                await saveSettings();
                                loadProcedureTypes();
                                showNotification('Menetlusliik lisatud!', 'success');
                            } catch (error) {
                                console.error('Error saving new procedure type:', error);
                                showNotification('Viga menetlusliigi lisamisel!', 'error');
                            }
                        };

                        // Function to get visible procedure types
                        window.getVisibleProcedureTypes = function () {
                            return Object.entries(procedureData)
                                .filter(([_, data]) => data.visible)
                                .reduce((acc, [key, value]) => {
                                    acc[key] = value;
                                    return acc;
                                }, {});
                        };
                    });

                    async function loadUsers(page = 1, searchTerm = '', roleFilter = '', statusFilter = '', verificationFilter = '') {
                        try {
                            console.log("Fetching users from Firestore...");
                            const usersPerPage = 10;
                            const usersRef = collection(db, "users");
                            let queryRef = usersRef;

                            // Apply filters
                            if (searchTerm) {
                                queryRef = query(queryRef,
                                    where("email", ">=", searchTerm),
                                    where("email", "<=", searchTerm + '\uf8ff')
                                );
                            }
                            if (roleFilter) {
                                queryRef = query(queryRef, where("role", "==", roleFilter));
                            }
                            if (statusFilter) {
                                queryRef = query(queryRef, where("status", "==", statusFilter));
                            }
                            if (verificationFilter) {
                                queryRef = query(queryRef, where("emailVerified", "==", verificationFilter === "verified"));
                            }

                            // Apply pagination
                            queryRef = query(queryRef, limit(usersPerPage));

                            const userDocs = await getDocs(queryRef);

                            const userTable = document.getElementById("userTable");
                            if (!userTable) {
                                console.error("User table not found in DOM");
                                return;
                            }

                            userTable.innerHTML = ""; // Clear table before loading

                            userDocs.forEach(docSnapshot => {
                                const userData = docSnapshot.data();
                                console.log("User Loaded:", userData);

                                const userRow = document.createElement("tr");
                                userRow.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" value="${docSnapshot.id}" class="rounded text-blue-600">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div>
                                    <div class="text-sm font-medium text-gray-900">${userData.email}</div>
                                    <div class="text-sm text-gray-500">${userData.emailVerified ? 'Verifitseeritud' : 'Verifitseerimata'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="relative group">
                                <select onchange="updateUserRole('${docSnapshot.id}', this.value)" 
                                    class="text-sm border rounded-lg px-2 py-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 
                                    ${userData.role === 'admin' ? 'bg-blue-50 border-blue-200' : ''} 
                                    ${userData.role === 'mainAdmin' ? 'bg-purple-50 border-purple-200 font-semibold' : ''}"
                                    ${userData.role === 'mainAdmin' ? 'disabled' : ''}>
                                    ${Object.entries(roles).map(([roleId, role]) => `
                                        <option value="${roleId}" ${userData.role === roleId ? 'selected' : ''}>
                                            ${role.name} ${roleId === 'admin' || roleId === 'mainAdmin' ? 'üëë' : ''}
                                        </option>
                                    `).join('')}
                                </select>
                                ${userData.role === 'admin' || userData.role === 'mainAdmin' ?
                                        `<div class="absolute left-0 top-full mt-2 hidden group-hover:block z-10 bg-black/70 backdrop-blur-md text-white text-xs p-2 rounded-md shadow-lg whitespace-normal max-w-xs">
                                    ${userData.role === 'mainAdmin' ?
                                            'Peaadministraatori rolli ei saa muuta.' :
                                            'Administraatori rolli saab muuta ainult Peaadministraator.'}
                                </div>` : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full
                                ${userData.status === 'active' ? 'bg-green-100 text-green-800' :
                                        userData.status === 'inactive' ? 'bg-red-100 text-red-800' :
                                            'bg-yellow-100 text-yellow-800'}">
                                ${userData.status === 'active' ? 'Aktiivne' :
                                        userData.status === 'inactive' ? 'Mitteaktiivne' : 'Ootsel'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full
                                ${userData.emailVerified ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${userData.emailVerified ? 'Verifitseeritud' : 'Verifitseerimata'}
                            </span>
                            ${!userData.emailVerified ? `
                                <div class="mt-1">
                                    <button onclick="resendVerificationEmail('${userData.uid}')" 
                                            class="text-xs text-blue-600 hover:text-blue-800">
                                        Saada verifitseerimise e-kiri uuesti
                                    </button>
                                </div>
                            ` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center space-x-2 justify-end">
                                <button onclick="toggleUserStatus('${docSnapshot.id}')" 
                                    class="px-2 py-1 rounded-md text-xs ${userData.status === 'active' ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-green-100 text-green-700 hover:bg-green-200'} transition-colors">
                                    <i class="fas ${userData.status === 'active' ? 'fa-ban' : 'fa-check'} mr-1"></i>
                                    ${userData.status === 'active' ? 'Blokeeri' : 'Aktiveeri'}
                                </button>
                                <button onclick="resetUserPassword('${docSnapshot.id}')"
                                    class="px-2 py-1 rounded-md text-xs bg-yellow-100 text-yellow-700 hover:bg-yellow-200 transition-colors">
                                    <i class="fas fa-key mr-1"></i>
                                    Parool
                                </button>
                                <button onclick="deleteUser('${docSnapshot.id}')" 
                                    class="px-2 py-1 rounded-md text-xs bg-red-100 text-red-700 hover:bg-red-200 transition-colors">
                                    <i class="fas fa-trash mr-1"></i>
                                    Kustuta
                                </button>
                            </div>
                        </td>
                    `;
                                userTable.appendChild(userRow);
                            });

                            // Get total count for pagination
                            let totalQueryRef = usersRef;
                            if (searchTerm) {
                                totalQueryRef = query(totalQueryRef,
                                    where("email", ">=", searchTerm),
                                    where("email", "<=", searchTerm + '\uf8ff')
                                );
                            }
                            if (roleFilter) {
                                totalQueryRef = query(totalQueryRef, where("role", "==", roleFilter));
                            }
                            if (statusFilter) {
                                totalQueryRef = query(totalQueryRef, where("status", "==", statusFilter));
                            }
                            if (verificationFilter) {
                                totalQueryRef = query(totalQueryRef, where("emailVerified", "==", verificationFilter === "verified"));
                            }

                            const totalSnapshot = await getDocs(totalQueryRef);
                            const totalUsers = totalSnapshot.size;
                            const totalPages = Math.ceil(totalUsers / usersPerPage);

                            // Update pagination controls if they exist
                            const currentPageElement = document.getElementById('currentPage');
                            const totalPagesElement = document.getElementById('totalPages');
                            const prevPageButtons = document.querySelectorAll('#prevPage');
                            const nextPageButtons = document.querySelectorAll('#nextPage');

                            if (currentPageElement) currentPageElement.textContent = page;
                            if (totalPagesElement) totalPagesElement.textContent = totalPages;

                            // Update button states
                            prevPageButtons.forEach(button => {
                                button.disabled = page === 1;
                                button.classList.toggle('opacity-50', page === 1);
                                button.classList.toggle('cursor-not-allowed', page === 1);
                            });

                            nextPageButtons.forEach(button => {
                                button.disabled = page === totalPages;
                                button.classList.toggle('opacity-50', page === totalPages);
                                button.classList.toggle('cursor-not-allowed', page === totalPages);
                            });

                        } catch (error) {
                            console.error("Error loading users from Firestore:", error);
                            showNotification("Viga kasutajate laadimisel!", "error");
                        }
                    }

                    // Add pagination event listeners
                    document.addEventListener('DOMContentLoaded', () => {
                        // Add event listeners for pagination buttons
                        document.querySelectorAll('#prevPage').forEach(button => {
                            button.addEventListener('click', () => {
                                const currentPage = parseInt(document.getElementById('currentPage').textContent);
                                if (currentPage > 1) {
                                    loadUsers(currentPage - 1);
                                }
                            });
                        });

                        document.querySelectorAll('#nextPage').forEach(button => {
                            button.addEventListener('click', () => {
                                const currentPage = parseInt(document.getElementById('currentPage').textContent);
                                const totalPages = parseInt(document.getElementById('totalPages').textContent);
                                if (currentPage < totalPages) {
                                    loadUsers(currentPage + 1);
                                }
                            });
                        });
                    });

                    window.toggleUserStatus = async (userId) => {
                        try {
                            const userRef = doc(db, "users", userId);
                            const userDoc = await getDoc(userRef);
                            const userData = userDoc.data();

                            // Get current status or default to 'pending' if not set
                            const currentStatus = userData.status || 'pending';
                            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';

                            // Update user status
                            await updateDoc(userRef, {
                                status: newStatus,
                                lastUpdated: new Date()
                            });

                            // Log the status change with valid data
                            await addDoc(collection(db, "auditLog"), {
                                action: "user_status_changed",
                                userId: userId,
                                oldStatus: currentStatus,
                                newStatus: newStatus,
                                performedBy: auth.currentUser.uid,
                                timestamp: new Date()
                            });

                            showNotification(`Kasutaja olek muudetud: ${newStatus}`, 'success');
                            loadUsers(); // Refresh user list
                        } catch (error) {
                            console.error("Error toggling user status:", error);
                            showNotification("Viga kasutaja oleku muutmisel!", "error");
                        }
                    };

                    window.approveUser = async (userId) => {
                        try {
                            const userRef = doc(db, "users", userId);
                            await updateDoc(userRef, {
                                approved: true,
                                status: 'active',
                                lastUpdated: new Date()
                            });

                            // Log the approval
                            await addDoc(collection(db, "auditLog"), {
                                action: "user_approved",
                                userId: userId,
                                performedBy: auth.currentUser.uid,
                                timestamp: new Date()
                            });

                            showNotification("Kasutaja kinnitatud!", "success");
                            loadUsers(); // Refresh user list
                        } catch (error) {
                            console.error("Error approving user:", error);
                            showNotification("Viga kasutaja kinnitamisel!", "error");
                        }
                    };

                    window.deleteUser = async (userId) => {
                        if (!confirm("Kas oled kindel, et soovid selle kasutaja kustutada?")) return;
                        try {
                            const userRef = doc(db, "users", userId);
                            await deleteDoc(userRef);

                            // Log the deletion
                            await addDoc(collection(db, "auditLog"), {
                                action: "user_deleted",
                                userId: userId,
                                performedBy: auth.currentUser.uid,
                                timestamp: new Date()
                            });

                            showNotification("Kasutaja kustutatud!", "success");
                            loadUsers(); // Refresh user list
                        } catch (error) {
                            console.error("Error deleting user:", error);
                            showNotification("Viga kasutaja kustutamisel!", "error");
                        }
                    };

                    // Add the updateUserRole function
                    window.updateUserRole = async (userId, newRole) => {
                        try {
                            // Get current user's role
                            const currentUserRef = doc(db, "users", auth.currentUser.uid);
                            const currentUserDoc = await getDoc(currentUserRef);

                            if (!currentUserDoc.exists()) {
                                showNotification('Kasutaja andmed ei leitud!', 'error');
                                return;
                            }

                            const currentUserData = currentUserDoc.data();

                            // Only main admin can change roles
                            if (currentUserData.role !== 'mainAdmin') {
                                showNotification('Sul ei ole √µigusi rollide muutmiseks!', 'error');
                                return;
                            }

                            // Get target user's data
                            const userRef = doc(db, "users", userId);
                            const userDoc = await getDoc(userRef);

                            if (!userDoc.exists()) {
                                showNotification('Sihtkasutaja andmed ei leitud!', 'error');
                                return;
                            }

                            const userData = userDoc.data();

                            // Prevent changing main admin's role
                            if (userData.role === 'mainAdmin') {
                                showNotification('Peaadmini rolli ei saa muuta!', 'error');
                                return;
                            }

                            // Validate the new role exists
                            if (!roles[newRole]) {
                                showNotification('Vigane roll!', 'error');
                                return;
                            }

                            // Update the role
                            await updateDoc(userRef, {
                                role: newRole,
                                lastUpdated: new Date(),
                                updatedBy: auth.currentUser.uid,
                                updatedByEmail: auth.currentUser.email
                            });

                            // Log the role change
                            await addDoc(collection(db, "auditLog"), {
                                action: "user_role_changed",
                                userId: userId,
                                userEmail: userData.email,
                                oldRole: userData.role,
                                newRole: newRole,
                                changedBy: auth.currentUser.uid,
                                changedByEmail: auth.currentUser.email,
                                timestamp: new Date()
                            });

                            showNotification('Kasutaja roll muudetud!', 'success');
                            loadUsers(); // Refresh user list
                        } catch (error) {
                            console.error("Error updating user role:", error);
                            let errorMessage = 'Viga kasutaja rolli muutmisel!';

                            if (error.code === 'permission-denied') {
                                errorMessage = 'Sul ei ole √µigusi rolli muutmiseks!';
                            } else if (error.code === 'not-found') {
                                errorMessage = 'Kasutaja ei leitud!';
                            }

                            showNotification(errorMessage, 'error');
                        }
                    };

                    // Add User Modal functionality
                    const addUserButton = document.getElementById("addUserButton");
                    const addUserContainer = document.getElementById("addUserContainer");
                    const addUserBackdrop = document.getElementById("addUserBackdrop");
                    const closeAddUser = document.getElementById("closeAddUser");
                    const addUserForm = document.getElementById("addUserForm");
                    const userRoleSelect = document.getElementById("userRole");

                    // Populate role select with available roles
                    Object.entries(roles).forEach(([roleId, role]) => {
                        const option = document.createElement('option');
                        option.value = roleId;
                        option.textContent = role.name;
                        userRoleSelect.appendChild(option);
                    });

                    // Function to open add user modal
                    function openAddUserModal() {
                        addUserContainer.classList.remove("hidden");
                        addUserBackdrop.classList.remove("hidden");
                        document.body.style.overflow = "hidden";
                    }

                    // Function to close add user modal
                    window.closeAddUserModal = function () {
                        addUserContainer.classList.add("hidden");
                        addUserBackdrop.classList.add("hidden");
                        document.body.style.overflow = "";
                        addUserForm.reset();
                    };

                    // Add user button click event
                    addUserButton.addEventListener("click", openAddUserModal);

                    // Close add user modal when clicking the close button
                    closeAddUser.addEventListener("click", closeAddUserModal);

                    // Close add user modal when clicking outside
                    addUserBackdrop.addEventListener("click", (e) => {
                        if (e.target === addUserBackdrop) {
                            closeAddUserModal();
                        }
                    });

                    // Close add user modal when pressing Escape key
                    document.addEventListener("keydown", (e) => {
                        if (e.key === "Escape" && !addUserContainer.classList.contains("hidden")) {
                            closeAddUserModal();
                        }
                    });

                    // Check if a user already exists with a given email
                    async function checkUserExists(email) {
                        try {
                            // Query Firestore for users with the given email
                            const usersRef = collection(db, "users");
                            const q = query(usersRef, where("email", "==", email));
                            const querySnapshot = await getDocs(q);

                            return !querySnapshot.empty;
                        } catch (error) {
                            console.error("Error checking if user exists:", error);
                            return false;
                        }
                    }

                    // Handle add user form submission
                    addUserForm.addEventListener("submit", async function (event) {
                        event.preventDefault();

                        const email = document.getElementById("userEmail").value;
                        const password = document.getElementById("userPassword").value;
                        const role = document.getElementById("userRole").value;
                        const approved = document.getElementById("userApproved").checked;

                        try {
                            // Check if current user is main admin
                            const currentUserRef = doc(db, "users", auth.currentUser.uid);
                            const currentUserDoc = await getDoc(currentUserRef);
                            const currentUserData = currentUserDoc.data();

                            if (currentUserData.role !== 'mainAdmin') {
                                showNotification("Sul ei ole √µigusi kasutajate lisamiseks!", "error");
                                return;
                            }

                            // Validate email format
                            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                            if (!emailRegex.test(email)) {
                                showNotification("Vigane e-posti aadress!", "error");
                                return;
                            }

                            // Check if user already exists
                            const userExists = await checkUserExists(email);
                            if (userExists) {
                                showNotification("See e-posti aadress on juba kasutusel!", "error");
                                return;
                            }

                            // Validate password strength
                            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
                            if (!passwordRegex.test(password)) {
                                showNotification("Parool peab sisaldama v√§hemalt 8 t√§hem√§rki, √ºht suurt t√§hte, √ºht v√§ikest t√§hte, √ºht numbrit ja √ºht erim√§rki!", "error");
                                return;
                            }

                            // Store current admin's authentication info
                            const adminUser = auth.currentUser;
                            const adminUid = adminUser.uid;
                            const adminEmail = adminUser.email;

                            try {
                                // Create user in Firebase Auth using Admin SDK approach
                                showNotification("Kasutaja loomine...", "success");

                                // First create the user document in Firestore
                                const userRef = doc(db, "users", generateUniqueId());
                                await setDoc(userRef, {
                                    email: email,
                                    role: role,
                                    approved: approved,
                                    createdAt: new Date(),
                                    lastLogin: null,
                                    status: approved ? 'active' : 'pending',
                                    uid: userRef.id, // Use the Firestore generated ID
                                    emailVerified: false,
                                    lastUpdated: new Date(),
                                    createdBy: adminUid,
                                    createdByEmail: adminEmail
                                });

                                // Log the user creation in audit log
                                await addDoc(collection(db, "auditLog"), {
                                    action: "user_created",
                                    userId: userRef.id,
                                    email: email,
                                    role: role,
                                    approved: approved,
                                    performedBy: adminUid,
                                    performedByEmail: adminEmail,
                                    timestamp: new Date()
                                });

                                showNotification("Kasutaja lisatud edukalt!", "success");
                                closeAddUserModal();

                                // Refresh the user list without refreshing the page
                                setTimeout(() => {
                                    loadUsers();
                                }, 1000);
                            } catch (innerError) {
                                console.error("Error in user creation process:", innerError);
                                showNotification("Viga kasutaja lisamisel: " + innerError.message, "error");
                            }
                        } catch (error) {
                            console.error("Error adding user:", error);
                            let errorMessage = "Viga kasutaja lisamisel!";

                            if (error.code === "auth/email-already-in-use") {
                                errorMessage = "See e-posti aadress on juba kasutusel!";
                            } else if (error.code === "auth/invalid-email") {
                                errorMessage = "Vigane e-posti aadress!";
                            } else if (error.code === "auth/weak-password") {
                                errorMessage = "Parool on liiga n√µrk!";
                            } else if (error.message === "Pead olema sisse logitud administraatorina!") {
                                errorMessage = error.message;
                            }

                            showNotification(errorMessage, "error");
                        }
                    });

                    // Function to generate a unique ID for Firestore documents
                    function generateUniqueId() {
                        return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
                    }

                    async function resendVerificationEmail(userId) {
                        try {
                            const user = await auth.getUser(userId);
                            await user.sendEmailVerification();
                            alert('Verifitseerimise e-kiri on saadetud! Palun kontrolli oma e-posti kasti.');
                        } catch (error) {
                            console.error('Error sending verification email:', error);
                            alert('Viga verifitseerimise e-kirja saatmisel. Palun proovi hiljem uuesti.');
                        }
                    }

                    // Function to view user details
                    function viewUserDetails(userId) {
                        // Fetch user data from Firestore
                        const userRef = doc(db, "users", userId);
                        getDoc(userRef).then((doc) => {
                            if (doc.exists()) {
                                const userData = doc.data();
                                // Populate modal with user details
                                document.getElementById('userDetailsEmail').textContent = userData.email;
                                document.getElementById('userDetailsRole').textContent = userData.role;
                                document.getElementById('userDetailsStatus').textContent = userData.status;
                                // Show modal
                                document.getElementById('userDetailsModal').classList.remove('hidden');
                            } else {
                                console.error("User not found");
                            }
                        }).catch((error) => {
                            console.error("Error fetching user details:", error);
                        });
                    }

                    // Bulk actions functions
                    async function bulkApproveUsers() {
                        const selectedUsers = getSelectedUsers();
                        if (selectedUsers.length === 0) {
                            showNotification('Palun vali v√§hemalt √ºks kasutaja!', 'error');
                            return;
                        }

                        if (!confirm(`Kas oled kindel, et soovid kinnitada ${selectedUsers.length} kasutajat?`)) return;

                        try {
                            const batch = writeBatch(db);
                            selectedUsers.forEach(userId => {
                                const userRef = doc(db, "users", userId);
                                batch.update(userRef, {
                                    approved: true,
                                    status: 'active',
                                    lastUpdated: new Date()
                                });
                            });

                            await batch.commit();
                            showNotification(`${selectedUsers.length} kasutajat kinnitatud!`, 'success');
                            loadUsers();
                        } catch (error) {
                            console.error('Error bulk approving users:', error);
                            showNotification('Viga kasutajate kinnitamisel!', 'error');
                        }
                    }

                    async function bulkDeleteUsers() {
                        const selectedUsers = getSelectedUsers();
                        if (selectedUsers.length === 0) {
                            showNotification('Palun vali v√§hemalt √ºks kasutaja!', 'error');
                            return;
                        }

                        if (!confirm(`Kas oled kindel, et soovid kustutada ${selectedUsers.length} kasutajat?`)) return;

                        try {
                            const batch = writeBatch(db);
                            selectedUsers.forEach(userId => {
                                const userRef = doc(db, "users", userId);
                                batch.delete(userRef);
                            });

                            await batch.commit();
                            showNotification(`${selectedUsers.length} kasutajat kustutatud!`, 'success');
                            loadUsers();
                        } catch (error) {
                            console.error('Error bulk deleting users:', error);
                            showNotification('Viga kasutajate kustutamisel!', 'error');
                        }
                    }

                    async function bulkExportUsers() {
                        const selectedUsers = getSelectedUsers();
                        if (selectedUsers.length === 0) {
                            showNotification('Palun vali v√§hemalt √ºks kasutaja!', 'error');
                            return;
                        }

                        try {
                            const usersData = await Promise.all(
                                selectedUsers.map(async userId => {
                                    const userDoc = await getDoc(doc(db, "users", userId));
                                    return userDoc.data();
                                })
                            );

                            const csv = convertToCSV(usersData);
                            const blob = new Blob([csv], { type: 'text/csv' });
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `users-export-${new Date().toISOString().split('T')[0]}.csv`;
                            a.click();
                            window.URL.revokeObjectURL(url);

                            showNotification(`${selectedUsers.length} kasutajat eksporditud!`, 'success');
                        } catch (error) {
                            console.error('Error exporting users:', error);
                            showNotification('Viga kasutajate ekspordil!', 'error');
                        }
                    }

                    // Import users functions
                    function openImportModal() {
                        document.getElementById('importUserModal').classList.remove('hidden');
                    }

                    function closeImportModal() {
                        document.getElementById('importUserModal').classList.add('hidden');
                        document.getElementById('importUserForm').reset();
                    }

                    document.getElementById('importUserForm').addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const file = document.getElementById('csvFile').files[0];
                        const defaultRole = document.getElementById('defaultRole').value;

                        try {
                            const text = await file.text();
                            const rows = text.split('\n').map(row => row.split(','));
                            const headers = rows[0];
                            const data = rows.slice(1);

                            const batch = writeBatch(db);
                            let successCount = 0;

                            for (const row of data) {
                                if (row.length < 1) continue;

                                const email = row[0].trim();
                                if (!email) continue;

                                try {
                                    const userCredential = await createUserWithEmailAndPassword(auth, email, generateRandomPassword());
                                    const user = userCredential.user;

                                    batch.set(doc(db, "users", user.uid), {
                                        email: email,
                                        role: defaultRole,
                                        approved: false,
                                        createdAt: new Date(),
                                        lastLogin: null,
                                        status: 'pending',
                                        uid: user.uid,
                                        emailVerified: false,
                                        lastUpdated: new Date()
                                    });

                                    successCount++;
                                } catch (error) {
                                    console.error(`Error creating user ${email}:`, error);
                                }
                            }

                            await batch.commit();
                            showNotification(`${successCount} kasutajat imporditud!`, 'success');
                            closeImportModal();
                            loadUsers();
                        } catch (error) {
                            console.error('Error importing users:', error);
                            showNotification('Viga kasutajate impordil!', 'error');
                        }
                    });

                    // Helper functions
                    function getSelectedUsers() {
                        const checkboxes = document.querySelectorAll('#userTable input[type="checkbox"]:checked');
                        return Array.from(checkboxes).map(checkbox => checkbox.value);
                    }

                    function generateRandomPassword() {
                        return Math.random().toString(36).slice(-8);
                    }



                    // Select all checkbox functionality
                    document.getElementById('selectAll').addEventListener('change', function () {
                        const checkboxes = document.querySelectorAll('#userTable input[type="checkbox"]');
                        checkboxes.forEach(checkbox => checkbox.checked = this.checked);
                    });

                    // Apply filters function
                    async function applyFilters() {
                        const searchTerm = document.getElementById('userSearch').value;
                        const roleFilter = document.getElementById('roleFilter').value;
                        const statusFilter = document.getElementById('statusFilter').value;
                        const verificationFilter = document.getElementById('verificationFilter').value;

                        await loadUsers(1, searchTerm, roleFilter, statusFilter, verificationFilter);
                    }

                    // Dashboard data fetching functions
                    async function fetchUserActivity(startDate, endDate) {
                        try {
                            const usersRef = collection(db, "users");
                            const q = query(
                                usersRef,
                                where("lastLogin", ">=", startDate),
                                where("lastLogin", "<=", endDate)
                            );
                            const snapshot = await getDocs(q);
                            return snapshot.size;
                        } catch (error) {
                            console.error("Error fetching user activity:", error);
                            return 0;
                        }
                    }

                    // Initialize system settings
                    async function initializeSystemSettings() {
                        try {
                            // First check if user is authenticated
                            if (!auth.currentUser) {
                                throw new Error('User not authenticated');
                            }

                            // Get user's role from Firestore
                            const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));

                            if (!userDoc.exists()) {
                                throw new Error('User document not found');
                            }

                            const userData = userDoc.data();
                            const isMainAdmin = userData.role === 'mainAdmin';
                            const isAdmin = userData.role === 'admin';

                            // Only proceed if user is mainAdmin or admin
                            if (!isMainAdmin && !isAdmin) {
                                throw new Error('Insufficient permissions');
                            }

                            const systemRef = doc(db, "system", "maintenance");
                            const systemDoc = await getDoc(systemRef);

                            if (!systemDoc.exists()) {
                                // Only mainAdmin can create initial settings
                                if (!isMainAdmin) {
                                    throw new Error('Only main admin can create system settings');
                                }

                                // Create initial system settings
                                await setDoc(systemRef, {
                                    enabled: false,
                                    message: "S√ºsteem on hooldusel. Palun proovige hiljem uuesti.",
                                    updatedAt: new Date(),
                                    updatedBy: auth.currentUser.uid,
                                    updatedByEmail: auth.currentUser.email
                                });
                            } else {
                                const data = systemDoc.data();
                                document.getElementById('maintenanceMode').checked = data.enabled;
                                document.getElementById('maintenanceMessage').value = data.message || '';
                            }
                        } catch (error) {
                            console.error('Error initializing system settings:', error);
                            if (error.message === 'User not authenticated') {
                                showNotification('Palun logige sisse!', 'error');
                            } else if (error.message === 'User document not found') {
                                showNotification('Kasutaja dokumenti ei leitud!', 'error');
                            } else if (error.message === 'Insufficient permissions') {
                                showNotification('Teil puuduvad √µigused s√ºsteemi seadete juurdep√§√§suks!', 'error');
                            } else {
                                showNotification('Viga s√ºsteemi seadete laadimisel!', 'error');
                            }
                        }
                    }

                    // Add auth state listener
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            console.log('User is signed in:', user.email);
                            // Store admin password if it's the main admin
                            if (user.email === "viljarpartel@gmail.com") {
                                const adminPassword = localStorage.getItem('mainAdminPassword');
                                if (!adminPassword) {
                                    // Prompt for password only if not stored
                                    const password = prompt("Palun sisesta administraatori parool:");
                                    if (password) {
                                        localStorage.setItem('mainAdminPassword', password);
                                    }
                                }
                            }
                        } else {
                            console.log('User is signed out');
                            // Try to sign in with stored credentials if available
                            const mainAdminPassword = localStorage.getItem('mainAdminPassword');
                            if (mainAdminPassword) {
                                signInWithEmailAndPassword(auth, "viljarpartel@gmail.com", mainAdminPassword)
                                    .catch((error) => {
                                        console.error("Auto-login failed:", error);
                                        localStorage.removeItem('mainAdminPassword'); // Clear invalid credentials
                                        showNotification("Palun logi uuesti sisse", "error");
                                    });
                            }
                        }
                    });

                    // Function to check if user is authenticated
                    function isAuthenticated() {
                        return auth.currentUser !== null;
                    }

                    // Modify addUser function to use isAuthenticated
                    async function addUser(email, password, role, approved) {
                        try {
                            if (!isAuthenticated()) {
                                throw new Error("Pead olema sisse logitud administraatorina!");
                            }

                            // Create the new user
                            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                            const user = userCredential.user;

                            // Store current admin user before creating new user
                            const adminUser = auth.currentUser;

                            // Add user data to Firestore with additional fields
                            await setDoc(doc(db, "users", user.uid), {
                                email: email,
                                role: role,
                                approved: approved,
                                createdAt: new Date(),
                                lastLogin: null,
                                status: approved ? 'active' : 'pending',
                                uid: user.uid,
                                emailVerified: false,
                                lastUpdated: new Date(),
                                createdBy: adminUid,
                                createdByEmail: adminUser.email
                            });

                            // Log the user creation in audit log
                            await addDoc(collection(db, "auditLog"), {
                                action: "user_created",
                                userId: user.uid,
                                email: email,
                                role: role,
                                approved: approved,
                                performedBy: adminUser.uid,
                                performedByEmail: adminUser.email,
                                timestamp: new Date()
                            });

                            showNotification("Kasutaja lisatud edukalt!", "success");
                            closeAddUserModal();
                            loadUsers(); // Refresh user list
                        } catch (error) {
                            console.error("Error adding user:", error);
                            let errorMessage = "Viga kasutaja lisamisel!";

                            if (error.code === "auth/email-already-in-use") {
                                errorMessage = "See e-posti aadress on juba kasutusel!";
                            } else if (error.code === "auth/invalid-email") {
                                errorMessage = "Vigane e-posti aadress!";
                            } else if (error.code === "auth/weak-password") {
                                errorMessage = "Parool on liiga n√µrk!";
                            } else if (error.message === "Pead olema sisse logitud administraatorina!") {
                                errorMessage = error.message;
                            }

                            showNotification(errorMessage, "error");
                        }
                    }

                    // Password Reset Modal
                    const resetPasswordModal = document.createElement('div');
                    resetPasswordModal.id = 'resetPasswordModal';
                    resetPasswordModal.className = 'hidden fixed inset-0 z-50 overflow-y-auto';
                    resetPasswordModal.innerHTML = `
            <div class="flex items-center justify-center min-h-screen">
                <div class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm transition-opacity"></div>
                <div class="relative bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
                    <h2 class="text-xl font-bold mb-4">L√§htesta kasutaja parool</h2>
                    <form id="resetPasswordForm" class="space-y-4">
                        <input type="hidden" id="resetUserId">
                        <div>
                            <label for="newPassword" class="block text-sm font-medium text-gray-700">Uus parool</label>
                            <input type="password" id="newPassword" required 
                                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Parool peab sisaldama v√§hemalt 8 t√§hem√§rki, √ºht suurt√§hte, √ºht v√§iket√§hte, √ºht numbrit ja √ºht erim√§rki.</p>
                        </div>
                        <div>
                            <label for="confirmPassword" class="block text-sm font-medium text-gray-700">Kinnita parool</label>
                            <input type="password" id="confirmPassword" required 
                                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div class="flex justify-end space-x-2 mt-6">
                            <button type="button" onclick="closeResetPasswordModal()" 
                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                T√ºhista
                            </button>
                            <button type="submit" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                L√§htesta parool
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
                    document.body.appendChild(resetPasswordModal);

                    // Function to reset a user's password
                    window.resetUserPassword = async (userId) => {
                        try {
                            // Get user data
                            const userRef = doc(db, "users", userId);
                            const userDoc = await getDoc(userRef);

                            if (!userDoc.exists()) {
                                showNotification("Kasutajat ei leitud!", "error");
                                return;
                            }

                            const userData = userDoc.data();

                            // Populate and show the reset password modal
                            document.getElementById('resetUserId').value = userId;
                            document.getElementById('resetPasswordModal').classList.remove('hidden');
                        } catch (error) {
                            console.error("Error preparing password reset:", error);
                            showNotification("Viga parooli l√§htestamise ettevalmistamisel!", "error");
                        }
                    };

                    // Close reset password modal
                    window.closeResetPasswordModal = () => {
                        document.getElementById('resetPasswordModal').classList.add('hidden');
                        document.getElementById('resetPasswordForm').reset();
                    };

                    // Handle password reset form submission
                    document.getElementById('resetPasswordForm').addEventListener('submit', async function (e) {
                        e.preventDefault();

                        const userId = document.getElementById('resetUserId').value;
                        const newPassword = document.getElementById('newPassword').value;
                        const confirmPassword = document.getElementById('confirmPassword').value;

                        // Validate passwords match
                        if (newPassword !== confirmPassword) {
                            showNotification("Paroolid ei √ºhti!", "error");
                            return;
                        }

                        // Validate password strength
                        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
                        if (!passwordRegex.test(newPassword)) {
                            showNotification("Parool peab sisaldama v√§hemalt 8 t√§hem√§rki, √ºht suurt t√§hte, √ºht v√§ikest t√§hte, √ºht numbrit ja √ºht erim√§rki!", "error");
                            return;
                        }

                        try {
                            // Get user data for audit log
                            const userRef = doc(db, "users", userId);
                            const userDoc = await getDoc(userRef);
                            if (!userDoc.exists()) {
                                showNotification("Kasutajat ei leitud!", "error");
                                return;
                            }

                            const userData = userDoc.data();

                            // Update password in Firestore
                            await updateDoc(userRef, {
                                passwordLastReset: new Date(),
                                passwordResetBy: auth.currentUser.uid,
                                passwordResetByEmail: auth.currentUser.email,
                                lastUpdated: new Date()
                            });

                            // Log the password reset
                            await addDoc(collection(db, "auditLog"), {
                                action: "password_reset",
                                userId: userId,
                                userEmail: userData.email,
                                performedBy: auth.currentUser.uid,
                                performedByEmail: auth.currentUser.email,
                                timestamp: new Date()
                            });

                            showNotification("Parool on edukalt l√§htestatud!", "success");
                            closeResetPasswordModal();
                        } catch (error) {
                            console.error("Error resetting password:", error);
                            showNotification("Viga parooli l√§htestamisel!", "error");
                        }
                    });

                    // Clean up any debugging output that might appear on the page
                    document.addEventListener('DOMContentLoaded', function () {
                        // Remove any text nodes that might contain debug output
                        const bodyChildNodes = Array.from(document.body.childNodes);

                        bodyChildNodes.forEach(node => {
                            // Text nodes or elements that look like debug output
                            if (node.nodeType === Node.TEXT_NODE ||
                                (node.nodeType === Node.ELEMENT_NODE &&
                                    node !== document.querySelector('.min-h-full') &&
                                    node !== resetPasswordModal &&
                                    !node.tagName.toLowerCase().includes('script'))) {

                                // Check if it's debug code (text that looks like code)
                                if (node.textContent &&
                                    (node.textContent.includes('const') ||
                                        node.textContent.includes('function') ||
                                        node.textContent.includes('document.') ||
                                        node.textContent.includes('await'))) {

                                    node.textContent = '';
                                    // If it's an element, hide it
                                    if (node.style) {
                                        node.style.display = 'none';
                                    }
                                }
                            }
                        });
                    });

                    // Function to check if user has permission and available usage limit for a specific action
                    async function checkUserLimits(userId, actionType) {
                        try {
                            // Get the user document
                            const userRef = doc(db, "users", userId);
                            const userSnap = await getDoc(userRef);

                            if (!userSnap.exists()) {
                                return { allowed: false, reason: 'Kasutajat ei leitud' };
                            }

                            const userData = userSnap.data();
                            const userRole = userData.role;

                            // Check if role exists
                            if (!roles[userRole]) {
                                return { allowed: false, reason: 'Kasutaja roll on vigane' };
                            }

                            const roleData = roles[userRole];

                            // If user has full access, allow all actions
                            if (roleData.permissions.fullAccess) {
                                return { allowed: true };
                            }

                            // Check permissions based on action type
                            let permissionKey, limitKey, usageKey;

                            switch (actionType) {
                                case 'search':
                                    permissionKey = 'search';
                                    limitKey = 'searchLimit';
                                    usageKey = 'searchCount';
                                    break;
                                case 'saveToFirestore':
                                    permissionKey = 'saveSearches';
                                    limitKey = 'firestoreSaveLimit';
                                    usageKey = 'firestoreSaveCount';
                                    break;
                                case 'generatePdf':
                                    permissionKey = 'generatePdf';
                                    limitKey = 'pdfGenerationLimit';
                                    usageKey = 'pdfGenerationCount';
                                    break;
                                case 'saveToExcel':
                                    permissionKey = 'saveToExcel';
                                    usageKey = 'excelSaveCount';
                                    break;
                                case 'adjustDays':
                                    permissionKey = 'adjustDays';
                                    break;
                                case 'saveSettings':
                                    permissionKey = 'saveSettings';
                                    break;
                                default:
                                    return { allowed: false, reason: 'Tundmatu tegevuse t√º√ºp' };
                            }

                            // Check if user has permission
                            if (!roleData.permissions[permissionKey]) {
                                return { allowed: false, reason: `Sul pole "${getPermissionLabel(permissionKey)}" √µigust` };
                            }

                            // If action has a limit, check if user is within limit
                            if (limitKey && roleData.limits && roleData.limits[limitKey] !== undefined) {
                                const limit = roleData.limits[limitKey];

                                // -1 means unlimited
                                if (limit === -1) {
                                    return { allowed: true };
                                }

                                // Check user's current usage
                                const currentUsage = userData[usageKey] || 0;

                                if (currentUsage >= limit) {
                                    return {
                                        allowed: false,
                                        reason: `Oled j√µudnud ${getActionLabel(actionType)} limiidini (${limit})`
                                    };
                                }

                                // Increment usage counter
                                await updateDoc(userRef, {
                                    [usageKey]: currentUsage + 1,
                                    lastUpdated: new Date()
                                });
                            }

                            return { allowed: true };
                        } catch (error) {
                            console.error('Error checking user limits:', error);
                            return { allowed: false, reason: 'Viga kasutaja limiitide kontrollimisel' };
                        }
                    }

                    // Function to get action labels for user-friendly messages
                    function getActionLabel(actionType) {
                        const labels = {
                            search: 'otsingute',
                            saveToFirestore: 'Firestore salvestamiste',
                            generatePdf: 'PDF genereerimiste',
                            saveToExcel: 'Excelisse salvestamiste',
                            adjustDays: 'p√§evade muutmise',
                            saveSettings: 'seadete salvestamise'
                        };
                        return labels[actionType] || actionType;
                    }

                    // Example usage:
                    // Used before performing an action
                    window.checkActionPermission = async function (actionType) {
                        const user = auth.currentUser;
                        if (!user) {
                            showNotification('Palun logi sisse!', 'error');
                            return false;
                        }

                        const result = await checkUserLimits(user.uid, actionType);

                        if (!result.allowed) {
                            showNotification(result.reason, 'error');
                            return false;
                        }

                        return true;
                    }

                    // Function to get recentSearchLimit for a user
                    window.getRecentSearchLimit = async function () {
                        const user = auth.currentUser;
                        if (!user) return 0;

                        try {
                            const userRef = doc(db, "users", user.uid);
                            const userSnap = await getDoc(userRef);

                            if (!userSnap.exists()) return 0;

                            const userData = userSnap.data();
                            const userRole = userData.role;

                            if (!roles[userRole] || !roles[userRole].limits) return 0;

                            return roles[userRole].limits.recentSearchLimit || 0;
                        } catch (error) {
                            console.error('Error getting recent search limit:', error);
                            return 0;
                        }
                    }
                </script>
</body>

</html>