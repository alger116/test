<!DOCTYPE html>
<html lang="et">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riigihanke Andmed</title>
    <link href="./dist/output.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5.0.0/themes.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pikaday/1.8.0/css/pikaday.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pikaday/1.8.0/pikaday.min.js"></script>
    <script src="timeline-init.js"></script>




    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import {
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
        import {
            getFirestore, doc, getDoc, setDoc, updateDoc, arrayRemove, arrayUnion
        } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

        if (!window.FIREBASE_CONFIG) {
            console.error("⚠ Firebase konfiguratsiooni ei leitud! Kontrolli, kas `config.js` on õigesti laaditud.");
        } else {
            const app = initializeApp(window.FIREBASE_CONFIG);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // Tee Firebase objektid globaalselt kättesaadavaks
            window.auth = auth;
            window.db = db;
        }

        // ✅ Lisa Firestore ja muud funktsioonid globaalseks
        window.auth = auth;
        window.db = db;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.arrayRemove = arrayRemove;
        window.arrayUnion = arrayUnion;

        // Simple implementation of loadUserSearches that will be used until the full implementation is loaded
        function loadUserSearches() {
            console.log("📥 Laen kasutaja otsingud Firestore'ist...");
            // The actual implementation will be called later in the document
            // This is just a placeholder to prevent errors
        }
        window.loadUserSearches = loadUserSearches;

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap");

        body {
            background-image: url('./src/tornid_ja_linnamuur_kaupo_kalda_2016.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }
    </style>
</head>

<body class="backdrop-blur-2xl min-h-screen flex flex-col"
    x-data="{ sidebarOpen: localStorage.getItem('sidebarOpen') === 'true', sidebarHovered: false, }">

    <!-- Sidebar Container -->
    <div id="sidebarContainer" class=" transition-all duration-300"
        @mouseenter="sidebarHovered = true; sidebarOpen = true"
        @mouseleave="sidebarHovered = false; if (!sidebarHovered) sidebarOpen = false">
        <!-- Sidebar content goes here -->
    </div>


    <!-- Modern Navbar with Active Tab Highlighting -->
    <header class="bg-gradient-to-r backdrop-blur-2xl text-black py-4 px-6 w-full bg-fixed top-0 z-50 glass-effect">
        <div class="w-full px-4 flex justify-between items-center">
            <!-- ✅ Left Side with Hamburger and Title -->
            <div class="flex items-center">
                <!-- ✅ Hamburger Menu (Responsive) -->
                <button @mouseenter="sidebarOpen = true" @mouseleave="if (!sidebarHovered) sidebarOpen = false"
                    class="btn btn-primary hover:text-white transition transform hover:scale-105" aria-label="open">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16m-7 6h7" />
                    </svg>
                </button>
                <!-- ✅ Title + Dropdown (Left Side) -->
                <div class="flex items-center space-x-4 ml-4">
                    <h1
                        class="text-xl bg-gradient-to-r bg-black text-transparent bg-clip-text font-bold transform hover:scale-105 protected-section">
                        <a href="index.html" class="hover:underline">Riigihanke andmed</a>
                    </h1>

                    <!-- ✅ Dropdown Button (Aligned Right, Opens Down) -->
                    <div x-data="{ open: false }" @mouseenter="open = true" @mouseleave="open = false"
                        class="dropdown dropdown-hover relative hidden">
                        <button id="dropdownButton"
                            class="btn btn-primary hover:text-white transition transform hover:scale-105"
                            aria-label="open">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16m-7 6h7" />
                            </svg>
                        </button>

                        <!-- ✅ Keskendatud sisselogimise teade -->
                        <div id="loginNotification" role="alert"
                            class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-md hidden">
                            ✅
                        </div>
                        <div id="notification"
                            class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-red-500 text-white px-4 py-2 rounded-lg shadow-md hidden">
                            Andmete salvestamiseks peab olema sisse logitud!
                        </div>

                        <!-- ✅ Dropdown Menu (Now Opens Down) -->
                        <div x-show="open"
                            class="absolute left-0 top-full mt-1 w-56 rounded-md shadow-xl bg-gray/80 backdrop-blur-md z-50"
                            x-transition:enter="transition ease-out duration-200"
                            x-transition:enter-start="opacity-0 transform scale-95"
                            x-transition:enter-end="opacity-100 transform scale-100"
                            x-transition:leave="transition ease-in duration-150"
                            x-transition:leave-start="opacity-100 transform scale-100"
                            x-transition:leave-end="opacity-0 transform scale-95">
                            <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="dropdownButton">
                                <!-- Admin button remains in dropdown -->
                                <button id="adminTab"
                                    class="px-4 py-2 text-sm text-gray-800 hover:bg-blue-200 hover:text-black w-full text-left transition transform hover:scale-105 protected-section hidden"
                                    role=" menuitem">
                                    <i class="fas fa-user-shield mr-2"></i> Admin
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ✅ Center - Moved Buttons -->
            <div class="flex-1 flex text-center items-center space-x-4">
                <!-- Rakendus Button -->
                <button id="showForm"
                    class="hidden px-3 py-1.5 text-lg font-bold text-gray-800 rounded-lg hover:bg-emerald-300 hover:text-black transition transform hover:scale-105 items-center">
                    <i class="fas fa-tools mr-2"></i> Rakendus
                </button>

                <!-- Hanked Button -->
                <button id="showSavedSearches"
                    class="px-3 py-1.5 text-lg font-bold text-black rounded-lg hover:bg-emerald-300 hover:text-black transition transform hover:scale-105 protected-section hidden items-center">
                    <i class="fas fa-folder-open mr-2"></i> Hanked
                </button>

                <!-- Timeline Toggle Button -->
                <button id="toggleTimelineButton"
                    class="hover:bg-emerald-300 text-black text-lg font-bold px-3 py-1.5 rounded-lg flex items-center justify-center hover:shadow-md transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-calendar-alt mr-1.5"></i> Ajakava
                </button>
                <button id="toggleAjakavaButton"
                    class="hidden hover:bg-emerald-300 text-black text-lg font-bold px-3 py-1.5 rounded-lg  items-center justify-center hover:shadow-md transition-all duration-300 transform hover:scale-105">
                    <a href="planeerija.html">
                        <i class="fa-solid fa-tag mr-1.5"></i> Planeerija</a>
                </button>


            </div>

            <!-- ✅ Right Side (Login, Register, Logout, Dark Mode) -->
            <div class="flex items-center space-x-4">
                <!-- Login Button -->
                <div x-data="{ open: false }" class="relative">
                    <!-- ✅ Login Button (Opens Modal) -->
                    <button id="loginButton" @click="open = true"
                        class="bg-blue-500 text-white px-3 py-1 rounded-lg flex items-center justify-center shadow-md hover:bg-blue-600 hover:scale-105 hover:shadow-lg transition-all duration-300">
                        <i class="fas fa-sign-in-alt mr-2"></i> Logi sisse
                    </button>

                    <!-- ✅ Modal -->
                    <div x-show="open" x-cloak x-ref="loginModal"
                        class="fixed inset-50 left-300 flex items-center justify-center backdrop-blur-md bg-black/30">
                        <div class="card w-96 bg-white shadow-xl p-8 rounded-xl border border-gray-200 relative">
                            <!-- ❌ Close Button -->
                            <button @click="open = false"
                                class="absolute top-2 right-2 text-gray-500 hover:text-red-500">
                                ✖
                            </button>

                            <h2 class="text-3xl font-bold text-center text-gray-900 mb-4">Logi sisse</h2>

                            <!-- ✅ Email Input -->
                            <div class="form-control w-full mb-3">
                                <label class="label text-gray-700 font-medium">E-post</label>
                                <input type="email" id="emailLogin" placeholder="Sisesta oma e-post"
                                    class="input input-bordered w-full text-gray-900 shadow-md rounded-lg p-3 focus:ring-2 focus:ring-blue-400 transition-all duration-300" />
                            </div>

                            <!-- ✅ Password Input -->
                            <div class="form-control w-full mb-3">
                                <label class="label text-gray-700 font-medium">Parool</label>
                                <input type="password" id="passwordLogin" placeholder="Sisesta oma parool"
                                    class="input input-bordered w-full text-gray-900 shadow-md rounded-lg p-3 focus:ring-2 focus:ring-blue-400 transition-all duration-300" />
                            </div>
                            <div class="form-control w-full mb-3 flex items-center">
                                <input type="checkbox" id="rememberMe" class="mr-2">
                                <label for="rememberMe" class="text-gray-700 font-medium">Pea meeles mind</label>
                            </div>

                            <!-- ✅ Login Button -->
                            <button @click="login(); open = false"
                                class="btn btn-primary w-full mt-4 flex items-center justify-center transition-transform hover:scale-105 shadow-lg text-lg py-3 rounded-lg font-semibold bg-blue-500 hover:bg-blue-600 text-white">
                                <i class="fas fa-sign-in-alt mr-2"></i> Logi sisse
                            </button>
                        </div>
                    </div>
                </div>

                <!-- User Menu -->
                <div x-data="{ open: false }" class="relative">
                    <button @click="open = !open"
                        class="flex items-center space-x-2 text-gray-700 hover:text-blue-600 transition-colors duration-300">
                        <span id="userEmail" class="font-semibold hidden md:inline">Kasutaja</span>
                        <i class="fas fa-user-circle text-xl"></i>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>

                    <!-- User Dropdown -->
                    <div x-show="open" @click.away="open = false"
                        class="absolute dropdown-menu right-0 mt-2 w-48  bg-opacity-95 rounded-lg z-50"
                        x-transition:enter="transition ease-out duration-200"
                        x-transition:enter-start="opacity-0 transform scale-95"
                        x-transition:enter-end="opacity-100 transform scale-100"
                        x-transition:leave="transition ease-in duration-150"
                        x-transition:leave-start="opacity-100 transform scale-100"
                        x-transition:leave-end="opacity-0 transform scale-95">
                        <button id="changeEmail"
                            class="w-full text-left px-4 py-2 text-sm text-blue-500 hover:bg-blue-400 transition-colors duration-300 transform hover:scale-105 protected-section hidden">
                            <i class="fas fa-envelope mr-2"></i> Muuda e-post
                        </button>
                        <button id="changePassword"
                            class="w-full text-left px-4 py-2 text-sm text-green-500 hover:bg-emerald-200 transition-colors duration-300 transform hover:scale-105 protected-section hidden">
                            <i class="fas fa-key mr-2"></i> Muuda parool
                        </button>
                        <a href="register.html" id="registerButton"
                            class="w-full text-left px-4 py-2 text-sm text-green-500 hover:bg-green-100 transition-colors duration-300 hidden transform hover:scale-105 protected-section">
                            <i class="fas fa-user-plus mr-2"></i> Registreeri
                        </a>
                        <button id="logoutButton"
                            class="block w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-red-400 transition-colors duration-300 transform hover:scale-105 protected-section">
                            <i class="fas fa-sign-out-alt mr-2"></i> Logi välja
                        </button>
                        <button id="settingsButton"
                            class="w-full text-left px-4 py-2 text-sm text-gray-800 hover:bg-amber-200 hover:text-black transition-colors duration-300 transform hover:scale-105 protected-section hidden"
                            role="menuitem">
                            <i class="fas fa-cog mr-2"></i> Seaded
                        </button>

                        <!-- ✅ Dark Mode Toggle -->
                        <div
                            class="hidden items-center justify-between px-4 py-2 text-sm text-gray-800 hover:bg-gray-100 transition-colors duration-300 cursor-pointer">
                            <span>Tume režiim</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggleDarkMode" class="sr-only peer">
                                <div
                                    class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-blue-600 peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 transition-all duration-300">
                                </div>
                                <div
                                    class="w-5 h-5 bg-white rounded-full shadow-md absolute left-0.5 top-0.5 peer-checked:translate-x-full transition-transform duration-300">
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ✅ Firebase Login Script -->
    <script type="module">
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

        window.login = async () => {
            try {
                const email = document.getElementById("emailLogin").value;
                const password = document.getElementById("passwordLogin").value;
                const rememberMe = document.getElementById("rememberMe").checked;
                if (rememberMe) {
                    localStorage.setItem("rememberedEmail", email);
                    localStorage.setItem("rememberedPassword", password);
                } else {
                    localStorage.removeItem("rememberedEmail");
                    localStorage.removeItem("rememberedPassword");
                }
                await signInWithEmailAndPassword(auth, email, password);

                // ✅ Kuvame teate
                const notification = document.getElementById("loginNotification");
                notification.classList.remove("hidden");

                // ✅ Sulgeme teate automaatselt 2 sekundi pärast
                setTimeout(() => {
                    notification.classList.add("hidden");
                }, 2000);

                // ✅ Sulgeme modaalakna Alpine.js kaudu
                setTimeout(() => {
                    const modal = document.querySelector('[x-ref="loginModal"]');
                    if (modal && modal.__x) {
                        modal.__x.$data.open = false;
                    }
                }, 100);
            } catch (error) {
                alert("Sisselogimine ebaõnnestus: " + error.message);
            }
        };
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const savedEmail = localStorage.getItem("rememberedEmail");
            const savedPassword = localStorage.getItem("rememberedPassword");
            if (savedEmail && savedPassword) {
                document.getElementById("emailLogin").value = savedEmail;
                document.getElementById("passwordLogin").value = savedPassword;
                document.getElementById("rememberMe").checked = true;
            }
        });
    </script>

    <footer
        class="bg-opacity-80 from-blue-500 to-indigo-600 text-black py-2 fixed bottom-0 left-0 w-full shadow-md backdrop-blur-md">
        <div class="container justify-between items-center px-6 text-sm hidden">
            <p class="text-sm">&copy; 2025 Riigihanke Andmed. Kõik õigused kaitstud.</p>
            <div class="space-x-2 hidden">
                <a href="#" class="hover:underline">Lingid</a>
                <a href="#" class="hover:underline">Kasutusjuhend</a>
                <a href="#" class="hover:underline">Kontakt</a>
            </div>
        </div>
    </footer>

    <main class="container mx-auto p-6 ">
        <div id="toastContainer" class="fixed bg-green-500 text-white hidden transition-opacity duration-300">
            <span id="toastMessage"></span>
        </div>
        <div id="toolTab" class="flex flex-wrap md:flex-nowrap justify-center gap-0 space-x-0 space-y-0">

            <!-- Timeline Container - Moved inside toolTab and positioned left -->
            <div id="timeline-Container"
                class="bg-white/40 p-5 rounded-xl  max-w-md w-100  hidden min-h-[350px] -mx-[-5px]">
                <div id="timelineContainer" class=" rounded-lg">
                    <h3 class="font-bold text-lg mb-6 text-blue-600 text-center hidden">Riigihanke eelduslik
                        ajakava</h3>

                    <!-- Timeline header - Card style -->
                    <div class="bg-white/60 rounded-lg p-5 hidden">
                        <div class=" grid-cols-1 flex flex-row gap-4">
                            <div class="bg-white/40 p-4 rounded-lg  border-blue-500">
                                <div class="text-gray-500 text-sm uppercase font-semibold mb-1">Hanke nimi</div>
                                <div class="font-bold text-lg text-gray-800"><span id="timeline-procurement-name"
                                        class="text-blue-600"></span></div>
                            </div>
                            <div class="bg-white/40 p-4 rounded-lg  border-green-500">
                                <div class="text-gray-500 text-sm uppercase font-semibold mb-1">Maksumus</div>
                                <div class="font-bold text-lg text-gray-800"><span id="timeline-procurement-cost"
                                        class="text-green-600"></span> €</div>
                            </div>
                            <div class="bg-white/40 p-4 rounded-lg  border-purple-500">
                                <div class="text-gray-500 text-sm uppercase font-semibold mb-1">Lepingu
                                    allkirjastamine
                                </div>
                                <div class="font-bold text-lg text-gray-800"><span id="timeline-contract-date"
                                        class="text-purple-600"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Days countdown from today - More prominent -->
                    <div class="bg-gradient-to-r  text-black  rounded-lg flex items-center">
                        <div class="rounded-full mr-4">

                            <!-- Remove the existing icon and replace it with the hoverable button -->
                            <button id="hoverableButton" class="btn text-black transition transform hover:scale-101">
                                Vajuta siia!
                            </button>
                        </div>
                        <div>
                            <div class="text-sm uppercase tracking-wider font-medium text-white"></div>
                            <div class="text-lg font-bold">Alustamiseni on jäänud <span id="day-to-start"
                                    class="text-2x px-2 py-1 rounded-md ml-1">-100</span>
                                päeva</div>
                        </div>
                    </div>

                    <!-- Timeline visualization - Modern vertical timeline -->
                    <div class="timeline-container bg-whit/40 rounded-lg">
                        <ul class="timeline-cards" id="timeline-steps">
                            <!-- Timeline steps will be dynamically generated -->
                        </ul>
                    </div>

                    <!-- Export buttons - Improved -->
                    <div class="mt-1 flex flex-wrap gap-4 justify-center">
                        <button id="exportExcel"
                            class="hidden bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-lg shadow-md transition transform hover:scale-105 hover:shadow-lg items-center"
                            onclick="alert('Excel export functionality would go here'); console.log('Export to Excel clicked');">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Salvesta Excelisse
                        </button>
                        <button id="exportPDF"
                            class="bg-gradient-to-r bg-red-500 text-white px-6 py-3 rounded-lg shadow-md transition transform hover:scale-105 hover:shadow-lg flex items-center"
                            onclick="exportTimelineToPDF()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                            </svg>
                            Salvesta PDF-ina
                        </button>

                    </div>
                </div>
            </div>

            <!-- Form Container - Middle -->
            <div id="formContainer"
                class="bg-white/40 p-5 rounded-xl shadow-lg max-w-md w-90  min-h-[350px] -mx-[-5px]">
                <h2 class="text-2xl font-bold text-center mb-5 text-gray-800">Riigihanke andmed</h2>
                <form id="procurementForm" class="space-y-4">
                    <div>
                        <label for="name" class="block text-gray-700 font-semibold mb-1 ">Riigihanke
                            nimi</label>
                        <input type="text" placeholder="Siseta riighanke nimetus" id="name" name="name"
                            class="w-full text-md text-center p-3  rounded-lg focus:ring-2 hover:bg-white/30 focus:ring-white/30 outline-none scale:100 hover:scale-101 hover:shadow-lg transition-all duration-300"
                            required autocomplete="off">
                    </div>
                    <div>
                        <label for="cost" class="block text-gray-700 font-semibold mb-1 ">Eeldatav
                            maksumus</label>
                        <input type="number" placeholder="Sisesta riigihanke eeldatav maksumus" id="cost" name="cost"
                            class="w-full text-sm text-center  p-3 rounded-lg focus:ring-2 hover:bg-white/30 focus:ring-white/30 outline-none scale:100 hover:scale-101 hover:shadow-lg transition-all duration-300"
                            required>
                    </div>
                    <div>
                        <label for="procedureType" class=" text-gray-700 font-semibold mb-1 flex space-x-2">
                            <span>Riigihanke menetlusliik</span>
                            <span id="procedureLabel"
                                class="text-blue-600 text-sm opacity-0.5 transition-opacity duration-300 scale-100 hover:scale-101"></span>
                        </label>

                        <select id="procedureType" name="procedureType"
                            class="w-full p-2 rounded-lg text-gray-700 text-center text-sm hover:bg-white/30 focus:ring-white/30 transition-all duration-300"
                            required aria-label="Riigihanke menetlusliik">

                            <!-- Placeholder option (disabled & selected by default) -->
                            <optgroup label="">
                                <option value="" disabled selected>Vali menetlusliik</option>
                            </optgroup>
                            <optgroup label="Avatud hankemenetlus">
                                <option value="Avatud hankemenetlus asjade hankelepingu sõlmimiseks">Asjade
                                    hankeleping
                                </option>
                                <option value="Avatud hankemenetlus teenuste hankelepingu sõlmimiseks">Teenuste
                                    hankeleping</option>
                                <option value="Avatud hankemenetlus ehitustööde hankelepingu sõlmimiseks">
                                    Ehitustööde
                                    hankeleping</option>
                            </optgroup>

                            <optgroup label="Piiratud hankemenetlus">
                                <option value="Piiratud hankemenetlus asjade hankelepingu sõlmimiseks">Asjade
                                    hankeleping</option>
                                <option value="Piiratud hankemenetlus teenuste hankelepingu sõlmimiseks">Teenuste
                                    hankeleping</option>
                                <option value="Piiratud hankemenetlus ehitustööde hankelepingu sõlmimiseks">
                                    Ehitustööde
                                    hankeleping</option>
                            </optgroup>

                            <optgroup label="Konkurentsipõhine läbirääkimistega menetlus">
                                <option
                                    value="Konkurentsipõhine läbirääkimistega hankemenetlus asjade hankelepingu sõlmimiseks">
                                    Asjade hankeleping
                                </option>
                                <option
                                    value="Konkurentsipõhine läbirääkimistega hankemenetlus teenuste hankelepingu sõlmimiseks">
                                    Teenuste
                                    hankeleping</option>
                                <option
                                    value="Konkurentsipõhine läbirääkimistega hankemenetlus ehitustööde hankelepingu sõlmimiseks">
                                    Ehitustööde
                                    hankeleping</option>
                            </optgroup>

                            <optgroup label="Võistlev dialoog">
                                <option value="Võistlev dialoog asjade hankelepingu sõlmimiseks">Asjade hankeleping
                                </option>
                                <option value="Võistlev dialoog teenuste hankelepingu sõlmimiseks">Teenuste
                                    hankeleping
                                </option>
                                <option value="Võistlev dialoog ehitustööde hankelepingu sõlmimiseks">Ehitustööde
                                    hankeleping</option>
                            </optgroup>

                            <optgroup label="Innovatsioonipartnerlus">
                                <option value="Innovatsioonipartnerlus asjade hankelepingu sõlmimiseks">Asjade
                                    hankeleping</option>
                                <option value="Innovatsioonipartnerlus teenuste hankelepingu sõlmimiseks">Teenuste
                                    hankeleping</option>
                                <option value="Innovatsioonipartnerlus ehitustööde hankelepingu sõlmimiseks">
                                    Ehitustööde
                                    hankeleping</option>
                            </optgroup>

                            <optgroup label="Kontsessioonimenetlus">
                                <option value="Kontsessioonimenetlus koos eraldi taotluse esitamisega">Koos eraldi
                                    taotlusega</option>
                                <option value="Kontsessioonimenetlus ilma eraldi taotlust esitamata">Ilma eraldi
                                    taotluseta</option>
                            </optgroup>

                            <optgroup label="Erimenetlused">
                                <option value="Sotsiaalteenuste erimenetlus">Sotsiaalteenuste erimenetlus</option>
                                <option value="Eriteenuste erimenetlus">Eriteenuste erimenetlus</option>
                            </optgroup>
                        </select>

                    </div>
                    <div>
                        <label for="contractSigningDate" class="block text-gray-700 font-semibold mb-1">
                            Lepingu eeldatav allkirjastamine
                        </label>
                        <input type="text" id="contractSigningDate" name="contractSigningDate"
                            class="w-full p-3  border-black rounded-lg text-center text-black cursor-pointer focus:ring-2 hover:bg-white/30 focus:ring-white/30 outline-none scale:100 hover:scale-101 hover:shadow-lg transition-all duration-300"
                            placeholder="Vali kuupäev" readonly>

                    </div>
                    <script>
                        document.addEventListener("DOMContentLoaded", function () {
                            var picker = new Pikaday({
                                field: document.getElementById('contractSigningDate'),
                                format: 'DD.MM.YYYY',
                                i18n: {
                                    previousMonth: 'Eelmine kuu',
                                    nextMonth: 'Järgmine kuu',
                                    months: ['Jaanuar', 'Veebruar', 'Märts', 'Aprill', 'Mai', 'Juuni', 'Juuli', 'August', 'September', 'Oktoober', 'November', 'Detsember'],
                                    weekdays: ['Pühapäev', 'Esmaspäev', 'Teisipäev', 'Kolmapäev', 'Neljapäev', 'Reede', 'Laupäev'],
                                    weekdaysShort: ['P', 'E', 'T', 'K', 'N', 'R', 'L']
                                },
                                onSelect: function (date) {
                                    const formattedDisplayDate = picker.toString();
                                    const formattedISODate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                                    document.getElementById('contractSigningDate').value = formattedISODate;
                                    document.getElementById('contractSigningDate').setAttribute('data-display', formattedDisplayDate);
                                }
                            });
                        });
                    </script>
                    <div class="flex justify-center space-x-4 mt-4">
                        <button id="calculateTime"
                            class="bg-sky-500/75 text-white mr-1 py-3 w-40 rounded-md items-center justify-center shadow-md hover:bg-sky-700 hover:scale-102 hover:shadow-lg transition-all duration-300">
                            <i class="fas fa-calculator"></i> Arvuta aeg
                        </button>
                        <div x-data="{ added: false }" class="relative">
                            <!-- ✅ Lisa hange tabelisse nupp (hidden vaikimisi) -->
                            <button id="updateProcurement" @click="added = true; setTimeout(() => added = false, 2000)"
                                class="bg-emerald-500 text-white  py-3 w-40 rounded-lg  items-center justify-center shadow-md hover:bg-emerald-700 hover:scale-105 hover:shadow-lg transition-all duration-300 hidden">
                                ✅ Lisa tabelisse
                            </button>

                            <!-- ✅ Väike checkmark teade -->
                            <div x-show="added" x-transition.opacity class="absolute mt-2 left-1/2 transform -translate-x-1/2 bg-green-500/90 text-white px-3 py-1 rounded-full shadow-lg flex items-center gap-2 text-sm font-semibold
    animate-bounce transition-all duration-300">
                                <i class="fas fa-check-circle text-white"></i> Lisatud!
                            </div>
                        </div>
                    </div>
                </form>
                <div class="hidden space-x-3 mt-6">
                    <button id="clearFields"
                        class="clear-button bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-lg flex-1 flex items-center justify-center shadow-md hover:from-red-600 hover:to-red-700 hover:scale-105 hover:shadow-lg transition-all duration-300"
                        aria-label="Clear Fields">
                        <i class="fas fa-broom mr-2"></i> Puhasta
                    </button>
                    <button id="saveFields"
                        class="save-button bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-lg flex-1 flex items-center justify-center shadow-md hover:from-green-600 hover:to-green-700 hover:scale-105 hover:shadow-lg transition-all duration-300"
                        aria-label="Save Fields">
                        <i class="fas fa-save mr-2"></i> Salvesta
                    </button>
                    <button id="refreshFields"
                        class="refresh-button bg-gradient-to-r from-yellow-500 to-yellow-600 text-black px-6 py-3 rounded-lg flex-1 flex items-center justify-center shadow-md hover:from-yellow-600 hover:to-yellow-700 hover:scale-105 hover:shadow-lg transition-all duration-300"
                        aria-label="Refresh Fields">
                        <i class="fas fa-sync-alt mr-2"></i> Uuenda
                    </button>
                </div>
            </div>

            <!-- Result Container - Right -->
            <div class="container bg-white/40 p-6 rounded-xl shadow-lg max-w-lg w-95 hidden -mx-[-2px]"
                id="resultContainer">
                <div id="result" class="result-card"></div>


            </div>
        </div>

        <!-- The saved searches container is hidden by default and will be shown when the user clicks the "Show Saved Searches" button -->
        <div class="container bg-white/20 p-5 rounded-lg max-w-full mx-auto hidden" id="savedSearchesContainer">
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">Salvestatud Hanked</h2>
            <div class="overflow-x-auto p-4 rounded-lg ">
                <table class="w-full border-collapse rounded-lg overflow-hidden">
                    <thead>
                        <tr class="bg-gradient-to-r from-blue-300/40 to-blue-500/40 text-black text-left">
                            <th class="p-4">📌 Nimi</th>
                            <th class="p-4">📜 Menetlusliik</th>
                            <th class="p-4">💰 Maksumus (€)</th>
                            <th class="p-4">📅 Taotluse Kuupäev</th>
                            <th class="p-4">🖊️ Allkirjastamise Kuupäev</th>
                            <th class="p-4 text-center hidden">✏️ Muuda</th>
                            <th class="p-4 text-center">❌ Kustuta</th>
                        </tr>
                    </thead>
                    <tbody id="savedSearchesTableBody">
                        <!-- 🔥 Firestore data will be inserted here -->
                    </tbody>
                </table>

                <div class="flex gap-4 mt-8 justify-center">
                    <button id="saveToExcel"
                        class="flex items-center gap-2 bg-gradient-to-r from-green-500 to-green-600 text-white px-5 py-2 rounded-lg shadow-md hover:from-green-600 hover:to-green-700 hover:scale-105 transition-all duration-300"
                        aria-label="Save to Excel">
                        📊 Excel
                    </button>
                    <button id="saveToFirestore"
                        class="flex items-center gap-2 bg-gradient-to-r from-green-500 to-green-600 text-white px-5 py-2 rounded-lg shadow-md hover:from-green-600 hover:to-green-700 hover:scale-105 transition-all duration-300">
                        💾 Salvesta
                    </button>
                    <button id="loadFromFirestore"
                        class="flex items-center gap-2 bg-gradient-to-r from-green-500 to-green-600 text-white px-5 py-2 rounded-lg shadow-md  hover:from-green-600 hover:to-green-700  hover:scale-105 transition-all duration-300"
                        aria-label="Load from Firestore">
                        📥 Lae
                    </button>
                </div>
            </div>

            <div class="mt-4 flex justify-between">
                <span class="text-sm text-gray-500"></span>
                <div class="btn-group">
                    <button class="btn btn-sm btn-ghost">«</button>
                    <button class="btn btn-sm btn-active">1</button>
                    <button class="btn btn-sm btn-ghost">2</button>
                    <button class="btn btn-sm btn-ghost">3</button>
                    <button class="btn btn-sm btn-ghost">»</button>
                </div>
            </div>

            <!-- Chart Container (Initially Hidden) -->
            <div id="chartContainer" class="hidden mt-4 w-full max-w-lg mx-auto">
                <canvas id="procurementChart" class="w-full"></canvas>
            </div>
        </div>



        <!-- Settings Container -->
        <div class="flex-wrap md:flex-nowrap gap-6 bg-white p-6 rounded-lg shadow-lg max-w-4xl hidden adminOnly"
            id="settingsContainer" aria-hidden="true">

            <!-- Form Section -->
            <form id="settingsForm" class="flex-1 space-y-6 bg-gray-50 p-4 rounded-lg shadow-md">
                <h3 class="text-lg font-bold text-gray-800">📑 Menetlusliigi sätted</h3>

                <div class="relative">
                    <label for="documentPreparationDays" class="block text-gray-700 mb-1">📄 Riigihanke
                        alusdokumentide
                        koostamine (päevad):</label>
                    <input type="number" id="documentPreparationDays" name="documentPreparationDays"
                        class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Sisesta päevad" required>
                </div>

                <div class="relative">
                    <label for="offerEvaluationDays" class="block text-gray-700 mb-1">🧐 Pakkumuste hindamine
                        (päevad):</label>
                    <input type="number" id="offerEvaluationDays" name="offerEvaluationDays"
                        class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Sisesta päevad" required>
                </div>

                <div class="relative">
                    <label for="decisionDays" class="block text-gray-700 mb-1">✅ Vastavaks ja edukaks tunnistamise
                        otsus
                        (päevad):</label>
                    <input type="number" id="decisionDays" name="decisionDays"
                        class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Sisesta päevad" required>
                </div>

                <div class="relative">
                    <label for="bidderEvaluationDays" class="block text-gray-700 mb-1">📊 Pakkujate hindamine
                        (päevad):</label>
                    <input type="number" id="bidderEvaluationDays" name="bidderEvaluationDays"
                        class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Sisesta päevad" required>
                </div>

                <div class="relative">
                    <label for="successfulBidderDays" class="block text-gray-700 mb-1">🏆 Eduka kõrvaldamata jätmine
                        ja
                        kval (päevad):</label>
                    <input type="number" id="successfulBidderDays" name="successfulBidderDays"
                        class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Sisesta päevad" required>
                </div>

                <div class="relative">
                    <label for="waitingPeriodDays" class="block text-gray-700 mb-1">⏳ Ooteaeg (päevad):</label>
                    <input type="number" id="waitingPeriodDays" name="waitingPeriodDays"
                        class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Sisesta päevad" required>
                </div>
            </form>

            <!-- Procedure Type Selection -->
            <div class="flex-1 bg-gray-50 p-4 rounded-lg shadow-md">
                <h3 class="text-lg font-bold text-gray-800 mb-3">🛠️ Menetlusliigid</h3>
                <select id="procedureTypeSelect"
                    class="w-full p-3 border rounded-lg bg-white/40 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <!-- Options will be populated dynamically -->
                </select>
                <div id="procedureTypeSettings" class="mt-4 space-y-4">
                    <!-- Procedure type settings will be displayed here -->
                </div>
                <button id="addProcedureTypeButton"
                    class="w-full flex items-center justify-center gap-2 mt-4 bg-gradient-to-r from-green-500 to-green-600 text-white p-3 rounded-lg shadow-md hover:from-green-600 hover:to-green-700 hover:scale-105 transition-all duration-300">
                    ➕ Lisa Menetlusliik
                </button>
            </div>
        </div>
        <div class="container bg-white p-6 rounded-lg shadow-lg hidden" id="historyContainer">
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">📜 Arvutuste Ajalugu</h2>

            <!-- Filter Dropdown -->
            <div class="mb-4 bg-gray-100 p-4 rounded-lg shadow-md">
                <label for="filterByDate" class="block text-gray-700 font-semibold mb-2">🔎 Filtreeri kuupäeva
                    järgi:</label>
                <select id="filterByDate"
                    class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="all">📅 Kõik kuupäevad</option>
                    <!-- Options will be dynamically added here -->
                </select>
            </div>

            <div class="overflow-x-auto bg-gray-100 p-4 rounded-lg shadow-md">
                <table class="w-full border-collapse shadow-lg rounded-lg overflow-hidden">
                    <thead>
                        <tr class="bg-gradient-to-r from-blue-500 to-blue-600 text-white text-left">
                            <th class="p-4">📌 Nimi</th>
                            <th class="p-4">📜 Menetlusliik</th>
                            <th class="p-4">💰 Maksumus (€)</th>
                            <th class="p-4">⏳ Menetlusaeg (päevad)</th>
                            <th class="p-4">📅 Taotluse Kuupäev</th>
                            <th class="p-4">🖊️ Allkirjastamise Kuupäev</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- History entries will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modern Table -->
        <table id="recentCalculationsTable"
            class="w-full border-collapse shadow-lg rounded-lg overflow-hidden mt-4 hidden">
            <thead class="bg-blue-500 text-white">
                <tr>
                    <th class="p-3">Nimi</th>
                    <th class="p-3">Menetlusliik</th>
                    <th class="p-3">Maksumus</th>
                    <th class="p-3">Menetlusaeg</th>
                    <th class="p-3">Taotluse Kuupäev</th>
                </tr>
            </thead>
            <tbody id="recentCalculations">
                <!-- Last 3 calculations will be dynamically inserted here -->
            </tbody>
        </table>
        <!-- Notification System -->


        <!-- ✅ Kinnituse modal kustutamiseks -->
        <div id="deleteConfirmModal" class="fixed inset-0 hidden z-50">
            <div class="absolute inset-0 bg-black/30 backdrop-blur-md"></div>
            <div
                class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-lg w-96 text-center">
                <h2 class="text-xl font-bold mb-4">Kustutamine</h2>
                <p class="text-gray-600 mb-6">Oled kindel, et kustutame?</p>
                <div class="flex justify-center space-x-4">
                    <button id="confirmDelete"
                        class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">Jah</button>
                    <button id="cancelDelete"
                        class="bg-gray-300 px-4 py-2 rounded-lg hover:bg-gray-400 transition">Ei</button>
                </div>
            </div>
        </div>
        <div id="successAlert" role="alert"
            class="alert fixed top-16 left-1/2 transform -translate-x-1/2 z-50 transition scale-95 opacity-0 hidden">

            <span id="alertMessage">Andmed salvestatud!</span>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
        <script>

            // kuupäevade handl
            function formatDate(date) {
                if (!date || date === "Määramata") {
                    console.error("❌ Received empty or invalid date:", date);
                    return "Määramata"; // Kasutajasõbralikum väljund
                }

                // 🔹 Kui `date` on string formaadis "dd.mm.yyyy", tagasta see muutmata kujul
                if (typeof date === "string" && date.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
                    return date;
                }

                // 🔹 Kui `date` on string formaadis "YYYY-MM-DD", teisenda see "dd.mm.yyyy"
                if (typeof date === "string" && date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [year, month, day] = date.split("-");
                    return `${day}.${month}.${year}`;
                }

                // 🔹 Kui `date` on Firestore timestamp (Firestore salvestab kuupäevad `toDate()` meetodiga)
                if (typeof date === "object" && date.toDate) {
                    date = date.toDate();
                }

                // 🔹 Kui `date` on juba `Date` objekt, teisenda see stringiks
                if (date instanceof Date && !isNaN(date.getTime())) {
                    return `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
                }

                // 🔹 Lõplik kontroll, kas `date` on konverteeritav
                const parsedDate = new Date(date);
                if (isNaN(parsedDate.getTime())) {
                    console.error("❌ Invalid date after parsing:", date);
                    return "Määramata"; // Väldib vigaseid kuupäevi
                }

                return `${String(parsedDate.getDate()).padStart(2, '0')}.${String(parsedDate.getMonth() + 1).padStart(2, '0')}.${parsedDate.getFullYear()}`;
            }

            const procedureData = {
                "Lihthankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 10, piirmäär: 30000 },
                "Lihthankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 10, piirmäär: 30000 },
                "Lihthankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 15, piirmäär: 60000 },
                "Avatud hankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 15, piirmäär: 60000 },
                "Avatud hankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 15, piirmäär: 60000 },
                "Avatud hankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 25, piirmäär: 150000 },
                "Piiratud hankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
                "Piiratud hankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
                "Piiratud hankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 25, piirmäär: 150000 },
                "Konkurentsipõhine läbirääkimistega hankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
                "Konkurentsipõhine läbirääkimistega hankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
                "Konkurentsipõhine läbirääkimistega hankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 25, piirmäär: 150000 },
                "Innovatsioonipartnerlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
                "Innovatsioonipartnerlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
                "Võistlev dialoog asjade hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
                "Võistlev dialoog teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
                "Võistlev dialoog ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 25, piirmäär: 150000 },
                "Innovatsioonipartnerlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 25, piirmäär: 150000 },
                "Kontsessioonimenetlus koos eraldi taotluse esitamisega": { taotlusteAeg: 30, pakkumusteAeg: 17, piirmäär: 300000 },
                "Kontsessioonimenetlus ilma eraldi taotlust esitamata": { taotlusteAeg: 0, pakkumusteAeg: 30, piirmäär: 300000 },
                "Sotsiaalteenuste erimenetlus": { taotlusteAeg: 0, pakkumusteAeg: 10, piirmäär: 300000 },
                "Eriteenuste erimenetlus": { taotlusteAeg: 0, pakkumusteAeg: 10, piirmäär: 60000 },
            };

            const internationalProcedureData = {
                "Avatud hankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 30, piirmäär: 143000 },
                "Avatud hankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 30, piirmäär: 143000 },
                "Avatud hankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 45, piirmäär: 5538000 },
                "Piiratud hankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
                "Piiratud hankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
                "Piiratud hankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 5538000 },
                "Konkurentsipõhine läbirääkimistega hankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
                "Konkurentsipõhine läbirääkimistega hankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
                "Konkurentsipõhine läbirääkimistega hankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 5538000 },
                "Innovatsioonipartnerlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
                "Innovatsioonipartnerlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
                "Innovatsioonipartnerlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 5538000 },
                "Võistlev dialoog asjade hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
                "Võistlev dialoog teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
                "Võistlev dialoog ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 5538000 },
                "Kontsessioonimenetlus koos eraldi taotluse esitamisega": { taotlusteAeg: 30, pakkumusteAeg: 17, piirmäär: 5538000 },
                "Kontsessioonimenetlus ilma eraldi taotlust esitamata": { taotlusteAeg: 0, pakkumusteAeg: 30, piirmäär: 5538000 },
                "Sotsiaalteenuste erimenetlus": { taotlusteAeg: 0, pakkumusteAeg: 10, piirmäär: 750000 },
                "Eriteenuste erimenetlus": { taotlusteAeg: 0, pakkumusteAeg: 10, piirmäär: 750000 }
            };

            const defaultSettings = {
                documentPreparationDays: 10,
                offerEvaluationDays: 5,
                decisionDays: 3,
                bidderEvaluationDays: 3,
                successfulBidderDays: 3,
                waitingPeriodDays: 14
            };

            let settings = { ...defaultSettings };

            const correctPassword = '123';
            let passwordValidUntil = null;

            function showPasswordPrompt(callback) {
                const now = new Date();
                if (passwordValidUntil && now < passwordValidUntil) {
                    callback();
                    return;
                }

                const passwordPrompt = document.getElementById('passwordPrompt');
                const passwordInput = document.getElementById('passwordInput');
                const passwordError = document.getElementById('passwordError');
                passwordPrompt.classList.remove('hidden');
                passwordInput.value = '';
                passwordError.classList.add('hidden');

                document.getElementById('passwordSubmit').onclick = function () {
                    if (passwordInput.value === correctPassword) {
                        passwordPrompt.classList.add('hidden');
                        passwordValidUntil = new Date(now.getTime() + 10 * 60000); // 10 minutes from now
                        callback();
                    } else {
                        passwordError.classList.remove('hidden');
                    }
                };

                document.getElementById('passwordClose').onclick = function () {
                    passwordPrompt.classList.add('hidden');
                };
            }

            document.getElementById("calculateTime").addEventListener("click", function () {
                // ✅ Kontrollime, kas kõik väljad on täidetud
                const name = document.getElementById("name").value.trim();
                const cost = document.getElementById("cost").value.trim();
                const procedureType = document.getElementById("procedureType").value.trim();
                const contractSigningDate = document.getElementById("contractSigningDate").value.trim();

                if (!name || !cost || !procedureType || !contractSigningDate) {
                    // Show custom toast notification
                    const toast = document.createElement("div");
                    toast.className = "fixed top-5 left-1/2 transform -translate-x-1/2 bg-red-500 text-white text-lg px-6 py-3 rounded-lg shadow-md transition-opacity opacity-0";
                    toast.innerText = "⚠️ Palun täida kõik väljad enne arvutamist!";

                    document.body.appendChild(toast);

                    // Animate toast
                    setTimeout(() => toast.classList.add("opacity-100"), 50);
                    setTimeout(() => {
                        toast.classList.remove("opacity-100");
                        setTimeout(() => toast.remove(), 500);
                    }, 3000);

                    return;
                }

                // ✅ Kuvame "Lisa hange tabelisse" nupu
                document.getElementById("updateProcurement").classList.remove("hidden");
            });

            document.getElementById('settingsButton').addEventListener('click', function () {
                closeAllTabs();
                document.getElementById('settingsContainer').classList.remove('hidden');
                loadSettings();
                loadProcedureTypes();
                setActiveTab(this);
            });

            document.getElementById("adminTab").addEventListener("click", () => {
                window.location.href = "/admin.html"; // Redirect to the admin page
            });

            document.getElementById('settingsForm').addEventListener('submit', function (event) {
                event.preventDefault();
                settings.documentPreparationDays = parseInt(document.getElementById('documentPreparationDays').value);
                settings.offerEvaluationDays = parseInt(document.getElementById('offerEvaluationDays').value);
                settings.decisionDays = parseInt(document.getElementById('decisionDays').value);
                settings.bidderEvaluationDays = parseInt(document.getElementById('bidderEvaluationDays').value);
                settings.successfulBidderDays = parseInt(document.getElementById('successfulBidderDays').value);
                settings.waitingPeriodDays = parseInt(document.getElementById('waitingPeriodDays').value);
            });

            document.getElementById('addProcedureTypeButton').addEventListener('click', function () {
                addProcedureType();
            });

            document.getElementById('procedureTypeSelect').addEventListener('change', function () {
                const selectedType = this.value;
                loadProcedureTypeSettings(selectedType);
            });

            function loadSettings() {
                document.getElementById('documentPreparationDays').value = settings.documentPreparationDays;
                document.getElementById('offerEvaluationDays').value = settings.offerEvaluationDays;
                document.getElementById('decisionDays').value = settings.decisionDays;
                document.getElementById('bidderEvaluationDays').value = settings.bidderEvaluationDays;
                document.getElementById('successfulBidderDays').value = settings.successfulBidderDays;
                document.getElementById('waitingPeriodDays').value = settings.waitingPeriodDays;
            }

            function saveSettings() {
                localStorage.setItem('procurementSettings', JSON.stringify(settings));
            }

            function loadSavedSettings() {
                const savedSettings = localStorage.getItem('procurementSettings');
                if (savedSettings) {
                    settings = JSON.parse(savedSettings);
                }
            }

            function loadProcedureTypes() {
                const select = document.getElementById('procedureTypeSelect');
                select.innerHTML = '';
                Object.keys(procedureData).forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    select.appendChild(option);
                });
                if (select.options.length > 0) {
                    loadProcedureTypeSettings(select.options[0].value);
                }
            }

            function loadProcedureTypeSettings(type) {
                const procedure = procedureData[type];
                const container = document.getElementById('procedureTypeSettings');
                container.innerHTML = `
            <div class="procedure-type">
                <label for="procedureTypeName" class="block text-gray-700">Menetlusliik:</label>
                <input type="text" id="procedureTypeName" value="${type}" required><br><br>
                <label for="requestDays" class="block text-gray-700">Taotluste esitamise päevad:</label>
                <input type="number" id="requestDays" value="${procedure.taotlusteAeg}" required><br><br>
                <label for="offerDays" class="block text-gray-700">Pakkumuste esitamise päevad:</label>
                <input type="number" id="offerDays" value="${procedure.pakkumusteAeg}" required><br><br>
                <label for="useInternationalThreshold" class="block text-gray-700">Kasuta rahvusvahelisi tähtaegu:</label>
                <input type="checkbox" id="useInternationalThreshold" ${procedure.useInternational ? 'checked' : ''} onchange="toggleInternationalThreshold('${type}')"><br><br>
                <button onclick="deleteProcedureType('${type}')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition transform hover:scale-105">Kustuta</button>
                <button onclick="saveProcedureType('${type}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition transform hover:scale-105">Salvesta</button>
            </div>
            `;
            }

            function addProcedureType() {
                const container = document.getElementById('procedureTypeSettings');
                container.innerHTML = `
            <div class="procedure-type">
                <label for="procedureTypeName" class="block text-gray-700">Menetlusliik:</label>
                <input type="text" id="procedureTypeName" required><br><br>
                <label for="requestDays" class="block text-gray-700">Taotluste esitamise päevad:</label>
                <input type="number" id="requestDays" required><br><br>
                <label for="offerDays" class="block text-gray-700">Pakkumuste esitamise päevad:</label>
                <input type="number" id="offerDays" required><br><br>
                <label for="useInternationalThreshold" class="block text-gray-700">Kasuta rahvusvahelisi tähtaegu:</label>
                <input type="checkbox" id="useInternationalThreshold" onchange="toggleInternationalThreshold()"><br><br>
                <button onclick="saveNewProcedureType()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition transform hover:scale-105">Salvesta</button>
            </div>
            `;
            }

            function toggleInternationalThreshold(type) {
                const useInternational = document.getElementById('useInternationalThreshold').checked;
                const procedure = useInternational ? internationalProcedureData[type] : procedureData[type];
                document.getElementById('requestDays').value = procedure.taotlusteAeg;
                document.getElementById('offerDays').value = procedure.pakkumusteAeg;
            }

            function deleteProcedureType(type) {
                delete procedureData[type];
                loadProcedureTypes();
                saveSettings();
            }

            function saveProcedureType(oldType) {
                const newType = document.getElementById('procedureTypeName').value;
                const requestDays = parseInt(document.getElementById('requestDays').value);
                const offerDays = parseInt(document.getElementById('offerDays').value);
                const useInternational = document.getElementById('useInternationalThreshold').checked;
                delete procedureData[oldType];
                procedureData[newType] = { taotlusteAeg: requestDays, pakkumusteAeg: offerDays, piirmäär: 60000, useInternational }; // Default piirmäär
                loadProcedureTypes();
                saveSettings();
            }

            function saveNewProcedureType() {
                const newType = document.getElementById('procedureTypeName').value;
                const requestDays = parseInt(document.getElementById('requestDays').value);
                const offerDays = parseInt(document.getElementById('offerDays').value);
                const useInternational = document.getElementById('useInternationalThreshold').checked;
                procedureData[newType] = { taotlusteAeg: requestDays, pakkumusteAeg: offerDays, piirmäär: 60000, useInternational }; // Default piirmäär
                loadProcedureTypes();
                saveSettings();
            }

            loadSavedSettings();

            class PublicProcurement {
                constructor(name, cost, procedureType, contractSigningDate) {
                    // Ensure the date is valid before any conversion logic
                    if (!contractSigningDate || isNaN(new Date(contractSigningDate).getTime())) {
                        console.error("Invalid contract signing date:", contractSigningDate);
                        this.contractSigningDate = null; // Avoid breaking further calculations
                    } else {
                        // Convert dd.mm.yyyy to YYYY-MM-DD if necessary
                        if (typeof contractSigningDate === "string" && contractSigningDate.includes(".")) {
                            const parts = contractSigningDate.split(".");
                            if (parts.length === 3) {
                                contractSigningDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                            }
                        }
                        this.contractSigningDate = new Date(contractSigningDate);
                    }

                    this.name = name;
                    this.cost = cost;
                    this.procedureType = procedureType;
                    this.contractSigningDate = new Date(contractSigningDate); null;
                    this.procedureDuration = this.calculateProcedureDuration();
                    this.procedureDetails = this.calculateProcedureDetails();
                    this.requestSubmissionDate = this.calculateRequestSubmissionDate();
                }

                calculateProcedureDuration() {
                    const procedure = procedureData[this.procedureType];
                    const internationalProcedure = internationalProcedureData[this.procedureType];
                    const internationalThreshold = internationalProcedure.piirmäär;

                    let duration = 0;

                    if (this.cost > internationalThreshold || procedure.useInternational) {
                        duration += internationalProcedure.taotlusteAeg + internationalProcedure.pakkumusteAeg;
                    } else {
                        duration += procedure.taotlusteAeg + procedure.pakkumusteAeg;
                    }

                    duration += settings.documentPreparationDays;
                    duration += settings.offerEvaluationDays;
                    duration += settings.decisionDays;
                    duration += settings.bidderEvaluationDays;
                    duration += settings.successfulBidderDays;
                    duration += settings.waitingPeriodDays;

                    return duration;
                }

                calculateProcedureDetails() {
                    const procedure = procedureData[this.procedureType];
                    const internationalProcedure = internationalProcedureData[this.procedureType];
                    const internationalThreshold = internationalProcedure.piirmäär;
                    let taotlusteAeg, pakkumusteAeg;

                    if (this.cost > internationalThreshold || procedure.useInternational) {
                        taotlusteAeg = internationalProcedure.taotlusteAeg;
                        pakkumusteAeg = internationalProcedure.pakkumusteAeg;
                    } else {
                        taotlusteAeg = procedure.taotlusteAeg;
                        pakkumusteAeg = procedure.pakkumusteAeg;
                    }

                    const details = [
                        { step: "Riigihanke alusdokumentide koostamine", days: ` ${settings.documentPreparationDays} päeva` },
                        { step: "Taotluste esitamine RHRis", days: taotlusteAeg ? `${taotlusteAeg} päeva` : "Ei kohaldu" },
                        { step: "Pakkumuste esitamine RHRis", days: pakkumusteAeg ? `${pakkumusteAeg} päeva` : "Ei kohaldu" },
                        { step: "Hindamine 1", days: `${settings.offerEvaluationDays} päeva` },
                        { step: "Otsus 1", days: `${settings.decisionDays} päeva` },
                        { step: "Hindamine 2", days: `${settings.bidderEvaluationDays} päeva` },
                        { step: "Otsus 2", days: `${settings.successfulBidderDays} päeva` },
                        { step: "Ooteaeg", days: `${settings.waitingPeriodDays} päeva` }
                    ];
                    return details;
                }

                calculateRequestSubmissionDate() {
                    // Step 1: Ensure contractSigningDate is in YYYY-MM-DD format
                    if (typeof this.contractSigningDate === "string" && this.contractSigningDate.includes(".")) {
                        const parts = this.contractSigningDate.split(".");
                        if (parts.length === 3) {
                            this.contractSigningDate = typeof this.contractSigningDate === "string" ? `${parts[2]}-${parts[1]}-${parts[0]}` : this.contractSigningDate; // Convert dd.mm.yyyy → YYYY-MM-DD only if it's a string
                        }
                    }

                    // Step 2: Validate contractSigningDate before using it
                    if (!this.contractSigningDate || isNaN(new Date(this.contractSigningDate).getTime())) {
                        console.error("Invalid contract signing date:", this.contractSigningDate);
                        return "Invalid date"; // Prevent further errors
                    }

                    // Step 3: Calculate the request submission date
                    const submissionDate = new Date(this.contractSigningDate);
                    if (!isNaN(this.procedureDuration)) {
                        submissionDate.setDate(submissionDate.getDate() - this.procedureDuration);
                        if (isNaN(submissionDate.getTime())) {
                            console.error("Invalid submission date:", submissionDate);
                            return "Invalid date"; // Prevents errors
                        }
                        return submissionDate.toISOString().split('T')[0]; // Returns YYYY-MM-DD format
                        console.error("Invalid procedure duration:", this.procedureDuration);
                    }

                    // Step 4: Calculate expected quarter
                    const month = submissionDate.getMonth() + 1;
                    const year = submissionDate.getFullYear();
                    this.expectedQuarter = `Q${Math.ceil(month / 3)} ${year}`;

                    return submissionDate.toISOString().split('T')[0]; // Returns YYYY-MM-DD format
                }

                generateHTML() {
                    const detailsHTML = this.procedureDetails.map((detail, index) => `
                    <li class="flex flex-col py-2 border-b">
                        <div class="flex justify-between items-center">
                            <span class="w-3/4">${detail.step}:</span>
                            <span id="days-${index}" class="w-16 text-center font-medium whitespace-nowrap">${detail.days}</span>
                            <div class="flex gap-1 ml-6">
                                <button onclick="adjustDays(${index}, -1)" class="adjustDays bg-sky-500 text-white px-3 py-1 rounded text-xs hover:bg-sky-800 transition transform hover:scale-105">-</button>
                                <button onclick="adjustDays(${index}, 1)" class="adjustDays bg-sky-500 text-white px-3 py-1 rounded text-xs hover:bg-sky-600 transition transform hover:scale-105">+</button>
                            </div>
                        </div>
                            <div class="w-full bg-gray-200/20 rounded-full h-4 overflow-hidden mt-1">
                            <div id="progress-${index}" class="progress-bar bg-blue-500 h-4 rounded-full transition-all duration-500" data-progress="0"></div>
                        </div>
                    </li>
                `).join('');



                    const errorMessage = new Date(this.requestSubmissionDate) < new Date() ?
                        '<p class="error-message text-red-500 font-bold hidden">NB! Oled hiljaks jäänud planeerimisel!</p>' : '';

                    return `
                    <div class="result-card p-0 rounded max-w-md rounded-md">
                        <p><strong>Riigihanke taotluse esitamise kuupäev:</strong> 
                            <span id="requestSubmissionDate">${formatDate(this.requestSubmissionDate)}</span>
                        </p>
                        ${errorMessage}
                        <p><strong>Nimi:</strong> ${this.name}</p>
                        <p><strong>Maksumus:</strong> ${this.cost}</p>
                        <p><strong>Riigihanke menetlusliik:</strong> ${this.procedureType}</p>
                        <p><strong>Lepingu allkirjastamise kuupäev:</strong> ${formatDate(this.contractSigningDate)}</p>

                        <p><strong>Eeldatav riigihanke menetlusaeg päevades:</strong> <span id="totalDuration">${this.procedureDuration}</span> päeva</p>

                        <ul class="list-none p-0">
                            ${detailsHTML}
                        </ul>
                    </div>
                `;
                }

                generateTableRow(index) {
                    return `
                    <tr>
                        <td class="border p-2">${this.name}</td>
                        <td class="border p-2">${this.procedureType}</td>
                        <td class="border p-2">${this.expectedQuarter}</td>
                        <td class="border p-2">${this.cost}</td>
                        <td class="border p-2">${this.procedureDuration} päeva</td>
                        <td class="border p-2">${formatDate(this.requestSubmissionDate)}</td>
                        <td class="border p-2">${formatDate(this.contractSigningDate)}</td>
                        <td class="border p-2"><button class="adjustDays edit-button bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 transition transform hover:scale-105 hidden" onclick="editSearch(${index})">Muuda</button></td>
                        <td class="border p-2"><button class="adjustdays delete-button bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 transition transform hover:scale-105" onclick="deleteSearch(${index})">Kustuta</button></td>
                    </tr>
                `;
                }
            }

            function adjustDays(index, adjustment) {
                const daysElement = document.getElementById(`days-${index}`);
                if (!daysElement) {
                    console.error(`❌ Element with id days-${index} not found`);
                    return;
                }

                let days = parseInt(daysElement.innerText.match(/\d+/)?.[0] || "0", 10);
                days = Math.max(0, days + adjustment);
                daysElement.innerText = `${days} päeva`;

                // ✅ Uuendame menetluse kogukestust
                const totalDurationElement = document.getElementById('totalDuration');
                if (totalDurationElement) {
                    let totalDuration = parseInt(totalDurationElement.innerText || "0", 10);
                    totalDuration = Math.max(0, totalDuration + adjustment);
                    totalDurationElement.innerText = totalDuration;
                } else {
                    console.error("❌ Element with id totalDuration not found");
                }
                // ⏱️ Värskenda sidebar ajajoont ja modaalset ajajoont
                if (typeof initializeTimeline === 'function') {
                    initializeTimeline(); // uuendab sidebar ajajoone täielikult
                }
                if (typeof showTimelineModal === 'function') {
                    showTimelineModal(); // uuendab modal ajajoont
                }

                // ✅ Otsime hanke nime järgi
                let procurement = savedSearches.find(p => p.name === document.getElementById('name').value.trim());

                // 🔹 Kui hanget pole, loome uue ja lisame massiivi
                if (!procurement) {
                    console.warn("⚠ Hange ei ole massiivis, loon uue objekti.");

                    procurement = new PublicProcurement(
                        document.getElementById('name').value.trim(),
                        parseFloat(document.getElementById('cost').value),
                        document.getElementById('procedureType').value,
                        document.getElementById('contractSigningDate').value
                    );
                    savedSearches.push(procurement);
                }

                // ✅ Veendume, et menetluse kestus ja taotluse esitamise kuupäev uuenevad õigesti
                procurement.procedureDuration = parseInt(totalDurationElement.innerText);
                procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();

                if (!procurement.requestSubmissionDate || procurement.requestSubmissionDate === "Invalid date") {
                    console.error("❌ Arvutatud kuupäev on vigane:", procurement.requestSubmissionDate);
                    procurement.requestSubmissionDate = "Määramata";
                }


                document.getElementById('requestSubmissionDate').innerText = formatDate(procurement.requestSubmissionDate);

                // ✅ Uuendame tabelis kuvamist ja progressiribasid
                updateSavedSearchesTable();
                updateTotalDuration();


                // Use the immediate update for the progress bar of the changed element
                const progressBar = document.getElementById(`progress-${index}`);
                if (progressBar) {
                    const totalDuration = parseInt(totalDurationElement?.innerText, 10) || 1;
                    let progressWidth = (days / totalDuration) * 100 * 1.25;

                    // Kill any existing animations
                    gsap.killTweensOf(progressBar);

                    // Update color immediately
                    progressBar.classList.remove("bg-blue-500", "bg-green-500", "bg-yellow-500", "bg-red-500");
                    if (progressWidth >= 25) {
                        progressBar.classList.add("bg-red-500");
                    } else if (progressWidth >= 14) {
                        progressBar.classList.add("bg-yellow-500");
                    } else {
                        progressBar.classList.add("bg-green-500");
                    }

                    // Animate just this bar
                    gsap.to(progressBar, {
                        width: `${progressWidth}%`,
                        duration: 0.2,  // Faster animation
                        ease: "power1.out"
                    });
                }

                // Use debounced update for all other bars
                debouncedUpdateProgressBars();



            }

            const savedSearches = [];
            const history = [];

            document.getElementById('procurementForm').addEventListener('submit', async function (event) {
                event.preventDefault();

                const name = document.getElementById('name').value;
                const cost = parseFloat(document.getElementById('cost').value);
                const procedureType = document.getElementById('procedureType').value;
                const contractSigningDate = document.getElementById('contractSigningDate').value;

                const procurement = new PublicProcurement(name, cost, procedureType, contractSigningDate);
                procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();

                document.getElementById('result').innerHTML = procurement.generateHTML();

                // ✅ Progressi ja kestuse uuendamine
                setTimeout(() => {
                    updateTotalDuration();
                    updateProgressBars();
                }, 100);

                // ✅ Kuvame tulemuste konteineri
                document.getElementById('resultContainer').classList.remove('hidden');
            });

            document.getElementById("updateProcurement").addEventListener("click", function () {
                const name = document.getElementById('name').value;
                const cost = parseFloat(document.getElementById('cost').value);
                const procedureType = document.getElementById('procedureType').value;
                const contractSigningDate = document.getElementById('contractSigningDate').value;
                const requestSubmissionDate = document.getElementById('requestSubmissionDate').innerText;

                if (!name || isNaN(cost) || !procedureType || !contractSigningDate || requestSubmissionDate === "Määramata") {
                    alert("Palun täida kõik väljad!");
                    return;
                }

                const index = savedSearches.findIndex(search => search.name === name);
                if (index !== -1) {
                    savedSearches.splice(index, 1);
                }

                let procurement = {
                    name,
                    cost,
                    procedureType,
                    contractSigningDate,
                    requestSubmissionDate,
                };

                savedSearches.push(procurement);
                updateSavedSearchesTable();

                console.log("✅ Hange lisatud tabelisse, kuid mitte Firestore'i:", procurement);
            });

            document.getElementById('clearFields').addEventListener('click', function () {
                document.getElementById('procurementForm').reset();
                document.getElementById('result').innerHTML = '';
                document.getElementById('resultContainer').classList.add('hidden'); // Hide the result container
            });

            document.getElementById('saveFields').addEventListener('click', function () {
                const name = document.getElementById('name').value;
                const cost = parseFloat(document.getElementById('cost').value);
                const procedureType = document.getElementById('procedureType').value;
                const contractSigningDate = document.getElementById('contractSigningDate').value;

                const procurement = new PublicProcurement(name, cost, procedureType, contractSigningDate);

                // Update procedure details with adjusted days
                procurement.procedureDetails.forEach((detail, index) => {
                    const daysElement = document.getElementById(`days-${index}`);
                    if (daysElement) {
                        let daysText = daysElement.innerText;
                        let match = daysText.match(/\d+/);
                        if (match) {
                            let days = parseInt(match[0]);
                            detail.days = `${days} päeva`;
                        } else {
                            console.error("No days found in text:", daysText);
                        }
                    } else {
                        console.error("Element not found for index:", index);
                    }
                })

                // Capture the adjusted procedureDuration value
                const totalDurationElement = document.getElementById('totalDuration');
                if (totalDurationElement) {
                    procurement.procedureDuration = parseInt(totalDurationElement.innerText);
                } else {
                    console.error("Total duration element not found");
                }

                procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();

                // Update the displayed result
                document.getElementById('result').innerHTML = procurement.generateHTML();

                // Save the updated procurement
                const existingIndex = savedSearches.findIndex(p => p.name === name);
                if (existingIndex !== -1) {
                    savedSearches[existingIndex] = procurement;
                } else {
                    if (savedSearches.length < 15) {
                        savedSearches.push(procurement);
                    } else {
                        alert("Maksimaalne salvestatud otsingute arv on 15.");
                    }
                }
            });

            document.getElementById('refreshFields').addEventListener('click', function () {
                const procurement = new PublicProcurement(
                    document.getElementById('name').value,
                    parseFloat(document.getElementById('cost').value),
                    document.getElementById('procedureType').value,
                    document.getElementById('contractSigningDate').value
                );

                procurement.procedureDuration = parseInt(document.getElementById('totalDuration').innerText);
                procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();
                document.getElementById('requestSubmissionDate').innerText = formatDate(procurement.requestSubmissionDate);
                updateSavedSearchesTable();
            });

            document.getElementById('saveToExcel').addEventListener('click', function () {
                const table = document.getElementById("savedSearchesTableBody");
                const rows = table.getElementsByTagName("tr");

                if (rows.length === 0) {
                    alert("Uusi hankeid salvestamiseks ei ole.");
                    return;
                }

                const headers = [
                    "Riigihanke nimi",
                    "Menetlusliik",
                    "Eeldatav korraldamise aeg (kvartal)",
                    "Eeldatav maksumus (€)",
                    "Lepingu kehtivusaeg",
                    "Riigihanke eest vastutav",
                    "Tehnilise kirjelduse eest vatutav"
                ];

                const data = [];
                data.push(headers);

                let totalCost = 0;

                for (let row of rows) {
                    const cells = row.getElementsByTagName("td");
                    if (cells.length > 0) {
                        const cost = parseFloat(cells[2].innerText.replace(/[^\d,.-]/g, "").replace(",", "."));
                        totalCost += isNaN(cost) ? 0 : cost;

                        data.push([
                            cells[0].innerText.trim(), // Name
                            cells[1].innerText.trim(), // Procedure Type
                            getQuarter(cells[3].innerText.trim()), // Estimated Time
                            isNaN(cost) ? "" : cost.toFixed(2) + " €", // Cost formatted
                            "",  // Empty field for contract duration
                            "",  // Empty field for responsible person
                            ""   // Empty field for technical responsible person
                        ]);
                    }
                }

                // Lisa kokkuvõte viimasena
                data.push([
                    "KOKKU", "", "", totalCost.toFixed(2) + " €", "", "", ""
                ]);

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);

                // **Seadista veergude laiused dünaamiliselt**
                ws['!cols'] = headers.map((header, i) => ({
                    wch: Math.max(...data.map(row => (row[i] ? row[i].length : 10))) + 2
                }));

                // **Lisa autofilter**
                const range = XLSX.utils.decode_range(ws['!ref']);
                ws['!autofilter'] = { ref: XLSX.utils.encode_range(range) };

                // **Lisa päise stiilid**
                Object.keys(ws).forEach(cell => {
                    if (cell.startsWith('A1') || cell.startsWith('B1')) {
                        ws[cell].s = {
                            font: { bold: true, color: { rgb: "FFFFFF" } },
                            fill: { fgColor: { rgb: "4F81BD" } },
                            alignment: { horizontal: "center" }
                        };
                    }
                });

                XLSX.utils.book_append_sheet(wb, ws, "Hankeplaan");
                XLSX.writeFile(wb, "hankeplaan.xlsx");
            });

            function getQuarter(dateString) {
                if (!dateString || dateString === "Määramata") return "Määramata";

                const dateParts = dateString.split('.');
                if (dateParts.length !== 3) return "Määramata";

                const month = parseInt(dateParts[1], 10);
                const year = dateParts[2];

                if (month >= 1 && month <= 3) return `1. kvartal ${year}`;
                if (month >= 4 && month <= 6) return `2. kvartal ${year}`;
                if (month >= 7 && month <= 9) return `3. kvartal ${year}`;
                if (month >= 10 && month <= 12) return `4. kvartal ${year}`;

                return "Määramata";
            }

            // ✅ Defineerime muutuja üleval, et vältida "not defined" viga
            let resultContainerHTML = "";

            document.getElementById("showSavedSearches").addEventListener("click", function () {
                // ✅ Salvestame resultContainer sisu enne selle peitmist
                resultContainerHTML = document.getElementById("resultContainer").innerHTML;
                document.getElementById("resultContainer").classList.add("hidden");
            });

            document.getElementById("showForm").addEventListener("click", function () {
                // ✅ Kui resultContainerHTML on olemas, taastame selle
                if (resultContainerHTML) {
                    document.getElementById("resultContainer").innerHTML = resultContainerHTML;
                    document.getElementById("resultContainer").classList.remove("hidden");
                }
                setActiveTab(this);
            });

            document.getElementById('showSavedSearches').addEventListener('click', function () {
                saveResultContainerHTML();
                closeAllTabs();
                document.getElementById('savedSearchesContainer').classList.remove('hidden');
                updateSavedSearchesTable();
                setActiveTab(this);
            });

            document.getElementById('settingsButton').addEventListener('click', function () {
                saveResultContainerHTML();
                closeAllTabs();
                document.getElementById('settingsContainer').classList.remove('hidden');
                loadSettings();
                loadProcedureTypes();
                setActiveTab(this);
            });

            function setActiveTab(button) {
                const navButtons = document.querySelectorAll('.nav button');
                navButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
            }

            function saveResultContainerHTML() {
                resultContainerHTML = document.getElementById('resultContainer').innerHTML;
            }

            function closeAllTabs() {
                document.getElementById('formContainer').classList.add('hidden');
                document.getElementById('savedSearchesContainer').classList.add('hidden');
                document.getElementById('settingsContainer').classList.add('hidden');
                document.getElementById('resultContainer').classList.add('hidden');
            }

            function updateSavedSearchesTable() {
                const tableBody = document.getElementById("savedSearchesTableBody");
                tableBody.innerHTML = ""; // Puhastame tabeli

                savedSearches.forEach((search, index) => {
                    const row = `
        <tr class="border-b even:bg-white/40 hover:bg-gray transition-all">
            <td class="p-4">${search.name}</td>
            <td class="p-4">${search.procedureType}</td>
            <td class="p-4">${search.cost} €</td>
            <td class="p-4 text-blue-600 font-semibold">${formatDate(search.requestSubmissionDate || "Määramata")}</td>
            <td class="p-4 text-blue-600 font-semibold">${formatDate(search.contractSigningDate)}</td>
            <td class="p-4 text-center">
                <button onclick="deleteSearch(${index})" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition transform hover:scale-105">
                ❌ 
                </button>
            </td>
        </tr>
        `;
                    tableBody.innerHTML += row;
                });
            }
            let deleteIndex = null; // Hoiab ajutiselt indeksi, mida kustutada soovitakse

            async function deleteSearch(index) {
                deleteIndex = index; // Salvestame kustutatava indeksi
                document.getElementById("deleteConfirmModal").classList.remove("hidden"); // Kuvame modali
            }


            async function updateProcurementInFirestore() {
                const user = auth.currentUser;
                if (!user) {
                    alert("Salvestamiseks peab olema sisse logitud!");
                    return;
                }

                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (!userDoc.exists()) {
                        console.error("❌ Kasutaja dokumenti ei leitud Firestore'ist.");
                        return;
                    }

                    let searches = userDoc.data().searches || [];
                    const procurementName = document.getElementById('name').value;
                    const searchIndex = searches.findIndex(s => s.name === procurementName);

                    if (searchIndex === -1) {
                        console.warn("⚠ Firestore'is ei leitud vastavat hanget, ei saa uuendada.");
                        return;
                    }

                    // ✅ Kontrollime ja teisendame kuupäeva õigesse formaati (YYYY-MM-DD)
                    let newRequestDate = document.getElementById('requestSubmissionDate').innerText.trim();

                    console.log("🟡 Kontrollime kuupäeva enne teisendamist:", newRequestDate);

                    if (!newRequestDate || newRequestDate === "Määramata") {
                        console.error("❌ Vigane kuupäev, ei saa Firestore'i salvestada:", newRequestDate);
                        newRequestDate = "Määramata"; // Kui puudub, määrame vaikimisi
                    } else if (newRequestDate.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
                        // Kui kuupäev on "dd.mm.yyyy", teisendame selle "yyyy-mm-dd"
                        const [day, month, year] = newRequestDate.split(".");
                        newRequestDate = `${year}-${month}-${day}`;
                    }

                    console.log("✅ Teisendatud kuupäev Firestore'i salvestamiseks:", newRequestDate);

                    // ✅ Uuendame kirje Firestore'is
                    searches[searchIndex].procedureDuration = parseInt(document.getElementById('totalDuration').innerText);
                    searches[searchIndex].requestSubmissionDate = newRequestDate;

                    await updateDoc(userDocRef, { searches });

                    console.log("✅ Hange Firestore'is uuendatud:", searches[searchIndex]);

                } catch (error) {
                    console.error("❌ Firestore'i uuendamise viga:", error);
                }
            }

            document.getElementById("confirmDelete").addEventListener("click", async () => {
                if (deleteIndex === null) return; // Kui indeks puudub, ära tee midagi

                const user = auth.currentUser;
                if (!user) {
                    alert("Kustutamiseks peab olema sisse logitud!");
                    return;
                }

                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (!userDoc.exists()) {
                        console.error("❌ Kasutaja dokumenti ei leitud Firestore'ist.");
                        return;
                    }

                    let searches = userDoc.data().searches || [];

                    if (deleteIndex < 0 || deleteIndex >= searches.length) {
                        console.error("❌ Kehtetu indeks:", deleteIndex);
                        return;
                    }

                    const searchToDelete = searches[deleteIndex];

                    console.log("🔴 Enne kustutamist:", searches);
                    console.log("🚨 Kustutame:", searchToDelete);

                    // 🔥 Kustutame Firestore'ist ainult selle konkreetse objekti
                    await updateDoc(userDocRef, {
                        searches: searches.filter((_, i) => i !== deleteIndex)
                    });

                    console.log("✅ Otsing kustutatud Firestore'ist:", searchToDelete);

                    // 🔄 Laadime uuesti andmed, et värskendada tabelit
                    await loadUserSearches();
                } catch (error) {
                    console.error("❌ Firestore'i kustutamise viga:", error);
                }
            });

            document.getElementById("cancelDelete").addEventListener("click", () => {
                deleteIndex = null; // Tühistame kustutamise
                document.getElementById("deleteConfirmModal").classList.add("hidden"); // Peidame modali
            });

            function editSearch(index) {
                const procurement = savedSearches[index];
                document.getElementById('name').value = procurement.name;
                document.getElementById('cost').value = procurement.cost;
                document.getElementById('procedureType').value = procurement.procedureType;
                document.getElementById('contractSigningDate').value = procurement.contractSigningDate.toISOString().split('T')[0];
                deleteSearch(index);
                closeAllTabs();
                document.getElementById('formContainer').classList.remove('hidden');
                setActiveTab(document.getElementById('showForm'));
            }

            function refreshDuration(index) {
                const procurement = savedSearches[index];
                procurement.procedureDuration = parseInt(document.getElementById('totalDuration').innerText);
                procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();
                document.getElementById('requestSubmissionDate').innerText = formatDate(procurement.requestSubmissionDate);
                updateSavedSearchesTable();
            }

            function updateHistoryTable() {
                const tableBody = document.getElementById('historyTableBody');
                tableBody.innerHTML = '';
                history.forEach((procurement, index) => {
                    console.log('Adding row for:', procurement); // Debugging statement
                    tableBody.innerHTML += procurement.generateTableRow(index);
                });
                populateFilterOptions();
            }

            function populateFilterOptions() {
                const filterSelect = document.getElementById('filterByDate');
                const dates = [...new Set(history.map(procurement => procurement.contractSigningDate.toISOString().split('T')[0]))];
                filterSelect.innerHTML = '<option value="all">Kõik</option>';
                dates.forEach(date => {
                    filterSelect.innerHTML += `<option value="${date}">${date}</option>`;
                });
            }

            document.getElementById('filterByDate').addEventListener('change', function () {
                const selectedDate = this.value;
                const filteredHistory = selectedDate === 'all' ? history : history.filter(procurement => procurement.contractSigningDate.toISOString().split('T')[0] === selectedDate);
                const tableBody = document.getElementById('historyTableBody');
                tableBody.innerHTML = '';
                filteredHistory.forEach((procurement, index) => {
                    tableBody.innerHTML += procurement.generateTableRow(index);
                });
            });

            async function saveToFirestore(index) {
                const user = auth.currentUser;
                if (!user) {
                    alert("Salvestamiseks peab olema sisse logitud!");
                    return;
                }

                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                    let searches = userDoc.exists() ? userDoc.data().searches || [] : [];

                    searches.push(savedSearches[index]);

                    await updateDoc(userDocRef, { searches });

                    console.log("✅ Hange Firestore'is salvestatud:", savedSearches[index]);
                    showNotification("✅ Andmed salvestatud!");
                } catch (error) {
                    console.error("❌ Firestore'i salvestamise viga:", error);
                }
            }

            // ✅ Firestore'st andmete laadimise funktsioon
            async function loadUserSearches() {
                const user = auth.currentUser;
                if (!user) {
                    console.error("❌ Kasutajat ei leitud, ei saa otsinguid laadida.");
                    return;
                }

                try {
                    console.log("📥 Laen Firestore'ist salvestatud otsinguid...");
                    const userDoc = await getDoc(doc(db, "users", user.uid));

                    if (!userDoc.exists()) {
                        console.warn("⚠ Kasutajal pole salvestatud hankeid Firestore'is.");
                        return;
                    }

                    let searches = userDoc.data().searches || [];
                    console.log("📜 Laetud otsingud Firestore'ist:", searches);

                    // ✅ Teisendame kuupäevad õigesse formaati ja lisame tabelisse
                    searches = searches.map(search => ({
                        ...search,
                        requestSubmissionDate: formatDate(search.requestSubmissionDate || "Määramata"),
                        contractSigningDate: formatDate(search.contractSigningDate || "Määramata")
                    }));

                    displaySearches(searches); // ✅ Uuendame tabeli
                } catch (error) {
                    console.error("❌ Otsingute laadimise viga Firestore'ist:", error);
                }
            }


            document.getElementById('toggleDarkMode').addEventListener('click', function () {
                document.body.classList.toggle('bg-gray-900');
                document.body.classList.toggle('text-white');
            });

            function adjustTableColumns() {
                const tables = document.querySelectorAll('table');
                tables.forEach(table => {
                    const columns = table.querySelectorAll('th');
                    columns.forEach((column, index) => {
                        let maxWidth = 0;
                        const cells = table.querySelectorAll(`td:nth-child(${index + 1})`);
                        cells.forEach(cell => {
                            const cellWidth = cell.offsetWidth;
                            if (cellWidth > maxWidth) {
                                maxWidth = cellWidth;
                            }
                        });
                        column.style.width = `${maxWidth}px`;
                    });
                });
            }

            // Dropdown menu is now handled by Alpine.js with @mouseenter and @mouseleave
            // No need for manual event listeners anymore

            // Dark Mode Toggle
            const darkModeToggle = document.getElementById('toggleDarkMode');
            darkModeToggle.addEventListener('change', () => {
                document.body.classList.toggle('bg-gray-900');
                document.body.classList.toggle('text-white');

                // Navbar, header, and tab menu
                // Fix navbar & header gradient
                const header = document.querySelector('header');
                if (darkModeToggle.checked) {
                    header.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600');
                    header.classList.add('bg-gray-800');
                } else {
                    header.classList.remove('bg-gray-800');
                    header.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600');
                }

                // Ensure navbar links stay visible
                document.querySelectorAll('nav a').forEach(el => {
                    el.classList.toggle('text-gray-300');
                    el.classList.toggle('text-white');
                });

                document.querySelectorAll('header, nav, .tab-content').forEach(el => {
                    el.classList.toggle('bg-gray-800');
                    el.classList.toggle('text-white');
                });

                // Containers & content boxes
                document.querySelectorAll('.container, .shadow, .rounded-lg, .bg-white, .bg-gray-100, .bg-gray-50').forEach(el => {
                    el.classList.toggle('bg-gray-800');
                    el.classList.toggle('text-gray-200');
                });

                // Tables
                document.querySelectorAll('table').forEach(el => {
                    el.classList.toggle('bg-gray-700');
                    el.classList.toggle('text-gray-300');
                });

                // Table headers
                document.querySelectorAll('thead tr').forEach(el => {
                    el.classList.toggle('bg-gray-600');
                });

                // Buttons
                document.querySelectorAll('button').forEach(el => {
                    el.classList.toggle('shadow-lg');
                    el.classList.toggle('border-gray-700');
                });

                // Form Inputs & Select Boxes
                document.querySelectorAll('input, select, textarea').forEach(el => {
                    el.classList.toggle('bg-gray-700');
                    el.classList.toggle('text-white');
                    el.classList.toggle('border-gray-600');
                });

                // Save dark mode preference in localStorage
                if (document.body.classList.contains('bg-gray-900')) {
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    localStorage.setItem('darkMode', 'disabled');
                }
            });

            // Show Notification
            function showNotification(message, duration = 3000) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.classList.remove('hidden');
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, duration);
            }

            document.getElementById('saveFields').addEventListener('click', function () {
                // Your save logic here
                showNotification('Salvestatud edukalt!');
            });

            document.getElementById('refreshFields').addEventListener('click', function () {
                // Your update logic here
                showNotification('Uuendatud edukalt!');
            });

            function toggleChart() {
                const chartContainer = document.getElementById("chartContainer");
                chartContainer.classList.toggle("hidden");

                // Ensure table has data before rendering
                if (!chartContainer.classList.contains("hidden")) {
                    setTimeout(() => {
                        if (document.querySelectorAll("#savedSearchesTableBody tr").length > 0) {
                            renderChart();
                        } else {
                            console.warn("⚠ No saved searches found, chart cannot be displayed.");
                        }
                    }, 300);
                }
            }

            function renderChart() {
                const canvas = document.getElementById("procurementChart");
                if (!canvas) {
                    console.error("❌ Chart canvas not found!");
                    return;
                }

                const ctx = canvas.getContext("2d");

                // Destroy previous chart if it exists
                if (window.procurementChart && typeof window.procurementChart.destroy === 'function') {
                    window.procurementChart.destroy();
                }

                // Extract data from savedSearchesTableBody
                const rows = document.querySelectorAll("#savedSearchesTableBody tr");
                const labels = [];
                const costs = [];
                const totalDays = [];

                rows.forEach(row => {
                    const columns = row.querySelectorAll("td");
                    if (columns.length >= 5) {  // Ensure there are enough columns
                        const name = columns[0].innerText.trim();
                        const cost = parseFloat(columns[2].innerText.replace("€", "").trim()); // Remove € sign
                        const days = parseInt(columns[3].innerText.trim(), 10); // Convert to integer

                        if (!isNaN(cost) && !isNaN(days)) { // Ensure valid data
                            labels.push(name);
                            costs.push(cost);
                            totalDays.push(days);
                        }
                    }
                });

                // If no valid data, show a warning and prevent chart initialization
                if (labels.length === 0) {
                    console.warn("⚠ No valid data found for the chart.");
                    return;
                }

                // Create the chart
                window.procurementChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: "Menetlusaeg (päevad)",
                                data: totalDays.map(days => {
                                    const today = new Date();
                                    const submissionDate = new Date();
                                    submissionDate.setDate(today.getDate() + days);
                                    const timeDiff = submissionDate.getTime() - today.getTime();
                                    return Math.ceil(timeDiff / (1000 * 3600 * 24));
                                }),
                                backgroundColor: "rgba(153, 102, 255, 0.6)",
                                borderColor: "rgba(153, 102, 255, 1)",
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { beginAtZero: true }
                        },
                        plugins: {
                            legend: { display: true },
                            tooltip: { enabled: true }
                        }
                    }
                });
            }

            // Attach event listeners to navbar buttons
            document.addEventListener("DOMContentLoaded", function () {
                const navTool = document.getElementById("showForm");
                const navHanked = document.getElementById("showSavedSearches");
                const navHistory = document.getElementById("showHistory");
                const navSettings = document.getElementById("settingsButton");

                if (navTool) navTool.addEventListener("click", () => showTab('formContainer'));
                if (navHanked) navHanked.addEventListener("click", () => showTab('savedSearchesContainer'));
                if (navHistory) navHistory.addEventListener("click", () => showTab('historyContainer'));
                function showTab(tabId) {
                    closeAllTabs();
                    document.getElementById(tabId).classList.remove('hidden');
                }
                // Initialize Chart.js
                renderChart();
            });
            function toggleDashboard() {
                const dashboard = document.getElementById("dashboard");
                const recentCalculationsTable = document.getElementById("recentCalculationsTable");
                dashboard.classList.toggle("hidden");
                recentCalculationsTable.classList.toggle("hidden");
            }

            // Ensure the container fades in on page load
            document.addEventListener("DOMContentLoaded", () => {
                gsap.from("body", { opacity: 0, duration: 0.3 });
                updateTotalDuration(); // Ensure total duration is calculated and progress bars are updated on load
            });

            // Immediate update function (no animation)
            function updateProgressBarsImmediate() {
                const stepData = extractStepDays();
                const totalDurationElement = document.getElementById('totalDuration');
                const totalDuration = parseInt(totalDurationElement?.innerText, 10) || 1;

                stepData.forEach(step => {
                    const progressBar = document.getElementById(`progress-${step.index}`);
                    if (progressBar) {
                        // Hide the progress bar if "Ei kohaldu"
                        if (step.element.innerText.includes("Ei kohaldu")) {
                            progressBar.style.display = "none";
                            return;
                        } else {
                            progressBar.style.display = "block";
                        }

                        // Scale width dynamically based on the total duration
                        let progressWidth = (step.days / totalDuration) * 100 * 1.25;
                        progressBar.dataset.progress = progressWidth.toFixed(2);

                        // Kill any existing animations on this element
                        gsap.killTweensOf(progressBar);

                        // Update colors
                        progressBar.classList.remove("bg-blue-500", "bg-green-500", "bg-yellow-500", "bg-red-500");
                        if (progressWidth >= 25) {
                            progressBar.classList.add("bg-red-500"); // suur ajakulu
                        } else if (progressWidth >= 14) {
                            progressBar.classList.add("bg-yellow-500"); // keskmine ajakulu
                        } else {
                            progressBar.classList.add("bg-green-500"); // väike ajakulu
                        }

                        // Set width immediately
                        progressBar.style.width = `${progressWidth}%`;
                    }
                });
            }

            // Animated update function (with smooth transition)
            function updateProgressBars() {
                // For rapid clicks, use the debounced version
                debouncedUpdateProgressBars();

                // For immediate visual feedback, update colors right away
                const stepData = extractStepDays();
                const totalDurationElement = document.getElementById('totalDuration');
                const totalDuration = parseInt(totalDurationElement?.innerText, 10) || 1;

                stepData.forEach(step => {
                    const progressBar = document.getElementById(`progress-${step.index}`);
                    if (progressBar && !step.element.innerText.includes("Ei kohaldu")) {
                        // Update colors immediately for visual feedback
                        let progressWidth = (step.days / totalDuration) * 100 * 1.25;

                        progressBar.classList.remove("bg-blue-500", "bg-green-500", "bg-yellow-500", "bg-red-500");
                        if (progressWidth >= 25) {
                            progressBar.classList.add("bg-red-500");
                        } else if (progressWidth >= 14) {
                            progressBar.classList.add("bg-yellow-500");
                        } else {
                            progressBar.classList.add("bg-green-500");
                        }
                    }
                });
            }

            function extractStepDays() {
                return Array.from(document.querySelectorAll('[id^="days-"]')).map(el => {
                    // Extract the original index from the element ID
                    const originalIndex = parseInt(el.id.replace('days-', ''), 10);
                    let daysText = el.innerText;
                    let days = parseInt(daysText.match(/\d+/)?.[0] || "0", 10);
                    return { index: originalIndex, element: el, days };
                });
            }

            function updateTotalDuration() {
                const totalDurationElement = document.getElementById('totalDuration');
                if (!totalDurationElement) return;

                const totalDays = extractStepDays().reduce((sum, step) => sum + step.days, 0);
                totalDurationElement.innerText = totalDays;

                updateProgressBars();
            }

            function adjustDays(index, adjustment) {
                const stepData = extractStepDays().find(step => step.index === index);
                if (!stepData) return;

                let newDays = Math.max(0, stepData.days + adjustment);
                stepData.element.innerText = `${newDays} päeva`;

                updateTotalDuration();
                updateProgressBars();

                // ✅ Kontrollime, kas hange on juba olemas
                let procurement = savedSearches.find(p => p.name === document.getElementById('name').value.trim());

                if (!procurement) {
                    procurement = new PublicProcurement(
                        document.getElementById('name').value.trim(),
                        parseFloat(document.getElementById('cost').value),
                        document.getElementById('procedureType').value,
                        document.getElementById('contractSigningDate').value
                    );
                }

                // ✅ Värskendame menetluse kestust ja taotluse esitamise kuupäeva
                procurement.procedureDuration = parseInt(document.getElementById('totalDuration').innerText);
                procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();
                document.getElementById('requestSubmissionDate').innerText = formatDate(procurement.requestSubmissionDate);
            }


            function initializeAdjustButtons() {
                document.querySelectorAll("button[data-adjust]").forEach(button => {
                    button.addEventListener("click", function () {
                        const index = parseInt(this.dataset.index, 10);
                        const adjustment = parseInt(this.dataset.adjust, 10);
                        adjustDays(index, adjustment);
                    });
                });
            }

            document.addEventListener("readystatechange", function () {
                if (document.readyState === "complete") {
                    console.log("Page fully loaded. Initializing scripts...");
                    initializeAdjustButtons();
                    updateTotalDuration();  // 🔥 Ensures total duration starts correctly
                    updateProgressBars();   // 🔥 Ensures progress bars scale correctly on load

                    // Add event listener for timeline button
                    document.getElementById('toggleTimelineButton').addEventListener('click', function () {
                        const timelineModal = document.getElementById('timelineModal');
                        if (timelineModal && timelineModal.__x) {
                            timelineModal.__x.$data.open = true;
                        } else {
                            // If Alpine.js is not initialized, call the showTimelineModal function directly
                            showTimelineModal();
                        }
                    });

                }
                async function registerUser(email, password) {
                    const { user } = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, "users", user.uid), {
                        email: email,
                        role: "active",
                        approved: false
                    });
                }
            });

            //firestore salvstamine
            document.getElementById("saveToFirestore").addEventListener("click", async function () {
                if (savedSearches.length === 0) {
                    alert("Uusi hankeid salvestamiseks ei ole.");
                    return;
                }

                try {
                    const user = auth.currentUser;
                    if (!user) {
                        alert("Peate olema sisse logitud!");
                        return;
                    }

                    const userDocRef = doc(db, "users", user.uid);

                    // ✅ Laeme olemasolevad hankeandmed
                    const docSnap = await getDoc(userDocRef);
                    let existingData = docSnap.exists() ? docSnap.data().searches || [] : [];

                    // ✅ Lisame uued andmed olemasolevatele juurde
                    const updatedData = [...existingData, ...savedSearches];

                    // ✅ Salvestame uued andmed massiivi nimega `searches`
                    await setDoc(userDocRef, { searches: updatedData }, { merge: true });

                    console.log("✅ Hanked salvestatud Firestore'i ilma üle kirjutamata.");
                    showSuccessAlert("✅ Andmed salvestatud edukalt!");
                } catch (error) {
                    console.error("❌ Viga Firestore'i salvestamisel:", error);
                    showSuccessAlert("❌ Viga andmete salvestamisel!");
                }
            });

            //firestore laadimine
            document.getElementById('loadFromFirestore').addEventListener('click', async function () {
                const user = auth.currentUser;
                if (!user) {
                    alert("Andmete laadimiseks peab olema sisse logitud!");
                    return;
                }

                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (!userDoc.exists()) {
                        console.error("❌ Kasutaja dokumenti ei leitud Firestore'ist.");
                        return;
                    }

                    // ✅ Kontrollime, kas massiiv eksisteerib
                    let searches = userDoc.data().searches || userDoc.data().savedSearches || [];
                    console.log("📜 Laetud otsingud Firestore'ist:", searches);

                    // ✅ Kontrollime, kas see on massiiv
                    if (!Array.isArray(searches)) {
                        console.error("❌ Firestore'ist saadud 'searches' EI OLE massiiv! Vale struktuur:", searches);
                        return;
                    }

                    // ✅ Teisendame kuupäevad õigesse formaati
                    searches = searches.map(search => ({
                        ...search,
                        requestSubmissionDate: formatDate(search.requestSubmissionDate || "Määramata"),
                        contractSigningDate: formatDate(search.contractSigningDate || "Määramata")
                    }));

                    displaySearches(searches); // ✅ Uuendame tabeli
                } catch (error) {
                    console.error("❌ Otsingute laadimise viga Firestore'ist:", error);
                }
            });

            function displaySearches(searches) {
                const container = document.getElementById("savedSearchesTableBody");
                if (!container) {
                    console.error("❌ Ei leitud tabeli keha: savedSearchesTableBody");
                    return;
                }

                console.log("🔎 Kuvan otsingud tabelisse, kokku:", searches.length, "otsingut");
                container.innerHTML = ""; // ✅ Puhastame tabeli enne lisamist

                if (searches.length === 0) {
                    container.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">⚠ Ei leitud salvestatud hankeid.</td></tr>`;
                    return;
                }

                searches.forEach((search, index) => {
                    console.log(`📌 Kuvan otsingu [${index}]:`, search);
                    container.innerHTML += `
            <tr class="border-b hover:bg-gray-400 transition-all">
                <td class="p-4">${search.name}</td>
                <td class="p-4">${search.procedureType}</td>
                <td class="p-4">${search.cost} €</td>
                <td class="p-4 text-blue-600 font-semibold">${search.requestSubmissionDate}</td>
                <td class="p-4 text-blue-600 font-semibold">${search.contractSigningDate}</td>
                <td class="p-4 text-center hidden">
                    <button onclick="editSearch(${index})" class="bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 transition transform hover:scale-105">✏️ Muuda</button>
                </td>
                <td class="p-4 text-center">
                    <button onclick="deleteSearch(${index})" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition transform hover:scale-105">❌</button>
                </td>
            </tr>
        `;
                });

                console.log("✅ Otsingud lisatud tabelisse!");
            }

            // Function to show the timeline modal
            function showTimelineModal() {
                // Get the procedure details from the result card
                const procedureDetails = [];
                document.querySelectorAll('.result-card .step-row, .result-card li').forEach(row => {
                    const stepName = row.querySelector('.step-name') ?
                        row.querySelector('.step-name').textContent :
                        row.textContent.split(':')[0].trim();

                    const daysElement = row.querySelector('[id^="days-"]');
                    if (daysElement) {
                        const days = daysElement.textContent;
                        procedureDetails.push({ step: stepName, days: days });
                    }
                });

            }

            // Debounce function to prevent multiple rapid calls
            function debounce(func, wait) {
                let timeout;
                return function (...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            }

            // Create debounced version of updateProgressBars
            const debouncedUpdateProgressBars = debounce(function () {
                updateProgressBarsImmediate();
            }, 50); // 50ms delay

            // Set default date to today
            document.addEventListener('DOMContentLoaded', function () {
                // Format today's date as DD.MM.YYYY
                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const year = today.getFullYear();
                const formattedDate = `${day}.${month}.${year}`;

                // Set default contract date
                document.getElementById('timeline-contract-date').textContent = formattedDate;

                // Update timeline when form fields change
                document.getElementById('name').addEventListener('input', updateTimelineHeader);
                document.getElementById('cost').addEventListener('input', updateTimelineHeader);
                document.getElementById('contractSigningDate').addEventListener('change', updateTimelineHeader);
            });

            function updateTimelineHeader() {
                // Get values from form
                const name = document.getElementById('name').value || '';
                const cost = document.getElementById('cost').value || '';
                const contractDate = document.getElementById('contractSigningDate').value || '';

                // Update timeline header
                document.getElementById('timeline-procurement-cost').textContent = cost;
                document.getElementById('timeline-procurement-name').textContent = name;


                // Format date if available (from YYYY-MM-DD to DD.MM.YYYY)
                if (contractDate) {
                    try {
                        const [year, month, day] = contractDate.split('-');

                        // Ensure we have valid parts
                        if (year && month && day) {
                            // Pad day and month with leading zeros
                            // Using a fallback for browsers that don't support padStart
                            const formattedDay = String(day).padStart ? String(day).padStart(2, '0') : (day.length === 1 ? '0' + day : day);
                            const formattedMonth = String(month).padStart ? String(month).padStart(2, '0') : (month.length === 1 ? '0' + month : month);

                            document.getElementById('timeline-contract-date').textContent = `${formattedDay}.${formattedMonth}.${year}`;
                        } else {
                            // If date parts are missing, display the original date
                            document.getElementById('timeline-contract-date').textContent = contractDate;
                        }
                    } catch (error) {
                        console.error('Error formatting date:', error);
                        // Fallback to displaying the original date
                        document.getElementById('timeline-contract-date').textContent = contractDate;
                    }
                }
            }

            // Also update timeline when Calculate button is clicked
            document.getElementById('calculateTime').addEventListener('click', updateTimelineHeader);


            // 🔄 Käivita adjustDays kuulaja ainult kui ajajoon on loodud
            if (typeof setupAdjustDaysListeners === 'function') {
                setupAdjustDaysListeners();
            }

            // Function to generate and download PDF
            function generatePDF() {
                // Get timeline data
                const procurementName = document.getElementById('name').value || 'Riigihanke';
                const timelineSteps = document.getElementById('timeline-steps');

                // Create a new jsPDF instance
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');

                // Add title
                doc.setFontSize(20);
                doc.setTextColor(0, 0, 255);
                doc.text(`${procurementName} Ajakava`, 105, 20, { align: 'center' });

                // Add current date
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                const today = new Date();
                doc.text(`Genereeritud: ${today.toLocaleDateString('et-EE')}`, 105, 30, { align: 'center' });

                // Capture timeline data
                const timelineData = [];
                if (timelineSteps && timelineSteps.children.length > 0) {
                    Array.from(timelineSteps.children).forEach((step, index) => {
                        const title = step.querySelector('.font-bold')?.textContent || `Samm ${index + 1}`;
                        const date = step.querySelector('.text-blue-600')?.textContent || 'Kuupäev määramata';
                        timelineData.push({ title, date });
                    });
                } else {
                    // If no timeline steps, get form data
                    const form = document.getElementById('procurementForm');
                    if (form) {
                        const formData = new FormData(form);
                        for (const [key, value] of formData.entries()) {
                            timelineData.push({ title: key, date: value });
                        }
                    }
                }

                // Add timeline data to PDF
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                let yPos = 50;

                timelineData.forEach((item, index) => {
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 150);
                    doc.text(`${index + 1}. ${item.title}`, 20, yPos);

                    doc.setFontSize(11);
                    doc.setTextColor(80, 80, 80);
                    doc.text(item.date, 20, yPos + 6);

                    // Add a line separator
                    if (index < timelineData.length - 1) {
                        doc.setDrawColor(200, 200, 200);
                        doc.line(20, yPos + 10, 190, yPos + 10);
                    }

                    yPos += 20;
                });

                // Add footer
                doc.setFontSize(10);
                doc.setTextColor(150, 150, 150);
                doc.text('© 2025 Riigihanke Andmed. Kõik õigused kaitstud.', 105, 280, { align: 'center' });

                // Save the PDF
                doc.save(`${procurementName.replace(/\s+/g, '_')}_ajakava.pdf`);
            }

            // Simpler PDF export function using html2pdf
            function exportToPDF() {
                // Get the timeline container
                const timelineContainer = document.querySelector('.timeline-container');

                // If timeline container is not found or empty, show an alert
                if (!timelineContainer || !timelineContainer.innerHTML.trim()) {
                    alert('Ajakava andmed puuduvad. Palun täitke vorm ja arvutage ajakava enne PDF-i salvestamist.');
                    return;
                }

                // Create a clone of the timeline container to modify for PDF
                const pdfContent = document.createElement('div');
                pdfContent.innerHTML = timelineContainer.innerHTML;
                pdfContent.style.padding = '20px';
                pdfContent.style.backgroundColor = 'white';

                // Add a title to the PDF
                const title = document.createElement('h1');
                const procurementName = document.getElementById('name').value || 'Riigihanke';
                title.textContent = procurementName + ' Ajakava';
                title.style.textAlign = 'center';
                title.style.color = '#1a56db';
                title.style.marginBottom = '20px';
                pdfContent.prepend(title);

                // Add generation date
                const dateInfo = document.createElement('p');
                dateInfo.textContent = 'Genereeritud: ' + new Date().toLocaleDateString('et-EE');
                dateInfo.style.textAlign = 'center';
                dateInfo.style.color = '#666';
                dateInfo.style.marginBottom = '30px';
                pdfContent.insertBefore(dateInfo, pdfContent.children[1]);

                // Add footer
                const footer = document.createElement('p');
                footer.textContent = '© 2025 Riigihanke Andmed. Kõik õigused kaitstud.';
                footer.style.textAlign = 'center';
                footer.style.color = '#999';
                footer.style.marginTop = '30px';
                footer.style.fontSize = '10px';
                pdfContent.appendChild(footer);

                // Configure PDF options
                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: `${procurementName.replace(/\s+/g, '_')}_ajakava.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                // Generate and download the PDF
                html2pdf().from(pdfContent).set(opt).save();
            }

            // Make exportToPDF globally accessible
            window.exportToPDF = exportToPDF;
        </script>

        <style>
            /* Navbar button hover effect */
            .nav-button {
                transition: background-color 0.3s ease, transform 0.2s ease;
            }

            .nav-button:hover {
                background-color: rgba(233, 253, 254, 0.2);
                transform: scale(1.05);
            }

            /* Navbar styling */
            .navbar {
                position: fixed;
                top: 0;
                z-index: 50;
                box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
                padding: 1rem;
            }

            /* Ensure the clock is fixed in the corner */
            #currentDateTime {
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                z-index: 1000;
            }

            .navbar-padding {
                padding-left: 10px;
                /* Adjust the value as needed */
            }

            /* Navbar Links */
            .nav-link {
                padding-bottom: 4px;
                transition: all 0.3s ease;
            }

            .nav-link:hover {
                opacity: 0.8;
            }

            .active-tab {
                border-bottom-width: 2px;
                border-color: white;
            }

            /* ✅ Fade-out efekt rea eemaldamiseks */
            .fade-out {
                opacity: 0;
                transition: opacity 0.5s ease-out;
            }

            /* ✅ Modaalakna stiil */
            #timeline-Container {
                display: block;

                margin: 0px 2;
                padding: 20px;
                border-radius: 12px;
            }
        </style>
        <script>
            // Active Tab Highlighting
            document.addEventListener('DOMContentLoaded', function () {
                const navLinks = document.querySelectorAll('.nav-link');

                function setActiveTab(event) {
                    navLinks.forEach(link => link.classList.remove('border-b-2', 'border-white'));
                    event.target.classList.add('border-b-2', 'border-white');
                }

                navLinks.forEach(link => {
                    link.addEventListener('click', setActiveTab);
                });
            });

            //menetlusliigi nimi
            document.addEventListener("DOMContentLoaded", function () {
                const procedureSelect = document.getElementById("procedureType");
                const procedureLabel = document.getElementById("procedureLabel");

                function updateProcedureLabel() {
                    const selectedOption = procedureSelect.options[procedureSelect.selectedIndex];
                    const optgroup = selectedOption.closest("optgroup"); // Find parent optgroup

                    if (optgroup) {
                        procedureLabel.innerText = `${optgroup.label}`;

                        // Animate fade-in effect
                        gsap.to(procedureLabel, { opacity: 1, y: 5, duration: 0.5, ease: "power2.out" });
                    } else {
                        gsap.to(procedureLabel, { opacity: 0, duration: 0.3 });
                    }
                }

                // Update on selection change
                procedureSelect.addEventListener("change", updateProcedureLabel);

                // Run once on page load to show the initially selected value
                updateProcedureLabel();
            });

            document.addEventListener("DOMContentLoaded", function () {
                function animateProgressBars() {
                    document.querySelectorAll(".progress-bar").forEach(bar => {
                        gsap.to(bar, { width: bar.dataset.progress + "%", duration: 0.3, ease: "power2.out" });
                    });
                }

                function extractStepDays() {
                    return Array.from(document.querySelectorAll('[id^="days-"]')).map((el, index) => {
                        let daysText = el.innerText;
                        let days = parseInt(daysText.match(/\d+/)?.[0] || "0", 10);
                        return { index, element: el, days };
                    });
                }
                function updateTotalDuration() {
                    const totalDurationElement = document.getElementById('totalDuration');
                    if (!totalDurationElement) return;

                    const totalDays = extractStepDays().reduce((sum, step) => sum + step.days, 0);
                    totalDurationElement.innerText = totalDays;

                    updateProgressBars();
                }

                function adjustDays(index, adjustment) {
                    const stepData = extractStepDays().find(step => step.index === index);
                    if (!stepData) return;

                    let newDays = Math.max(0, stepData.days + adjustment);
                    stepData.element.innerText = `${newDays} päeva`;

                    updateTotalDuration(); // Update total duration
                    updateProgressBars();  // Update progress bars dynamically
                    // ✅ Immediately recalculate everything by re-running the main function
                    initializeTimeline();
                }

                function initializeAdjustButtons() {
                    document.querySelectorAll("button[data-adjust]").forEach(button => {
                        button.addEventListener("click", function () {
                            const index = parseInt(this.dataset.index, 10);
                            const adjustment = parseInt(this.dataset.adjust, 10);
                            adjustDays(index, adjustment);
                        });
                    });
                }

                function adjustDays(index, adjustment) {
                    const daysElement = document.getElementById(`days-${index}`);
                    if (!daysElement) {
                        console.error(`Element with id days-${index} not found`);
                        return;
                    }

                    let daysText = daysElement.innerText;
                    let days = parseInt(daysText.match(/\d+/)?.[0] || "0", 10);
                    days = Math.max(0, days + adjustment);
                    daysElement.innerText = `${days} päeva`;

                    // Update total duration and progress bars
                    updateTotalDuration();
                    updateProgressBars();

                    // Update the procurement object if it exists
                    const procurement = savedSearches.find(p => p.name === document.getElementById('name').value);
                    if (procurement) {
                        procurement.procedureDuration = parseInt(document.getElementById('totalDuration').innerText);
                        procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();
                        document.getElementById('requestSubmissionDate').innerText = formatDate(procurement.requestSubmissionDate);
                    }
                }

                document.addEventListener("readystatechange", function () {
                    if (document.readyState === "complete") {
                        console.log("Page fully loaded. Initializing scripts...");
                        initializeAdjustButtons();
                        updateTotalDuration();  // 🔥 Ensures total duration starts correctly
                        updateProgressBars();   // 🔥 Ensures progress bars scale correctly on load

                        requestAnimationFrame(() => {
                            requestAnimationFrame(updateProgressBarsImmediate); // Double RAF for ensuring DOM updates
                        });
                    }
                });
            });
        </script>

        <script>
            function showSuccessAlert(message) {
                const alertBox = document.getElementById("successAlert");
                const alertText = document.getElementById("alertMessage");

                if (!alertBox || !alertText) return;

                alertText.innerText = message;
                alertBox.classList.remove("hidden", "opacity-0", "scale-95");
                alertBox.classList.add("show");

                // Hide alert after 3 seconds
                setTimeout(() => {
                    alertBox.classList.add("hide");
                    setTimeout(() => alertBox.classList.add("hidden"), 500);
                }, 3000);
            }
        </script>

        <!-- Firebase Authentication Logic (Add before closing body tag) -->
        <script type="module">
            import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
            import { getFirestore, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

            // ✅ Firebase initsialiseerimine
            const auth = getAuth();
            const db = getFirestore();

            document.addEventListener("DOMContentLoaded", () => {
                console.log("🚀 Page Loaded - Waiting for login or guest selection.");

                // ✅ Buttons
                const loginButton = document.getElementById("loginButton");
                const registerButton = document.getElementById("registerButton");
                const guestButton = document.getElementById("guestButton");
                const logoutButton = document.getElementById("logoutButton");
                const settingsButton = document.getElementById("settingsButton");
                const showHankedButton = document.getElementById("showSavedSearches");

                // ✅ Sections
                const hankedSection = document.getElementById("savedSearchesContainer");
                const settingsSection = document.getElementById("settingsContainer");
                const adminTab = document.getElementById("adminTab");

                // 🔥 Peidame "Hanked" ja "Seaded" esialgu
                hankedSection?.classList.add("hidden");
                settingsSection?.classList.add("hidden");

                // ✅ "Hanked" nupp laadib andmed Firestore'ist ja kuvab need
                showHankedButton?.addEventListener("click", async () => {
                    console.log("📂 'Hanked' nuppu vajutati, laen Firestore andmed...");
                    await loadUserSearches();
                    // ✅ Uuendame ka lokaalseid hankeid tabelis
                    updateSavedSearchesTable();
                    hankedSection?.classList.remove("hidden");
                });

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("✅ Kasutaja sisse logitud:", user.email);

                        // ✅ Eemaldame hidden klassi, et kuvada menüünupud
                        showHankedButton?.classList.remove("hidden");
                        settingsButton?.classList.remove("hidden");

                        // ✅ Peidame sisselogimisnupud ja kuvame "Logi välja" nupu
                        loginButton?.classList.add("hidden");
                        registerButton?.classList.add("hidden");
                        guestButton?.classList.add("hidden");
                        logoutButton?.classList.remove("hidden");

                        // ✅ Kontrollime Firestore rolli
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            console.log("📜 Firestore roll:", userData.role);

                            if (userData.role === "admin") {
                                adminTab?.classList.remove("hidden");
                            } else {
                                adminTab?.classList.add("hidden");
                            }
                        }
                    } else {
                        console.log("🚫 Kasutaja pole sisse logitud.");

                        // ✅ Peidame "Hanked", "Seaded" ja "Admin" vahelehed
                        showHankedButton?.classList.add("hidden");
                        settingsButton?.classList.add("hidden");
                        adminTab?.classList.add("hidden");

                        // ✅ Kuvame sisselogimisnupud ja peidame "Logi välja" nupu
                        loginButton?.classList.remove("hidden");
                        registerButton?.classList.remove("hidden");
                        guestButton?.classList.remove("hidden");
                        logoutButton?.classList.add("hidden");
                    }
                });

                // 🔥 Logout Button Click Event
                logoutButton?.addEventListener("click", async () => {
                    console.log("🔴 Logging out user...");
                    await signOut(auth);
                    window.location.href = "index.html";
                });

                // ✅ Funktsioon otsingu salvestamiseks Firestore'i
                const saveSearchToFirestore = async (searchData) => {
                    const user = auth.currentUser;
                    if (!user) {
                        showNotification("Andmete salvestamiseks peab olema sisse logitud!", 3000);
                        return;
                    }

                    // Add loading indicator
                    const savingIndicator = document.createElement('div');
                    savingIndicator.id = 'saving-indicator';
                    savingIndicator.className = 'fixed top-4 right-4 bg-white text-blue-500 px-4 py-2 rounded-lg shadow-md z-50';
                    savingIndicator.innerHTML = '<div class="flex items-center"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500 mr-2"></div>Salvestan...</div>';
                    document.body.appendChild(savingIndicator);

                    try {
                        // Add retry logic
                        let retries = 2;
                        let success = false;

                        while (retries >= 0 && !success) {
                            try {
                                await updateDoc(doc(db, "users", user.uid), {
                                    searches: arrayUnion(searchData)
                                });
                                success = true;
                            } catch (error) {
                                retries--;
                                if (retries < 0) throw error;
                                // Wait before retrying
                                await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                        }

                        showNotification("✅ Otsing salvestatud edukalt!", 3000);
                        console.log("✅ Otsing salvestatud Firestore'i:", searchData);
                    } catch (error) {
                        console.error("❌ Otsingu salvestamise viga:", error);
                        showNotification("❌ Otsingu salvestamise viga!", 3000);
                    } finally {
                        // Remove loading indicator
                        if (savingIndicator.parentNode) {
                            savingIndicator.parentNode.removeChild(savingIndicator);
                        }
                    }
                };

                // ✅ Seome otsingu salvestamise "lisa hange tabelisse" nupuga
                document.getElementById('procurementForm').addEventListener('submit', async function (event) {
                    event.preventDefault();

                    const name = document.getElementById('name').value;
                    const cost = parseFloat(document.getElementById('cost').value);
                    const procedureType = document.getElementById('procedureType').value;
                    const contractSigningDate = document.getElementById('contractSigningDate').value;

                    const procurement = new PublicProcurement(name, cost, procedureType, contractSigningDate);
                    procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();

                    // ✅ Värskendame tulemuste kuvamist, kuid EI LISATA HANKED TABELISSE
                    document.getElementById('result').innerHTML = procurement.generateHTML();

                    // ✅ Progressi ja kestuse uuendamine
                    setTimeout(() => {
                        updateTotalDuration();
                        updateProgressBars();
                    }, 100);

                    // ✅ Kuvame tulemuste konteineri
                    document.getElementById('resultContainer').classList.remove('hidden');

                    console.log("✅ Menetlusaeg arvutatud, kuid hange EI LISATUD tabelisse.");
                });
                async function loadUserSearches() {
                    const user = auth.currentUser;
                    if (!user) {
                        console.error("❌ Kasutajat ei leitud, ei saa otsinguid laadida.");
                        return;
                    }

                    try {
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        if (userDoc.exists()) {
                            let searches = userDoc.data().searches || [];
                            console.log("📜 Laetud otsingud Firestore'ist:", searches);

                            // ✅ Kontrollime ja teisendame kuupäevad õigesse formaati
                            searches = searches.map((search, index) => {
                                if (!search.requestSubmissionDate || search.requestSubmissionDate === "Määramata") {
                                    console.warn(`⚠ Otsingul [${index}] puudub requestSubmissionDate, määrame uue.`);
                                    search.requestSubmissionDate = "Määramata";
                                } else if (search.requestSubmissionDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                    // Kui kuupäev on "YYYY-MM-DD", teisendame selle "dd.mm.yyyy"
                                    const [year, month, day] = search.requestSubmissionDate.split("-");
                                    search.requestSubmissionDate = `${day}.${month}.${year}`;
                                }
                                return search;
                            });

                            displaySearches(searches);
                        } else {
                            console.log("❌ Kasutaja dokumenti ei leitud Firestore'ist.");
                        }
                    } catch (error) {
                        console.error("❌ Otsingute laadimise viga:", error);
                    }
                }
                const deleteSearch = async (index) => {
                    const user = auth.currentUser;
                    if (!user) {
                        alert("Kustutamiseks peab olema sisse logitud!");
                        return;
                    }

                    try {
                        const userDocRef = doc(db, "users", user.uid);
                        const userDoc = await getDoc(userDocRef);

                        if (userDoc.exists()) {
                            let searches = userDoc.data().searches || [];

                            if (index < 0 || index >= searches.length) {
                                console.error("❌ Kehtetu indeks:", index);
                                return;
                            }

                            const searchToDelete = searches[index];

                            // 🔍 Kontrollime, milline element kustutatakse
                            console.log("🔴 Enne kustutamist:", searches);
                            console.log("🚨 Kustutame:", searchToDelete);

                            // 🔥 Kustutame Firestore'ist ainult selle konkreetse objekti
                            await updateDoc(userDocRef, {
                                searches: arrayRemove(searchToDelete),
                            });

                            console.log("✅ Otsing kustutatud Firestore'ist:", searchToDelete);

                            // 🔄 Laadime uuesti andmed, et värskendada tabelit
                            await loadUserSearches();
                        }
                    } catch (error) {
                        console.error("❌ Firestore'i kustutamise viga:", error);
                    }
                };

                // ✅ Funktsioon otsingute kuvamiseks tabelis
                function displaySearches(searches) {
                    const container = document.getElementById("savedSearchesTableBody");
                    if (!container) {
                        console.error("❌ Ei leitud tabeli keha: savedSearchesTableBody");
                        return;
                    }

                    console.log("🔎 Kuvan otsingud tabelisse:", searches);
                    container.innerHTML = ""; // ✅ Puhastame tabeli enne lisamist

                    if (searches.length === 0) {
                        container.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">⚠ Ei leitud salvestatud hankeid.</td></tr>`;
                        return;
                    }

                    searches.forEach((search, index) => {
                        container.innerHTML += `
                                <tr class="border-b even:bg-gray-100 hover:bg-gray-200 transition-all">
                                    <td class="p-4">${search.name}</td>
                                    <td class="p-4">${search.procedureType}</td>
                                    <td class="p-4">${search.cost} €</td>
                                    <td class="p-4 text-blue-600 font-semibold">${search.requestSubmissionDate}</td>
                                    <td class="p-4 text-gray-500">${search.contractSigningDate}</td>
                                    <td class="p-4 text-center">
                                        <button onclick="editSearch(${index})" class="bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 transition transform hover:scale-105">✏️ Muuda</button>
                                    </td>
                                    <td class="p-4 text-center">
                                        <button onclick="deleteSearch(${index})" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition transform hover:scale-105">❌ Kustuta</button>
                                    </td>
                                </tr>
                            `;
                    });

                    console.log("✅ Otsingud lisatud tabelisse!");
                };
            });
        </script>

        <script type="module">

            // Listen for authentication state changes
            onAuthStateChanged(auth, (user) => {
                const userEmailElement = document.getElementById("userEmail");
                if (user) {
                    // User is signed in
                    userEmailElement.textContent = user.email;
                    document.getElementById("logoutButton").classList.remove("hidden");
                    document.getElementById("toggleTimelineButton")?.classList.remove("hidden");
                    document.getElementById("sidebarContainer")?.classList.remove("hidden");
                    document.getElementById("userEmail")?.parentElement.classList.remove("hidden");
                } else {
                    // No user signed in
                    userEmailElement.textContent = "Pole sisse logitud";
                    document.getElementById("logoutButton").classList.add("hidden");
                    document.getElementById("toggleTimelineButton")?.classList.add("hidden");
                    document.getElementById("sidebarContainer")?.classList.add("hidden");
                    document.getElementById("userEmail")?.parentElement.classList.add("hidden");
                }
            });

            // Logout function
            document.getElementById("logoutButton").addEventListener("click", async () => {
                try {
                    await signOut(auth);
                    showToast("Oled edukalt välja logitud!", "success");
                    setTimeout(() => {
                        location.reload();
                    }, 2000); // Give time for the user to see the notification
                } catch (error) {
                    showToast("Väljalogimine ebaõnnestus: " + error.message, "error");
                }
            });

            // Change email function
            document.getElementById("changeEmail").addEventListener("click", async () => {
                const newEmail = prompt("Sisesta uus e-post:");
                if (newEmail) {
                    try {
                        await updateEmail(auth.currentUser, newEmail);
                        alert("E-post uuendatud! Logi uuesti sisse.");
                        await signOut(auth);
                        location.reload();
                    } catch (error) {
                        alert("E-posti muutmine ebaõnnestus: " + error.message);
                    }
                }
            });

            // Change password function
            document.getElementById("changePassword").addEventListener("click", async () => {
                const newPassword = prompt("Sisesta uus parool:");
                if (newPassword) {
                    try {
                        await updatePassword(auth.currentUser, newPassword);
                        alert("Parool uuendatud! Logi uuesti sisse.");
                        await signOut(auth);
                        location.reload();
                    } catch (error) {
                        alert("Parooli muutmine ebaõnnestus: " + error.message);
                    }
                }
            });
        </script>

        <script>
            async function loadSidebar() {
                const response = await fetch("sidebar.html");
                const sidebarHtml = await response.text();
                document.getElementById("sidebarContainer").innerHTML = sidebarHtml;

                // ✅ Force Alpine.js to reinitialize for dynamically loaded content
                document.dispatchEvent(new Event("alpine:init"));
            }



            // ✅ Load sidebar and timeline when the page loads
            document.addEventListener("DOMContentLoaded", async () => {
                await loadSidebar();

            });
        </script>

        <style>
            /* Toast notification styles */
            .toast-container {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
            }

            .toast {
                background-color: #b24325;
                color: white;
                padding: 16px 20px;
                border-radius: 8px;
                margin-bottom: 10px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                display: flex;
                align-items: center;
                justify-content: space-between;
                min-width: 250px;
                max-width: 350px;
                opacity: 0;
                transform: translateY(-20px);
                transition: opacity 0.3s, transform 0.3s;
            }

            .toast.show {
                opacity: 1;
                transform: translateY(0);
            }

            .toast-content {
                display: flex;
                align-items: center;
            }

            .toast-icon {
                margin-right: 12px;
                font-size: 20px;
            }

            .toast-close {
                background: none;
                border: none;
                color: white;
                font-size: 16px;
                cursor: pointer;
                padding: 0 5px;
            }

            .toast-error {
                background-color: #f44336;
            }

            .toast-info {
                background-color: #2196F3;
            }
        </style>

        <script type="module">
            // Toast notification function
            function showToast(message, type = 'success') {
                // Create toast container if it doesn't exist
                let container = document.querySelector('.toast-container');
                if (!container) {
                    container = document.createElement('div');
                    container.className = 'toast-container';
                    document.body.appendChild(container);
                }

                // Create toast element
                const toast = document.createElement('div');
                toast.className = `toast ${type === 'error' ? 'toast-error' : type === 'info' ? 'toast-info' : ''}`;

                // Create toast content
                const content = document.createElement('div');
                content.className = 'toast-content';

                // Add icon based on type
                const icon = document.createElement('span');
                icon.className = 'toast-icon';
                if (type === 'success') {
                    icon.innerHTML = '✓';
                } else if (type === 'error') {
                    icon.innerHTML = '✗';
                } else {
                    icon.innerHTML = 'ℹ';
                }
                content.appendChild(icon);

                // Add message
                const text = document.createElement('span');
                text.textContent = message;
                content.appendChild(text);

                toast.appendChild(content);

                // Add close button
                const closeBtn = document.createElement('button');
                closeBtn.className = 'toast-close';
                closeBtn.innerHTML = '×';
                closeBtn.addEventListener('click', () => {
                    toast.remove();
                });
                toast.appendChild(closeBtn);

                // Add to container
                container.appendChild(toast);

                // Show toast with animation
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);

                // Auto remove after 5 seconds
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, 5000);
            }

            // Listen for authentication state changes
            onAuthStateChanged(auth, (user) => {
                const userEmailElement = document.getElementById("userEmail");
                if (user) {
                    // User is signed in
                    userEmailElement.textContent = user.email;
                    document.getElementById("logoutButton").classList.remove("hidden");
                } else {
                    // No user signed in
                    userEmailElement.textContent = "Pole sisse logitud";
                    document.getElementById("logoutButton").classList.add("hidden");
                }
            });

            // Logout function
            document.getElementById("logoutButton").addEventListener("click", async () => {
                try {
                    await signOut(auth);
                    showToast("Oled edukalt välja logitud!", "success");
                    setTimeout(() => {
                        location.reload();
                    }, 2000); // Give time for the user to see the notification
                } catch (error) {
                    showToast("Väljalogimine ebaõnnestus: " + error.message, "error");
                }
            });

            // Change email function
            document.getElementById("changeEmail").addEventListener("click", async () => {
                const newEmail = prompt("Sisesta uus e-post:");
                if (newEmail) {
                    try {
                        await updateEmail(auth.currentUser, newEmail);
                        alert("E-post uuendatud! Logi uuesti sisse.");
                        await signOut(auth);
                        location.reload();
                    } catch (error) {
                        alert("E-posti muutmine ebaõnnestus: " + error.message);
                    }
                }
            });

            // Change password function
            document.getElementById("changePassword").addEventListener("click", async () => {
                const newPassword = prompt("Sisesta uus parool:");
                if (newPassword) {
                    try {
                        await updatePassword(auth.currentUser, newPassword);
                        alert("Parool uuendatud! Logi uuesti sisse.");
                        await signOut(auth);
                        location.reload();
                    } catch (error) {
                        alert("Parooli muutmine ebaõnnestus: " + error.message);
                    }
                }
            });
        </script>


        <style>
            /* Timeline container styles */
            .timeline-container {

                padding: 1rem;
                margin-bottom: 1rem;
                scrollbar-width: thin;
                scrollbar-color: rgba(25, 79, 166, 0.5) rgba(229, 231, 235, 0.5);
            }

            .timeline-container::-webkit-scrollbar {
                width: 8px;
            }

            .timeline-container::-webkit-scrollbar-track {
                background: rgba(229, 231, 235, 0.5);
                border-radius: 10px;
            }

            .timeline-container::-webkit-scrollbar-thumb {
                background-color: rgba(59, 130, 246, 0.5);
                border-radius: 10px;
            }

            /* Animation for current step */
            @keyframes pulse {
                0% {
                    box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
                }

                70% {
                    box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
                }

                100% {
                    box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
                }
            }

            .animate-pulse {
                animation: pulse 2s infinite;
            }
        </style>

        <script>

            // Function to show toast notification
            function showToast(message, event) {
                const toastContainer = document.getElementById("toastContainer");
                const toastMessage = document.getElementById("toastMessage");

                if (!toastContainer || !toastMessage) {
                    console.error("⚠ Error: Toast element not found!");
                    return;
                }

                toastMessage.textContent = message;

                // ✅ Position the toast relative to the clicked button
                if (event) {
                    const buttonRect = event.target.getBoundingClientRect();
                    toastContainer.style.position = "absolute";
                    toastContainer.style.top = `${buttonRect.top + window.scrollY + 40}px`; // Adjust the Y position
                    toastContainer.style.left = `${buttonRect.left + window.scrollX}px`; // Align with button
                }

                toastContainer.classList.remove("hidden");
                toastContainer.classList.add("opacity-100");

                // Hide after 3 seconds
                setTimeout(() => {
                    toastContainer.classList.add("hidden");
                    toastContainer.classList.remove("opacity-100");
                }, 5000);
            }

            // Add event listeners for hover
            const hoverableButton = document.getElementById('hoverableButton');
            hoverableButton.addEventListener('mouseenter', () => {
                showToast('NB! Tegu on üksnes näidis ajakavaga, reaalne ajakava palun pange paika vastavalt enda tööplaanile!');
            });
            hoverableButton.addEventListener('mouseleave', () => {
                const toast = document.getElementById('toastNotification');

            });
        </script>

        <!-- PDF Export functionality -->
        <script>
            // Ensure jsPDF is available
            document.addEventListener('DOMContentLoaded', function () {
                if (typeof window.jspdf === 'undefined') {
                    console.log("Loading jsPDF library...");
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                    script.async = true;
                    script.onload = function () {
                        console.log("jsPDF library loaded successfully");
                    };
                    script.onerror = function () {
                        console.error("Failed to load jsPDF library");
                    };
                    document.head.appendChild(script);
                } else {
                    console.log("jsPDF library already loaded");
                }
            });

            // PDF Export function - This will be called when the PDF button is clicked
            function exportTimelineToPDF() {
                console.log("PDF Export function called");
                try {
                    // Check if jsPDF is loaded
                    if (typeof window.jspdf === 'undefined') {
                        console.log("jsPDF not loaded yet, loading now...");
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                        script.onload = function () {
                            console.log("jsPDF loaded, trying again...");
                            setTimeout(exportTimelineToPDF, 500);
                        };
                        document.head.appendChild(script);
                        return;
                    }

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    // Get timeline data
                    const procurementName = document.getElementById('name').value || "Hankenimi puudub";
                    const contractDate = document.getElementById('contractSigningDate').value || "Kuupäev puudub";
                    const daysToStart = document.getElementById('day-to-start')?.textContent || "N/A";

                    // Add title
                    doc.setFontSize(18);
                    doc.text('Riigihanke ajakava', 105, 20, { align: 'center' });

                    // Add procurement details
                    doc.setFontSize(12);
                    doc.text(`Hanke nimi: ${procurementName}`, 20, 40);
                    doc.text(`Lepingu allkirjastamine: ${contractDate}`, 20, 50);
                    doc.text(`Alustamiseni on jäänud: ${daysToStart} päeva`, 20, 60);

                    // Add timeline steps
                    let yPosition = 80;
                    const steps = document.querySelectorAll('#timeline-steps li, .timeline-step');
                    if (steps.length > 0) {
                        steps.forEach((step, index) => {
                            const stepName = step.querySelector('.title')?.textContent ||
                                step.querySelector('.step-name')?.textContent ||
                                `Etapp ${index + 1}`;

                            const dateText = step.querySelector('.date')?.textContent ||
                                step.querySelector('.step-date-range')?.textContent ||
                                'Kuupäev puudub';

                            // Check if we need a new page
                            if (yPosition > 270) {
                                doc.addPage();
                                yPosition = 20;
                            }

                            doc.setFontSize(12);
                            doc.text(`${index + 1}. ${stepName}`, 20, yPosition);
                            yPosition += 8;

                            doc.setFontSize(10);
                            doc.text(`${dateText}`, 30, yPosition);
                            yPosition += 15;
                        });
                    } else {
                        doc.text("Ajakava etappe ei leitud", 20, yPosition);
                    }

                    // Save the PDF
                    doc.save(`${procurementName}_ajakava.pdf`);
                    console.log("PDF generated successfully");

                    // Show success message
                    const toast = document.createElement('div');
                    toast.style.position = 'fixed';
                    toast.style.bottom = '20px';
                    toast.style.right = '20px';
                    toast.style.backgroundColor = 'rgba(0, 150, 0, 0.8)';
                    toast.style.color = 'white';
                    toast.style.padding = '10px 20px';
                    toast.style.borderRadius = '5px';
                    toast.style.zIndex = '9999';
                    toast.textContent = 'PDF edukalt genereeritud!';
                    document.body.appendChild(toast);

                    setTimeout(() => {
                        toast.style.opacity = '0';
                        setTimeout(() => toast.remove(), 500);
                    }, 3000);

                } catch (error) {
                    console.error("Error generating PDF:", error);
                    alert("PDF genereerimine ebaõnnestus. Viga: " + error.message);
                }
            }
        </script>

    </main>
</body>

</html>