<!doctype html>
<html lang="et">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ostumenetluse kutse - Hankest.ee</title>

  <!-- Only include jsPDF -->
  <script src="../assets/js/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    // Wait for jsPDF to be fully loaded
    window.addEventListener("DOMContentLoaded", function () {
      // Check if jsPDF is already available
      if (typeof window.jspdf !== "undefined") {
        console.log("jsPDF loaded successfully");
        return;
      }

      // Try to initialize jsPDF from the UMD bundle
      if (
        typeof window.jspdf === "undefined" &&
        typeof window.jsPDF !== "undefined"
      ) {
        window.jspdf = { jsPDF: window.jsPDF };
        console.log("jsPDF initialized from window.jsPDF");
      } else {
        console.error(
          "jsPDF not found. Please check if the script is properly loaded.",
        );
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <link href="../dist/output.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/daisyui@5.0.0/themes.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary-color: #6366f1;
      --secondary-color: #4f46e5;
      --accent-color: #8b5cf6;
      --success-color: rgba(34, 197, 94, 0.95);
      --error-color: rgba(239, 68, 68, 0.95);
      --info-color: rgba(59, 130, 246, 0.95);
      --clear-color: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      --warning-color: rgba(249, 115, 22, 0.95);
      font-family: "Inter", sans-serif;
    }

    body {
      background-image: url("../src/tornid_ja_linnamuur_kaupo_kalda_2016.jpg") !important;
      background-size: cover !important;
      background-position: center !important;
      background-attachment: fixed !important;
      background-repeat: no-repeat !important;
      color: var(--text-color) !important;
      font-family: "Inter", sans-serif !important;
      min-height: 100vh !important;
      line-height: 1.6 !important;
    }

    .btn {
      @apply rounded-xl font-semibold transition-all duration-300 transform px-5 py-2.5 focus:outline-none focus:ring-2 focus:ring-opacity-50 backdrop-blur-sm shadow-lg hover:scale-105;
    }

    .btn-primary {
      @apply bg-indigo-600/90 hover:bg-indigo-700/90 text-white focus:ring-indigo-500;
    }

    .btn-success {
      @apply bg-emerald-600/90 hover:bg-emerald-700/90 text-white focus:ring-emerald-500;
    }

    .btn-danger {
      @apply bg-red-500/90 hover:bg-red-600/90 text-white focus:ring-red-400;
    }

    .card {
      background-color: rgba(255, 255, 255, 0.85);
      border-radius: 16px;
      box-shadow:
        0 10px 25px -5px rgba(0, 0, 0, 0.1),
        0 8px 10px -6px rgba(0, 0, 0, 0.1);
      padding: 18px;
      transition: all 0.3s ease;

      backdrop-filter: blur(12px);
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow:
        0 15px 20px -5px rgba(0, 0, 0, 0.1),
        0 8px 10px -6px rgba(0, 0, 0, 0.04);

    }

    .toast-success {
      background-color: var(--success-color);
      @apply shadow-lg rounded-xl shadow-green-500/20;
    }

    .toast-error {
      background-color: var(--error-color);
      @apply shadow-lg rounded-xl shadow-red-500/20;
    }

    .toast-info {
      background-color: var(--info-color);
      @apply shadow-lg rounded-xl shadow-blue-500/20;
    }

    /* New modern notification style for clear actions */
    .toast-clear {
      background-image: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      @apply shadow-lg rounded-xl shadow-indigo-500/30;
    }

    .toast-action-button {
      @apply px-3 py-1 bg-white/20 hover:bg-white/30 rounded-lg text-white text-sm font-medium transition-all duration-200;
    }

    .drag-active {
      border-color: var(--primary-color);
      background-color: #eff6ff;
    }

    input[type="text"],
    textarea {
      @apply bg-white/80 backdrop-blur-sm rounded-xl border-gray-200 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition-all duration-200 text-black shadow-md !important;
    }

    input[type="checkbox"] {
      @apply w-5 h-5 rounded-md text-indigo-600 focus:ring-indigo-500 transition-all duration-200 cursor-pointer;
    }

    .section-header {
      @apply flex items-center p-4 font-semibold cursor-pointer bg-white/60 hover:bg-white/70 backdrop-blur-sm rounded-xl transition-all duration-200 !important;
    }

    .section-content {
      @apply ml-8 mt-4 space-y-4 p-4 bg-white/30 backdrop-blur-sm rounded-xl !important;
    }

    [x-cloak] {
      display: none !important;
    }

    @media print {
      body * {
        visibility: hidden;
      }

      #pdfPreview,
      #pdfPreview * {
        visibility: visible;
      }

      #pdfPreview {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }

    #pdfPreview {
      @apply bg-white/50 backdrop-blur-lg rounded-2xl shadow-xl !important;
    }

    #pdfPreview * {
      @apply text-black !important;
    }

    #pdfPreview .bg-indigo-600 {
      @apply bg-gradient-to-r from-indigo-600 to-indigo-800 backdrop-blur-lg text-white p-6 rounded-t-2xl shadow-md !important;
    }

    #pdfPreview h1,
    #pdfPreview h2,
    #pdfPreview h3 {
      @apply text-white !important;
    }

    .highlight-points li {
      @apply text-black font-semibold mb-3 leading-relaxed !important;
    }

    label {
      @apply text-black font-semibold mb-2 block !important;
    }

    nav {
      @apply bg-white/40 backdrop-blur-xl shadow-lg sticky top-0 z-50 border-b border-white/20 !important;
    }

    .nav-link {
      @apply text-gray-800 hover:text-indigo-600 bg-white/30 hover:bg-white/50 px-4 py-2 rounded-full transition-all text-base !important;
    }

    .file-item {
      @apply flex items-center justify-between bg-white/50 p-2 rounded-lg transition-all duration-200 hover:bg-white/70 backdrop-blur-sm border border-white/20;
    }

    .glassmorphism {
      @apply bg-white/70 backdrop-blur-xl border border-white/20 rounded-xl shadow-lg;
    }

    .hover-scale {
      @apply transition-transform duration-300 hover:scale-105;
    }

    .active-section {
      @apply ring-2 ring-indigo-500 ring-opacity-50;
    }

    @media (max-width: 768px) {
      .card {
        @apply p-4;
      }

      .section-content {
        @apply ml-4;
      }
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut,
      setPersistence,
      browserLocalPersistence,
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      arrayUnion,
      arrayRemove,
      addDoc,
      collection,
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
    import { auth, db } from "../auth/firebase-config.js";

    // Make Firebase objects globally available
    window.auth = auth;
    window.db = db;
    window.onAuthStateChanged = onAuthStateChanged;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword;
    window.signOut = signOut;
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.arrayUnion = arrayUnion;
    window.arrayRemove = arrayRemove;
    window.addDoc = addDoc;
    window.collection = collection;

    // Set persistence to LOCAL
    setPersistence(auth, browserLocalPersistence).catch((error) => {
      console.error("Auth persistence error:", error);
    });

    // Make auth and db available globally
    window.auth = auth;
    window.db = db;

    // Add auth state listener
    onAuthStateChanged(auth, async (user) => {
      console.log("Auth state changed:", user ? "User logged in" : "No user");
      if (user) {
        // User is signed in
        window.currentUser = {
          uid: user.uid,
          email: user.email,
        };
        // Load user data from Firestore
        const userDocRef = doc(db, "users", user.uid);
        const userDoc = await getDoc(userDocRef);

        if (userDoc.exists()) {
          window.userData = userDoc.data();
          console.log("User data loaded:", window.userData);
        } else {
          console.log("No user data found, initializing with defaults");
          window.userData = {
            settings: {},
            pdfHistory: [],
          };
        }
      } else {
        window.currentUser = null;
        window.userData = null;
      }
    });

    // Initialize Alpine.js after auth state is determined
    document.addEventListener("DOMContentLoaded", () => {
      // Wait for auth state to be determined
      const checkAuthState = setInterval(() => {
        if (window.currentUser !== undefined) {
          clearInterval(checkAuthState);
          // Initialize Alpine.js
          Alpine.start();
        }
      }, 100);
    });

    // Make logout function available globally
    window.handleLogout = async () => {
      try {
        // Sign out from Firebase
        await signOut(auth);

        // Clear all authentication related data from localStorage
        localStorage.removeItem("currentUser");
        localStorage.removeItem("rememberedUser");
        localStorage.removeItem("previousPage");

        // Force page reload to reset all state
        window.location.reload();
      } catch (error) {
        console.error("Error signing out:", error);
        // Even if there's an error, try to clear local state and reload
        localStorage.removeItem("currentUser");
        localStorage.removeItem("rememberedUser");
        localStorage.removeItem("previousPage");
        window.location.reload();
      }
    };

    // Check authentication state
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Check if there's a remembered user in localStorage
        const rememberedUser = localStorage.getItem("rememberedUser");
        if (rememberedUser) {
          try {
            const { username, password } = JSON.parse(rememberedUser);
            await signInWithEmailAndPassword(auth, username, password);
            return; // The onAuthStateChanged will be triggered again
          } catch (error) {
            console.error("Auto-login failed:", error);
            localStorage.removeItem("rememberedUser");
          }
        }

        // Show login modal and update state
        const formApp = document.querySelector('[x-data="formApp"]')?.__x;
        if (formApp) {
          formApp.$data.showLoginModal = true;
          formApp.$data.currentUser = null;
          formApp.$data.isAdmin = false;
          formApp.$data.showUserMenu = false;
          formApp.$data.showToast("Palun logi sisse", "info");
        }
      } else {
        // Get user data from Firestore
        const userDocRef = doc(db, "users", user.uid);
        const userDoc = await getDoc(userDocRef);
        const userData = userDoc.data();

        // Update Alpine.js state
        const formApp = document.querySelector('[x-data="formApp"]')?.__x;
        if (formApp) {
          formApp.$data.currentUser = {
            id: user.uid,
            email: user.email,
            ...userData,
          };
          formApp.$data.isAdmin = userData?.isAdmin || false;
          formApp.$data.showLoginModal = false;
          formApp.$data.showToast("Edukalt sisse logitud", "success");
        }

        // Store current user in localStorage
        localStorage.setItem(
          "currentUser",
          JSON.stringify({
            id: user.uid,
            email: user.email,
            isAdmin: userData?.isAdmin || false,
          }),
        );
      }
    });

    // Make login function available globally
    window.handleLogin = async (email, password) => {
      try {
        const userCredential = await signInWithEmailAndPassword(
          auth,
          email,
          password,
        );
        const user = userCredential.user;

        // Get or create user document in Firestore
        const userDocRef = doc(db, "users", user.uid);
        const userDoc = await getDoc(userDocRef);
        if (!userDoc.exists()) {
          // Create new user document
          await setDoc(userDocRef, {
            email: user.email,
            isAdmin: user.email.endsWith("@hankest.ee"),
            createdAt: new Date().toISOString(),
            lastLogin: new Date().toISOString(),
          });
        } else {
          // Update last login
          await setDoc(
            doc(db, "users", user.uid),
            {
              lastLogin: new Date().toISOString(),
            },
            { merge: true },
          );
        }

        // Store user in localStorage
        localStorage.setItem(
          "currentUser",
          JSON.stringify({
            id: user.uid,
            email: user.email,
            isAdmin: user.email.endsWith("@hankest.ee"),
          }),
        );

        return user;
      } catch (error) {
        console.error("Login error:", error);
        throw error;
      }
    };
  </script>

  <script>
    document.addEventListener("alpine:init", () => {
      Alpine.data("formApp", () => {
        const standardFields = [
          {
            key: "buyer",
            label: "Hankija",
            placeholder: "Nimi, aadress, registrikood",
          },
          {
            key: "submission",
            label: "Pakkumise esitamise aeg ja koht",
            placeholder: "nt 10. aprill, e-post",
          },
          {
            key: "validity",
            label: "Pakkumuse jõusoleku aeg",
            placeholder: "nt 30 päeva",
          },
          {
            key: "requirements",
            label: "Nõuded pakkujale",
            placeholder: "nt kogemus 3 aastat",
          },
          {
            key: "criteria",
            label: "Väljavaliku alused",
            placeholder: "Majanduslikult soodsaim",
          },
          { key: "responsible", label: "Vastutav isik", placeholder: "Nimi" },
        ];

        const defaultFields = {};
        standardFields.forEach((field) => {
          defaultFields[field.key] = "";
        });

        return {
          standardFields,
          form: {
            name: "",
            intro:
              'Lisa hankija nimi teeb Teile ettepaneku esitada pakkumus "Lisa ostetav ese/teenus" ostumenetluse kutses sätestatud tingimustele. Ostumenetluse eesmärk on... ',
            fields: { ...defaultFields },
            sections: [
              {
                title: "1. Üldtingimused",
                enabled: true,
                open: false,
                options: [
                  {
                    text: "Ettevõtjatel on õigus küsida kutse kohta selgitusi, esitades küsimused e-posti teel ostumenetluse eest vastutavale isikule. Hankija vastab ettevõtja küsimustele kolme tööpäeva jooksul. Hankija edastab esitatud küsimused ja antud vastused samaaegselt kõigile ettevõtjatele, kellele tehti ettepanek pakkumuse esitamiseks. Telefoni teel esitatud küsimustele ei vastata.",
                    checked: false,
                  },
                  {
                    text: "Hankijal on õigus enne pakkumuste esitamise tähtaega muuta vajadusel kutset. Kutse muutmisel teavitab hankija sellest kõiki ettevõtjaid, kellele on tehtud ettepanek pakkumuste esitamiseks ja edastab ettevõtjatele muudetud kutse. Hankija võib pikendada pakkumuste esitamise tähtaega.",
                    checked: false,
                  },
                  {
                    text: 'Iga viidet, mille hankija teeb kutses mõnele standardile, tehnilisele tunnusele, kontrollsüsteemile, ostuallikale, protsessile, kaubamärgile, patendile, tüübile, päritolule või tootmisviisile, tuleb lugeda selliselt, et see on täiendatud märkega „või sellega samaväärne".',
                    checked: false,
                  },
                  {
                    text: "Hankija ei sõlmi hankelepingut pakkujaga, kellel on maksuvõlg (kohalikud maksud Tallinna linnale ja riiklik maksuvõlg). Enne hankelepingu sõlmimist kontrollib hankija pakkujal maksuvõla puudumist. Kui pakkujal esineb maksuvõlg, siis teavitab hankija sellest pakkujat ja annab pakkujale kaks tööpäeva maksuvõla tasumiseks või täies ulatuses ajatamiseks. Hankija võib anda ka pikema tähtaja maksuvõla tasumiseks või täies ulatuses ajatamiseks. Kui hankija poolt antud tähtaja jooksul pakkuja maksuvõlga ei tasu või täies ulatuses ei ajata, siis kõrvaldab hankija pakkuja ostumenetluselt. ",
                    checked: false,
                  },
                  {
                    text: "Arve maksetähtaeg peab olema vähemalt 21 päeva.",
                    checked: true,
                  },
                ],
              },
              {
                title: "2. Tehniline kirjeldus",
                enabled: true,
                open: false,
                options: [
                  {
                    text: '"Hankija lisab siia tehnilise kirjelduse" - Lisada kas viide eraldi failile kui TK on eraldi või kopeerida siia lihtsalt tehniline kirjeldus teenuse/asja kohta, mida soovitakse osta.',
                    checked: false,
                    editable: true,
                  },
                ],
              },
              {
                title: "3 Nõuded pakkumusele",
                enabled: true,
                open: false,
                options: [
                  {
                    text: "Pakkumus on pakkuja tahteavaldus tellimuse täitmiseks ja on selle esitamisel pakkujale siduv alates esitamisest kuni pakkumuse jõusoleku minimaalse tähtaja lõpuni. Hankijal on õigus teha ettepanek pakkumuse jõusoleku tähtaja pikendamiseks. Tingimusliku pakkumuse esitamine on keelatud.",
                    checked: false,
                  },
                  {
                    text: "Hilinenud pakkumusi hankija vastu ei võta.",
                    checked: false,
                  },
                  {
                    text: "Pakkumus peab sisaldama pakkumuse maksumust vastavalt lisale 1.",
                    checked: false,
                  },
                  {
                    text: "Pakkumus peab sisaldama pakkumuse kirjeldust, mis võimaldab hankijal kontrollida kutse punktis 2 sätestatud tingimustele vastavust.",
                    checked: false,
                  },
                  {
                    text: "Pakkuja kannab kõik pakkumuse ettevalmistamise ja esitamisega seotud kulud ning pakkumuse tähtaegse esitamise riski.",
                    checked: false,
                  },
                  {
                    text: "Pakkumus on konfidentsiaalne kuni tellimuse tegemiseni.",
                    checked: false,
                  },
                  {
                    text: "Pakkuja märgib pakkumuses, milline teave pakkumusest on ärisaladus ning põhjendab ärisaladuseks määramist. Ärisaladusena ei või märkida pakkumuse maksumust (sh osamaksumusi kui need on hindamise aluseks) (RHS § 46 1 ). Kui põhjendust pakkumuses ei sisaldu, siis eeldab hankija, et ärisaladus puudub. Hankija ei avalikusta pakkumuse sisu ärisaladusega kaetud osas.",
                    checked: false,
                  },
                ],
              },
              {
                title:
                  "4 Pakkumuste kontroll, hindamine ja eduka pakkumuse valik",
                enabled: true,
                open: false,
                options: [
                  {
                    text: "Hankija kontrollib tähtaegselt esitatud pakkumuste vastavust kutses esitatud tingimustele. Juhul, kui pakkumus ei vasta kutses esitatud tingimustele, lükkab hankija pakkumuse tagasi.",
                    checked: false,
                  },
                  {
                    text: "Hankijal on õigus küsida pakkujalt esitatud pakkumuse kohta täpsustavaid andmeid ja täpsustavaid selgitusi.",
                    checked: false,
                  },
                  {
                    text: "Kutses esitatud tingimustele vastavate pakkumuste seast valib hankija eduka pakkumuse välja madalaima hinna alusel. Juhul, kui esitatud maksumused on võrdsed, korraldab hankija eduka pakkumuse väljaselgitamiseks liisuheitmise, võimaldades võrdse pakkumuse esitanud pakkujatel liisuheitmise juures viibida.",
                    checked: false,
                  },
                  {
                    text: "Kui edukas pakkuja võtab hankijast mitteolenevatel põhjustel oma pakkumuse tagasi, ei allkirjasta hankija antud tähtaja jooksul hankelepingut või ei asu nõustumuse andmisega sõlmitud hankelepingut pakkujast tulenevatel põhjustel hankija määratud aja jooksul täitma, hindab hankija kõiki ülejäänud pakkumusi uuesti ja tunnistab edukaks pakkumuse, mis on vastavaks tunnistatud pakkumustest majanduslikult soodsaim.",
                    checked: false,
                  },
                  {
                    text: "Hankija ei ole kohustatud korra punktis 4.5 nimetatud alusel pakkumusi uuesti hindama ja võib tunnistada edukaks esialgsel hindamisel leitud järjestuselt teise pakkumuse juhul, kui edukaks tunnistatud pakkumuse äralangemine ei saa mõjutada ülejäänud pakkumuste omavahelist järjestust.",
                    checked: false,
                  },
                ],
              },
              {
                title: "5 Läbirääkimiste pidamine",
                enabled: true,
                open: false,
                options: [
                  {
                    text: "Hankijal on õigus pidada läbirääkimisi esitatud pakkumuse sisu, maksumuse ning ostukutsest sätestatud tingimuste üle.",
                    checked: false,
                  },
                  {
                    text: "Vastavalt läbirääkimiste pidamise vajadusele teatab hankija pakkujatele läbirääkimiste aja. Iga pakkujaga peetakse läbirääkimisi eraldi. Läbirääkimisi võib pidada kirjalikku taasesitamist võimaldavas vormis (nt e-kiri) või suuliselt. Suuliselt peetud läbirääkimised protokollitakse. Läbirääkimised on konfidentsiaalsed. Hankija tagab läbirääkimiste käigus pakkujate võrdse kohtlemise.",
                    checked: false,
                  },
                  {
                    text: "Pärast läbirääkimiste toimumist esitab pakkuja vajadusel uue kohandatud pakkumuse, mis esitatakse läbirääkimistel kokku lepitud tähtajaks.",
                    checked: false,
                  },
                  {
                    text: "Hankija ei ole kohustatud läbirääkimisi pidama.",
                    checked: false,
                  },
                ],
              },
              {
                title:
                  "6 Pakkumuste tagasi lükkamine ja kehtetuks tunnistamine",
                enabled: true,
                open: false,
                options: [
                  {
                    text: "Hankijal on õigus kõik esitatud või kutses toodud tingimustele vastavad pakkumused tagasi lükata igal ajal enne lepingu sõlmimist või tellimuse tegemist, kui esitatud pakkumuste maksumused ületavad eeldatavat maksumust. Hankija teavitab pakkujaid kõigi pakkumuste tagasilükkamisest.",
                    checked: false,
                  },
                  {
                    text: "Kui hankijal on tekkinud vajadus pärast pakkumuste esitamise tähtpäeva kutses esitatud tingimusi olulisel määral muuta või kui ostumenetluse läbiviimise aluseks olevad tingimused on oluliselt muutunud ja seetõttu osutub ostumenetluse esemeks oleva asja või teenuse tellimine mittevajalikuks, saadab hankija pakkujatele sellekohase teavituse.",
                    checked: false,
                  },
                  {
                    text: "Hankija võib ostumenetluse kehtetuks tunnistada, kui hankija tuvastab peale pakkumuste esitamise tähtpäeva, et on teinud ostumenetluse kutses vea, mida ei ole võimalik enam antud etapis seaduspäraselt parandada.",
                    checked: false,
                  },
                ],
              },
              {
                title: "7 Lisad",
                enabled: true,
                open: false,
                options: [
                  { text: "Lisa 1. ", checked: false, editable: true },
                ],
              },
            ],
          },
          today: new Date()
            .toLocaleDateString("et-EE", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
            })
            .replace(/\//g, ".")
            .replace(/(\d+)\.(\d+)\.(\d+)/, "$1.$2.$3"),
          toasts: [],
          files: [],
          isDragging: false,
          isGeneratingPDF: false,
          saveTimeout: null,
          isLoading: false,
          errorMessage: "",
          showError: false,
          isDarkMode: false,
          currentUser: null,
          isAdmin: false,
          showUserMenu: false,
          showLoginModal: false,
          showSettingsModal: false,
          activeTab: "info",
          userSettings: {
            buyer: "",
            submission: "",
            validity: "",
            requirements: "",
            criteria: "",
            responsible: "",
            autofillEnabled: false,
            theme: "indigo",
            font: "Inter",
            buttonStyle: "rounded",
            generatedPdfs: [],
            lastUpdated: null,
          },

          // Add tab switching function
          switchTab(tab) {
            this.activeTab = tab;
            if (tab === "history") {
              this.loadPdfHistory();
            } else if (tab === "basicInfo") {
              this.loadUserSettings();
            }
          },

          // Add function to check if tab is active
          isTabActive(tab) {
            return this.activeTab === tab;
          },

          async init() {
            console.log("Initializing Alpine.js component...");
            this.checkLocalStorage();

            // Check for remembered user
            const rememberedUser = localStorage.getItem("rememberedUser");
            if (rememberedUser) {
              const { username } = JSON.parse(rememberedUser);
              document.getElementById("emailLogin").value = username;
              document.getElementById("rememberMe").checked = true;
            }

            // Check for current user
            const currentUser = localStorage.getItem("currentUser");
            if (currentUser) {
              const userData = JSON.parse(currentUser);
              this.currentUser = userData;
              this.isAdmin = userData.isAdmin;
              this.showLoginModal = false;
            }

            // Initialize Sortable for the sections
            this.$nextTick(() => {
              if (this.$refs.draggableSections) {
                new Sortable(this.$refs.draggableSections, {
                  animation: 150,
                  handle: ".drag-handle",
                  onEnd: (evt) => {
                    const newOrder = Array.from(evt.from.children).map(
                      (child) => {
                        return child.__x.$data.section;
                      },
                    );
                    this.form.sections = newOrder;
                    this.saveToStorage();
                  },
                });
              }
            });

            // Load data from storage initially
            this.loadFromStorage();

            // Wait until user is fully loaded (onAuthStateChanged)
            const waitForAuth = () => {
              return new Promise((resolve) => {
                const check = setInterval(() => {
                  if (window.currentUser) {
                    clearInterval(check);
                    resolve();
                  }
                }, 100);
              });
            };

            await waitForAuth();

            // Lae seaded Firestore'ist
            await this.loadUserSettings();

            // Rakenda autofill, kui lubatud
            if (this.userSettings.autofillEnabled) {
              this.$nextTick(() => {
                console.log("Applying autofill after auth and nextTick...");
                this.applyAutofill();
              });
            }


            // Set up manual watcher for form changes
            this.setupFormWatcher();

            // Auto-hide error messages
            setInterval(() => {
              if (this.showError) {
                this.showError = false;
              }
            }, 5000);



            // Load user settings and PDF history
            await this.loadUserSettings();

            // Listen for user data updates
            window.addEventListener("userDataUpdated", (event) => {
              console.log("Received user data update:", event.detail);
              const { currentUser, userData } = event.detail;
              this.currentUser = currentUser;
              if (userData) {
                window.userData = userData;
                if (userData.pdfHistory) {
                  this.userSettings.generatedPdfs = userData.pdfHistory;
                  console.log(
                    "Updated PDF history in Alpine:",
                    this.userSettings.generatedPdfs,
                  );
                }
              } else {
                window.userData = null;
                this.userSettings.generatedPdfs = [];
              }
            });

            // Set up watchers
            this.watchAutofill();
            this.watchBasicDataFields();
          },

          async loadPdfHistory() {
            try {
              console.log("Loading PDF history in Alpine...");
              if (window.currentUser) {
                console.log("Current user in Alpine:", window.currentUser);
                const { doc, getDoc } = window.firestoreFunctions;
                const userRef = doc(
                  window.db,
                  "users",
                  window.currentUser.uid,
                );
                console.log("User reference:", userRef);

                const userDoc = await getDoc(userRef);
                console.log("User document exists:", userDoc.exists());

                if (userDoc.exists()) {
                  const data = userDoc.data();
                  console.log("Full user data:", data);

                  if (data.pdfHistory && Array.isArray(data.pdfHistory)) {
                    console.log("PDF History array:", data.pdfHistory);
                    this.userSettings.generatedPdfs = data.pdfHistory;
                    // Update global state
                    window.userData = {
                      ...window.userData,
                      pdfHistory: data.pdfHistory,
                    };
                    console.log(
                      "Updated userSettings.generatedPdfs:",
                      this.userSettings.generatedPdfs,
                    );
                  } else {
                    console.log("No PDF history array found in data");
                    this.userSettings.generatedPdfs = [];
                  }
                } else {
                  console.log("No user document found");
                  this.userSettings.generatedPdfs = [];
                }
              } else {
                console.log("No current user found");
                this.userSettings.generatedPdfs = [];
              }
            } catch (error) {
              console.error("Error loading PDF history:", error);
              this.showToast(
                "Viga PDF ajaloo laadimisel: " + error.message,
                "error",
              );
              this.userSettings.generatedPdfs = [];
            }
          },



          async loadUserSettings() {
            try {
              console.log("Loading user settings...");
              if (window.currentUser) {
                console.log("User is logged in, loading from Firestore");
                const userRef = doc(
                  window.db,
                  "users",
                  window.currentUser.uid,
                );
                const userDoc = await getDoc(userRef);

                if (userDoc.exists()) {
                  const userData = userDoc.data();
                  console.log("Loaded user data:", userData);

                  const settings = userData.settings || {}; // <== FIRESTORE salvestab seaded siin!

                  this.userSettings = {
                    buyer: settings.buyer || "",
                    submission: settings.submission || "",
                    validity: settings.validity || "",
                    requirements: settings.requirements || "",
                    criteria: settings.criteria || "",
                    responsible: settings.responsible || "",
                    autofillEnabled: settings.autofillEnabled || false,
                    generatedPdfs: userData.pdfHistory || [],
                  };

                  if (this.userSettings.autofillEnabled) {
                    this.applyAutofill();
                  }

                  console.log("Updated userSettings:", this.userSettings);
                } else {
                  console.log(
                    "No user document found, using default settings",
                  );
                  this.userSettings = {
                    buyer: "",
                    submission: "",
                    validity: "",
                    requirements: "",
                    criteria: "",
                    responsible: "",
                    autofillEnabled: false,
                    theme: "indigo",
                    font: "Inter",
                    buttonStyle: "rounded",
                    generatedPdfs: [],
                    lastUpdated: null,
                  };
                }
              } else {
                console.log(
                  "No user logged in, falling back to localStorage",
                );
                // Fallback to localStorage
                const savedSettings = localStorage.getItem("userSettings");
                if (savedSettings) {
                  const settings = JSON.parse(savedSettings);
                  Object.keys(settings).forEach((key) => {
                    if (this.userSettings.hasOwnProperty(key)) {
                      this.userSettings[key] = settings[key];
                    }
                  });
                }
              }

              console.log("Final userSettings:", this.userSettings);
            } catch (error) {
              console.error("Settings load error:", error);
              this.showToast(
                "Viga seadete laadimisel: " + error.message,
                "error",
              );
            }
          },

          async saveUserSettings() {
            try {
              console.log("Saving user settings...");
              // Apply theme changes immediately
              this.applyTheme();

              // Save to Firestore if logged in
              if (window.currentUser) {
                console.log(
                  "User is logged in, saving to Firestore:",
                  window.currentUser.uid,
                );
                const userRef = doc(
                  window.db,
                  "users",
                  window.currentUser.uid,
                );

                // Create settings object without generatedPdfs
                const settingsToSave = { ...this.userSettings };
                delete settingsToSave.generatedPdfs;
                delete settingsToSave.lastUpdated;

                console.log("Saving to Firestore:", {
                  settings: settingsToSave,
                  pdfHistory: this.userSettings.generatedPdfs,
                  lastUpdated: new Date().toISOString(),
                });

                await setDoc(
                  userRef,
                  {
                    settings: settingsToSave,
                    pdfHistory: this.userSettings.generatedPdfs,
                    lastUpdated: new Date().toISOString(),
                  },
                  { merge: true },
                );

                // Update global state
                if (window.userData) {
                  window.userData.settings = settingsToSave;
                  window.userData.pdfHistory =
                    this.userSettings.generatedPdfs;
                }

                this.showToast("Seaded salvestatud", "success");
              } else {
                console.log("User not logged in, saving to localStorage");
                // Save to localStorage if not logged in
                localStorage.setItem(
                  "userSettings",
                  JSON.stringify(this.userSettings),
                );
                this.showToast("Seaded salvestatud", "success");
              }
            } catch (error) {
              console.error("Settings save error:", error);
              this.showToast(
                "Viga seadete salvestamisel: " + error.message,
                "error",
              );
            }
          },

          async login() {
            const email = document.getElementById("emailLogin").value;
            const password = document.getElementById("passwordLogin").value;
            const rememberMe = document.getElementById("rememberMe").checked;

            try {
              await window.handleLogin(email, password);

              // Handle remember me
              if (rememberMe) {
                localStorage.setItem(
                  "rememberedUser",
                  JSON.stringify({
                    username: email,
                    password: password,
                  }),
                );
              } else {
                localStorage.removeItem("rememberedUser");
              }

              this.showToast("Sisselogimine õnnestus", "success");
              this.showLoginModal = false;
              // Force Alpine.js to update the state
              this.$nextTick(() => {
                this.currentUser = window.auth.currentUser
                  ? {
                    id: window.auth.currentUser.uid,
                    email: window.auth.currentUser.email,
                    isAdmin:
                      window.auth.currentUser.email.endsWith("@hankest.ee"),
                  }
                  : null;
                this.isAdmin = this.currentUser?.isAdmin || false;
              });
            } catch (error) {
              this.showToast(this.getErrorMessage(error.code), "error");
            }
          },

          getErrorMessage(errorCode) {
            const errorMessages = {
              "auth/invalid-email": "Vigane e-posti aadress",
              "auth/user-disabled": "Kasutaja on deaktiveeritud",
              "auth/user-not-found": "Kasutajat ei leitud",
              "auth/wrong-password": "Vale parool",
              "auth/too-many-requests":
                "Liiga palju katsetusi. Palun proovige hiljem uuesti",
              "auth/network-request-failed":
                "Võrgu viga. Palun kontrollige oma internetiühendust",
            };
            return errorMessages[errorCode] || "Sisselogimisel tekkis viga";
          },

          checkLocalStorage() {
            try {
              // Test if localStorage is available
              if (typeof localStorage === "undefined") {
                this.showToast("localStorage ei ole saadaval", "error");
                return false;
              }

              // Test writing and reading
              localStorage.setItem("test", "test");
              if (localStorage.getItem("test") !== "test") {
                this.showToast("localStorage ei tööta korralikult", "error");
                return false;
              }
              localStorage.removeItem("test");

              // Check available space (estimate)
              let totalSize = 0;
              for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                  totalSize += (localStorage[key].length || 0) * 2; // UTF-16 characters = 2 bytes
                }
              }

              const availableSpace = 5 * 1024 * 1024 - totalSize; // 5MB is a common limit
              if (availableSpace < 500000) {
                // If less than 500KB available
                this.showToast(
                  "Hoiatus: localStorage on peaaegu täis",
                  "info",
                );
              }

              return true;
            } catch (error) {
              console.error("localStorage check failed:", error);
              this.showToast(
                "Viga localStorage kontrollimisel: " + error.message,
                "error",
              );
              return false;
            }
          },

          setupFormWatcher() {
            // Watch for changes to form inputs
            document.addEventListener("input", (e) => {
              if (
                e.target.hasAttribute("x-model") ||
                e.target.closest("[x-model]") ||
                e.target.closest("[x-data]")
              ) {
                this.debouncedSave();
              }
            });

            // Also watch for checkbox changes
            document.addEventListener("change", (e) => {
              if (e.target.type === "checkbox") {
                this.debouncedSave();
              }
            });
          },

          get visibleSections() {
            return this.form.sections.filter(
              (s) => s.enabled && s.options.some((o) => o.checked),
            );
          },

          validateForm() {
            if (!this.form.name?.trim()) {
              this.showToast("Palun sisesta ostumenetluse nimi", "error");
              return false;
            }
            if (!this.form.fields?.buyer?.trim()) {
              this.showToast("Palun täida hankija andmed", "error");
              return false;
            }
            return true;
          },

          async generatePDF() {
            try {
              this.isGeneratingPDF = true;
              console.log("Generating PDF...");

              if (!this.validateForm()) return;

              // Check if jsPDF is properly loaded
              if (
                typeof window.jspdf === "undefined" ||
                typeof window.jspdf.jsPDF === "undefined"
              ) {
                if (typeof window.jsPDF !== "undefined") {
                  window.jspdf = { jsPDF: window.jsPDF };
                } else {
                  throw new Error("jsPDF not properly loaded");
                }
              }

              const { jsPDF } = window.jspdf;
              const doc = new jsPDF("p", "mm", "a4");

              // Add header with logo and title
              doc.setFillColor(79, 70, 229); // Indigo color
              doc.rect(0, 0, 210, 30, "F");
              doc.setTextColor(255, 255, 255);
              doc.setFontSize(24);
              doc.setFont(undefined, "bold");
              doc.text(this.form.name || "Ostumenetluse kutse", 105, 20, {
                align: "center",
              });

              // Add intro text with modern styling
              doc.setFontSize(11);
              doc.setTextColor(0, 0, 0);
              let yPos = 40;
              const introLines = doc.splitTextToSize(this.form.intro, 170);
              doc.text(introLines, 20, yPos);
              yPos += introLines.length * 6 + 10;

              // Add standard fields with modern styling
              doc.setFontSize(11);
              this.standardFields.forEach((field) => {
                const fieldValue = this.form.fields[field.key] || "";
                if (fieldValue.trim() !== "") {
                  // Add field label with background
                  doc.setFillColor(243, 244, 246); // Light gray background
                  doc.rect(20, yPos - 2, 170, 6, "F");

                  doc.setFont(undefined, "bold");
                  doc.setTextColor(79, 70, 229); // Indigo color for labels
                  doc.text(`${field.label}: `, 22, yPos);
                  const textWidth = doc.getTextWidth(`${field.label}: `);

                  doc.setFont(undefined, "normal");
                  doc.setTextColor(0, 0, 0);
                  const valueLines = doc.splitTextToSize(fieldValue, 150);
                  doc.text(valueLines, 22 + textWidth, yPos);

                  yPos += valueLines.length * 6 + 4;
                }
              });

              // Add sections with modern styling
              let sectionNumber = 1;
              this.visibleSections.forEach((section) => {
                yPos += 5;

                // Section title with modern styling
                doc.setFontSize(14);
                doc.setFont(undefined, "bold");
                doc.setTextColor(79, 70, 229); // Indigo color for section titles
                const originalTitle = section.title;
                const newTitle = `${sectionNumber} ${originalTitle.split(" ").slice(1).join(" ")}`;

                // Add underline for section title
                doc.text(newTitle, 20, yPos);
                doc.setLineWidth(0.5);
                doc.line(20, yPos + 1, 190, yPos + 1);

                yPos += 10;

                // Section options with modern styling
                doc.setFontSize(11);
                doc.setFont(undefined, "normal");
                doc.setTextColor(0, 0, 0);

                section.options
                  .filter((o) => o.checked)
                  .forEach((opt, i) => {
                    const optionText = `${sectionNumber}.${i + 1} ${opt.text}`;
                    const optLines = doc.splitTextToSize(optionText, 160);

                    // Add bullet point with custom styling
                    doc.setFillColor(79, 70, 229);

                    doc.text(optLines, 25, yPos);

                    // Calculate total height needed for this option
                    const optionHeight = optLines.length * 5; // Reduced from 6 to 5
                    yPos += optionHeight + 2; // Reduced spacing from 5 to 2

                    // Check if we need a new page
                    if (yPos > 270) {
                      doc.addPage();
                      yPos = 20;
                    }
                  });

                sectionNumber++;
              });

              // Add footer with modern styling
              yPos = Math.min(yPos + 10, 270); // Reduced from 15 to 10
              doc.setLineWidth(0.5);
              doc.line(20, yPos, 190, yPos);
              yPos += 10;

              doc.setFontSize(10);
              doc.setFont(undefined, "bold");
              doc.setTextColor(79, 70, 229);
              doc.text(`Kuupäev: ${this.today}`, 20, yPos);
              yPos += 6;
              doc.text(
                `Vastutav isik: ${this.form.fields.responsible || ""}`,
                20,
                yPos,
              );

              // Add attachments with modern styling
              if (this.files?.length > 0) {
                yPos += 10;
                doc.setFontSize(12);
                doc.setFont(undefined, "bold");
                doc.setTextColor(79, 70, 229);
                doc.text("Manused:", 20, yPos);
                yPos += 5;

                doc.setFontSize(10);
                doc.setFont(undefined, "normal");
                doc.setTextColor(0, 0, 0);
                this.files.forEach((file, i) => {
                  // Add file icon
                  doc.setFillColor(79, 70, 229);
                  doc.rect(22, yPos - 1, 1.5, 1.5, "F");
                  doc.text(
                    `${i + 1}. ${file.name} (${this.formatFileSize(file.size)}) ${file.comment || ""}`,
                    25,
                    yPos,
                  );
                  yPos += 6;
                });
              }

              // Save the PDF
              const pdfName = `${this.form.name || "ostumenetlus"}.pdf`;
              const pdfData = doc.output("datauristring");

              // Save PDF to Firestore if user is logged in
              if (window.currentUser) {
                console.log("User is logged in, saving PDF to Firestore");
                // Use the functions directly from window object
                const userRef = window.doc(
                  window.db,
                  "users",
                  window.currentUser.uid,
                );

                const pdfEntry = {
                  id: Date.now().toString(),
                  name: `${this.form.name || "Pakkumus"}_${new Date().toLocaleDateString("et-EE")}.pdf`,
                  pdfData: pdfData,
                  createdAt: new Date().toISOString(),
                  responsible: this.form.fields.responsible || "",
                  submissionDate: this.form.fields.submission || "",
                };

                console.log("Saving PDF entry:", pdfEntry);

                // Get current user data
                const userDoc = await window.getDoc(userRef);
                const currentData = userDoc.exists() ? userDoc.data() : {};
                const currentPdfHistory = currentData.pdfHistory || [];

                console.log("Current PDF history:", currentPdfHistory);

                // Add new PDF and keep only last 10
                const updatedPdfHistory = [
                  pdfEntry,
                  ...currentPdfHistory,
                ].slice(0, 10);

                console.log("Updated PDF history:", updatedPdfHistory);

                // Update Firestore
                await window.setDoc(
                  userRef,
                  {
                    pdfHistory: updatedPdfHistory,
                    lastUpdated: new Date().toISOString(),
                  },
                  { merge: true },
                );

                // Update global state
                window.userData = {
                  ...window.userData,
                  pdfHistory: updatedPdfHistory,
                  lastUpdated: new Date().toISOString(),
                };

                // Update local state
                this.userSettings.generatedPdfs = updatedPdfHistory;

                console.log("PDF saved to Firestore successfully");
              } else {
                console.log("No user logged in, not saving PDF to Firestore");
              }

              // Download the PDF
              doc.save(pdfName);

              this.showToast("PDF edukalt loodud", "success");
            } catch (error) {
              console.error("PDF generation error:", error);
              this.showToast(
                "Viga PDF genereerimisel: " + error.message,
                "error",
              );
            } finally {
              this.isGeneratingPDF = false;
            }
          },

          debouncedSave() {
            if (this.saveTimeout) {
              clearTimeout(this.saveTimeout);
            }
            this.saveTimeout = setTimeout(() => {
              this.saveToStorage();
            }, 2000);
          },

          saveToStorage() {
            try {
              localStorage.setItem('OM_DRAFT', JSON.stringify(this.form));
              console.log('Form saved to localStorage');
            } catch (error) {
              console.error('Error saving to localStorage:', error);
            }
          },

          loadFromStorage() {
            try {
              const raw = localStorage.getItem("OM_DRAFT");
              if (!raw) {
                console.log("No saved data found in localStorage");
                return false;
              }

              const data = JSON.parse(raw);
              if (data.version === "1.4" && data.form) {
                console.log("Loading saved form data:", data.form);

                // Create a fresh default form
                const freshDefaultFields = {};
                this.standardFields.forEach((field) => {
                  freshDefaultFields[field.key] = "";
                });

                // Apply saved data to the form
                this.form = {
                  name: data.form.name || "",
                  intro:
                    data.form.intro ||
                    'Lisa hankija nimi teeb Teile ettepaneku esitada pakkumus "Lisa ostetav ese/teenus" ostumenetluse kutses sätestatud tingimustele. Ostumenetluse eesmärk on... ',
                  fields: {
                    ...freshDefaultFields,
                    ...(data.form.fields || {}),
                  },
                  sections: data.form.sections || this.form.sections,
                };

                // Load files if present
                if (
                  data.files &&
                  Array.isArray(data.files) &&
                  data.files.length > 0
                ) {
                  this.files = data.files;
                }

                this.showToast("Laaditud salvestatud andmed", "success");
                return true;
              } else {
                console.warn(
                  "Incompatible data version or missing form data",
                );
                localStorage.removeItem("OM_DRAFT");
                this.showToast(
                  "Vana versiooni andmed, algandmed laetud",
                  "info",
                );
                return false;
              }
            } catch (error) {
              console.error(
                "Failed to load from storage:",
                error,
                error.stack,
              );
              localStorage.removeItem("OM_DRAFT");
              this.showToast(
                "Viga andmete laadimisel: " + error.message,
                "error",
              );
              return false;
            }
          },

          manualSave() {
            // This is called directly from the save button click
            clearTimeout(this.saveTimeout); // Clear any pending save
            const success = this.saveToStorage();
            if (success) {
              this.showToast("Andmed edukalt salvestatud!", "success");
            }
          },

          addAttachment() {
            const lisaCount = this.form.sections[6].options.length + 1;
            this.form.sections[6].options.push({
              text: `Lisa ${lisaCount}. `,
              checked: false,
              editable: true,
            });
            this.showToast("Lisa lisatud", "success");
          },

          addNewSection() {
            this.newSectionTitle = '';
            this.showNewSectionModal = true;
          },

          handleNewSection() {
            const rawTitle = this.newSectionTitle.trim();

            if (!rawTitle) {
              this.showToast("Pealkiri jäi sisestamata", "error");
              return;
            }

            const nextNum = this.form.sections.length + 1;
            const title = `${nextNum}. ${rawTitle}`;

            this.form.sections.push({
              title,
              enabled: false,
              open: true,
              options: [
                {
                  text: "Lisa tingimus",
                  checked: false,
                  editable: true,
                  isEditing: true,
                },
              ],
            });

            this.showToast("Uus tingimus lisatud", "success");
            this.showNewSectionModal = false;
          },

          toggleAllSections() {
            const hasClosedSections = this.form.sections.some(
              (section) => !section.open,
            );
            this.form.sections.forEach((section) => {
              section.open = hasClosedSections;
            });
            this.showToast(
              hasClosedSections
                ? "Kõik avatud"
                : "Kõik suletud",
              "success",
            );
          },

          selectAllOptions() {
            const hasUncheckedOptions = this.form.sections.some((section) =>
              section.options.some((option) => !option.checked),
            );

            this.form.sections.forEach((section) => {
              section.enabled = true;
              section.options.forEach((option) => {
                option.checked = hasUncheckedOptions;
              });
            });
            this.showToast(
              hasUncheckedOptions
                ? "Kõik valikud valitud"
                : "Kõik valikud eemaldatud",
              "success",
            );
          },

          showToast(message, type = "info", duration = 3000) {
            const toast = {
              id: Date.now(),
              message,
              type,
              duration,
            };
            this.toasts.push(toast);
            setTimeout(() => {
              this.toasts = this.toasts.filter((t) => t.id !== toast.id);
            }, duration);
          },

          // New function for showing toast with action
          showActionToast(
            message,
            type = "clear",
            duration = 6000,
            actionText = null,
            actionCallback = null,
          ) {
            console.log("Showing action toast:", {
              message,
              type,
              duration,
              actionText,
            });

            // Force gradient styles for clear toasts
            if (type === "clear") {
              document.documentElement.style.setProperty(
                "--clear-color",
                "linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%)",
              );
            }

            const toast = {
              id: Date.now(),
              message,
              type,
              duration,
              actionText,
              actionCallback,
            };

            this.toasts.push(toast);
            console.log("Current toasts:", this.toasts);

            setTimeout(() => {
              this.toasts = this.toasts.filter((t) => t.id !== toast.id);
            }, duration);
          },

          handleDragOver(e) {
            e.preventDefault();
            this.isDragging = true;
          },

          handleDragLeave() {
            this.isDragging = false;
          },

          handleDrop(e) {
            e.preventDefault();
            this.isDragging = false;
            const files = Array.from(e.dataTransfer.files);
            this.processFiles(files);
          },

          handleFileInput(e) {
            const files = Array.from(e.target.files);
            this.processFiles(files);
            e.target.value = ""; // Reset input
          },

          processFiles(files) {
            const maxFileSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = [
              "application/pdf",
              "image/jpeg",
              "image/png",
              "image/gif",
            ];

            Array.from(files).forEach((file) => {
              if (file.size > maxFileSize) {
                this.showToast(
                  `Fail ${file.name} on liiga suur. Maksimaalne suurus on 10MB.`,
                  "error",
                );
                return;
              }

              if (!allowedTypes.includes(file.type)) {
                this.showToast(
                  `Fail ${file.name} on sobimatu tüüp. Lubatud on PDF ja pildifailid.`,
                  "error",
                );
                return;
              }

              const reader = new FileReader();
              reader.onload = (e) => {
                this.files.push({
                  name: file.name,
                  size: file.size,
                  type: file.type,
                  data: e.target.result,
                  comment: "",
                });
                this.showToast("Fail lisatud", "success");
              };
              reader.onerror = () => {
                this.showToast(
                  `Faili ${file.name} lugemisel tekkis viga`,
                  "error",
                );
              };
              reader.readAsDataURL(file);
            });
          },

          removeFile(index) {
            const fileName = this.files[index].name;
            this.files.splice(index, 1);
            this.showToast(`Fail ${fileName} eemaldatud`, "info");
          },

          formatFileSize(bytes) {
            if (bytes === 0) return "0 Bytes";
            const k = 1024;
            const sizes = ["Bytes", "KB", "MB", "GB"];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (
              parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]
            );
          },

          resetForm() {
            this.showResetConfirmModal = true;
          },

          handleResetConfirm() {
            // Reset to default form structure
            this.form = {
              name: "",
              intro:
                "(Lisa hankija nimi) teeb Teile ettepaneku esitada pakkumus (Lisa ostetava eseme/teenuse nimi ja kirjeldus) ostumenetluse kutses sätestatud tingimustele. Ostumenetluse eesmärk on (täpsusta kas lepingu sõlmimine või tellimuse tegemine)",
              fields: { ...defaultFields },
              sections: [
                {
                  title: "1. Üldised tingimused",
                  enabled: true,
                  open: false,
                  options: [
                    {
                      text: "Ettevõtjatel on õigus küsida kutse kohta selgitusi, esitades küsimused e-posti teel ostumenetluse eest vastutavale isikule. Hankija vastab ettevõtja küsimustele kolme tööpäeva jooksul. Hankija edastab esitatud küsimused ja antud vastused samaaegselt kõigile ettevõtjatele, kellele tehti ettepanek pakkumuse esitamiseks. Telefoni teel esitatud küsimustele ei vastata.",
                      checked: false,
                    },
                    {
                      text: "Hankijal on õigus enne pakkumuste esitamise tähtaega muuta vajadusel kutset. Kutse muutmisel teavitab hankija sellest kõiki ettevõtjaid, kellele on tehtud ettepanek pakkumuste esitamiseks ja edastab ettevõtjatele muudetud kutse. Hankija võib pikendada pakkumuste esitamise tähtaega.",
                      checked: false,
                    },
                    {
                      text: 'Iga viidet, mille hankija teeb kutses mõnele standardile, tehnilisele tunnusele, kontrollsüsteemile, ostuallikale, protsessile, kaubamärgile, patendile, tüübile, päritolule või tootmisviisile, tuleb lugeda selliselt, et see on täiendatud märkega „või sellega samaväärne".',
                      checked: false,
                    },
                    {
                      text: "Hankija ei sõlmi hankelepingut pakkujaga, kellel on maksuvõlg (kohalikud maksud Tallinna linnale ja riiklik maksuvõlg). Enne hankelepingu sõlmimist kontrollib hankija pakkujal maksuvõla puudumist. Kui pakkujal esineb maksuvõlg, siis teavitab hankija sellest pakkujat ja annab pakkujale kaks tööpäeva maksuvõla tasumiseks või täies ulatuses ajatamiseks. Hankija võib anda ka pikema tähtaja maksuvõla tasumiseks või täies ulatuses ajatamiseks. Kui hankija poolt antud tähtaja jooksul pakkuja maksuvõlga ei tasu või täies ulatuses ei ajata, siis kõrvaldab hankija pakkuja ostumenetluselt. ",
                      checked: false,
                    },
                    {
                      text: "Arve maksetähtaeg peab olema vähemalt 21 päeva.",
                      checked: true,
                    },
                  ],
                },
                {
                  title: "2. Ostumenetluse tehniline kirjeldus",
                  enabled: true,
                  open: false,
                  options: [
                    {
                      text: '"Hankija lisab siia tehnilise kirjelduse" - Lisada kas viide eraldi failile kui TK on eraldi või kopeerida siia lihtsalt tehniline kirjeldus teenuse/asja kohta, mida soovitakse osta.',
                      checked: false,
                      editable: true,
                    },
                  ],
                },
                {
                  title: "3. Nõuded pakkumusele",
                  enabled: true,
                  open: false,
                  options: [
                    {
                      text: "Pakkumus on pakkuja tahteavaldus tellimuse täitmiseks ja on selle esitamisel pakkujale siduv alates esitamisest kuni pakkumuse jõusoleku minimaalse tähtaja lõpuni. Hankijal on õigus teha ettepanek pakkumuse jõusoleku tähtaja pikendamiseks. Tingimusliku pakkumuse esitamine on keelatud.",
                      checked: false,
                    },
                    {
                      text: "Hilinenud pakkumusi hankija vastu ei võta.",
                      checked: false,
                    },
                    {
                      text: "Pakkumus peab sisaldama pakkumuse maksumust vastavalt lisale 1.",
                      checked: false,
                    },
                    {
                      text: "Pakkumus peab sisaldama pakkumuse kirjeldust, mis võimaldab hankijal kontrollida kutse punktis 2 sätestatud tingimustele vastavust.",
                      checked: false,
                    },
                    {
                      text: "Pakkuja kannab kõik pakkumuse ettevalmistamise ja esitamisega seotud kulud ning pakkumuse tähtaegse esitamise riski.",
                      checked: false,
                    },
                    {
                      text: "Pakkumus on konfidentsiaalne kuni tellimuse tegemiseni.",
                      checked: false,
                    },
                    {
                      text: "Pakkuja märgib pakkumuses, milline teave pakkumusest on ärisaladus ning põhjendab ärisaladuseks määramist. Ärisaladusena ei või märkida pakkumuse maksumust (sh osamaksumusi kui need on hindamise aluseks) (RHS § 46 1 ). Kui põhjendust pakkumuses ei sisaldu, siis eeldab hankija, et ärisaladus puudub. Hankija ei avalikusta pakkumuse sisu ärisaladusega kaetud osas.",
                      checked: false,
                    },
                  ],
                },
                {
                  title:
                    "4. Pakkumuste kontroll, hindamine ja eduka pakkumuse valik",
                  enabled: true,
                  open: false,
                  options: [
                    {
                      text: "Hankija kontrollib tähtaegselt esitatud pakkumuste vastavust kutses esitatud tingimustele. Juhul, kui pakkumus ei vasta kutses esitatud tingimustele, lükkab hankija pakkumuse tagasi.",
                      checked: false,
                    },
                    {
                      text: "Hankijal on õigus küsida pakkujalt esitatud pakkumuse kohta täpsustavaid andmeid ja täpsustavaid selgitusi.",
                      checked: false,
                    },
                    {
                      text: "Kutses esitatud tingimustele vastavate pakkumuste seast valib hankija eduka pakkumuse välja madalaima hinna alusel. Juhul, kui esitatud maksumused on võrdsed, korraldab hankija eduka pakkumuse väljaselgitamiseks liisuheitmise, võimaldades võrdse pakkumuse esitanud pakkujatel liisuheitmise juures viibida.",
                      checked: false,
                    },
                    {
                      text: "Kui edukas pakkuja võtab hankijast mitteolenevatel põhjustel oma pakkumuse tagasi, ei allkirjasta hankija antud tähtaja jooksul hankelepingut või ei asu nõustumuse andmisega sõlmitud hankelepingut pakkujast tulenevatel põhjustel hankija määratud aja jooksul täitma, hindab hankija kõiki ülejäänud pakkumusi uuesti ja tunnistab edukaks pakkumuse, mis on vastavaks tunnistatud pakkumustest majanduslikult soodsaim.",
                      checked: false,
                    },
                    {
                      text: "Hankija ei ole kohustatud korra punktis 4.5 nimetatud alusel pakkumusi uuesti hindama ja võib tunnistada edukaks esialgsel hindamisel leitud järjestuselt teise pakkumuse juhul, kui edukaks tunnistatud pakkumuse äralangemine ei saa mõjutada ülejäänud pakkumuste omavahelist järjestust.",
                      checked: false,
                    },
                  ],
                },
                {
                  title: "5. Läbirääkimiste pidamine",
                  enabled: true,
                  open: false,
                  options: [
                    {
                      text: "Hankijal on õigus pidada läbirääkimisi esitatud pakkumuse sisu, maksumuse ning ostukutsest sätestatud tingimuste üle.",
                      checked: false,
                    },
                    {
                      text: "Vastavalt läbirääkimiste pidamise vajadusele teatab hankija pakkujatele läbirääkimiste aja. Iga pakkujaga peetakse läbirääkimisi eraldi. Läbirääkimisi võib pidada kirjalikku taasesitamist võimaldavas vormis (nt e-kiri) või suuliselt. Suuliselt peetud läbirääkimised protokollitakse. Läbirääkimised on konfidentsiaalsed. Hankija tagab läbirääkimiste käigus pakkujate võrdse kohtlemise.",
                      checked: false,
                    },
                    {
                      text: "Pärast läbirääkimiste toimumist esitab pakkuja vajadusel uue kohandatud pakkumuse, mis esitatakse läbirääkimistel kokku lepitud tähtajaks.",
                      checked: false,
                    },
                    {
                      text: "Hankija ei ole kohustatud läbirääkimisi pidama.",
                      checked: false,
                    },
                  ],
                },
                {
                  title:
                    "6. Pakkumuste tagasi lükkamine ja kehtetuks tunnistamine",
                  enabled: true,
                  open: false,
                  options: [
                    {
                      text: "Hankijal on õigus kõik esitatud või kutses toodud tingimustele vastavad pakkumused tagasi lükata igal ajal enne lepingu sõlmimist või tellimuse tegemist, kui esitatud pakkumuste maksumused ületavad eeldatavat maksumust. Hankija teavitab pakkujaid kõigi pakkumuste tagasilükkamisest.",
                      checked: false,
                    },
                    {
                      text: "Kui hankijal on tekkinud vajadus pärast pakkumuste esitamise tähtpäeva kutses esitatud tingimusi olulisel määral muuta või kui ostumenetluse läbiviimise aluseks olevad tingimused on oluliselt muutunud ja seetõttu osutub ostumenetluse esemeks oleva asja või teenuse tellimine mittevajalikuks, saadab hankija pakkujatele sellekohase teavituse.",
                      checked: false,
                    },
                    {
                      text: "Hankija võib ostumenetluse kehtetuks tunnistada, kui hankija tuvastab peale pakkumuste esitamise tähtpäeva, et on teinud ostumenetluse kutses vea, mida ei ole võimalik enam antud etapis seaduspäraselt parandada.",
                      checked: false,
                    },
                  ],
                },
                {
                  title: "7. Lisad",
                  enabled: true,
                  open: false,
                  options: [
                    { text: "Lisa 1. ", checked: false, editable: true },
                  ],
                },
              ],
            };

            // Clear files
            this.files = [];

            // Remove from local storage
            localStorage.removeItem("OM_DRAFT");

            // Close modal
            this.showResetConfirmModal = false;

            // Show success messages
            this.showToast("Vorm on tühjendatud ✅", "success");
            this.showActionToast(
              "Vorm on tühjendatud",
              "clear",
              5000,
              "",
              () => {
                this.showToast("Andmeid ei saa taastada", "info");
              }
            );
          },

          addOption(sectionIndex) {
            const section = this.form.sections[sectionIndex];
            const optionCount = section.options.length + 1;

            let newOption;
            if (sectionIndex === 6) {
              // Lisad section
              newOption = {
                text: `Lisa ${optionCount}. `,
                checked: false,
                editable: true,
                isEditing: true,
              };
            } else if (sectionIndex === 0) {
              // Üldised tingimused section
              newOption = {
                text: `${optionCount}. `,
                checked: false,
                checked: true,
                editable: true,
                isEditing: true,
              };
            } else {
              // Other sections
              newOption = {
                text: `${optionCount}. `,
                checked: false,
                editable: true,
                isEditing: true,
              };
            }

            section.options.push(newOption);
            this.showToast("Punkt lisatud", "success");
          },

          toggleUserMenu() {
            if (this.currentUser) {
              this.showUserMenu = !this.showUserMenu;
            }
          },

          logout() {
            window.handleLogout();
          },

          applyTheme() {
            // Apply current theme settings to the UI
            const html = document.documentElement;

            // Apply font setting
            if (this.userSettings.font) {
              html.style.fontFamily = this.userSettings.font;
            }

            // Apply button style
            // This would normally be implemented with CSS classes or custom properties

            // You could also change gradient colors based on theme
            const gradientElements =
              document.querySelectorAll(".bg-gradient-to-r");
            const theme = this.userSettings.theme;

            gradientElements.forEach((el) => {
              el.classList.remove(
                "from-indigo-600",
                "to-indigo-700",
                "from-blue-600",
                "to-blue-700",
                "from-emerald-600",
                "to-emerald-700",
                "from-purple-600",
                "to-purple-700",
              );

              switch (theme) {
                case "indigo":
                  el.classList.add("from-indigo-600", "to-indigo-700");
                  break;
                case "blue":
                  el.classList.add("from-blue-600", "to-blue-700");
                  break;
                case "emerald":
                  el.classList.add("from-emerald-600", "to-emerald-700");
                  break;
                case "purple":
                  el.classList.add("from-purple-600", "to-purple-700");
                  break;
                default:
                  el.classList.add("from-indigo-600", "to-indigo-700");
              }
            });
          },

          applyAutofill() {
            console.log("Applying autofill settings");
            const updatedFields = { ...this.form.fields };
            if (this.userSettings.buyer)
              updatedFields.buyer = this.userSettings.buyer;
            if (this.userSettings.submission)
              updatedFields.submission = this.userSettings.submission;
            if (this.userSettings.validity)
              updatedFields.validity = this.userSettings.validity;
            if (this.userSettings.requirements)
              updatedFields.requirements = this.userSettings.requirements;
            if (this.userSettings.criteria)
              updatedFields.criteria = this.userSettings.criteria;
            if (this.userSettings.responsible)
              updatedFields.responsible = this.userSettings.responsible;
            this.form.fields = updatedFields;
            console.log("Autofill applied:", updatedFields);
          },

          // Add watcher for autofill toggle
          watchAutofill() {
            this.$watch("userSettings.autofillEnabled", (value) => {
              console.log("Autofill toggled:", value);
              if (value) {
                this.applyAutofill();
              }
            });
          },

          // Add watchers for basic data fields
          watchBasicDataFields() {
            const fields = [
              "buyer",
              "submission",
              "validity",
              "requirements",
              "criteria",
              "responsible",
            ];
            fields.forEach((field) => {
              this.$watch(`userSettings.${field}`, (value) => {
                console.log(`${field} changed:`, value);
                if (this.userSettings.autofillEnabled) {
                  this.applyAutofill();
                }
              });
            });
          },

          // Add function to download saved PDF
          async downloadSavedPdf(pdfData, fileName) {
            try {
              const link = document.createElement("a");
              link.href = pdfData;
              link.download = fileName;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            } catch (error) {
              this.showToast(
                "Viga PDF allalaadimisel: " + error.message,
                "error",
              );
            }
          },

          async saveToFirestoreDraft() {
            if (!window.currentUser) return;

            try {
              const userRef = doc(window.db, "users", window.currentUser.uid);
              await setDoc(userRef, { draft: this.form }, { merge: true });
              console.log("Form draft saved to Firestore");
            } catch (error) {
              console.error("Error saving draft to Firestore:", error);
            }
          },

          // Function to send PDF via Outlook
          async sendPdfToOutlook(pdfData, fileName) {
            try {
              // First, we need to download the file to make it available for attachment
              const link = document.createElement("a");
              link.href = pdfData;
              link.download = fileName;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);

              // Create mailto link for Outlook
              const subject = encodeURIComponent(
                `${this.form.name || "Ostumenetluse kutse"}`,
              );
              const body = encodeURIComponent(
                `Tere,\n\nLisan manusesse ostumenetluse kutse.\n\nLugupidamisega,\n${this.form.fields.responsible || ""}`,
              );

              // Open Outlook with new email
              window.location.href = `mailto:?subject=${subject}&body=${body}`;

              this.showToast("Outlook avatud uue e-kirjaga", "success");
            } catch (error) {
              this.showToast(
                "Viga e-kirja koostamisel: " + error.message,
                "error",
              );
            }
          },

          // Add function to clear PDF history
          async clearPdfHistory() {
            if (
              !confirm(
                "Kas olete kindel, et soovite kogu PDF ajaloo kustutada?",
              )
            )
              return;

            try {
              if (window.currentUser) {
                const { doc, setDoc } = window.firestoreFunctions;
                const userRef = doc(
                  window.db,
                  "users",
                  window.currentUser.uid,
                );
                await setDoc(
                  userRef,
                  {
                    pdfHistory: [],
                  },
                  { merge: true },
                );

                this.userSettings.generatedPdfs = [];
                this.showActionToast(
                  "PDF ajalugu kustutatud",
                  "clear",
                  5000,
                  "",
                  () => {
                    this.showToast("Kustutamist ei saa tagasi võtta", "info");
                  },
                );
              }
            } catch (error) {
              this.showToast(
                "Viga PDF ajaloo kustutamisel: " + error.message,
                "error",
              );
            }
          },

          // Update the tab click handler
          handleTabClick(tab) {
            console.log("Tab clicked:", tab);
            this.activeTab = tab;
            if (tab === "history") {
              console.log("Loading PDF history for history tab");
              this.loadPdfHistory();
            } else if (tab === "basicInfo") {
              console.log("Loading user settings for basic info tab");
              this.loadUserSettings();
            }
          },

          async loadBasicDataFields() {
            try {
              console.log("Loading basic data fields...");
              if (window.currentUser) {
                console.log("Current user:", window.currentUser);
                const { doc, getDoc } = window.firestoreFunctions;
                const userRef = doc(
                  window.db,
                  "users",
                  window.currentUser.uid,
                );
                console.log("User reference:", userRef);

                const userDoc = await getDoc(userRef);
                console.log("User document exists:", userDoc.exists());

                if (userDoc.exists()) {
                  const data = userDoc.data();
                  console.log("Full user data:", data);

                  if (data.settings) {
                    console.log(
                      "Loading settings from Firestore:",
                      data.settings,
                    );
                    // Update only the basic data fields
                    const basicFields = [
                      "buyer",
                      "submission",
                      "validity",
                      "requirements",
                      "criteria",
                      "responsible",
                      "autofillEnabled",
                    ];
                    basicFields.forEach((field) => {
                      if (data.settings[field] !== undefined) {
                        this.userSettings[field] = data.settings[field];
                      }
                    });
                    console.log("Updated userSettings:", this.userSettings);
                  } else {
                    console.log("No settings found in data");
                  }
                } else {
                  console.log("No user document found");
                }
              } else {
                console.log("No current user found");
              }
            } catch (error) {
              console.error("Error loading basic data fields:", error);
              this.showToast(
                "Viga põhiandmete laadimisel: " + error.message,
                "error",
              );
            }
          },

          // Add Word document generation function
          async generateWord() {
            try {
              const {
                Document,
                Packer,
                Paragraph,
                TextRun,
                HeadingLevel,
                AlignmentType,
              } = docx;

              // Create document content
              const doc = new Document({
                sections: [
                  {
                    properties: {},
                    children: [
                      new Paragraph({
                        text: "Pakkumine",
                        heading: HeadingLevel.HEADING_1,
                        alignment: AlignmentType.CENTER,
                      }),
                      new Paragraph({
                        children: [
                          new TextRun({
                            text:
                              "Hankija: " + (this.form.fields.buyer || ""),
                            bold: true,
                          }),
                        ],
                      }),
                      new Paragraph({
                        children: [
                          new TextRun({
                            text:
                              "Pakkumise esitamise aeg ja koht: " +
                              (this.form.fields.submission || ""),
                          }),
                        ],
                      }),
                      new Paragraph({
                        children: [
                          new TextRun({
                            text:
                              "Pakkumuse jõusoleku aeg: " +
                              (this.form.fields.validity || ""),
                          }),
                        ],
                      }),
                      new Paragraph({
                        children: [
                          new TextRun({
                            text: "Nõuded pakkujale:",
                            bold: true,
                          }),
                        ],
                      }),
                      new Paragraph({
                        children: [
                          new TextRun({
                            text: this.form.fields.requirements || "",
                          }),
                        ],
                      }),
                      new Paragraph({
                        children: [
                          new TextRun({
                            text: "Väljavaliku alused:",
                            bold: true,
                          }),
                        ],
                      }),
                      new Paragraph({
                        children: [
                          new TextRun({
                            text: this.form.fields.criteria || "",
                          }),
                        ],
                      }),
                      new Paragraph({
                        children: [
                          new TextRun({
                            text:
                              "Vastutav isik: " +
                              (this.form.fields.responsible || ""),
                            bold: true,
                          }),
                        ],
                      }),
                    ],
                  },
                ],
              });

              // Generate and save the document
              const blob = await Packer.toBlob(doc);
              const fileName = `Pakkumine_${new Date().toLocaleDateString("et-EE")}.docx`;
              saveAs(blob, fileName);

              // Save to history if user is logged in
              if (window.currentUser) {
                const wordData = URL.createObjectURL(blob);
                await this.saveToHistory({
                  name: fileName,
                  pdfData: wordData,
                  formData: JSON.stringify({
                    name: this.form.name,
                    intro: this.form.intro,
                    fields: this.form.fields,
                    sections: this.form.sections,
                    attachments: this.form.attachments,
                  }),
                  createdAt: new Date().toISOString(),
                  responsible: this.form.fields.responsible,
                  submissionDate: this.form.fields.submission,
                });
              }
            } catch (error) {
              console.error("Error generating Word document:", error);
              alert("Viga Word dokumendi loomisel. Palun proovige uuesti.");
            }
          },

          async saveToHistory(data) {
            try {
              if (!window.currentUser) {
                throw new Error("User not logged in");
              }

              const { doc, setDoc, getDoc } = window.firestoreFunctions;
              const userRef = doc(window.db, "users", window.currentUser.uid);

              // Get current user data
              const userDoc = await getDoc(userRef);
              const currentData = userDoc.exists() ? userDoc.data() : {};
              const currentPdfHistory = currentData.pdfHistory || [];

              // Add new entry and keep only last 10
              const updatedPdfHistory = [data, ...currentPdfHistory].slice(
                0,
                10,
              );

              // Update Firestore
              await setDoc(
                userRef,
                {
                  pdfHistory: updatedPdfHistory,
                  lastUpdated: new Date().toISOString(),
                },
                { merge: true },
              );

              // Update global state
              window.userData = {
                ...window.userData,
                pdfHistory: updatedPdfHistory,
                lastUpdated: new Date().toISOString(),
              };

              // Update local state
              this.userSettings.generatedPdfs = updatedPdfHistory;

              return true;
            } catch (error) {
              console.error("Error saving to history:", error);
              throw error;
            }
          },

          async copyToTender(pdf) {
            try {
              // Check if we're dealing with history data
              if (!pdf) {
                throw new Error("No data provided to copy");
              }

              // Add defensive programming
              if (!pdf.formData) {
                throw new Error("PDF data is missing formData");
              }

              // Log the PDF data structure for debugging
              console.log("PDF data structure:", pdf);

              // Parse the form data
              let formData;
              try {
                formData =
                  typeof pdf.formData === "string"
                    ? JSON.parse(pdf.formData)
                    : pdf.formData;
              } catch (error) {
                console.error("Error parsing formData:", error);
                throw new Error(
                  "Invalid tender data: could not parse formData",
                );
              }

              if (!formData || typeof formData !== "object") {
                console.error("Invalid formData structure:", formData);
                throw new Error(
                  "Invalid tender data: formData is not an object",
                );
              }

              // Update form with saved data
              if (formData) {
                this.form.name = formData.name || "";
                this.form.intro = formData.intro || "";

                // Copy all standard fields
                if (formData.fields && typeof formData.fields === "object") {
                  Object.keys(formData.fields).forEach((key) => {
                    if (
                      this.form.fields &&
                      this.form.fields[key] !== undefined
                    ) {
                      this.form.fields[key] = formData.fields[key] || "";
                    }
                  });
                }
              }

              // Copy sections
              if (Array.isArray(formData.sections)) {
                this.form.sections = formData.sections.map((section) => ({
                  ...section,
                  enabled: section.enabled ?? true,
                  open: section.open ?? false,
                  options: Array.isArray(section.options)
                    ? section.options.map((option) => ({
                      ...option,
                      checked: option.checked ?? false,
                      editable: option.editable ?? false,
                    }))
                    : [],
                }));
              }

              // Copy files if they exist
              if (Array.isArray(formData.files)) {
                this.files = formData.files;
              }

              // Show success message
              this.showToast("Andmed kanti edukalt kutsele", "success");

              // Close settings modal
              this.showSettingsModal = false;
            } catch (error) {
              console.error("Error copying tender data:", error);
              console.error("PDF data that caused the error:", pdf);
              this.showToast(
                "Viga andmete kopeerimisel: " + error.message,
                "error",
              );
            }
          },

          previewPdf(pdf) {
            try {
              if (!pdf || !pdf.pdfData) {
                throw new Error("No PDF data available");
              }

              // Create a blob URL for the PDF
              const byteCharacters = atob(pdf.pdfData.split(",")[1]);
              const byteNumbers = new Array(byteCharacters.length);
              for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
              }
              const byteArray = new Uint8Array(byteNumbers);
              const blob = new Blob([byteArray], { type: "application/pdf" });
              const url = URL.createObjectURL(blob);

              this.previewPdfUrl = url;
              this.previewPdfName = pdf.name;

              // Show the modal
              const modal = document.getElementById("pdfPreviewModal");
              modal.classList.remove("hidden");
            } catch (error) {
              console.error("Error previewing PDF:", error);
              this.showToast(
                "Viga PDF-i eelvaate kuvamisel: " + error.message,
                "error",
              );
            }
          },

          closePdfPreview() {
            const modal = document.getElementById("pdfPreviewModal");
            modal.classList.add("hidden");

            // Clean up the blob URL
            if (this.previewPdfUrl) {
              URL.revokeObjectURL(this.previewPdfUrl);
              this.previewPdfUrl = null;
              this.previewPdfName = null;
            }
          },
        };
      });
    });

    // Remove these lines (around line 1098)
    // Show settings modal
    let showSettingsModal = false;

    // Function to load user basic data
    async function loadUserBasicData() {
      // ... remove this entire block
    }

    // Call this function when the page loads
    loadUserBasicData();
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const modal = document.getElementById("tableModal");
      const openBtn = document.getElementById("openTableModal");
      const closeBtn = document.getElementById("closeTableModal");
      const addColumn = document.getElementById("addColumn");
      const addRow = document.getElementById("addRow");
      const exportExcel = document.getElementById("exportExcelBtn");
      const exportPdf = document.getElementById("exportPdfBtn");
      const saveTable = document.getElementById("saveTableBtn");
      const previewBtn = document.getElementById("previewBtn");

      // Preview modal elements
      const previewModal = document.getElementById("previewModal");
      const previewContent = document.getElementById("previewContent");
      const closePreviewBtn = document.getElementById("closePreviewBtn");

      openBtn.onclick = () => modal.classList.remove("hidden");
      closeBtn.onclick = () => modal.classList.add("hidden");
      closePreviewBtn.onclick = () => previewModal.classList.add("hidden");

      // Function to add delete buttons to rows and columns
      function addDeleteButtons() {
        // Add delete buttons to rows
        const rows = document.querySelectorAll("#tableBody tr");
        rows.forEach((row) => {
          if (!row.querySelector(".delete-row")) {
            const deleteCell = document.createElement("td");
            deleteCell.className =
              "w-10 p-3 opacity-0 group-hover:opacity-100";
            const deleteBtn = document.createElement("button");
            deleteBtn.className =
              "delete-row text-red-500 hover:text-red-700";
            deleteBtn.textContent = "✕";
            deleteBtn.onclick = () => row.remove();
            deleteCell.appendChild(deleteBtn);
            row.appendChild(deleteCell);
          }
        });

        // Add delete buttons to header
        const headers = document.querySelectorAll("#tableHead th");
        headers.forEach((header, index) => {
          if (!header.querySelector(".delete-col")) {
            const deleteBtn = document.createElement("button");
            deleteBtn.className =
              "delete-col absolute right-2 top-1/2 -translate-y-1/2 text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100";
            deleteBtn.textContent = "✕";
            deleteBtn.onclick = () => {
              // Remove column from all rows
              const rows = document.querySelectorAll("#tableBody tr");
              rows.forEach((row) => {
                const cells = row.querySelectorAll("td:not(.w-10)");
                if (cells[index]) cells[index].remove();
              });
              header.remove();
            };
            header.appendChild(deleteBtn);
          }
        });
      }

      // Show preview
      previewBtn.onclick = () => {
        const element = document
          .getElementById("dynamicTable")
          .cloneNode(true);
        const title = document.getElementById("tableTitle").value;
        previewContent.innerHTML = `<h2 class="text-xl font-bold mb-4">${title}</h2>`;
        previewContent.appendChild(element);
        previewModal.classList.remove("hidden");
      };

      // Save to Firestore
      saveTable.onclick = async () => {
        if (!auth.currentUser) {
          alert("Palun logi sisse, et tabelit salvestada");
          return;
        }

        const tableData = {
          title: document.getElementById("tableTitle").value,
          headers: [...document.querySelectorAll("#tableHead th")].map((th) =>
            th.textContent.replace("❌", "").trim(),
          ),
          rows: [...document.querySelectorAll("#tableBody tr")].map((row) =>
            [...row.querySelectorAll("td:not(.delete-row)")].map((td) =>
              td.textContent.trim(),
            ),
          ),
          createdAt: new Date(),
          userId: auth.currentUser.uid,
        };

        try {
          await addDoc(collection(db, "tables"), tableData);
          alert("Tabel salvestatud edukalt!");
        } catch (error) {
          console.error("Error saving table:", error);
          alert("Viga tabeli salvestamisel");
        }
      };

      // Initialize delete buttons
      addDeleteButtons();

      // ➕ Lisa veerg
      addColumn.onclick = () => {
        const head = document.getElementById("tableHead");
        const rows = document.querySelectorAll("#tableBody tr");

        const th = document.createElement("th");
        th.className =
          "border border-gray-200 p-3 text-left font-semibold text-gray-700 relative";
        th.textContent = `Veerg ${head.children.length + 1}`;
        head.appendChild(th);

        rows.forEach((row) => {
          const td = document.createElement("td");
          td.contentEditable = "true";
          td.className = "border border-gray-200 p-3 text-left";
          td.textContent = "";
          // Insert before the delete button cell
          row.insertBefore(td, row.lastElementChild);
        });

        addDeleteButtons();
      };

      // ➕ Lisa rida
      addRow.onclick = () => {
        const row = document.createElement("tr");
        row.className = "group hover:bg-gray-50";
        const cols = document.querySelectorAll("#tableHead th").length;

        for (let i = 0; i < cols; i++) {
          const td = document.createElement("td");
          td.contentEditable = "true";
          td.className = "border border-gray-200 p-3 text-left";
          row.appendChild(td);
        }

        document.getElementById("tableBody").appendChild(row);
        addDeleteButtons();
      };

      // 📥 Ekspordi Excel
      exportExcel.onclick = () => {
        const wb = XLSX.utils.book_new();
        const data = [];

        const title = document.getElementById("tableTitle").value;
        if (title) data.push([title], []);

        const headers = [...document.querySelectorAll("#tableHead th")].map(
          (th) => th.textContent.replace("❌", "").trim(),
        );
        data.push(headers);

        document.querySelectorAll("#tableBody tr").forEach((row) => {
          const rowData = [
            ...row.querySelectorAll("td:not(.delete-row)"),
          ].map((td) => td.textContent.trim());
          data.push(rowData);
        });

        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, "Tabel");
        XLSX.writeFile(wb, "tabel.xlsx");
      };

      // 📄 Ekspordi PDF
      exportPdf.onclick = () => {
        const element = document
          .getElementById("dynamicTable")
          .cloneNode(true);
        const title = document.getElementById("tableTitle").value;
        const container = document.createElement("div");
        container.innerHTML = `<h2 class="text-xl font-bold mb-4">${title}</h2>`;
        container.appendChild(element);

        html2pdf()
          .set({
            filename: "tabel.pdf",
            margin: 10,
            image: { type: "jpeg", quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
          })
          .from(container)
          .save();
      };
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const tableHead = document.getElementById("tableHead");
      const tableBody = document.getElementById("tableBody");

      document.getElementById("addColumn").onclick = () => {
        const newTh = document.createElement("th");
        newTh.className = "p-3 border border-gray-200 bg-gray-50";
        newTh.contentEditable = "true"; // redigeeritav nimi
        newTh.textContent = `Uus veerg`;

        tableHead.appendChild(newTh);

        [...tableBody.rows].forEach((row) => {
          const newTd = document.createElement("td");
          newTd.className = "p-3 border border-gray-200";
          newTd.contentEditable = "true";
          row.insertBefore(newTd, row.lastElementChild);
        });
      };

      // Siia võid lisada ka addRow, eksport jne
    });
  </script>
</head>

<body class="backdrop-blur-2xl min-h-screen flex flex-col" x-data="formApp" x-cloak :class="{'dark': isDarkMode}">
  <!-- Login Modal -->
  <div x-show="showLoginModal" x-cloak x-transition:enter="transition duration-300 ease-out"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition duration-200 ease-in" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-50 overflow-y-auto bg-black/30 backdrop-blur-sm flex items-center justify-center p-4">
    <div
      class="fixed left-1/2 transform -translate-x-1/2 top-8 md:top-24 w-full max-w-md rounded-2xl shadow-2xl border border-white/40 bg-white"
      @click.stop>
      <!-- Close Button -->
      <div class="flex justify-between items-center p-6 border-b border-gray-100/30">
        <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-700">
          Logi sisse
        </h2>
        <button @click="showLoginModal = false"
          class="rounded-full p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="p-6">
        <!-- Add form wrapper here -->
        <form id="loginForm" @submit.prevent="login()">
          <div class="space-y-5">
            <!-- Email Input -->
            <div class="relative">
              <label class="text-gray-700 font-medium text-sm mb-1 block" for="emailLogin">E-post</label>
              <div class="relative flex items-center">
                <div class="absolute left-3 text-gray-400">
                  <i class="fas fa-envelope"></i>
                </div>
                <input type="email" id="emailLogin" placeholder="Sisesta oma e-post"
                  class="input w-full pl-10 pr-4 py-3 border border-gray-200 text-gray-900 rounded-xl focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-300"
                  required autocomplete="email" />
              </div>
            </div>

            <!-- Password Input -->
            <div class="relative">
              <label class="text-gray-700 font-medium text-sm mb-1 block" for="passwordLogin">Parool</label>
              <div class="relative flex items-center">
                <div class="absolute left-3 text-gray-400">
                  <i class="fas fa-lock"></i>
                </div>
                <input type="password" id="passwordLogin" placeholder="Sisesta oma parool"
                  class="input w-full pl-10 pr-4 py-3 border border-gray-200 text-gray-900 rounded-xl focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-300"
                  required autocomplete="current-password" />
              </div>
            </div>

            <div class="flex items-center justify-between mt-2">
              <div class="flex items-center">
                <input type="checkbox" id="rememberMe" class="mr-2 rounded-md" />
                <label for="rememberMe" class="text-gray-700 text-sm">Pea meeles mind</label>
              </div>
              <a href="#" class="text-sm text-indigo-600 hover:text-indigo-800">Unustasid parooli?</a>
            </div>
          </div>

          <!-- Changed button to submit type -->
          <button type="submit"
            class="w-full mt-6 py-3 px-4 bg-gradient-to-r from-indigo-600 to-indigo-800 text-white rounded-xl flex items-center justify-center transition-all duration-300 hover:shadow-lg hover:shadow-indigo-500/30 transform hover:-translate-y-1">
            <i class="fas fa-sign-in-alt mr-2"></i> Logi sisse
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="fixed top-0 left-0 right-0 z-50 glassmorphism py-3">
    <div class="max-w-7xl mx-auto px-6">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-6">
          <a href="om.html" class="text-xl font-bold bg-clip-text text-transparent bg-black">
          </a>
          <div class="hidden md:flex md:space-x-4">
            <a href="../index.html"
              class="flex items-center space-x-2 text-gray-800 hover:text-indigo-600 bg-white/30 hover:bg-white/50 px-4 py-2 rounded-full transition-all">
              <i class="fas fa-home"></i>
              <span>Avalehele</span>
            </a>
            <a href="om.html"
              class="flex items-center space-x-2 text-gray-800 hover:text-indigo-600 bg-white/30 hover:bg-white/50 px-4 py-2 rounded-full transition-all">
              <i class="fas fa-file-alt"></i>
              <span>Kutse</span>
            </a>
            <!-- Tabeli loomise nupp -->
            <button id="openTableModal"
              class="flex items-center space-x-2 text-gray-800 hover:text-indigo-600 bg-white/30 hover:bg-white/50 px-4 py-2 rounded-full transition-all">
              <i class="fas fa-table"></i>
              <span>Loo tabel</span>
            </button>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <!-- Settings Button -->
          <button @click="showSettingsModal = true" x-show="currentUser"
            class="flex items-center space-x-2 text-gray-800 hover:text-indigo-600 bg-white/30 hover:bg-white/50 px-4 py-2 rounded-full transition-all">
            <i class="fas fa-cog"></i>
            <span class="hidden md:inline">Seaded</span>
          </button>

          <div class="relative">
            <button @click="currentUser ? toggleUserMenu() : showLoginModal = true"
              class="flex items-center space-x-2 text-gray-800 hover:text-indigo-600 bg-white/30 hover:bg-white/50 px-4 py-2 rounded-full transition-all">
              <i class="fas fa-user-circle"></i>
              <span x-text="currentUser ? currentUser.email?.split('@')[0] : 'Logi sisse'"
                class="hidden md:inline"></span>
              <i class="fas fa-chevron-down text-xs ml-1"></i>
            </button>
            <div x-show="showUserMenu && currentUser" @click.away="showUserMenu = false"
              x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95"
              x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-150"
              x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
              class="absolute right-0 mt-2 w-48 rounded-xl shadow-xl glassmorphism ring-1 ring-black ring-opacity-5 z-50 border border-white/20">
              <div class="py-1">
                <a href="#" @click.prevent="logout()"
                  class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-red-50 hover:text-red-700">
                  <i class="fas fa-sign-out-alt mr-3 text-red-500"></i> Logi
                  välja
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Add padding to main content to account for fixed navbar -->
  <div class="pt-20">
    <!-- Main Content -->
    <div class="container mx-auto max-w-7xl p-6">
      <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-center text-transparent bg-clip-text bg-black">
          Ostumenetluse kutse koostamine
        </h1>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
        <!-- Left: Data Input -->
        <div class="space-y-6">
          <!-- Form Header Card -->
          <div class="card transition-all" x-data="{ isOpen: true }">
            <div class="flex items-center justify-between mb-4 cursor-pointer" @click="isOpen = !isOpen">
              <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                  <i class="fas fa-file-contract text-indigo-600"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800">Ostumenetluse nimi ja kirjeldus</h2>
              </div>
              <button class="p-2 rounded-full hover:bg-indigo-100 transition-all">
                <i class="fas transition-transform duration-300"
                  :class="isOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
              </button>
            </div>

            <div x-show="isOpen" x-transition:enter="transition ease-out duration-50"
              x-transition:enter-start="opacity-0 transform -translate-y-2"
              x-transition:enter-end="opacity-100 transform translate-y-0"
              x-transition:leave="transition ease-in duration-50"
              x-transition:leave-start="opacity-100 transform translate-y-0"
              x-transition:leave-end="opacity-0 transform -translate-y-2">
              <!-- Ostumenetluse nimi -->
              <div class="mb-4">
                <label class="block text-sm font-semibold mb-2 text-gray-700">Ostumenetluse nimi</label>
                <input type="text" x-model="form.name" class="w-full border rounded-xl px-4 py-3 shadow-sm"
                  placeholder="Näiteks: Haljasala rajamine" />
              </div>

              <!-- Ostumenetluse kirjeldus -->
              <div>
                <label class="block text-sm font-semibold mb-2 text-gray-700">Ostumenetluse kutse lühikirjeldus</label>
                <textarea x-model="form.intro" class="w-full border rounded-xl px-4 py-3 h-40 shadow-sm"></textarea>
              </div>
            </div>
          </div>

          <!-- Põhiandmed Card -->
          <div class="card transition-all" x-data="{ isOpen: true }">
            <div class="flex items-center justify-between mb-6 cursor-pointer" @click="isOpen = !isOpen">
              <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                  <i class="fas fa-sliders-h text-indigo-600"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800">Ostumenetluse andmed</h2>
              </div>
              <button class="p-2 rounded-full hover:bg-indigo-100 transition-all">
                <i class="fas transition-transform duration-300"
                  :class="isOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
              </button>
            </div>

            <div x-show="isOpen" x-transition:enter="transition ease-out duration-200"
              x-transition:enter-start="opacity-0 transform -translate-y-2"
              x-transition:enter-end="opacity-100 transform translate-y-0"
              x-transition:leave="transition ease-in duration-150"
              x-transition:leave-start="opacity-100 transform translate-y-0"
              x-transition:leave-end="opacity-0 transform -translate-y-2">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <template x-for="field in standardFields" :key="field.key">
                  <div class="group">
                    <label class="block text-sm font-semibold mb-2 text-gray-700" x-text="field.label"></label>
                    <div class="relative">
                      <input type="text" x-model="form.fields[field.key]"
                        class="w-full border rounded-xl px-4 py-3 shadow-sm transition-all focus:shadow-md"
                        :placeholder="field.placeholder" />
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- Sections 1-7 Card -->
          <div class="card transition-all" x-data="{ isOpen: true }">
            <div class="flex items-center justify-between mb-6 cursor-pointer" @click="isOpen = !isOpen">
              <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                  <i class="fas fa-list-check text-indigo-600"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800">
                  Ostumenetluse tingimused
                </h2>
              </div>
              <button class="p-2 rounded-full hover:bg-indigo-100 transition-all">
                <i class="fas transition-transform duration-300"
                  :class="isOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
              </button>
            </div>

            <div x-show="isOpen" x-transition:enter="transition ease-out duration-200"
              x-transition:enter-start="opacity-0 transform -translate-y-2"
              x-transition:enter-end="opacity-100 transform translate-y-0"
              x-transition:leave="transition ease-in duration-150"
              x-transition:leave-start="opacity-100 transform translate-y-0"
              x-transition:leave-end="opacity-0 transform -translate-y-2">
              <div class="flex gap-2 mb-6">
                <button @click="selectAllOptions"
                  class="flex items-center text-sm bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-2 rounded-lg transition-colors">
                  <i class="fas mr-1"
                    :class="form.sections.some(section => section.options.some(option => !option.checked)) ? 'fa-check-double' : 'fa-times'"></i>
                  <span
                    x-text="form.sections.some(section => section.options.some(option => !option.checked)) ? 'Lisa kõik' : 'Eemalda kõik'"></span>
                </button>
                <button @click="toggleAllSections"
                  class="flex items-center text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg transition-colors">
                  <i class="fas mr-1"
                    :class="form.sections.some(section => !section.open) ? 'fa-chevron-down' : 'fa-chevron-up'"></i>
                  <span x-text="form.sections.some(section => !section.open) ? 'Ava kõik' : 'Sulge kõik'"></span>
                </button>
              </div>

              <div id="draggableSections" x-ref="draggableSections" class="space-y-4">
                <template x-for="(section, index) in form.sections" :key="index">
                  <div
                    class="mb-4 border bg-white/50 backdrop-blur-sm border-gray-200 rounded-xl overflow-hidden shadow-sm transition-all hover:shadow-md"
                    x-data="{ section }" :class="{ 'active-section': section.enabled }">
                    <div class="section-header" @click="section.open = !section.open">
                      <input type="checkbox" x-model="section.enabled" class="mr-3" @click.stop />
                      <span class="drag-handle cursor-move mr-3 text-gray-400 hover:text-indigo-500 transition-colors">
                        <i class="fas fa-grip-lines"></i>
                      </span>
                      <span x-text="section.title" class="flex-grow"></span>
                      <i class="fas transition-transform duration-300"
                        :class="section.open ? 'fa-chevron-down transform rotate-180' : 'fa-chevron-right'"></i>
                    </div>
                    <div x-show="section.open" x-transition:enter="transition ease-out duration-200"
                      x-transition:enter-start="opacity-0 transform -translate-y-4"
                      x-transition:enter-end="opacity-100 transform translate-y-0"
                      x-transition:leave="transition ease-in duration-150"
                      x-transition:leave-start="opacity-100 transform translate-y-0"
                      x-transition:leave-end="opacity-0 transform -translate-y-4" class="section-content">
                      <template x-for="(opt, i) in section.options" :key="i">
                        <label class="block p-3 hover:bg-white/50 rounded-lg transition-colors mb-2">
                          <div class="flex items-start">
                            <input type="checkbox" x-model="opt.checked" class="mt-1 mr-3 rounded" />
                            <template x-if="opt.isEditing">
                              <input type="text" x-model="opt.text" @blur="opt.isEditing = false"
                                @keydown.enter="opt.isEditing = false"
                                class="flex-grow border rounded-lg px-3 py-2 text-sm shadow-sm" x-ref="editInput" />
                            </template>
                            <template x-if="!opt.isEditing">
                              <span x-text="opt.text" class="text-sm cursor-pointer hover:text-indigo-600"
                                @dblclick="opt.isEditing = true; $nextTick(() => $refs.editInput?.focus())">
                              </span>
                            </template>
                          </div>
                        </label>
                      </template>
                    </div>
                  </div>
                </template>
              </div>

              <div class="flex flex-wrap justify-between items-center gap-4 mt-8">

                <!-- Lisa uus punkt nupp -->
                <button @click="addNewSection"
                  class="flex items-center gap-2 text-sm font-medium text-emerald-600 hover:text-white border border-emerald-600 hover:bg-emerald-600 px-4 py-2 rounded-xl shadow-sm transition-all duration-200">
                  <i class="fas fa-plus-circle"></i> Lisa uus tingimus
                </button>

                <!-- Alapunkti / lisa / punkti lisamise nupud -->
                <template x-for="(section, index) in form.sections" :key="index">
                  <button @click="addOption(index)" x-show="section.open"
                    class="flex items-center gap-2 text-sm font-medium text-indigo-600 hover:text-white border border-indigo-600 hover:bg-indigo-600 px-4 py-2 rounded-xl shadow-sm transition-all duration-200">
                    <i class="fas fa-plus-circle"></i>
                    <span x-text="index === 0 ? 'Lisa alapunkt' : 
                              index === 6 ? 'Lisa lisa' : 
                              'Lisa punkt'"></span>
                  </button>
                </template>

              </div>
            </div>
          </div>

          <!-- File Upload Section -->
          <div class="card transition-all" x-data="{ isOpen: false }">
            <div class="flex items-center justify-between mb-2 cursor-pointer" @click="isOpen = !isOpen">
              <div class="flex items-center">
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                  <i class="fas fa-paperclip text-indigo-600 text-sm"></i>
                </div>
                <h2 class="text-lg font-bold text-gray-800">Manused</h2>
              </div>
              <button class="p-1 rounded-full hover:bg-indigo-100 transition-all">
                <i class="fas transition-transform duration-300 text-sm"
                  :class="isOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
              </button>
            </div>

            <div x-show="isOpen" x-transition:enter="transition ease-out duration-200"
              x-transition:enter-start="opacity-0 transform -translate-y-2"
              x-transition:enter-end="opacity-100 transform translate-y-0"
              x-transition:leave="transition ease-in duration-150"
              x-transition:leave-start="opacity-100 transform translate-y-0"
              x-transition:leave-end="opacity-0 transform -translate-y-2">
              <div @dragover="handleDragOver" @dragleave="handleDragLeave" @drop="handleDrop"
                :class="{'border-indigo-500 bg-indigo-50/50': isDragging}"
                class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center cursor-pointer transition-colors hover:border-indigo-400">
                <input type="file" id="fileInput" class="hidden" @change="handleFileInput" multiple />
                <label for="fileInput" class="cursor-pointer block">
                  <i class="fas fa-cloud-upload-alt text-xl text-indigo-500 mb-2"></i>
                  <p class="text-gray-700 font-medium text-sm mb-1">
                    Lohista failid siia või
                    <span class="text-indigo-600 underline">kliki valimiseks</span>
                  </p>
                  <p class="text-xs text-gray-500">Max 10MB fail</p>
                </label>
              </div>

              <div class="mt-3 space-y-2" x-show="files.length > 0">
                <template x-for="(file, index) in files" :key="index">
                  <div class="file-item hover-scale py-2 px-3">
                    <div class="flex items-center truncate max-w-[80%]">
                      <div class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center mr-2">
                        <i class="fas fa-file-alt text-indigo-500 text-xs"></i>
                      </div>
                      <div class="truncate">
                        <div x-text="file.name" class="truncate text-gray-800 font-medium text-sm"></div>
                        <div class="text-xs text-gray-500" x-text="formatFileSize(file.size)"></div>
                      </div>
                    </div>
                    <button @click="removeFile(index)"
                      class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50 transition-colors">
                      <i class="fas fa-trash-alt text-xs"></i>
                    </button>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-wrap gap-5 mt-8">
            <button @click="generatePDF" x-show="currentUser"
              class="relative overflow-hidden group flex items-center gap-3 px-5 py-2.5 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-emerald-500/30 hover:-translate-y-1">
              <div
                class="absolute inset-0 w-full h-full bg-gradient-to-r from-emerald-600 to-emerald-700 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              </div>
              <div class="w-7 h-7 flex items-center justify-center bg-white/20 rounded-full relative">
                <i class="fas fa-file-pdf text-white text-sm"></i>
              </div>
              <span class="relative">Kutse PDF</span>
            </button>

            <button @click="manualSave" x-show="currentUser"
              class="relative overflow-hidden group flex items-center gap-3 px-5 py-2.5 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-indigo-500/30 hover:-translate-y-1">
              <div
                class="absolute inset-0 w-full h-full bg-gradient-to-r from-indigo-600 to-indigo-700 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              </div>
              <div class="w-7 h-7 flex items-center justify-center bg-white/20 rounded-full relative">
                <i class="fas fa-save text-white text-sm"></i>
              </div>
              <span class="relative">Salvesta</span>
            </button>

            <button @click="resetForm" x-show="currentUser"
              class="relative overflow-hidden group flex items-center gap-3 px-5 py-2.5 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-red-500/30 hover:-translate-y-1">
              <div
                class="absolute inset-0 w-full h-full bg-gradient-to-r from-red-600 to-red-700 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              </div>
              <div class="w-7 h-7 flex items-center justify-center bg-white/20 rounded-full relative">
                <i
                  class="fas fa-trash-alt text-white text-sm group-hover:rotate-12 transition-transform duration-300"></i>
              </div>
              <span class="relative">
                <span class="inline-block group-hover:-translate-y-px transition-transform duration-300">Kustuta</span>
                <span class="block h-0.5 w-0 group-hover:w-full bg-white transition-all duration-300 mt-0.5"></span>
              </span>
            </button>

          </div>
        </div>

        <!-- Right: PDF Preview -->
        <div>
          <div class="sticky top-24">
            <div class="flex items-center mb-4">
              <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                <i class="fas fa-eye text-indigo-600"></i>
              </div>
              <h2 class="text-lg font-bold text-gray-800">
                Reaalajas eelvaade
              </h2>
            </div>

            <div id="pdfPreview"
              class="border-0 card space-y-6 min-h-[70vh] max-h-[80vh] overflow-auto backdrop-blur-md transition-all scroll-smooth">
              <!-- Header -->
              <div
                class="bg-gradient-to-r from-indigo-600 to-indigo-800 backdrop-blur-sm text-white p-5 rounded-t-2xl -mx-6 -mt-6 mb-6">
                <h1 class="text-2xl font-bold text-center" x-text="form.name || 'Ostumenetluse kutse'"></h1>
              </div>

              <!-- Intro text -->
              <div class="text-gray-800 font-medium text-sm leading-relaxed p-2" x-text="form.intro"></div>

              <!-- Standard fields -->
              <div class="space-y-3">
                <template x-for="field in standardFields">
                  <div x-show="form.fields[field.key]"
                    class="bg-white/40 backdrop-blur-sm p-3 rounded-xl shadow-sm transition-all hover:shadow-md">
                    <div class="flex items-start">
                      <span class="font-semibold text-indigo-700 mr-2" x-text="field.label + ':'"></span>
                      <span class="text-gray-800 font-medium" x-text="form.fields[field.key] || ''"></span>
                    </div>
                  </div>
                </template>
              </div>

              <!-- Sections -->
              <template x-for="(section, idx) in visibleSections" :key="idx">
                <div class="mt-8">
                  <!-- Section title -->
                  <div class="flex items-center mb-4">
                    <h2 class="text-lg font-bold text-indigo-700"
                      x-text="(idx + 1) + ' ' + section.title.split(' ').slice(1).join(' ')"></h2>
                    <div class="flex-grow h-0.5 bg-gradient-to-r from-indigo-500 to-indigo-300 ml-3 rounded-full"></div>
                  </div>

                  <!-- Section options -->
                  <ul class="space-y-3 pl-2">
                    <template x-for="(opt, i) in section.options.filter(o => o.checked)" :key="i">
                      <li class="flex items-start p-2 bg-white/30 rounded-lg shadow-sm hover:shadow-md transition-all">
                        <div
                          class="min-w-8 h-6 bg-indigo-100 rounded-full flex items-center justify-center text-xs font-bold text-indigo-700 mr-3">
                          <span x-text="(idx + 1) + '.' + (i+1)"></span>
                        </div>
                        <span class="text-sm text-gray-800" x-text="opt.text"></span>
                      </li>
                    </template>
                  </ul>
                </div>
              </template>

              <!-- Footer -->
              <div class="mt-10 pt-5 border-t border-gray-200">
                <div class="flex justify-between text-sm">
                  <div class="text-indigo-700 font-semibold">
                    <p>
                      Kuupäev:
                      <span class="text-gray-800" x-text="today"></span>
                    </p>
                  </div>
                  <div class="text-indigo-700 font-semibold">
                    <p>
                      Vastutav isik:
                      <span class="text-gray-800" x-text="form.fields.responsible || ''"></span>
                    </p>
                  </div>
                </div>
              </div>

              <!-- Attachments -->
              <template x-if="files.length > 0">
                <div class="mt-8">
                  <div class="flex items-center mb-4">
                    <h3 class="text-lg font-bold text-indigo-700">Manused</h3>
                    <div class="flex-grow h-0.5 bg-gradient-to-r from-indigo-500 to-indigo-300 ml-3 rounded-full"></div>
                  </div>

                  <div class="space-y-2">
                    <template x-for="(file, index) in files" :key="index">
                      <div class="flex items-center p-3 bg-white/40 rounded-xl transition-all hover:bg-white/60">
                        <div class="w-8 h-8 flex items-center justify-center bg-indigo-100 rounded-full mr-3">
                          <i class="fas fa-file-alt text-indigo-600"></i>
                        </div>
                        <span class="text-sm text-gray-800">
                          <span x-text="index + 1 + '. '"></span>
                          <span x-text="file.name" class="font-medium"></span>
                          <span class="text-gray-500" x-text="' (' + formatFileSize(file.size) + ')'"></span>
                          <span x-show="file.comment" class="text-gray-500" x-text="' - ' + file.comment"></span>
                        </span>
                      </div>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div class="fixed bottom-4 right-4 space-y-3 z-50" x-show="toasts.length > 0">
    <template x-for="toast in toasts" :key="toast.id">
      <div x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-2"
        x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 translate-y-2" :class="{
                    'toast-success': toast.type === 'success',
                    'toast-error': toast.type === 'error',
                    'toast-info': toast.type === 'info'
                }"
        :style="toast.type === 'clear' ? 'background-image: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%); box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3)' : ''"
        class="text-white px-6 py-4 rounded-xl shadow-lg flex items-center backdrop-blur-sm max-w-md">
        <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-white/20 mr-3">
          <i class="fas" :class="{
                        'fa-check': toast.type === 'success',
                        'fa-exclamation': toast.type === 'error',
                        'fa-info': toast.type === 'info',
                        'fa-trash-alt': toast.type === 'clear'
                    }"></i>
        </div>
        <div class="flex-1">
          <p class="font-medium" x-text="toast.message"></p>
        </div>
        <div class="flex items-center space-x-2 ml-auto">
          <button x-show="toast.actionText"
            @click="toast.actionCallback(); toasts = toasts.filter(t => t.id !== toast.id)" class="toast-action-button">
            <span x-text="toast.actionText"></span>
          </button>
          <button @click="toasts = toasts.filter(t => t.id !== toast.id)" class="text-white/80 hover:text-white p-1">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    </template>
  </div>

  <!-- Settings Modal -->
  <div x-show="showSettingsModal" x-cloak x-transition:enter="transition duration-300 ease-out"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition duration-200 ease-in" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0" class="fixed inset-0 z-50 bg-black/70 backdrop-blur-md"
    @click.self="showSettingsModal = false" x-data="{ 
            activeTab: 'info',
            async handleTabClick(tab) {
                console.log('Tab clicked:', tab);
                this.activeTab = tab;
                if (tab === 'history') {
                    console.log('Loading PDF history for history tab');
                    await this.loadPdfHistory();
                } else if (tab === 'basicInfo') {
                    console.log('Loading user settings for basic info tab');
                    await this.loadUserSettings();
                }
            },
            async loadUserSettings() {
                try {
                    console.log('Loading user settings...');
                    if (window.currentUser && window.userData) {
                        console.log('User is logged in, loading from global data');
                        if (window.userData.settings) {
                            console.log('Loading settings from global data');
                            Object.keys(window.userData.settings).forEach(key => {
                                if (this.userSettings.hasOwnProperty(key)) {
                                    this.userSettings[key] = window.userData.settings[key];
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error('Settings load error:', error);
                    this.showToast('Viga seadete laadimisel: ' + error.message, 'error');
                }
            },
            async loadPdfHistory() {
                if (window.currentUser && window.userData && window.userData.pdfHistory) {
                    this.userSettings.generatedPdfs = window.userData.pdfHistory;
                }
            }
        }" x-init="loadUserSettings()">
    <div
      class="fixed left-1/2 transform -translate-x-1/2 top-8 md:top-24 w-full max-w-3xl rounded-2xl shadow-2xl border border-white/40 max-h-[85vh] overflow-y-auto mx-auto bg-white/90 backdrop-blur-xl"
      @click.stop>
      <!-- Header -->
      <div class="sticky top-0 p-6 border-b border-gray-100/30 bg-gradient-to-r from-indigo-600 to-indigo-800 z-10">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-bold text-white flex items-center">
            <i class="fas fa-cog mr-3"></i>Seaded
          </h2>
          <button @click="showSettingsModal = false"
            class="text-white/80 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <!-- Tabs -->
        <div class="flex space-x-1 mt-5">
          <button @click="handleTabClick('info')"
            :class="activeTab === 'info' ? 'text-white bg-white/20 border-b-2 border-white' : 'text-white/70 hover:text-white hover:bg-white/10'"
            class="px-4 py-2 rounded-t-lg font-medium transition-colors">
            Info
          </button>
          <button @click="handleTabClick('basicInfo')"
            :class="activeTab === 'basicInfo' ? 'text-white bg-white/20 border-b-2 border-white' : 'text-white/70 hover:text-white hover:bg-white/10'"
            class="px-4 py-2 rounded-t-lg font-medium transition-colors">
            Põhiandmed
          </button>
          <button @click="handleTabClick('history')"
            :class="activeTab === 'history' ? 'text-white bg-white/20 border-b-2 border-white' : 'text-white/70 hover:text-white hover:bg-white/10'"
            class="px-4 py-2 rounded-t-lg font-medium transition-colors">
            Ajalugu
          </button>
        </div>
      </div>

      <!-- Content -->
      <div class="p-6 bg-white/90">
        <!-- Info Tab Content -->
        <div x-show="activeTab === 'info'" x-transition:enter="transition ease-out duration-200"
          x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
          <div class="space-y-8">
            <div class="flex items-center space-x-3 mb-6">
              <i class="fas fa-cog text-2xl text-gray-700"></i>
              <h3 class="text-2xl font-bold text-gray-800">Seadete info</h3>
            </div>

            <!-- Põhiandmed Info -->
            <div
              class="bg-gradient-to-br from-indigo-50 to-white rounded-2xl p-8 border border-indigo-100 shadow-sm hover:shadow-md transition-shadow duration-200">
              <div class="flex items-start">
                <div class="w-12 h-12 rounded-xl bg-indigo-100 flex items-center justify-center mr-4">
                  <i class="fas fa-info-circle text-xl text-indigo-600"></i>
                </div>
                <div class="flex-1">
                  <h4 class="text-xl font-semibold text-gray-800 mb-3">
                    Põhiandmed
                  </h4>
                  <p class="text-gray-600 mb-4">
                    Salvestage oma põhiteave, mida saab automaatselt täita
                    vormi avamisel.
                  </p>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white/80 rounded-xl p-4 border border-indigo-100">
                      <h5 class="font-medium text-gray-700 mb-2">
                        Salvestatav info
                      </h5>
                      <ul class="space-y-2 text-gray-600">
                        <li class="flex items-center">
                          <i class="fas fa-check-circle text-indigo-500 mr-2"></i>
                          Hankija info
                        </li>
                        <li class="flex items-center">
                          <i class="fas fa-check-circle text-indigo-500 mr-2"></i>
                          Pakkumise aeg ja koht
                        </li>
                        <li class="flex items-center">
                          <i class="fas fa-check-circle text-indigo-500 mr-2"></i>
                          Jõusoleku aeg
                        </li>
                      </ul>
                    </div>
                    <div class="bg-white/80 rounded-xl p-4 border border-indigo-100">
                      <h5 class="font-medium text-gray-700 mb-2">
                        Täiendav info
                      </h5>
                      <ul class="space-y-2 text-gray-600">
                        <li class="flex items-center">
                          <i class="fas fa-check-circle text-indigo-500 mr-2"></i>
                          Nõuded pakkujale
                        </li>
                        <li class="flex items-center">
                          <i class="fas fa-check-circle text-indigo-500 mr-2"></i>
                          Väljavaliku alused
                        </li>
                        <li class="flex items-center">
                          <i class="fas fa-check-circle text-indigo-500 mr-2"></i>
                          Vastutav isik
                        </li>
                      </ul>
                    </div>
                  </div>

                  <div class="bg-indigo-50 rounded-xl p-4 border border-indigo-100">
                    <div class="flex items-start">
                      <i class="fas fa-lightbulb text-indigo-500 text-xl mt-1 mr-3"></i>
                      <div>
                        <h5 class="font-medium text-gray-700 mb-1">
                          Automaatne täitmine
                        </h5>
                        <p class="text-sm text-gray-600">
                          Lülitage sisse "Automaatne täitmine" lüliti
                          Põhiandmete sektsioonis, et põhiandmed täidetaksid
                          vormi automaatselt.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Ajalugu Info -->
            <div
              class="bg-gradient-to-br from-emerald-50 to-white rounded-2xl p-8 border border-emerald-100 shadow-sm hover:shadow-md transition-shadow duration-200">
              <div class="flex items-start">
                <div class="w-12 h-12 rounded-xl bg-emerald-100 flex items-center justify-center mr-4">
                  <i class="fas fa-history text-xl text-emerald-600"></i>
                </div>
                <div class="flex-1">
                  <h4 class="text-xl font-semibold text-gray-800 mb-3">
                    Ajalugu
                  </h4>
                  <p class="text-gray-600 mb-4">
                    Vaadake ja hallake kõiki teie genereeritud PDF-e.
                  </p>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white/80 rounded-xl p-4 border border-emerald-100">
                      <h5 class="font-medium text-gray-700 mb-2">PDF info</h5>
                      <ul class="space-y-2 text-gray-600">
                        <li class="flex items-center">
                          <i class="fas fa-check-circle text-emerald-500 mr-2"></i>
                          PDF-i nimi
                        </li>
                        <li class="flex items-center">
                          <i class="fas fa-check-circle text-emerald-500 mr-2"></i>
                          Loomise kuupäev
                        </li>
                        <li class="flex items-center">
                          <i class="fas fa-check-circle text-emerald-500 mr-2"></i>
                          Vastutava isiku info
                        </li>
                      </ul>
                    </div>
                    <div class="bg-white/80 rounded-xl p-4 border border-emerald-100">
                      <h5 class="font-medium text-gray-700 mb-2">
                        Tegevused
                      </h5>
                      <ul class="space-y-2 text-gray-600">
                        <li class="flex items-center">
                          <i class="fas fa-eye text-emerald-500 mr-2"></i>
                          Vaata PDF-i
                        </li>
                        <li class="flex items-center">
                          <i class="fas fa-download text-emerald-500 mr-2"></i>
                          Lae alla
                        </li>
                        <li class="flex items-center">
                          <i class="fas fa-trash text-emerald-500 mr-2"></i>
                          Kustuta ajalugu
                        </li>
                      </ul>
                    </div>
                  </div>

                  <div class="bg-emerald-50 rounded-xl p-4 border border-emerald-100">
                    <div class="flex items-start">
                      <i class="fas fa-info-circle text-emerald-500 text-xl mt-1 mr-3"></i>
                      <div>
                        <h5 class="font-medium text-gray-700 mb-1">
                          Tähelepanu
                        </h5>
                        <p class="text-sm text-gray-600">
                          "Tühjenda" nupp kustutab kogu ajaloo jäädavalt. Enne
                          kustutamist veenduge, et olete salvestanud vajalikud
                          PDF-id.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Põhiandmed Tab Content -->
        <div x-show="activeTab === 'basicInfo'" x-transition:enter="transition ease-out duration-200"
          x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
          <form @submit.prevent="saveUserSettings" class="space-y-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
              Põhiandmete seaded
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Hankija</label>
                <div class="relative">
                  <i class="fas fa-building absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  <input type="text" x-model="userSettings.buyer"
                    class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl bg-white text-gray-900 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                    placeholder="Nimi, aadress, registrikood" />
                </div>
              </div>

              <div class="group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Pakkumise esitamise aeg ja koht</label>
                <div class="relative">
                  <i class="fas fa-calendar absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  <input type="text" x-model="userSettings.submission"
                    class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl bg-white text-gray-900 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                    placeholder="nt 10. aprill, e-post" />
                </div>
              </div>

              <div class="group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Pakkumuse jõusoleku aeg</label>
                <div class="relative">
                  <i class="fas fa-clock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  <input type="text" x-model="userSettings.validity"
                    class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl bg-white text-gray-900 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                    placeholder="nt 30 päeva" />
                </div>
              </div>

              <div class="group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Nõuded pakkujale</label>
                <div class="relative">
                  <i class="fas fa-list-check absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  <input type="text" x-model="userSettings.requirements"
                    class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl bg-white text-gray-900 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                    placeholder="nt kogemus 3 aastat" />
                </div>
              </div>

              <div class="group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Väljavaliku alused</label>
                <div class="relative">
                  <i class="fas fa-scale-balanced absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  <input type="text" x-model="userSettings.criteria"
                    class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl bg-white text-gray-900 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                    placeholder="Majanduslikult soodsaim" />
                </div>
              </div>

              <div class="group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Vastutav isik</label>
                <div class="relative">
                  <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  <input type="text" x-model="userSettings.responsible"
                    class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl bg-white text-gray-900 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                    placeholder="Nimi" />
                </div>
              </div>
            </div>

            <!-- Autofill Toggle -->
            <div
              class="flex items-center justify-between p-5 bg-indigo-50 rounded-xl mt-6 border border-indigo-100 shadow-sm">
              <div class="flex items-center">
                <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center mr-3">
                  <i class="fas fa-magic text-indigo-600"></i>
                </div>
                <div>
                  <label class="text-lg font-medium text-gray-800">
                    Automaatne täitmine
                  </label>
                  <p class="text-sm text-gray-500">
                    Põhiandmete automaatne täitmine vormi avamisel
                  </p>
                </div>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" x-model="userSettings.autofillEnabled" class="sr-only peer" />
                <div
                  class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-indigo-600">
                </div>
              </label>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end gap-3 mt-8 pt-6 border-t border-gray-200">
              <button type="button" @click="showSettingsModal = false"
                class="px-5 py-3 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all shadow-sm hover:shadow">
                Tühista
              </button>
              <button type="button" @click="saveUserSettings()"
                class="px-5 py-3 text-sm font-medium text-white bg-gradient-to-r from-indigo-600 to-indigo-700 border border-transparent rounded-xl hover:from-indigo-700 hover:to-indigo-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all shadow-sm hover:shadow-md">
                <i class="fas fa-save mr-2"></i> Salvesta seaded
              </button>
            </div>
          </form>
        </div>

        <!-- History Tab Content -->
        <div x-show="activeTab === 'history'" x-transition:enter="transition ease-out duration-200"
          x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
          <div class="space-y-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
              Ajalugu ja tehtud PDF-id
            </h3>

            <div class="border border-gray-200 rounded-xl overflow-hidden">
              <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                <div class="flex justify-between items-center">
                  <h4 class="font-medium text-gray-700">
                    Viimased genereeritud PDF-id
                  </h4>
                  <button @click="clearPdfHistory()"
                    class="group flex items-center space-x-1 text-red-600 hover:text-red-800 text-sm font-medium bg-white/50 hover:bg-white/80 transition-all duration-200 px-3 py-1.5 rounded-lg shadow-sm hover:shadow-md">
                    <i class="fas fa-trash-alt mr-1 group-hover:rotate-12 transition-transform duration-300"></i>
                    <span class="relative">Tühjenda</span>
                  </button>
                </div>
              </div>

              <div class="divide-y divide-gray-200">
                <template x-if="userSettings.generatedPdfs && userSettings.generatedPdfs.length > 0">
                  <template x-for="pdf in userSettings.generatedPdfs" :key="pdf.id">
                    <div class="p-4 hover:bg-gray-50 transition-colors">
                      <div class="flex justify-between items-center">
                        <div>
                          <p class="font-medium text-gray-800" x-text="pdf.name"></p>
                          <p class="text-sm text-gray-500"
                            x-text="'Genereeritud: ' + new Date(pdf.createdAt).toLocaleDateString('et-EE')"></p>
                          <p class="text-sm text-gray-500" x-show="pdf.responsible"
                            x-text="'Vastutav: ' + pdf.responsible"></p>
                          <p class="text-sm text-gray-500" x-show="pdf.submissionDate"
                            x-text="'Esitamise tähtaeg: ' + pdf.submissionDate"></p>
                        </div>
                        <div class="flex space-x-3">
                          <button @click="downloadSavedPdf(pdf.pdfData, pdf.name + '.pdf')"
                            class="flex items-center px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors duration-200 shadow-sm hover:shadow-md">
                            <i class="fas fa-download mr-2"></i>
                            <span>Laadi alla</span>
                          </button>
                          <button @click="previewPdf(pdf)"
                            class="flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200 shadow-sm hover:shadow-md">
                            <i class="fas fa-eye mr-2"></i>
                            <span>Vaata</span>
                          </button>
                          <button @click="sendPdfToOutlook(pdf.pdfData, pdf.name + '.pdf')"
                            class="flex items-center px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors duration-200 shadow-sm hover:shadow-md">
                            <i class="fas fa-envelope mr-2"></i>
                            <span>Saada e-mailiga</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </template>
                </template>
                <template x-if="!userSettings.generatedPdfs || userSettings.generatedPdfs.length === 0">
                  <div class="p-4 text-center text-gray-500">
                    <i class="fas fa-file-pdf text-2xl mb-2"></i>
                    <p>Pole veel genereeritud PDF-e</p>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

<!-- Tabeli modal -->
<div id="tableModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50">
  <div class="absolute top-1/4 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-5xl p-6">
    <div class="bg-white rounded-2xl shadow-2xl p-8 border border-gray-200">
      <!-- Header -->
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold text-gray-900">
          📊 Esildise koostamine
        </h2>
        <button id="closeTableModal" class="text-gray-500 hover:text-red-600 transition">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <!-- Tabeli pealkiri -->
      <input type="text" id="tableTitle" placeholder="Tabeli pealkiri..."
        class="w-full px-5 py-3 bg-gray-50 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-400 focus:outline-none mb-6" />

      <!-- Tabel -->
      <div class="overflow-x-auto mb-6">
        <table id="dynamicTable" class="min-w-full text-sm text-left border border-gray-200">
          <thead>
            <tr id="tableHead">
              <th contenteditable="true"
                class="p-3 border border-gray-200 bg-gray-50 text-left font-semibold text-gray-700">
                Veerg 1
              </th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr class="hover:bg-gray-50 group">
              <td contenteditable="true" class="p-3 border border-gray-200 focus:outline-none">
                Andmed 1
              </td>
              <td class="w-10 text-center opacity-0 group-hover:opacity-100">
                <button class="delete-row text-red-500 hover:text-red-700">
                  ✖
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Lisa read / veerud -->
      <div class="flex gap-4 mb-6">
        <button id="addColumn" class="px-4 py-2 rounded-lg bg-blue-100 hover:bg-blue-200 transition">
          ➕ Veerg
        </button>
        <button id="addRow" class="px-4 py-2 rounded-lg bg-green-100 hover:bg-green-200 transition">
          ➕ Rida
        </button>
      </div>

      <!-- Ekspordi nupud -->
      <div class="flex flex-wrap gap-4">
        <button id="previewBtn" class="btn px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">
          👁️ Eelvaade
        </button>
        <button id="saveTableBtn" class="btn px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
          💾 Salvesta
        </button>
        <button id="exportExcelBtn" class="btn px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
          📥 Excel
        </button>
        <button id="exportPdfBtn" class="btn px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
          📄 PDF
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden">
  <div
    class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-lg w-3/4 max-w-4xl">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">Tabeli eelvaade</h2>
      <button id="closePreviewBtn" class="text-gray-500 hover:text-gray-700">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div id="previewContent" class="overflow-x-auto"></div>
  </div>
</div>

<!-- PDF Preview Modal -->
<div id="pdfPreviewModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50">
  <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-6xl h-[80vh] p-6">
    <div class="bg-white rounded-2xl shadow-2xl p-8 border border-gray-200 h-full flex flex-col">
      <!-- Header -->
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-900" x-text="previewPdfName"></h2>
        <button @click="closePdfPreview" class="text-gray-500 hover:text-red-600 transition p-2">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <!-- PDF Preview -->
      <div class="flex-1 overflow-hidden">
        <iframe :src="previewPdfUrl" class="w-full h-full border-0" title="PDF Preview"></iframe>
      </div>
    </div>
  </div>
</div>

<!-- Add this modal markup near your other modals -->
<div x-show="showNewSectionModal" x-cloak x-transition:enter="transition duration-300 ease-out"
  x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
  x-transition:leave="transition duration-200 ease-in" x-transition:leave-start="opacity-100"
  x-transition:leave-end="opacity-0"
  class="fixed inset-0 z-50 overflow-y-auto bg-black/30 backdrop-blur-sm flex items-center justify-center p-4">

  <div class="relative w-full max-w-md rounded-2xl shadow-2xl border border-white/40 bg-white" @click.stop
    x-transition:enter="transition duration-300 ease-out" x-transition:enter-start="opacity-0 scale-95"
    x-transition:enter-end="opacity-100 scale-100">

    <!-- Header -->
    <div class="flex justify-between items-center p-6 border-b border-gray-100">
      <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-700">
        Lisa uus tingimus
      </h2>
      <button @click="showNewSectionModal = false"
        class="rounded-full p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition-colors">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Content -->
    <div class="p-6">
      <div class="space-y-4">
        <div>
          <label for="sectionTitle" class="block text-sm font-medium text-gray-700 mb-1">
            Tingimuse pealkiri
          </label>
          <div class="relative">
            <input type="text" id="sectionTitle" x-model="newSectionTitle" placeholder="Sisesta pealkiri"
              class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-300"
              @keyup.enter="handleNewSection()" />
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex space-x-3 mt-6">
        <button @click="showNewSectionModal = false"
          class="flex-1 px-4 py-3 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 transition-all duration-300">
          Tühista
        </button>
        <button @click="handleNewSection()"
          class="flex-1 px-4 py-3 bg-gradient-to-r from-indigo-600 to-indigo-800 text-white rounded-xl hover:shadow-lg hover:shadow-indigo-500/30 transform hover:-translate-y-0.5 transition-all duration-300">
          Lisa
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Update your Alpine.js data and methods -->

<!-- Reset Form Confirmation Modal -->
<div x-show="showResetConfirmModal" x-cloak x-transition:enter="transition duration-300 ease-out"
  x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
  x-transition:leave="transition duration-200 ease-in" x-transition:leave-start="opacity-100"
  x-transition:leave-end="opacity-0"
  class="fixed inset-0 z-50 overflow-y-auto bg-black/30 backdrop-blur-sm flex items-center justify-center p-4">

  <div class="relative w-full max-w-md rounded-2xl shadow-2xl border border-white/40 bg-white" @click.stop
    x-transition:enter="transition duration-300 ease-out" x-transition:enter-start="opacity-0 scale-95"
    x-transition:enter-end="opacity-100 scale-100">

    <!-- Header -->
    <div class="flex justify-between items-center p-6 border-b border-gray-100">
      <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-red-600 to-red-800">
        Kinnita kustutamine
      </h2>
      <button @click="showResetConfirmModal = false"
        class="rounded-full p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition-colors">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Content -->
    <div class="p-6">
      <p class="text-gray-700 mb-6">
        Kas oled kindel, et soovid kõik andmed kustutada? Seda tegevust ei saa tagasi võtta.
      </p>

      <!-- Actions -->
      <div class="flex space-x-3">
        <button @click="showResetConfirmModal = false"
          class="flex-1 px-4 py-3 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 transition-all duration-300">
          Tühista
        </button>
        <button @click="handleResetConfirm()"
          class="flex-1 px-4 py-3 bg-gradient-to-r from-red-600 to-red-800 text-white rounded-xl hover:shadow-lg hover:shadow-red-500/30 transform hover:-translate-y-0.5 transition-all duration-300">
          Kustuta
        </button>
      </div>
    </div>
  </div>
</div>

</html>