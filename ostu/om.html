<!doctype html>
<html lang="et">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ostumenetluse kutse - Hankest.ee</title>

  <!-- Only include jsPDF -->
  <script src="../assets/js/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    // Wait for jsPDF to be fully loaded
    window.addEventListener("DOMContentLoaded", function () {
      // Check if jsPDF is already available
      if (typeof window.jspdf !== "undefined") {
        console.log("jsPDF loaded successfully");
        return;
      }

      // Try to initialize jsPDF from the UMD bundle
      if (
        typeof window.jspdf === "undefined" &&
        typeof window.jsPDF !== "undefined"
      ) {
        window.jspdf = { jsPDF: window.jsPDF };
        console.log("jsPDF initialized from window.jsPDF");
      } else {
        console.error(
          "jsPDF not found. Please check if the script is properly loaded.",
        );
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <link href="../dist/output.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/daisyui@5.0.0/themes.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary-color: #6366f1;
      --secondary-color: #4f46e5;
      --accent-color: #8b5cf6;
      --success-color: rgba(34, 197, 94, 0.95);
      --error-color: rgba(239, 68, 68, 0.95);
      --info-color: rgba(59, 130, 246, 0.95);
      --clear-color: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      --warning-color: rgba(249, 115, 22, 0.95);
      font-family: "Inter", sans-serif;
    }

    body {
      background-image: url("../src/tornid_ja_linnamuur_kaupo_kalda_2016.jpg") !important;
      background-size: cover !important;
      background-position: center !important;
      background-attachment: fixed !important;
      background-repeat: no-repeat !important;
      color: var(--text-color) !important;
      font-family: "Inter", sans-serif !important;
      min-height: 100vh !important;
      line-height: 1.6 !important;
    }

    .btn {
      @apply rounded-xl font-semibold transition-all duration-300 transform px-5 py-2.5 focus:outline-none focus:ring-2 focus:ring-opacity-50 backdrop-blur-sm shadow-lg hover:scale-105;
    }

    .btn-primary {
      @apply bg-indigo-600/90 hover:bg-indigo-700/90 text-white focus:ring-indigo-500;
    }

    .btn-success {
      @apply bg-emerald-600/90 hover:bg-emerald-700/90 text-white focus:ring-emerald-500;
    }

    .btn-danger {
      @apply bg-red-500/90 hover:bg-red-600/90 text-white focus:ring-red-400;
    }

    .card {
      background-color: rgba(255, 255, 255, 0.85);
      border-radius: 16px;
      box-shadow:
        0 10px 25px -5px rgba(0, 0, 0, 0.1),
        0 8px 10px -6px rgba(0, 0, 0, 0.1);
      padding: 18px;
      transition: all 0.3s ease;

      backdrop-filter: blur(12px);
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow:
        0 15px 20px -5px rgba(0, 0, 0, 0.1),
        0 8px 10px -6px rgba(0, 0, 0, 0.04);

    }

    .toast-success {
      background-color: var(--success-color);
      @apply shadow-lg rounded-xl shadow-green-500/20;
    }

    .toast-error {
      background-color: var(--error-color);
      @apply shadow-lg rounded-xl shadow-red-500/20;
    }

    .toast-info {
      background-color: var(--info-color);
      @apply shadow-lg rounded-xl shadow-blue-500/20;
    }

    /* New modern notification style for clear actions */
    .toast-clear {
      background-image: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      @apply shadow-lg rounded-xl shadow-indigo-500/30;
    }

    .toast-action-button {
      @apply px-3 py-1 bg-white/20 hover:bg-white/30 rounded-lg text-white text-sm font-medium transition-all duration-200;
    }

    .drag-active {
      border-color: var(--primary-color);
      background-color: #eff6ff;
    }

    input[type="text"],
    textarea {
      @apply bg-white/80 backdrop-blur-sm rounded-xl border-gray-200 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition-all duration-200 text-black shadow-md !important;
    }

    input[type="checkbox"] {
      @apply w-5 h-5 rounded-md text-indigo-600 focus:ring-indigo-500 transition-all duration-200 cursor-pointer;
    }

    .section-header {
      @apply flex items-center p-4 font-semibold cursor-pointer bg-white/60 hover:bg-white/70 backdrop-blur-sm rounded-xl transition-all duration-200 !important;
    }

    .section-content {
      @apply ml-8 mt-4 space-y-4 p-4 bg-white/30 backdrop-blur-sm rounded-xl !important;
    }

    [x-cloak] {
      display: none !important;
    }

    @media print {
      body * {
        visibility: hidden;
      }

      #pdfPreview,
      #pdfPreview * {
        visibility: visible;
      }

      #pdfPreview {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }

    #pdfPreview {
      @apply bg-white/50 backdrop-blur-lg rounded-2xl shadow-xl !important;
    }

    #pdfPreview * {
      @apply text-black !important;
    }

    #pdfPreview .bg-indigo-600 {
      @apply bg-gradient-to-r from-indigo-600 to-indigo-800 backdrop-blur-lg text-white p-6 rounded-t-2xl shadow-md !important;
    }

    #pdfPreview h1,
    #pdfPreview h2,
    #pdfPreview h3 {
      @apply text-white !important;
    }

    .highlight-points li {
      @apply text-black font-semibold mb-3 leading-relaxed !important;
    }

    label {
      @apply text-black font-semibold mb-2 block !important;
    }

    nav {
      @apply bg-white/40 backdrop-blur-xl shadow-lg sticky top-0 z-50 border-b border-white/20 !important;
    }

    .nav-link {
      @apply text-gray-800 hover:text-indigo-600 bg-white/30 hover:bg-white/50 px-4 py-2 rounded-full transition-all text-base !important;
    }

    .file-item {
      @apply flex items-center justify-between bg-white/50 p-2 rounded-lg transition-all duration-200 hover:bg-white/70 backdrop-blur-sm border border-white/20;
    }

    .glassmorphism {
      @apply bg-white/70 backdrop-blur-xl border border-white/20 rounded-xl shadow-lg;
    }

    .hover-scale {
      @apply transition-transform duration-300 hover:scale-105;
    }

    .active-section {
      @apply ring-2 ring-indigo-500 ring-opacity-50;
    }

    @media (max-width: 768px) {
      .card {
        @apply p-4;
      }

      .section-content {
        @apply ml-4;
      }
    }

    /* Add these styles to ensure modal visibility */
    #tableModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 9999;
    }

    #tableModal.hidden {
      display: none;
    }

    #tableModal:not(.hidden) {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Add these styles for editable table headers */
    th[contenteditable="true"] {
      cursor: text;
      transition: all 0.2s ease;
    }

    th[contenteditable="true"]:hover {
      background-color: rgba(99, 102, 241, 0.05);
    }

    th[contenteditable="true"]:focus {
      background-color: rgba(99, 102, 241, 0.1);
      outline: none;
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
    }

    th[contenteditable="true"]:empty:before {
      content: attr(data-placeholder);
      color: #9CA3AF;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut,
      setPersistence,
      browserLocalPersistence,
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      arrayUnion,
      arrayRemove,
      addDoc,
      collection,
      getDocs,
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
    import { auth, db } from "../auth/firebase-config.js";

    // Make Firebase objects globally available
    window.auth = auth;
    window.db = db;
    window.onAuthStateChanged = onAuthStateChanged;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword;
    window.signOut = signOut;
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.arrayUnion = arrayUnion;
    window.arrayRemove = arrayRemove;
    window.addDoc = addDoc;
    window.collection = collection;
    window.getDocs = getDocs;

    // Set persistence to LOCAL
    setPersistence(auth, browserLocalPersistence).catch((error) => {
      console.error("Auth persistence error:", error);
    });

    // Make auth and db available globally
    window.auth = auth;
    window.db = db;

    // Add auth state listener
    onAuthStateChanged(auth, async (user) => {
      console.log("Auth state changed:", user ? "User logged in" : "No user");
      if (user) {
        // User is signed in
        window.currentUser = {
          uid: user.uid,
          email: user.email,
        };
        // Load user data from Firestore
        const userDocRef = doc(db, "users", user.uid);
        const userDoc = await getDoc(userDocRef);

        if (userDoc.exists()) {
          window.userData = userDoc.data();
          console.log("User data loaded:", window.userData);
        } else {
          console.log("No user data found, initializing with defaults");
          window.userData = {
            settings: {},
            pdfHistory: [],
          };
        }
      } else {
        window.currentUser = null;
        window.userData = null;
      }
    });

    // Initialize Alpine.js after auth state is determined
    document.addEventListener("DOMContentLoaded", () => {
      // Wait for auth state to be determined
      const checkAuthState = setInterval(() => {
        if (window.currentUser !== undefined) {
          clearInterval(checkAuthState);
          // No need to initialize Alpine.js again - it auto-initializes
          // Alpine.start();
        }
      }, 100);
    });

    // Make logout function available globally
    window.handleLogout = async () => {
      try {
        // Sign out from Firebase
        await signOut(auth);

        // Clear all authentication related data from localStorage
        localStorage.removeItem("currentUser");
        localStorage.removeItem("rememberedUser");
        localStorage.removeItem("previousPage");

        // Force page reload to reset all state
        window.location.reload();
      } catch (error) {
        console.error("Error signing out:", error);
        // Even if there's an error, try to clear local state and reload
        localStorage.removeItem("currentUser");
        localStorage.removeItem("rememberedUser");
        localStorage.removeItem("previousPage");
        window.location.reload();
      }
    };

    // Check authentication state
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Check if there's a remembered user in localStorage
        const rememberedUser = localStorage.getItem("rememberedUser");
        if (rememberedUser) {
          try {
            const { username, password } = JSON.parse(rememberedUser);
            await signInWithEmailAndPassword(auth, username, password);
            return; // The onAuthStateChanged will be triggered again
          } catch (error) {
            console.error("Auto-login failed:", error);
            localStorage.removeItem("rememberedUser");
          }
        }

        // Show login modal and update state
        const formApp = document.querySelector('[x-data="formApp"]')?.__x;
        if (formApp) {
          formApp.$data.showLoginModal = true;
          formApp.$data.currentUser = null;
          formApp.$data.isAdmin = false;
          formApp.$data.showUserMenu = false;
          formApp.$data.showToast("Palun logi sisse", "info");
        }
      } else {
        // Get user data from Firestore
        const userDocRef = doc(db, "users", user.uid);
        const userDoc = await getDoc(userDocRef);
        const userData = userDoc.data();

        // Update Alpine.js state
        const formApp = document.querySelector('[x-data="formApp"]')?.__x;
        if (formApp) {
          formApp.$data.currentUser = {
            id: user.uid,
            email: user.email,
            ...userData,
          };
          formApp.$data.isAdmin = userData?.isAdmin || false;
          formApp.$data.showLoginModal = false;
          formApp.$data.showToast("Edukalt sisse logitud", "success");
        }

        // Store current user in localStorage
        localStorage.setItem(
          "currentUser",
          JSON.stringify({
            id: user.uid,
            email: user.email,
            isAdmin: userData?.isAdmin || false,
          }),
        );
      }
    });

    // Make login function available globally
    window.handleLogin = async (email, password) => {
      try {
        const userCredential = await signInWithEmailAndPassword(
          auth,
          email,
          password,
        );
        const user = userCredential.user;

        // Get or create user document in Firestore
        const userDocRef = doc(db, "users", user.uid);
        const userDoc = await getDoc(userDocRef);
        if (!userDoc.exists()) {
          // Create new user document
          await setDoc(userDocRef, {
            email: user.email,
            isAdmin: user.email.endsWith("@hankest.ee"),
            createdAt: new Date().toISOString(),
            lastLogin: new Date().toISOString(),
          });
        } else {
          // Update last login
          await setDoc(
            doc(db, "users", user.uid),
            {
              lastLogin: new Date().toISOString(),
            },
            { merge: true },
          );
        }

        // Store user in localStorage
        localStorage.setItem(
          "currentUser",
          JSON.stringify({
            id: user.uid,
            email: user.email,
            isAdmin: user.email.endsWith("@hankest.ee"),
          }),
        );

        return user;
      } catch (error) {
        console.error("Login error:", error);
        throw error;
      }
    };
  </script>

  <script>
    document.addEventListener("alpine:init", () => {
      Alpine.data("formData", formDataGenerator);

      function formDataGenerator() {
        const standardFields = [
          {
            key: "buyer",
            label: "Hankija",
            placeholder: "Nimi, aadress, registrikood",
          },
          {
            key: "submission",
            label: "Pakkumise esitamise aeg ja koht",
            placeholder: "nt 10. aprill, e-post",
          },
          {
            key: "validity",
            label: "Pakkumuse jõusoleku aeg",
            placeholder: "nt 30 päeva",
          },
          {
            key: "requirements",
            label: "Nõuded pakkujale",
            placeholder: "nt kogemus 3 aastat",
          },
          {
            key: "criteria",
            label: "Väljavaliku alused",
            placeholder: "Majanduslikult soodsaim",
          },
          {
            key: "responsible",
            label: "Vastutav isik",
            placeholder: "Nimi"
          }
        ];

        const defaultFields = {};
        standardFields.forEach((field) => {
          defaultFields[field.key] = "";
        });

        return {
          standardFields,
          form: {
            name: "",
            intro: 'Lisa hankija nimi teeb Teile ettepaneku esitada pakkumus "Lisa ostetav ese/teenus" ostumenetluse kutses sätestatud tingimustele. Ostumenetluse eesmärk on... ',
            fields: { ...defaultFields },
            sections: [] // Alustame tühja sektsiooniloendiga, mis hiljem laaditakse Firestore'ist
          },
          today: new Date()
            .toLocaleDateString("et-EE", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
            })
            .replace(/\//g, ".")
            .replace(/(\d+)\.(\d+)\.(\d+)/, "$1.$2.$3"),
          toasts: [],
          files: [],
          isDragging: false,
          isGeneratingPDF: false,
          saveTimeout: null,
          isLoading: true,
          errorMessage: "",
          showError: false,
          isDarkMode: false,
          currentUser: null,
          isAdmin: false,
          showUserMenu: false,
          showLoginModal: false,
          showSettingsModal: false,
          activeTab: "info",
          userSettings: {
            buyer: "",
            submission: "",
            validity: "",
            requirements: "",
            criteria: "",
            responsible: "",
            autofillEnabled: false,
            theme: "indigo",
            font: "Inter",
            buttonStyle: "rounded",
            generatedPdfs: [],
            lastUpdated: null,
          },
          previewPdfName: null,
          previewPdfUrl: null,
          showNewSectionModal: false,
          newSectionTitle: '',
          showResetConfirmModal: false,

          // Add tab switching function
          switchTab(tab) {
            this.activeTab = tab;
            if (tab === "history") {
              this.loadPdfHistory();
            } else if (tab === "basicInfo") {
              this.loadUserSettings();
            }
          },

          // Add function to check if tab is active
          isTabActive(tab) {
            return this.activeTab === tab;
          },

          // Funktsioon, mis salvestab form.sections põhja eraldi kollektsiooni Firestore'is
          async saveFormTemplate() {
            try {
              // Lisa andmed form_templates kollektsiooni
              const docRef = await addDoc(collection(db, "form_templates"), {
                name: this.form.name || "Ostumenetluse põhi",
                sections: this.form.sections,
                createdAt: new Date().toISOString()
              });

              console.log("Form template saved to Firestore with ID: ", docRef.id);
              return docRef.id;
            } catch (error) {
              console.error("Error saving form template to Firestore:", error);
              return null;
            }
          },

          // Funktsioon mis laeb form_templates kollektsioonist põhja
          async loadFormTemplate(templateId) {
            try {
              const docRef = doc(db, "form_templates", templateId);
              const docSnap = await getDoc(docRef);

              if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.sections) {
                  this.form.sections = data.sections;
                  if (data.name) {
                    this.form.name = data.name;
                  }
                  console.log("Form template loaded from Firestore");
                  return true;
                }
              }
              return false;
            } catch (error) {
              console.error("Error loading form template from Firestore:", error);
              return false;
            }
          },

          async init() {
            console.log("Initializing form and loading sections from Firestore...");
            try {
              // Loeme sisseehitatud init meetodit  
              console.log("Initializing Alpine.js component...");
              this.checkLocalStorage();

              // Check for remembered user
              const rememberedUser = localStorage.getItem("rememberedUser");
              if (rememberedUser) {
                const { username } = JSON.parse(rememberedUser);
                document.getElementById("emailLogin").value = username;
                document.getElementById("rememberMe").checked = true;
              }

              // Check for current user
              const currentUser = localStorage.getItem("currentUser");
              if (currentUser) {
                const userData = JSON.parse(currentUser);
                this.currentUser = userData;
                this.isAdmin = userData.isAdmin;
                this.showLoginModal = false;
              }

              // Initialize Sortable for the sections
              this.$nextTick(() => {
                if (this.$refs.draggableSections) {
                  new Sortable(this.$refs.draggableSections, {
                    animation: 150,
                    handle: ".drag-handle",
                    onEnd: (evt) => {
                      const newOrder = Array.from(evt.from.children).map(
                        (child) => {
                          return child.__x.$data.section;
                        },
                      );
                      this.form.sections = newOrder;
                      this.saveToStorage();
                    },
                  });
                }
              });

              // Load data from storage initially
              this.loadFromStorage();

              // LISAME SIIA FIRESTORE'I ANDMETE LAADIMISE
              // Oodake, kuni autentimine on läbi
              if (typeof window.currentUser === 'undefined') {
                await new Promise(resolve => {
                  const checkUser = setInterval(() => {
                    if (typeof window.currentUser !== 'undefined') {
                      clearInterval(checkUser);
                      resolve();
                    }
                  }, 100);
                });
              }

              this.isLoading = true;

              // Lae sektsiooniandmed Firestore'ist
              console.log("Loading form sections from Firestore...");
              const formSettingsDoc = await window.getDoc(window.doc(window.db, "formSettings", "main"));

              if (formSettingsDoc.exists()) {
                const data = formSettingsDoc.data();
                console.log("Form data loaded from Firestore:", data);

                if (data.form) {
                  // Laadi ainult sektsiooniandmed ja intro, säilita kasutaja väljad
                  if (data.form.sections && Array.isArray(data.form.sections)) {
                    this.form.sections = data.form.sections;
                    console.log("Sections loaded from Firestore:", this.form.sections);
                  }

                  // Kui intro on olemas, laadi ka see
                  if (data.form.intro) {
                    this.form.intro = data.form.intro;
                  }

                  console.log("Form updated with Firestore data (only sections and intro)");
                } else {
                  console.warn("Form data not found in Firestore document");
                }
              } else {
                console.warn("formSettings/main document does not exist");
              }

              // JÄTKAME TAVALIST INITSIALISEERIMIST
              // Wait until user is fully loaded (onAuthStateChanged)
              const waitForAuth = () => {
                return new Promise((resolve) => {
                  const check = setInterval(() => {
                    if (window.currentUser) {
                      clearInterval(check);
                      resolve();
                    }
                  }, 100);
                });
              };

              await waitForAuth();

              // Lae seaded Firestore'ist
              await this.loadUserSettings();

              // Rakenda autofill, kui lubatud
              if (this.userSettings.autofillEnabled) {
                this.$nextTick(() => {
                  console.log("Applying autofill after auth and nextTick...");
                  this.applyAutofill();
                });
              }

              // Set up manual watcher for form changes
              this.setupFormWatcher();

              // Auto-hide error messages
              setInterval(() => {
                if (this.showError) {
                  this.showError = false;
                }
              }, 5000);

              // Load user settings and PDF history
              await this.loadUserSettings();

              // Listen for user data updates
              window.addEventListener("userDataUpdated", (event) => {
                console.log("Received user data update:", event.detail);
                const { currentUser, userData } = event.detail;
                this.currentUser = currentUser;
                if (userData) {
                  window.userData = userData;
                  if (userData.pdfHistory) {
                    this.userSettings.generatedPdfs = userData.pdfHistory;
                    console.log(
                      "Updated PDF history in Alpine:",
                      this.userSettings.generatedPdfs,
                    );
                  }
                } else {
                  window.userData = null;
                  this.userSettings.generatedPdfs = [];
                }
              });

              // Set up watchers
              this.watchAutofill();
              this.watchBasicDataFields();

              // Lae eelsätted
              this.loadFormPresets();

            } catch (error) {
              console.error("Error initializing form:", error);
              this.errorMessage = "Vormi algandmete laadimine ebaõnnestus. Proovige uuesti laadida lehte.";
              this.showError = true;
            } finally {
              this.isLoading = false;
            }
          },

          async loadPdfHistory() {
            try {
              console.log('Loading PDF history...');
              if (window.currentUser) {
                if (window.userData && window.userData.pdfHistory) {
                  console.log('Loading PDF history from global data');
                  this.userSettings.generatedPdfs = window.userData.pdfHistory;
                } else {
                  // Fetch from Firestore if not in global data
                  const userRef = doc(window.db, "users", window.currentUser.uid);
                  const userDoc = await getDoc(userRef);
                  if (userDoc.exists()) {
                    const data = userDoc.data();
                    if (data.pdfHistory) {
                      this.userSettings.generatedPdfs = data.pdfHistory;
                      // Update global state
                      window.userData = {
                        ...window.userData,
                        pdfHistory: data.pdfHistory
                      };
                    } else {
                      this.userSettings.generatedPdfs = [];
                    }
                  }
                }
              } else {
                this.userSettings.generatedPdfs = [];
              }
            } catch (error) {
              console.error('Error loading PDF history:', error);
              this.showToast('Viga PDF ajaloo laadimisel: ' + error.message, 'error');
              this.userSettings.generatedPdfs = [];
            }
          },

          async restoreDraftFromFirestore() {
            if (!window.currentUser) return;

            try {
              const userRef = doc(window.db, "users", window.currentUser.uid);
              const userDoc = await getDoc(userRef);
              const data = userDoc.data();
              if (data?.draft) {
                this.form = data.draft;
                this.showToast("Vorm taastatud Firestore'ist", "success");
              } else {
                this.showToast("Vormi mustandit ei leitud", "error");
              }
            } catch (error) {
              console.error("Error restoring draft:", error);
              this.showToast("Viga mustandi taastamisel: " + error.message, "error");
            }
          },

          async loadUserSettings() {
            try {
              console.log("Loading user settings...");
              if (window.currentUser) {
                console.log("User is logged in, loading from Firestore");
                const userRef = doc(
                  window.db,
                  "users",
                  window.currentUser.uid,
                );
                const userDoc = await getDoc(userRef);

                if (userDoc.exists()) {
                  const userData = userDoc.data();
                  console.log("Loaded user data:", userData);

                  const settings = userData.settings || {}; // <== FIRESTORE salvestab seaded siin!

                  this.userSettings = {
                    buyer: settings.buyer || "",
                    submission: settings.submission || "",
                    validity: settings.validity || "",
                    requirements: settings.requirements || "",
                    criteria: settings.criteria || "",
                    responsible: settings.responsible || "",
                    autofillEnabled: settings.autofillEnabled || false,
                    generatedPdfs: userData.pdfHistory || [],
                  };

                  if (this.userSettings.autofillEnabled) {
                    this.applyAutofill();
                  }

                  console.log("Updated userSettings:", this.userSettings);
                } else {
                  console.log(
                    "No user document found, using default settings",
                  );
                  this.userSettings = {
                    buyer: "",
                    submission: "",
                    validity: "",
                    requirements: "",
                    criteria: "",
                    responsible: "",
                    autofillEnabled: false,
                    theme: "indigo",
                    font: "Inter",
                    buttonStyle: "rounded",
                    generatedPdfs: [],
                    lastUpdated: null,
                  };
                }
              } else {
                console.log(
                  "No user logged in, falling back to localStorage",
                );
                // Fallback to localStorage
                const savedSettings = localStorage.getItem("userSettings");
                if (savedSettings) {
                  const settings = JSON.parse(savedSettings);
                  Object.keys(settings).forEach((key) => {
                    if (this.userSettings.hasOwnProperty(key)) {
                      this.userSettings[key] = settings[key];
                    }
                  });
                }
              }

              console.log("Final userSettings:", this.userSettings);
            } catch (error) {
              console.error("Settings load error:", error);
              this.showToast(
                "Viga seadete laadimisel: " + error.message,
                "error",
              );
            }
          },
          async loadFieldSettingsFromFirestore() {
            try {
              const fieldDoc = await window.getDoc(
                window.doc(window.db, "fieldSettings", "main")
              );
              if (fieldDoc.exists()) {
                this.form.sections = fieldDoc.data().sections;
                console.log("Väljad laetud:", this.form.sections);
              } else {
                console.warn("Väljade andmeid ei leitud");
              }
            } catch (error) {
              console.error("Viga Firestore andmete laadimisel:", error);
              this.showToast("Viga väljade laadimisel: " + error.message, "error");
            }
          },
          async saveUserSettings() {
            try {
              console.log("Saving user settings...");
              // Apply theme changes immediately
              this.applyTheme();

              // Save to Firestore if logged in
              if (window.currentUser) {
                console.log(
                  "User is logged in, saving to Firestore:",
                  window.currentUser.uid,
                );
                const userRef = doc(
                  window.db,
                  "users",
                  window.currentUser.uid,
                );

                // Create settings object without generatedPdfs
                const settingsToSave = { ...this.userSettings };
                delete settingsToSave.generatedPdfs;
                delete settingsToSave.lastUpdated;

                console.log("Saving to Firestore:", {
                  settings: settingsToSave,
                  pdfHistory: this.userSettings.generatedPdfs,
                  lastUpdated: new Date().toISOString(),
                });

                await setDoc(
                  userRef,
                  {
                    settings: settingsToSave,
                    pdfHistory: this.userSettings.generatedPdfs,
                    lastUpdated: new Date().toISOString(),
                  },
                  { merge: true },
                );

                // Update global state
                if (window.userData) {
                  window.userData.settings = settingsToSave;
                  window.userData.pdfHistory =
                    this.userSettings.generatedPdfs;
                }

                this.showToast("Seaded salvestatud", "success");
              } else {
                console.log("User not logged in, saving to localStorage");
                // Save to localStorage if not logged in
                localStorage.setItem(
                  "userSettings",
                  JSON.stringify(this.userSettings),
                );
                this.showToast("Seaded salvestatud", "success");
              }
            } catch (error) {
              console.error("Settings save error:", error);
              this.showToast(
                "Viga seadete salvestamisel: " + error.message,
                "error",
              );
            }
          },

          async login() {
            const email = document.getElementById("emailLogin").value;
            const password = document.getElementById("passwordLogin").value;
            const rememberMe = document.getElementById("rememberMe").checked;

            try {
              await window.handleLogin(email, password);

              // Handle remember me
              if (rememberMe) {
                localStorage.setItem(
                  "rememberedUser",
                  JSON.stringify({
                    username: email,
                    password: password,
                  }),
                );
              } else {
                localStorage.removeItem("rememberedUser");
              }

              this.showToast("Sisselogimine õnnestus", "success");
              this.showLoginModal = false;
              // Force Alpine.js to update the state
              this.$nextTick(() => {
                this.currentUser = window.auth.currentUser
                  ? {
                    id: window.auth.currentUser.uid,
                    email: window.auth.currentUser.email,
                    isAdmin:
                      window.auth.currentUser.email.endsWith("@hankest.ee"),
                  }
                  : null;
                this.isAdmin = this.currentUser?.isAdmin || false;
              });
            } catch (error) {
              this.showToast(this.getErrorMessage(error.code), "error");
            }
          },

          getErrorMessage(errorCode) {
            const errorMessages = {
              "auth/invalid-email": "Vigane e-posti aadress",
              "auth/user-disabled": "Kasutaja on deaktiveeritud",
              "auth/user-not-found": "Kasutajat ei leitud",
              "auth/wrong-password": "Vale parool",
              "auth/too-many-requests":
                "Liiga palju katsetusi. Palun proovige hiljem uuesti",
              "auth/network-request-failed":
                "Võrgu viga. Palun kontrollige oma internetiühendust",
            };
            return errorMessages[errorCode] || "Sisselogimisel tekkis viga";
          },

          checkLocalStorage() {
            try {
              // Test if localStorage is available
              if (typeof localStorage === "undefined") {
                this.showToast("localStorage ei ole saadaval", "error");
                return false;
              }

              // Test writing and reading
              localStorage.setItem("test", "test");
              if (localStorage.getItem("test") !== "test") {
                this.showToast("localStorage ei tööta korralikult", "error");
                return false;
              }
              localStorage.removeItem("test");

              // Check available space (estimate)
              let totalSize = 0;
              for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                  totalSize += (localStorage[key].length || 0) * 2; // UTF-16 characters = 2 bytes
                }
              }

              const availableSpace = 5 * 1024 * 1024 - totalSize; // 5MB is a common limit
              if (availableSpace < 500000) {
                // If less than 500KB available
                this.showToast(
                  "Hoiatus: localStorage on peaaegu täis",
                  "info",
                );
              }

              return true;
            } catch (error) {
              console.error("localStorage check failed:", error);
              this.showToast(
                "Viga localStorage kontrollimisel: " + error.message,
                "error",
              );
              return false;
            }
          },

          setupFormWatcher() {
            // Watch for changes to form inputs
            document.addEventListener("input", (e) => {
              if (
                e.target.hasAttribute("x-model") ||
                e.target.closest("[x-model]") ||
                e.target.closest("[x-data]")
              ) {
                this.debouncedSave();
              }
            });

            // Also watch for checkbox changes
            document.addEventListener("change", (e) => {
              if (e.target.type === "checkbox") {
                this.debouncedSave();
              }
            });
          },

          get visibleSections() {
            return this.form.sections.filter(
              (s) => s.enabled && s.options.some((o) => o.checked),
            );
          },

          validateForm() {
            if (!this.form.name?.trim()) {
              this.showToast("Palun sisesta ostumenetluse nimi", "error");
              return false;
            }
            if (!this.form.fields?.buyer?.trim()) {
              this.showToast("Palun täida hankija andmed", "error");
              return false;
            }
            return true;
          },

          async generatePDF() {
            try {
              this.isGeneratingPDF = true;
              console.log("Generating PDF...");

              if (!this.validateForm()) return;

              // Check if jsPDF is properly loaded
              if (
                typeof window.jspdf === "undefined" ||
                typeof window.jspdf.jsPDF === "undefined"
              ) {
                if (typeof window.jsPDF !== "undefined") {
                  window.jspdf = { jsPDF: window.jsPDF };
                } else {
                  throw new Error("jsPDF not properly loaded");
                }
              }

              const { jsPDF } = window.jspdf;
              const doc = new jsPDF("p", "mm", "a4");

              // Add header with logo and title
              doc.setFillColor(79, 70, 229); // Indigo color
              doc.rect(0, 0, 210, 30, "F");
              doc.setTextColor(255, 255, 255);
              doc.setFontSize(24);
              doc.setFont(undefined, "bold");
              doc.text(this.form.name || "Ostumenetluse kutse", 105, 20, {
                align: "center",
              });

              // Add intro text with modern styling
              doc.setFontSize(11);
              doc.setTextColor(0, 0, 0);
              let yPos = 40;
              const introLines = doc.splitTextToSize(this.form.intro, 170);
              doc.text(introLines, 20, yPos);
              yPos += introLines.length * 6 + 10;

              // Add standard fields with modern styling
              doc.setFontSize(11);
              this.standardFields.forEach((field) => {
                const fieldValue = this.form.fields[field.key] || "";
                if (fieldValue.trim() !== "") {
                  // Add field label with background
                  doc.setFillColor(243, 244, 246); // Light gray background
                  doc.rect(20, yPos - 2, 170, 6, "F");

                  doc.setFont(undefined, "bold");
                  doc.setTextColor(79, 70, 229); // Indigo color for labels
                  doc.text(`${field.label}: `, 22, yPos);
                  const textWidth = doc.getTextWidth(`${field.label}: `);

                  doc.setFont(undefined, "normal");
                  doc.setTextColor(0, 0, 0);
                  const valueLines = doc.splitTextToSize(fieldValue, 150);
                  doc.text(valueLines, 22 + textWidth, yPos);

                  yPos += valueLines.length * 6 + 4;
                }
              });

              // Add sections with modern styling
              let sectionNumber = 1;
              this.visibleSections.forEach((section) => {
                yPos += 5;

                // Section title with modern styling
                doc.setFontSize(14);
                doc.setFont(undefined, "bold");
                doc.setTextColor(79, 70, 229); // Indigo color for section titles
                const originalTitle = section.title;
                const newTitle = `${sectionNumber} ${originalTitle.split(" ").slice(1).join(" ")}`;

                // Add underline for section title
                doc.text(newTitle, 20, yPos);
                doc.setLineWidth(0.5);
                doc.line(20, yPos + 1, 190, yPos + 1);

                yPos += 10;

                // Section options with modern styling
                doc.setFontSize(11);
                doc.setFont(undefined, "normal");
                doc.setTextColor(0, 0, 0);

                section.options
                  .filter((o) => o.checked)
                  .forEach((opt, i) => {
                    const optionText = `${sectionNumber}.${i + 1} ${opt.text}`;
                    const optLines = doc.splitTextToSize(optionText, 160);

                    // Add bullet point with custom styling
                    doc.setFillColor(79, 70, 229);

                    doc.text(optLines, 25, yPos);

                    // Calculate total height needed for this option
                    const optionHeight = optLines.length * 5; // Reduced from 6 to 5
                    yPos += optionHeight + 2; // Reduced spacing from 5 to 2

                    // Check if we need a new page
                    if (yPos > 270) {
                      doc.addPage();
                      yPos = 20;
                    }
                  });

                sectionNumber++;
              });

              // Add footer with modern styling
              yPos = Math.min(yPos + 10, 270); // Reduced from 15 to 10
              doc.setLineWidth(0.5);
              doc.line(20, yPos, 190, yPos);
              yPos += 10;

              doc.setFontSize(10);
              doc.setFont(undefined, "bold");
              doc.setTextColor(79, 70, 229);
              doc.text(`Kuupäev: ${this.today}`, 20, yPos);
              yPos += 6;
              doc.text(
                `Vastutav isik: ${this.form.fields.responsible || ""}`,
                20,
                yPos,
              );

              // Add attachments with modern styling
              if (this.files?.length > 0) {
                yPos += 10;
                doc.setFontSize(12);
                doc.setFont(undefined, "bold");
                doc.setTextColor(79, 70, 229);
                doc.text("Manused:", 20, yPos);
                yPos += 5;

                doc.setFontSize(10);
                doc.setFont(undefined, "normal");
                doc.setTextColor(0, 0, 0);
                this.files.forEach((file, i) => {
                  // Add file icon
                  doc.setFillColor(79, 70, 229);
                  doc.rect(22, yPos - 1, 1.5, 1.5, "F");
                  doc.text(
                    `${i + 1}. ${file.name} (${this.formatFileSize(file.size)}) ${file.comment || ""}`,
                    25,
                    yPos,
                  );
                  yPos += 6;
                });
              }

              // Save the PDF
              const pdfName = `${this.form.name || "ostumenetlus"}.pdf`;
              const pdfData = doc.output("datauristring");

              // Save PDF to Firestore if user is logged in
              if (window.currentUser) {
                console.log("User is logged in, saving PDF to Firestore");
                // Use the functions directly from window object
                const userRef = window.doc(
                  window.db,
                  "users",
                  window.currentUser.uid,
                );

                const pdfEntry = {
                  id: Date.now().toString(),
                  name: `${this.form.name || "Pakkumus"}_${new Date().toLocaleDateString("et-EE")}.pdf`,
                  pdfData: pdfData,
                  createdAt: new Date().toISOString(),
                  responsible: this.form.fields.responsible || "",
                  submissionDate: this.form.fields.submission || "",
                };

                console.log("Saving PDF entry:", pdfEntry);

                // Get current user data
                const userDoc = await window.getDoc(userRef);
                const currentData = userDoc.exists() ? userDoc.data() : {};
                const currentPdfHistory = currentData.pdfHistory || [];

                console.log("Current PDF history:", currentPdfHistory);

                // Add new PDF and keep only last 10
                const updatedPdfHistory = [
                  pdfEntry,
                  ...currentPdfHistory,
                ].slice(0, 10);

                console.log("Updated PDF history:", updatedPdfHistory);

                // Update Firestore
                await window.setDoc(
                  userRef,
                  {
                    pdfHistory: updatedPdfHistory,
                    lastUpdated: new Date().toISOString(),
                  },
                  { merge: true },
                );

                // Update global state
                window.userData = {
                  ...window.userData,
                  pdfHistory: updatedPdfHistory,
                  lastUpdated: new Date().toISOString(),
                };

                // Update local state
                this.userSettings.generatedPdfs = updatedPdfHistory;

                console.log("PDF saved to Firestore successfully");
              } else {
                console.log("No user logged in, not saving PDF to Firestore");
              }

              // Download the PDF
              doc.save(pdfName);

              this.showToast("PDF edukalt loodud", "success");
            } catch (error) {
              console.error("PDF generation error:", error);
              this.showToast(
                "Viga PDF genereerimisel: " + error.message,
                "error",
              );
            } finally {
              this.isGeneratingPDF = false;
            }
          },

          debouncedSave() {
            if (this.saveTimeout) {
              clearTimeout(this.saveTimeout);
            }
            this.saveTimeout = setTimeout(() => {
              this.saveToStorage();
              this.saveToFirestoreDraft();
            }, 2000);
          },

          saveToStorage() {
            try {
              localStorage.setItem('OM_DRAFT', JSON.stringify(this.form));
              console.log('Form saved to localStorage');
            } catch (error) {
              console.error('Error saving to localStorage:', error);
            }
          },

          loadFromStorage() {
            try {
              const raw = localStorage.getItem("OM_DRAFT");
              if (!raw) {
                console.log("No saved data found in localStorage");
                return false;
              }

              const data = JSON.parse(raw);
              if (data.version === "1.4" && data.form) {
                console.log("Loading saved form data:", data.form);

                // Create a fresh default form
                const freshDefaultFields = {};
                this.standardFields.forEach((field) => {
                  freshDefaultFields[field.key] = "";
                });

                // Apply saved data to the form
                this.form = {
                  name: data.form.name || "",
                  intro:
                    data.form.intro ||
                    'Lisa hankija nimi teeb Teile ettepaneku esitada pakkumus "Lisa ostetav ese/teenus" ostumenetluse kutses sätestatud tingimustele. Ostumenetluse eesmärk on... ',
                  fields: {
                    ...freshDefaultFields,
                    ...(data.form.fields || {}),
                  },
                  sections: data.form.sections || this.form.sections,
                };

                // Load files if present
                if (
                  data.files &&
                  Array.isArray(data.files) &&
                  data.files.length > 0
                ) {
                  this.files = data.files;
                }

                this.showToast("Laaditud salvestatud andmed", "success");
                return true;
              } else {
                console.warn(
                  "Incompatible data version or missing form data",
                );
                localStorage.removeItem("OM_DRAFT");
                this.showToast(

                  "info",
                );
                return false;
              }
            } catch (error) {
              console.error(
                "Failed to load from storage:",
                error,
                error.stack,
              );
              localStorage.removeItem("OM_DRAFT");
              this.showToast(
                "Viga andmete laadimisel: " + error.message,
                "error",
              );
              return false;
            }
          },

          manualSave() {
            // This is called directly from the save button click
            clearTimeout(this.saveTimeout); // Clear any pending save
            const success = this.saveToStorage();
            if (success) {
              this.showToast("Andmed edukalt salvestatud!", "success");
            }
          },

          addAttachment() {
            const lisaCount = this.form.sections[6].options.length + 1;
            this.form.sections[6].options.push({
              text: `Lisa ${lisaCount}. `,
              checked: false,
              editable: true,
            });
            this.showToast("Lisa lisatud", "success");
          },

          addNewSection() {
            this.newSectionTitle = '';
            this.showNewSectionModal = true;
          },

          handleNewSection() {
            const rawTitle = this.newSectionTitle.trim();

            if (!rawTitle) {
              this.showToast("Pealkiri jäi sisestamata", "error");
              return;
            }

            const nextNum = this.form.sections.length + 1;
            const title = `${nextNum}. ${rawTitle}`;

            this.form.sections.push({
              title,
              enabled: false,
              open: true,
              options: [
                {
                  text: "Lisa tingimus",
                  checked: false,
                  editable: true,
                  isEditing: true,
                },
              ],
            });

            this.showToast("Uus tingimus lisatud", "success");
            this.showNewSectionModal = false;
          },

          toggleAllSections() {
            const hasClosedSections = this.form.sections.some(
              (section) => !section.open,
            );
            this.form.sections.forEach((section) => {
              section.open = hasClosedSections;
            });
            this.showToast(
              hasClosedSections
                ? "Kõik avatud"
                : "Kõik suletud",
              "success",
            );
          },

          selectAllOptions() {
            const hasUncheckedOptions = this.form.sections.some((section) =>
              section.options.some((option) => !option.checked),
            );

            this.form.sections.forEach((section) => {
              section.enabled = true;
              section.options.forEach((option) => {
                option.checked = hasUncheckedOptions;
              });
            });
            this.showToast(
              hasUncheckedOptions
                ? "Kõik tingimused lisatud"
                : "Kõik tingimused eemaldatud",
              "success",
            );
          },

          showToast(message, type = "OK!", duration = 3000) {
            const toast = {
              id: Date.now(),
              message,
              type,
              duration,
            };
            this.toasts.push(toast);
            setTimeout(() => {
              this.toasts = this.toasts.filter((t) => t.id !== toast.id);
            }, duration);
          },

          // New function for showing toast with action
          showActionToast(
            message,
            type = "clear",
            duration = 6000,
            actionText = null,
            actionCallback = null,
          ) {
            console.log("Showing action toast:", {
              message,
              type,
              duration,
              actionText,
            });

            // Force gradient styles for clear toasts
            if (type === "clear") {
              document.documentElement.style.setProperty(
                "--clear-color",
                "linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%)",
              );
            }

            const toast = {
              id: Date.now(),
              message,
              type,
              duration,
              actionText,
              actionCallback,
            };

            this.toasts.push(toast);
            console.log("Current toasts:", this.toasts);

            setTimeout(() => {
              this.toasts = this.toasts.filter((t) => t.id !== toast.id);
            }, duration);
          },

          handleDragOver(e) {
            e.preventDefault();
            this.isDragging = true;
          },

          handleDragLeave() {
            this.isDragging = false;
          },

          handleDrop(e) {
            e.preventDefault();
            this.isDragging = false;
            const files = Array.from(e.dataTransfer.files);
            this.processFiles(files);
          },

          handleFileInput(e) {
            const files = Array.from(e.target.files);
            this.processFiles(files);
            e.target.value = ""; // Reset input
          },

          processFiles(files) {
            const maxFileSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = [
              "application/pdf",
              "image/jpeg",
              "image/png",
              "image/gif",
            ];

            Array.from(files).forEach((file) => {
              if (file.size > maxFileSize) {
                this.showToast(
                  `Fail ${file.name} on liiga suur. Maksimaalne suurus on 10MB.`,
                  "error",
                );
                return;
              }

              if (!allowedTypes.includes(file.type)) {
                this.showToast(
                  `Fail ${file.name} on sobimatu tüüp. Lubatud on PDF ja pildifailid.`,
                  "error",
                );
                return;
              }

              const reader = new FileReader();
              reader.onload = (e) => {
                this.files.push({
                  name: file.name,
                  size: file.size,
                  type: file.type,
                  data: e.target.result,
                  comment: "",
                });
                this.showToast("Fail lisatud", "success");
              };
              reader.onerror = () => {
                this.showToast(
                  `Faili ${file.name} lugemisel tekkis viga`,
                  "error",
                );
              };
              reader.readAsDataURL(file);
            });
          },

          removeFile(index) {
            const fileName = this.files[index].name;
            this.files.splice(index, 1);
            this.showToast(`Fail ${fileName} eemaldatud`, "info");
          },

          formatFileSize(bytes) {
            if (bytes === 0) return "0 Bytes";
            const k = 1024;
            const sizes = ["Bytes", "KB", "MB", "GB"];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (
              parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]
            );
          },

          resetForm() {
            this.showResetConfirmModal = true;
          },

          handleResetConfirm() {
            // Reset to default form structure
            this.form = {
              name: "",
              intro:
                "(Lisa hankija nimi) teeb Teile ettepaneku esitada pakkumus (Lisa ostetava eseme/teenuse nimi ja kirjeldus) ostumenetluse kutses sätestatud tingimustele. Ostumenetluse eesmärk on (täpsusta kas lepingu sõlmimine või tellimuse tegemine)",
              fields: { ...defaultFields },
              sections: [
                {
                  title: "1. Üldised tingimused",
                  enabled: true,
                  open: false,
                  options: [
                    {
                      text: "Ettevõtjatel on õigus küsida kutse kohta selgitusi, esitades küsimused e-posti teel ostumenetluse eest vastutavale isikule. Hankija vastab ettevõtja küsimustele kolme tööpäeva jooksul. Hankija edastab esitatud küsimused ja antud vastused samaaegselt kõigile ettevõtjatele, kellele tehti ettepanek pakkumuse esitamiseks. Telefoni teel esitatud küsimustele ei vastata.",
                      checked: false,
                    },
                    {
                      text: "Hankijal on õigus enne pakkumuste esitamise tähtaega muuta vajadusel kutset. Kutse muutmisel teavitab hankija sellest kõiki ettevõtjaid, kellele on tehtud ettepanek pakkumuste esitamiseks ja edastab ettevõtjatele muudetud kutse. Hankija võib pikendada pakkumuste esitamise tähtaega.",
                      checked: false,
                    },
                    {
                      text: 'Iga viidet, mille hankija teeb kutses mõnele standardile, tehnilisele tunnusele, kontrollsüsteemile, ostuallikale, protsessile, kaubamärgile, patendile, tüübile, päritolule või tootmisviisile, tuleb lugeda selliselt, et see on täiendatud märkega „või sellega samaväärne".',
                      checked: false,
                    },
                    {
                      text: "Hankija ei sõlmi hankelepingut pakkujaga, kellel on maksuvõlg (kohalikud maksud Tallinna linnale ja riiklik maksuvõlg). Enne hankelepingu sõlmimist kontrollib hankija pakkujal maksuvõla puudumist. Kui pakkujal esineb maksuvõlg, siis teavitab hankija sellest pakkujat ja annab pakkujale kaks tööpäeva maksuvõla tasumiseks või täies ulatuses ajatamiseks. Hankija võib anda ka pikema tähtaja maksuvõla tasumiseks või täies ulatuses ajatamiseks. Kui hankija poolt antud tähtaja jooksul pakkuja maksuvõlga ei tasu või täies ulatuses ei ajata, siis kõrvaldab hankija pakkuja ostumenetluselt. ",
                      checked: false,
                    },
                    {
                      text: "Arve maksetähtaeg peab olema vähemalt 21 päeva.",
                      checked: true,
                    },
                  ],
                },
                {
                  title: "2. Ostumenetluse tehniline kirjeldus",
                  enabled: true,
                  open: false,
                  options: [
                    {
                      text: '"Hankija lisab siia tehnilise kirjelduse" - Lisada kas viide eraldi failile kui TK on eraldi või kopeerida siia lihtsalt tehniline kirjeldus teenuse/asja kohta, mida soovitakse osta.',
                      checked: false,
                      editable: true,
                    },
                  ],
                },
                {
                  title: "3 Nõuded pakkumusele",
                  enabled: true,
                  open: false,
                  options: [
                    {
                      text: "Pakkumus on pakkuja tahteavaldus tellimuse täitmiseks ja on selle esitamisel pakkujale siduv alates esitamisest kuni pakkumuse jõusoleku minimaalse tähtaja lõpuni. Hankijal on õigus teha ettepanek pakkumuse jõusoleku tähtaja pikendamiseks. Tingimusliku pakkumuse esitamine on keelatud.",
                      checked: false,
                    },
                    {
                      text: "Hilinenud pakkumusi hankija vastu ei võta.",
                      checked: false,
                    },
                    {
                      text: "Pakkumus peab sisaldama pakkumuse maksumust vastavalt lisale 1.",
                      checked: false,
                    },
                    {
                      text: "Pakkumus peab sisaldama pakkumuse kirjeldust, mis võimaldab hankijal kontrollida kutse punktis 2 sätestatud tingimustele vastavust.",
                      checked: false,
                    },
                    {
                      text: "Pakkuja kannab kõik pakkumuse ettevalmistamise ja esitamisega seotud kulud ning pakkumuse tähtaegse esitamise riski.",
                      checked: false,
                    },
                    {
                      text: "Pakkumus on konfidentsiaalne kuni tellimuse tegemiseni.",
                      checked: false,
                    },
                    {
                      text: "Pakkuja märgib pakkumuses, milline teave pakkumusest on ärisaladus ning põhjendab ärisaladuseks määramist. Ärisaladusena ei või märkida pakkumuse maksumust (sh osamaksumusi kui need on hindamise aluseks) (RHS § 46 1 ). Kui põhjendust pakkumuses ei sisaldu, siis eeldab hankija, et ärisaladus puudub. Hankija ei avalikusta pakkumuse sisu ärisaladusega kaetud osas.",
                      checked: false,
                    },
                  ],
                },
                {
                  title:
                    "4 Pakkumuste kontroll, hindamine ja eduka pakkumuse valik",
                  enabled: true,
                  open: false,
                  options: [
                    {
                      text: "Hankija kontrollib tähtaegselt esitatud pakkumuste vastavust kutses esitatud tingimustele. Juhul, kui pakkumus ei vasta kutses esitatud tingimustele, lükkab hankija pakkumuse tagasi.",
                      checked: false,
                    },
                    {
                      text: "Hankijal on õigus küsida pakkujalt esitatud pakkumuse kohta täpsustavaid andmeid ja täpsustavaid selgitusi.",
                      checked: false,
                    },
                    {
                      text: "Kutses esitatud tingimustele vastavate pakkumuste seast valib hankija eduka pakkumuse välja madalaima hinna alusel. Juhul, kui esitatud maksumused on võrdsed, korraldab hankija eduka pakkumuse väljaselgitamiseks liisuheitmise, võimaldades võrdse pakkumuse esitanud pakkujatel liisuheitmise juures viibida.",
                      checked: false,
                    },
                    {
                      text: "Kui edukas pakkuja võtab hankijast mitteolenevatel põhjustel oma pakkumuse tagasi, ei allkirjasta hankija antud tähtaja jooksul hankelepingut või ei asu nõustumuse andmisega sõlmitud hankelepingut pakkujast tulenevatel põhjustel hankija määratud aja jooksul täitma, hindab hankija kõiki ülejäänud pakkumusi uuesti ja tunnistab edukaks pakkumuse, mis on vastavaks tunnistatud pakkumustest majanduslikult soodsaim.",
                      checked: false,
                    },
                    {
                      text: "Hankija ei ole kohustatud korra punktis 4.5 nimetatud alusel pakkumusi uuesti hindama ja võib tunnistada edukaks esialgsel hindamisel leitud järjestuselt teise pakkumuse juhul, kui edukaks tunnistatud pakkumuse äralangemine ei saa mõjutada ülejäänud pakkumuste omavahelist järjestust.",
                      checked: false,
                    },
                  ],
                },
                {
                  title: "5 Läbirääkimiste pidamine",
                  enabled: true,
                  open: false,
                  options: [
                    {
                      text: "Hankijal on õigus pidada läbirääkimisi esitatud pakkumuse sisu, maksumuse ning ostukutsest sätestatud tingimuste üle.",
                      checked: false,
                    },
                    {
                      text: "Vastavalt läbirääkimiste pidamise vajadusele teatab hankija pakkujatele läbirääkimiste aja. Iga pakkujaga peetakse läbirääkimisi eraldi. Läbirääkimisi võib pidada kirjalikku taasesitamist võimaldavas vormis (nt e-kiri) või suuliselt. Suuliselt peetud läbirääkimised protokollitakse. Läbirääkimised on konfidentsiaalsed. Hankija tagab läbirääkimiste käigus pakkujate võrdse kohtlemise.",
                      checked: false,
                    },
                    {
                      text: "Pärast läbirääkimiste toimumist esitab pakkuja vajadusel uue kohandatud pakkumuse, mis esitatakse läbirääkimistel kokku lepitud tähtajaks.",
                      checked: false,
                    },
                    {
                      text: "Hankija ei ole kohustatud läbirääkimisi pidama.",
                      checked: false,
                    },
                  ],
                },
                {
                  title:
                    "6 Pakkumuste tagasi lükkamine ja kehtetuks tunnistamine",
                  enabled: true,
                  open: false,
                  options: [
                    {
                      text: "Hankijal on õigus kõik esitatud või kutses toodud tingimustele vastavad pakkumused tagasi lükata igal ajal enne lepingu sõlmimist või tellimuse tegemist, kui esitatud pakkumuste maksumused ületavad eeldatavat maksumust. Hankija teavitab pakkujaid kõigi pakkumuste tagasilükkamisest.",
                      checked: false,
                    },
                    {
                      text: "Kui hankijal on tekkinud vajadus pärast pakkumuste esitamise tähtpäeva kutses esitatud tingimusi olulisel määral muuta või kui ostumenetluse läbiviimise aluseks olevad tingimused on oluliselt muutunud ja seetõttu osutub ostumenetluse esemeks oleva asja või teenuse tellimine mittevajalikuks, saadab hankija pakkujatele sellekohase teavituse.",
                      checked: false,
                    },
                    {
                      text: "Hankija võib ostumenetluse kehtetuks tunnistada, kui hankija tuvastab peale pakkumuste esitamise tähtpäeva, et on teinud ostumenetluse kutses vea, mida ei ole võimalik enam antud etapis seaduspäraselt parandada.",
                      checked: false,
                    },
                  ],
                },
                {
                  title: "7 Lisad",
                  enabled: true,
                  open: false,
                  options: [
                    { text: "Lisa 1. ", checked: false, editable: true },
                  ],
                },
              ],
            };

            // Clear files
            this.files = [];

            // Remove from local storage
            localStorage.removeItem("OM_DRAFT");

            // Close modal
            this.showResetConfirmModal = false;

            // Show success messages
            this.showToast("Vorm on tühjendatud ✅", "success");
            this.showActionToast(
              "Vorm on tühjendatud",
              "clear",
              5000,
              "",
              () => {
                this.showToast("Andmeid ei saa taastada", "info");
              }
            );
          },

          addOption(sectionIndex) {
            const section = this.form.sections[sectionIndex];
            const optionCount = section.options.length + 1;

            let newOption;
            if (sectionIndex === 6) {
              // Lisad section
              newOption = {
                text: `Lisa ${optionCount}. `,
                checked: false,
                editable: true,
              };
            } else if (sectionIndex === 0) {
              // Üldised tingimused section
              newOption = {
                text: `${optionCount}. `,
                checked: false,
                checked: true,
                editable: true,
                isEditing: true,
              };
            } else {
              // Other sections
              newOption = {
                text: `${optionCount}. `,
                checked: false,
                editable: true,
                isEditing: true,
              };
            }

            section.options.push(newOption);
            this.showToast("Punkt lisatud", "success");
          },

          toggleUserMenu() {
            if (this.currentUser) {
              this.showUserMenu = !this.showUserMenu;
            }
          },

          logout() {
            window.handleLogout();
          },

          applyTheme() {
            // Apply current theme settings to the UI
            const html = document.documentElement;

            // Apply font setting
            if (this.userSettings.font) {
              html.style.fontFamily = this.userSettings.font;
            }

            // Apply button style
            // This would normally be implemented with CSS classes or custom properties

            // You could also change gradient colors based on theme
            const gradientElements =
              document.querySelectorAll(".bg-gradient-to-r");
            const theme = this.userSettings.theme;

            gradientElements.forEach((el) => {
              el.classList.remove(
                "from-indigo-600",
                "to-indigo-700",
                "from-blue-600",
                "to-blue-700",
                "from-emerald-600",
                "to-emerald-700",
                "from-purple-600",
                "to-purple-700",
              );

              switch (theme) {
                case "indigo":
                  el.classList.add("from-indigo-600", "to-indigo-700");
                  break;
                case "blue":
                  el.classList.add("from-blue-600", "to-blue-700");
                  break;
                case "emerald":
                  el.classList.add("from-emerald-600", "to-emerald-700");
                  break;
                case "purple":
                  el.classList.add("from-purple-600", "to-purple-700");
                  break;
                default:
                  el.classList.add("from-indigo-600", "to-indigo-700");
              }
            });
          },

          applyAutofill() {
            console.log("Applying autofill settings");
            const updatedFields = { ...this.form.fields };
            if (this.userSettings.buyer)
              updatedFields.buyer = this.userSettings.buyer;
            if (this.userSettings.submission)
              updatedFields.submission = this.userSettings.submission;
            if (this.userSettings.validity)
              updatedFields.validity = this.userSettings.validity;
            if (this.userSettings.requirements)
              updatedFields.requirements = this.userSettings.requirements;
            if (this.userSettings.criteria)
              updatedFields.criteria = this.userSettings.criteria;
            if (this.userSettings.responsible)
              updatedFields.responsible = this.userSettings.responsible;
            this.form.fields = updatedFields;
            console.log("Autofill applied:", updatedFields);
          },

          // Add watcher for autofill toggle
          watchAutofill() {
            this.$watch("userSettings.autofillEnabled", (value) => {
              console.log("Autofill toggled:", value);
              if (value) {
                this.applyAutofill();
              }
            });
          },

          // Add watchers for basic data fields
          watchBasicDataFields() {
            const fields = [
              "buyer",
              "submission",
              "validity",
              "requirements",
              "criteria",
              "responsible",
            ];
            fields.forEach((field) => {
              this.$watch(`userSettings.${field}`, (value) => {
                console.log(`${field} changed:`, value);
                if (this.userSettings.autofillEnabled) {
                  this.applyAutofill();
                }
              });
            });
          },

          // Add function to download saved PDF
          async downloadSavedPdf(pdfData, fileName) {
            try {
              const link = document.createElement("a");
              link.href = pdfData;
              link.download = fileName;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            } catch (error) {
              this.showToast(
                "Viga PDF allalaadimisel: " + error.message,
                "error",
              );
            }
          },

          async saveToFirestoreDraft() {
            if (!window.currentUser) return;

            try {
              const userRef = doc(window.db, "users", window.currentUser.uid);
              await setDoc(userRef, { draft: this.form }, { merge: true });
              console.log("Form draft saved to Firestore");
            } catch (error) {
              console.error("Error saving draft to Firestore:", error);
            }
          },

          // Function to send PDF via Outlook
          async sendPdfToOutlook(pdfData, fileName) {
            try {
              // First, we need to download the file to make it available for attachment
              const link = document.createElement("a");
              link.href = pdfData;
              link.download = fileName;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);

              // Create mailto link for Outlook
              const subject = encodeURIComponent(
                `${this.form.name || "Ostumenetluse kutse"}`,
              );
              const body = encodeURIComponent(
                `Tere,\n\nLisan manusesse ostumenetluse kutse.\n\nLugupidamisega,\n${this.form.fields.responsible || ""}`,
              );

              // Open Outlook with new email
              window.location.href = `mailto:?subject=${subject}&body=${body}`;

              this.showToast("Outlook avatud uue e-kirjaga", "success");
            } catch (error) {
              this.showToast(
                "Viga e-kirja koostamisel: " + error.message,
                "error",
              );
            }
          },

          // Add function to clear PDF history
          async clearPdfHistory() {
            if (
              !confirm(
                "Kas olete kindel, et soovite kogu PDF ajaloo kustutada?",
              )
            )
              return;

            try {
              if (window.currentUser) {
                const { doc, setDoc } = window.firestoreFunctions;
                const userRef = doc(
                  window.db,
                  "users",
                  window.currentUser.uid,
                );
                await setDoc(
                  userRef,
                  {
                    pdfHistory: [],
                  },
                  { merge: true },
                );

                this.userSettings.generatedPdfs = [];
                this.showActionToast(
                  "PDF ajalugu kustutatud",
                  "clear",
                  5000,
                  "",
                  () => {
                    this.showToast("Kustutamist ei saa tagasi võtta", "info");
                  },
                );
              }
            } catch (error) {
              this.showToast(
                "Viga PDF ajaloo kustutamisel: " + error.message,
                "error",
              );
            }
          },

          // Update the tab click handler
          async handleTabClick(tab) {
            console.log('Tab clicked:', tab);
            this.activeTab = tab;
            if (tab === 'history') {
              console.log('Loading PDF history for history tab');
              await this.loadPdfHistory();
              // Force Alpine to re-render the history tab content
              this.$nextTick(() => {
                this.$refs.historyContent.innerHTML = this.$refs.historyContent.innerHTML;
              });
            } else if (tab === 'basicInfo') {
              console.log('Loading user settings for basic info tab');
              await this.loadUserSettings();
            }
          },

          async loadBasicDataFields() {
            try {
              console.log("Loading basic data fields...");
              if (window.currentUser) {
                console.log("Current user:", window.currentUser);
                const { doc, getDoc } = window.firestoreFunctions;
                const userRef = doc(
                  window.db,
                  "users",
                  window.currentUser.uid,
                );
                console.log("User reference:", userRef);

                const userDoc = await getDoc(userRef);
                console.log("User document exists:", userDoc.exists());

                if (userDoc.exists()) {
                  const data = userDoc.data();
                  console.log("Full user data:", data);

                  if (data.settings) {
                    console.log(
                      "Loading settings from Firestore:",
                      data.settings,
                    );
                    // Update only the basic data fields
                    const basicFields = [
                      "buyer",
                      "submission",
                      "validity",
                      "requirements",
                      "criteria",
                      "responsible",
                      "autofillEnabled",
                    ];
                    basicFields.forEach((field) => {
                      if (data.settings[field] !== undefined) {
                        this.userSettings[field] = data.settings[field];
                      }
                    });
                    console.log("Updated userSettings:", this.userSettings);
                  } else {
                    console.log("No settings found in data");
                  }
                } else {
                  console.log("No user document found");
                }
              } else {
                console.log("No current user found");
              }
            } catch (error) {
              console.error("Error loading basic data fields:", error);
              this.showToast(
                "Viga põhiandmete laadimisel: " + error.message,
                "error",
              );
            }
          },

          // Add Word document generation function
          async generateWord() {
            try {
              const {
                Document,
                Packer,
                Paragraph,
                TextRun,
                HeadingLevel,
                AlignmentType,
              } = docx;

              // Create document content
              const doc = new Document({
                sections: [
                  {
                    properties: {},
                    children: [
                      new Paragraph({
                        text: "Pakkumine",
                        heading: HeadingLevel.HEADING_1,
                        alignment: AlignmentType.CENTER,
                      }),
                      new Paragraph({
                        children: [
                          new TextRun({
                            text:
                              "Hankija: " + (this.form.fields.buyer || ""),
                            bold: true,
                          }),
                        ],
                      }),
                      new Paragraph({
                        children: [
                          new TextRun({
                            text:
                              "Pakkumise esitamise aeg ja koht: " +
                              (this.form.fields.submission || ""),
                          }),
                        ],
                      }),
                      new Paragraph({
                        children: [
                          new TextRun({
                            text:
                              "Pakkumuse jõusoleku aeg: " +
                              (this.form.fields.validity || ""),
                          }),
                        ],
                      }),
                      new Paragraph({
                        children: [
                          new TextRun({
                            text: "Nõuded pakkujale:",
                            bold: true,
                          }),
                        ],
                      }),
                      new Paragraph({
                        children: [
                          new TextRun({
                            text: this.form.fields.requirements || "",
                          }),
                        ],
                      }),
                      new Paragraph({
                        children: [
                          new TextRun({
                            text: "Väljavaliku alused:",
                            bold: true,
                          }),
                        ],
                      }),
                      new Paragraph({
                        children: [
                          new TextRun({
                            text: this.form.fields.criteria || "",
                          }),
                        ],
                      }),
                      new Paragraph({
                        children: [
                          new TextRun({
                            text:
                              "Vastutav isik: " +
                              (this.form.fields.responsible || ""),
                            bold: true,
                          }),
                        ],
                      }),
                    ],
                  },
                ],
              });

              // Generate and save the document
              const blob = await Packer.toBlob(doc);
              const fileName = `Pakkumine_${new Date().toLocaleDateString("et-EE")}.docx`;
              saveAs(blob, fileName);

              // Save to history if user is logged in
              if (window.currentUser) {
                const wordData = URL.createObjectURL(blob);
                await this.saveToHistory({
                  name: fileName,
                  pdfData: wordData,
                  formData: JSON.stringify({
                    name: this.form.name,
                    intro: this.form.intro,
                    fields: this.form.fields,
                    sections: this.form.sections,
                    attachments: this.form.attachments,
                  }),
                  createdAt: new Date().toISOString(),
                  responsible: this.form.fields.responsible,
                  submissionDate: this.form.fields.submission,
                });
              }
            } catch (error) {
              console.error("Error generating Word document:", error);
              alert("Viga Word dokumendi loomisel. Palun proovige uuesti.");
            }
          },

          async saveToHistory(data) {
            try {
              if (!window.currentUser) {
                throw new Error("User not logged in");
              }

              const { doc, setDoc, getDoc } = window.firestoreFunctions;
              const userRef = doc(window.db, "users", window.currentUser.uid);

              // Get current user data
              const userDoc = await getDoc(userRef);
              const currentData = userDoc.exists() ? userDoc.data() : {};
              const currentPdfHistory = currentData.pdfHistory || [];

              // Add new entry and keep only last 10
              const updatedPdfHistory = [data, ...currentPdfHistory].slice(
                0,
                10,
              );

              // Update Firestore
              await setDoc(
                userRef,
                {
                  pdfHistory: updatedPdfHistory,
                  lastUpdated: new Date().toISOString(),
                },
                { merge: true },
              );

              // Update global state
              window.userData = {
                ...window.userData,
                pdfHistory: updatedPdfHistory,
                lastUpdated: new Date().toISOString(),
              };

              // Update local state
              this.userSettings.generatedPdfs = updatedPdfHistory;

              return true;
            } catch (error) {
              console.error("Error saving to history:", error);
              throw error;
            }
          },

          async copyToTender(pdf) {
            try {
              // Check if we're dealing with history data
              if (!pdf) {
                throw new Error("No data provided to copy");
              }

              // Add defensive programming
              if (!pdf.formData) {
                throw new Error("PDF data is missing formData");
              }

              // Log the PDF data structure for debugging
              console.log("PDF data structure:", pdf);

              // Parse the form data
              let formData;
              try {
                formData =
                  typeof pdf.formData === "string"
                    ? JSON.parse(pdf.formData)
                    : pdf.formData;
              } catch (error) {
                console.error("Error parsing formData:", error);
                throw new Error(
                  "Invalid tender data: could not parse formData",
                );
              }

              if (!formData || typeof formData !== "object") {
                console.error("Invalid formData structure:", formData);
                throw new Error(
                  "Invalid tender data: formData is not an object",
                );
              }

              // Update form with saved data
              if (formData) {
                this.form.name = formData.name || "";
                this.form.intro = formData.intro || "";

                // Copy all standard fields
                if (formData.fields && typeof formData.fields === "object") {
                  Object.keys(formData.fields).forEach((key) => {
                    if (
                      this.form.fields &&
                      this.form.fields[key] !== undefined
                    ) {
                      this.form.fields[key] = formData.fields[key] || "";
                    }
                  });
                }
              }

              // Copy sections
              if (Array.isArray(formData.sections)) {
                this.form.sections = formData.sections.map((section) => ({
                  ...section,
                  enabled: section.enabled ?? true,
                  open: section.open ?? false,
                  options: Array.isArray(section.options)
                    ? section.options.map((option) => ({
                      ...option,
                      checked: option.checked ?? false,
                      editable: option.editable ?? false,
                    }))
                    : [],
                }));
              }

              // Copy files if they exist
              if (Array.isArray(formData.files)) {
                this.files = formData.files;
              }

              // Show success message
              this.showToast("Andmed kanti edukalt kutsele", "success");

              // Close settings modal
              this.showSettingsModal = false;
            } catch (error) {
              console.error("Error copying tender data:", error);
              console.error("PDF data that caused the error:", pdf);
              this.showToast(
                "Viga andmete kopeerimisel: " + error.message,
                "error",
              );
            }
          },

          previewPdf(pdf) {
            try {
              if (!pdf || !pdf.pdfData) {
                throw new Error("No PDF data available");
              }

              // Create a blob URL for the PDF
              const byteCharacters = atob(pdf.pdfData.split(",")[1]);
              const byteNumbers = new Array(byteCharacters.length);
              for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
              }
              const byteArray = new Uint8Array(byteNumbers);
              const blob = new Blob([byteArray], { type: "application/pdf" });
              const url = URL.createObjectURL(blob);

              this.previewPdfUrl = url;
              this.previewPdfName = pdf.name;

              // Show the modal
              const modal = document.getElementById("pdfPreviewModal");
              modal.classList.remove("hidden");
            } catch (error) {
              console.error("Error previewing PDF:", error);
              this.showToast(
                "Viga PDF-i eelvaate kuvamisel: " + error.message,
                "error",
              );
            }
          },

          closePdfPreview() {
            const modal = document.getElementById("pdfPreviewModal");
            modal.classList.add("hidden");

            // Clean up the blob URL
            if (this.previewPdfUrl) {
              URL.revokeObjectURL(this.previewPdfUrl);
              this.previewPdfUrl = null;
              this.previewPdfName = null;
            }
          },

          // Lisame eelsätete funktsionaalsuse
          formPresets: [],
          showPresetDropdown: false,
          isLoadingPresets: false,

          // Lisame eelsätete laadimise ja rakendamise meetodid
          async loadFormPresets() {
            try {
              this.isLoadingPresets = true;
              console.log("Loading form presets from Firestore...");

              // Get current user's usergroups if user is logged in
              let userGroups = [];
              if (window.auth.currentUser) {
                const userDoc = await window.getDoc(window.doc(window.db, "users", window.auth.currentUser.uid));
                userGroups = userDoc.exists() ? userDoc.data().usergroups || [] : [];
              }

              // Lae eelsätted Firestore'ist
              const presetsSnapshot = await window.getDocs(
                window.collection(window.db, "formPresets")
              );

              const presets = [];
              presetsSnapshot.forEach(doc => {
                const preset = doc.data();

                // Check if preset has usergroup restrictions
                const presetUsergroups = preset.usergroups || [];

                // Show preset if:
                // 1. It has no usergroup restrictions (empty array), or
                // 2. User belongs to at least one of the allowed usergroups
                if (presetUsergroups.length === 0 ||
                  presetUsergroups.some(group => userGroups.includes(group))) {
                  presets.push({
                    id: doc.id,
                    name: preset.name || `Preset ${doc.id}`,
                    description: preset.description || '',
                    createdBy: preset.createdBy || 'Admin',
                    createdAt: preset.createdAt ? new Date(preset.createdAt.seconds * 1000).toLocaleDateString() : 'Teadmata',
                    data: preset.form || {}
                  });
                }
              });

              this.formPresets = presets;
              console.log(`Loaded ${presets.length} form presets`);
            } catch (error) {
              console.error("Error loading form presets:", error);
              this.errorMessage = "Eelsätete laadimine ebaõnnestus.";
              this.showError = true;
            } finally {
              this.isLoadingPresets = false;
            }
          },

          applyFormPreset(preset) {
            try {
              console.log("Applying form preset:", preset.name);
              if (!preset || !preset.data) {
                console.error("Invalid preset data");
                return;
              }

              // DEEP CLONE the preset sections to ensure we get a completely new copy
              let newSections = preset.data.sections ?
                JSON.parse(JSON.stringify(preset.data.sections)) : [];

              console.log("Original preset sections:", newSections);

              // Apply the new sections directly to form
              this.form.sections = newSections;

              // Force a refresh of the Alpine component to ensure UI updates
              this.$nextTick(() => {
                // Ensure all sections are open for visibility
                this.form.sections.forEach(section => {
                  section.open = true;
                  section.enabled = true; // Enable all sections for better visibility
                });

                console.log("Updated form sections after applying preset:", this.form.sections);

                // Salvesta muudatused
                this.saveToStorage();

                // Force reactive update by creating a small change to the array
                // This triggers Alpine's reactivity without using $refresh
                const tempSections = [...this.form.sections];
                this.form.sections = [];
                setTimeout(() => {
                  this.form.sections = tempSections;
                }, 10);
              });

              // Peida dropdown
              this.showPresetDropdown = false;

              // Lisa teade kasutajale
              this.toasts.push({
                message: `Eelsäte "${preset.name}" rakendatud!`,
                type: 'success',
                id: Date.now()
              });

            } catch (error) {
              console.error("Error applying form preset:", error);
              this.errorMessage = "Eelsätte rakendamine ebaõnnestus.";
              this.showError = true;
            }
          },
        };
      }
    });

  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const modal = document.getElementById("tableModal");
      const openBtn = document.getElementById("openTableModal");
      const closeBtn = document.getElementById("closeTableModal");
      const addColumn = document.getElementById("addColumn");
      const addRow = document.getElementById("addRow");
      const exportExcel = document.getElementById("exportExcelBtn");
      const exportPdf = document.getElementById("exportPdfBtn");
      const saveTable = document.getElementById("saveTableBtn");
      const previewBtn = document.getElementById("previewBtn");
      const columnCount = document.getElementById("columnCount");
      const rowCount = document.getElementById("rowCount");

      // Preview modal elements
      const previewModal = document.getElementById("previewModal");
      const previewContent = document.getElementById("previewContent");
      const closePreviewBtn = document.getElementById("closePreviewBtn");

      // Initialize table with default values
      function initializeTable() {
        console.log("Initializing table...");
        const cols = parseInt(columnCount.value) || 3;
        const rows = parseInt(rowCount.value) || 5;

        // Clear existing table
        document.getElementById("tableHead").innerHTML = "";
        document.getElementById("tableBody").innerHTML = "";

        // Add headers with improved styling and placeholder behavior
        const headerRow = document.createElement("tr");
        for (let i = 0; i < cols; i++) {
          const th = document.createElement("th");
          th.className = "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider group relative";
          th.contentEditable = "true";

          // Set default column headers
          let defaultHeaderText;
          if (i === 0) {
            defaultHeaderText = "Nimetus";
          } else if (i === 1) {
            defaultHeaderText = "Kogus";
          } else if (i === 2) {
            defaultHeaderText = "Maksumus (eurodes ilma käibemaksuta)";
          } else {
            defaultHeaderText = `Veerg ${i + 1}`;
          }

          th.setAttribute("data-placeholder", "Sisesta veeru nimi");
          th.textContent = defaultHeaderText;

          // Add focus/blur events for placeholder behavior
          th.addEventListener('focus', function () {
            if (this.textContent === defaultHeaderText) {
              this.textContent = '';
            }
            this.classList.add('editing');
          });

          th.addEventListener('blur', function () {
            if (this.textContent.trim() === '') {
              this.textContent = defaultHeaderText;
            }
            this.classList.remove('editing');
          });

          // Add keyboard events for better editing
          th.addEventListener('keydown', handleCellKeydown);

          headerRow.appendChild(th);
        }
        document.getElementById("tableHead").appendChild(headerRow);

        // Add rows with better cell behavior
        for (let i = 0; i < rows; i++) {
          addTableRow(true); // Pass true to indicate initial setup
        }

        addDeleteButtons();

        // Add resize observer to auto-resize columns based on content
        setupTableResizeObserver();
      }

      // Handle keyboard navigation within table
      function handleCellKeydown(e) {
        const isHeader = e.target.tagName === 'TH';

        // Tab navigation
        if (e.key === 'Tab') {
          e.preventDefault();
          navigateToNextCell(e.target, e.shiftKey);
          return;
        }

        // Enter in header creates a new row
        if (e.key === 'Enter' && isHeader) {
          e.preventDefault();
          if (e.ctrlKey || e.metaKey) {
            // Insert line break with Ctrl+Enter or Cmd+Enter
            document.execCommand('insertLineBreak');
          } else {
            // Focus first cell in the next row
            const firstCell = document.querySelector('#tableBody tr:first-child td');
            if (firstCell) firstCell.focus();
          }
          return;
        }

        // Arrow key navigation
        if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
          if (e.ctrlKey || e.metaKey || e.altKey) return; // Allow default behavior with modifiers

          e.preventDefault();
          navigateTable(e.target, e.key);
        }
      }

      // Navigate to next/previous cell
      function navigateToNextCell(currentCell, reverse = false) {
        const isHeader = currentCell.tagName === 'TH';
        const allCells = isHeader
          ? [...document.querySelectorAll('#tableHead th')]
          : [...document.querySelectorAll('#tableBody td:not(.delete-row)')];

        const currentIndex = allCells.indexOf(currentCell);
        let nextIndex = reverse ? currentIndex - 1 : currentIndex + 1;

        // Handle row boundaries
        if (nextIndex < 0 && isHeader) {
          // Wrap to last cell of body if we're in the header
          const bodyCells = [...document.querySelectorAll('#tableBody td:not(.delete-row)')];
          if (bodyCells.length > 0) {
            bodyCells[bodyCells.length - 1].focus();
          }
          return;
        } else if (nextIndex < 0) {
          // Move to previous row, last cell
          const currentRow = currentCell.closest('tr');
          const prevRow = currentRow.previousElementSibling;

          if (prevRow) {
            const cells = [...prevRow.querySelectorAll('td:not(.delete-row)')];
            if (cells.length > 0) {
              cells[cells.length - 1].focus();
            }
          } else {
            // Jump to header if we're at the first body row
            const headerCells = [...document.querySelectorAll('#tableHead th')];
            if (headerCells.length > 0) {
              headerCells[headerCells.length - 1].focus();
            }
          }
          return;
        } else if (nextIndex >= allCells.length && isHeader) {
          // If we're in header and going past the end, go to first body cell
          const firstBodyCell = document.querySelector('#tableBody td:not(.delete-row)');
          if (firstBodyCell) {
            firstBodyCell.focus();
          } else {
            // If no body cells, add a row
            addTableRow();
            setTimeout(() => {
              document.querySelector('#tableBody td:not(.delete-row)').focus();
            }, 0);
          }
          return;
        } else if (nextIndex >= allCells.length) {
          // Add a new row when tabbing past the last cell
          addTableRow();
          setTimeout(() => {
            document.querySelector('#tableBody tr:last-child td:first-child').focus();
          }, 0);
          return;
        }

        // Focus the next cell
        allCells[nextIndex].focus();
      }

      // Navigate table with arrow keys
      function navigateTable(currentCell, direction) {
        const isHeader = currentCell.tagName === 'TH';
        const currentRow = currentCell.closest('tr');
        const rowCells = [...currentRow.querySelectorAll(isHeader ? 'th' : 'td:not(.delete-row)')];
        const currentIndex = rowCells.indexOf(currentCell);

        switch (direction) {
          case 'ArrowLeft':
            if (currentIndex > 0) {
              rowCells[currentIndex - 1].focus();
            }
            break;
          case 'ArrowRight':
            if (currentIndex < rowCells.length - 1) {
              rowCells[currentIndex + 1].focus();
            }
            break;
          case 'ArrowUp':
            if (isHeader) return; // Already at top

            const prevRow = currentRow.previousElementSibling;
            if (prevRow) {
              const prevCells = [...prevRow.querySelectorAll('td:not(.delete-row)')];
              if (currentIndex < prevCells.length) {
                prevCells[currentIndex].focus();
              } else if (prevCells.length > 0) {
                prevCells[prevCells.length - 1].focus();
              }
            } else {
              // Move to header
              const headerCells = [...document.querySelector('#tableHead tr').querySelectorAll('th')];
              if (headerCells.length > 0 && currentIndex < headerCells.length) {
                headerCells[currentIndex].focus();
              } else if (headerCells.length > 0) {
                headerCells[headerCells.length - 1].focus();
              }
            }
            break;
          case 'ArrowDown':
            if (isHeader) {
              // Move from header to first body row
              const firstBodyRow = document.querySelector('#tableBody tr');
              if (firstBodyRow) {
                const bodyCells = [...firstBodyRow.querySelectorAll('td:not(.delete-row)')];
                if (currentIndex < bodyCells.length) {
                  bodyCells[currentIndex].focus();
                } else if (bodyCells.length > 0) {
                  bodyCells[bodyCells.length - 1].focus();
                }
              } else {
                // If no body rows, add one
                addTableRow();
                setTimeout(() => {
                  const firstCell = document.querySelector('#tableBody td:not(.delete-row)');
                  if (firstCell) firstCell.focus();
                }, 0);
              }
            } else {
              // Move to next body row
              const nextRow = currentRow.nextElementSibling;
              if (nextRow) {
                const nextCells = [...nextRow.querySelectorAll('td:not(.delete-row)')];
                if (currentIndex < nextCells.length) {
                  nextCells[currentIndex].focus();
                } else if (nextCells.length > 0) {
                  nextCells[nextCells.length - 1].focus();
                }
              } else {
                // Add new row if at the last row
                addTableRow();
                setTimeout(() => {
                  const newRow = document.querySelector('#tableBody tr:last-child');
                  const newCells = [...newRow.querySelectorAll('td:not(.delete-row)')];
                  if (currentIndex < newCells.length) {
                    newCells[currentIndex].focus();
                  } else if (newCells.length > 0) {
                    newCells[newCells.length - 1].focus();
                  }
                }, 0);
              }
            }
            break;
        }
      }

      // Setup automatic column resizing based on content
      function setupTableResizeObserver() {
        // Apply min-width to all cells for better readability
        const allCells = document.querySelectorAll('#tableHead th, #tableBody td:not(.delete-row)');
        allCells.forEach(cell => {
          cell.style.minWidth = '100px';
        });

        // Create ResizeObserver to watch content changes
        const resizeObserver = new ResizeObserver(entries => {
          // This fires when any observed cell's content changes size
          const table = document.getElementById('dynamicTable');
          if (table.classList.contains('auto-sizing')) return; // Prevent recursion

          table.classList.add('auto-sizing');
          requestAnimationFrame(() => {
            balanceColumnWidths();
            table.classList.remove('auto-sizing');
          });
        });

        // Observe all cells
        allCells.forEach(cell => {
          resizeObserver.observe(cell);
        });
      }

      // Balance column widths based on content
      function balanceColumnWidths() {
        const headerCells = [...document.querySelectorAll('#tableHead th')];
        const columnCount = headerCells.length;

        if (columnCount === 0) return;

        // Get all rows including header row
        const allRows = [
          document.querySelector('#tableHead tr'),
          ...document.querySelectorAll('#tableBody tr')
        ].filter(Boolean);

        // Calculate ideal widths for each column
        const colWidths = new Array(columnCount).fill(0);

        // Check all cells in each column for largest content width
        allRows.forEach(row => {
          const cells = row.tagName === 'TR' && row.parentElement.id === 'tableHead'
            ? [...row.querySelectorAll('th')]
            : [...row.querySelectorAll('td:not(.delete-row)')];

          cells.forEach((cell, index) => {
            if (index >= colWidths.length) return;

            // Use scrollWidth as a measure of the content width
            const contentWidth = cell.scrollWidth;
            colWidths[index] = Math.max(colWidths[index], contentWidth);
          });
        });

        // Apply calculated widths with some padding
        headerCells.forEach((cell, index) => {
          const width = colWidths[index];
          if (width > 0) {
            const idealWidth = Math.min(Math.max(width + 20, 100), 300); // Between 100px and 300px
            cell.style.width = `${idealWidth}px`;
          }
        });
      }

      // Add delete buttons to rows and columns
      function addDeleteButtons() {
        // Add delete buttons to rows
        const rows = document.querySelectorAll("#tableBody tr");
        rows.forEach((row) => {
          if (!row.querySelector(".delete-row")) {
            const deleteCell = document.createElement("td");
            deleteCell.className = "w-10 p-3 opacity-0 group-hover:opacity-100";
            const deleteBtn = document.createElement("button");
            deleteBtn.className = "delete-row text-red-500 hover:text-red-700";
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.onclick = () => row.remove();
            deleteCell.appendChild(deleteBtn);
            row.appendChild(deleteCell);
          }
        });

        // Add delete buttons to header
        const headers = document.querySelectorAll("#tableHead th");
        headers.forEach((header, index) => {
          if (!header.querySelector(".delete-col")) {
            const deleteBtn = document.createElement("button");
            deleteBtn.className = "delete-col absolute right-2 top-1/2 -translate-y-1/2 text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100";
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.onclick = () => {
              const rows = document.querySelectorAll("#tableBody tr");
              rows.forEach((row) => {
                const cells = row.querySelectorAll("td:not(.delete-row)");
                if (cells[index]) cells[index].remove();
              });
              header.remove();
            };
            header.appendChild(deleteBtn);
          }
        });
      }

      // Add a new row to the table
      function addTableRow(isInitialSetup = false) {
        const row = document.createElement("tr");
        row.className = "group hover:bg-gray-50";
        const cols = document.querySelectorAll("#tableHead th").length;

        for (let i = 0; i < cols; i++) {
          const td = document.createElement("td");
          td.contentEditable = "true";
          td.className = "px-4 py-3 text-left border-b border-gray-200";

          // Set up event handlers for better cell behavior
          td.addEventListener('focus', function () {
            this.classList.add('editing');
            // Select all text on focus only if double-clicked
            if (window.lastClickTarget === this && window.lastClickTime && (Date.now() - window.lastClickTime < 300)) {
              const selection = window.getSelection();
              const range = document.createRange();
              range.selectNodeContents(this);
              selection.removeAllRanges();
              selection.addRange(range);
            }
            window.lastClickTarget = this;
            window.lastClickTime = Date.now();
          });

          td.addEventListener('blur', function () {
            this.classList.remove('editing');
            formatCellContent(this);
          });

          // Add keyboard navigation
          td.addEventListener('keydown', handleCellKeydown);

          // Set placeholder for empty cells in non-initial setup
          if (!isInitialSetup) {
            td.setAttribute('data-placeholder', 'Kliki siia...');
          }

          row.appendChild(td);
        }

        document.getElementById("tableBody").appendChild(row);

        // Only add delete buttons if we've completed the initial setup
        if (!isInitialSetup) {
          addDeleteButtons();
        }

        return row;
      }

      // Format cell content based on detected type
      function formatCellContent(cell) {
        const content = cell.textContent.trim();

        // Reset all classes first
        cell.classList.remove('text-right', 'font-mono', 'text-blue-600');

        // Skip empty cells
        if (!content) return;

        // Detect and format numbers
        if (/^-?\d+(\.\d+)?$/.test(content)) {
          cell.classList.add('text-right');
          // Format number with thousands separators
          const num = parseFloat(content);
          if (!isNaN(num)) {
            // Don't reformat the number if it has leading zeros
            if (!/^0\d+/.test(content)) {
              cell.textContent = num.toLocaleString('et-EE');
            }
          }
          return;
        }

        // Detect and format currencies
        if (/^-?\d+(\.\d+)?\s*(€|EUR)$/.test(content)) {
          cell.classList.add('text-right');
          const num = parseFloat(content.replace(/[^\d.-]/g, ''));
          if (!isNaN(num)) {
            cell.textContent = num.toLocaleString('et-EE') + ' €';
          }
          return;
        }

        // Detect and format dates (dd.mm.yyyy or yyyy-mm-dd)
        if (/^(\d{1,2}\.\d{1,2}\.\d{4}|\d{4}-\d{1,2}-\d{1,2})$/.test(content)) {
          let date;
          if (content.includes('.')) {
            const [day, month, year] = content.split('.').map(part => parseInt(part, 10));
            date = new Date(year, month - 1, day);
          } else {
            date = new Date(content);
          }

          if (!isNaN(date.getTime())) {
            cell.textContent = date.toLocaleDateString('et-EE');
          }
          return;
        }

        // Detect formulas (starting with =)
        if (content.startsWith('=')) {
          cell.classList.add('text-blue-600', 'font-mono');
          return;
        }
      }

      // Event listeners
      openBtn.onclick = () => {
        console.log("Open button clicked");
        modal.classList.remove("hidden");
        initializeTable();
      };

      closeBtn.onclick = () => modal.classList.add("hidden");
      closePreviewBtn.onclick = () => previewModal.classList.add("hidden");

      columnCount.addEventListener("change", initializeTable);
      rowCount.addEventListener("change", initializeTable);

      addColumn.onclick = () => {
        const head = document.getElementById("tableHead");
        const rows = document.querySelectorAll("#tableBody tr");
        const columnIndex = head.children[0].children.length;

        const th = document.createElement("th");
        th.className = "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider group relative";
        th.contentEditable = "true";
        th.setAttribute("data-placeholder", "Sisesta veeru nimi");

        // Use more meaningful default names for new columns
        let defaultHeaderText;
        if (columnIndex === 0) {
          defaultHeaderText = "Nimetus";
        } else if (columnIndex === 1) {
          defaultHeaderText = "Kogus";
        } else if (columnIndex === 2) {
          defaultHeaderText = "Maksumus (eurodes ilma käibemaksuta)";
        } else {
          defaultHeaderText = `Veerg ${columnIndex + 1}`;
        }

        th.textContent = defaultHeaderText;

        // Add focus/blur events for placeholder behavior
        th.addEventListener('focus', function () {
          if (this.textContent === defaultHeaderText) {
            this.textContent = '';
          }
          this.classList.add('editing');
        });

        th.addEventListener('blur', function () {
          if (this.textContent.trim() === '') {
            this.textContent = defaultHeaderText;
          }
          this.classList.remove('editing');
        });

        // Add keyboard events
        th.addEventListener('keydown', handleCellKeydown);

        head.children[0].appendChild(th);

        rows.forEach((row) => {
          const td = document.createElement("td");
          td.contentEditable = "true";
          td.className = "px-4 py-3 text-left border-b border-gray-200";

          // Add the same cell event handlers as in addTableRow
          td.addEventListener('focus', function () {
            this.classList.add('editing');
            if (window.lastClickTarget === this && window.lastClickTime && (Date.now() - window.lastClickTime < 300)) {
              const selection = window.getSelection();
              const range = document.createRange();
              range.selectNodeContents(this);
              selection.removeAllRanges();
              selection.addRange(range);
            }
            window.lastClickTarget = this;
            window.lastClickTime = Date.now();
          });

          td.addEventListener('blur', function () {
            this.classList.remove('editing');
            formatCellContent(this);
          });

          td.addEventListener('keydown', handleCellKeydown);

          td.textContent = "";
          row.insertBefore(td, row.lastElementChild);
        });

        addDeleteButtons();

        // Update column sizing
        setTimeout(() => {
          balanceColumnWidths();
        }, 0);
      };

      addRow.onclick = () => addTableRow();

      // Show preview
      previewBtn.onclick = () => {
        const element = document.getElementById("dynamicTable").cloneNode(true);
        const title = document.getElementById("tableTitle").value;
        previewContent.innerHTML = `<h2 class="text-xl font-bold mb-4">${title}</h2>`;
        previewContent.appendChild(element);
        previewModal.classList.remove("hidden");
      };

      // Save to Firestore
      saveTable.onclick = async () => {
        if (!auth.currentUser) {
          showToast("Palun logi sisse, et tabelit salvestada", "error");
          return;
        }

        const title = document.getElementById("tableTitle").value.trim();
        if (!title) {
          showToast("Palun sisesta tabeli pealkiri", "error");
          return;
        }

        const tableData = {
          title,
          headers: [...document.querySelectorAll("#tableHead th")].map((th) =>
            th.textContent.replace("❌", "").trim(),
          ),
          rows: [...document.querySelectorAll("#tableBody tr")].map((row) =>
            [...row.querySelectorAll("td:not(.delete-row)")].map((td) =>
              td.textContent.trim(),
            ),
          ),
          createdAt: new Date(),
          userId: auth.currentUser.uid,
        };

        try {
          await addDoc(collection(db, "tables"), tableData);
          showToast("Tabel salvestatud edukalt!", "success");
          modal.classList.add("hidden");
        } catch (error) {
          console.error("Error saving table:", error);
          showToast("Viga tabeli salvestamisel", "error");
        }
      };

      // Export to Excel with improved formatting and formula support
      exportExcel.onclick = () => {
        // Close any existing modals
        document.querySelectorAll('.fixed.inset-0.bg-black.bg-opacity-50').forEach(modal => {
          modal.classList.add('hidden');
        });

        const excelModal = document.getElementById("excelExportModal");
        const excelFileName = document.getElementById("excelFileName");
        const excelPreview = document.getElementById("excelPreview");
        const cancelExcelExport = document.getElementById("cancelExcelExport");
        const confirmExcelExport = document.getElementById("confirmExcelExport");

        // Show modal
        excelModal.classList.remove("hidden");

        // Generate preview
        const generatePreview = () => {
          const title = document.getElementById("tableTitle").value;
          const headers = [...document.querySelectorAll("#tableHead th")].map(
            (th) => th.textContent.replace("❌", "").trim()
          );

          let previewHTML = '<table class="w-full border-collapse">';

          if (title) {
            previewHTML += `<tr><td colspan="${headers.length}" class="border p-2 font-bold text-center">${title}</td></tr>`;
          }

          // Headers
          previewHTML += '<tr class="bg-gray-100">';
          headers.forEach(header => {
            previewHTML += `<th class="border p-2">${header}</th>`;
          });
          previewHTML += '</tr>';

          // Data rows
          document.querySelectorAll("#tableBody tr").forEach((row, rowIndex) => {
            const cells = [...row.querySelectorAll("td:not(.delete-row)")].map(
              (td) => td.textContent.trim()
            );

            previewHTML += '<tr>';
            cells.forEach((cell, colIndex) => {
              // Add formula indicators and special formatting
              if (cell.startsWith('=')) {
                previewHTML += `<td class="border p-2 text-blue-600 font-mono">${cell}</td>`;
              } else if (/^-?\d+(\.\d+)?$/.test(cell)) {
                // Number cell
                previewHTML += `<td class="border p-2 text-right">${cell}</td>`;
              } else if (/^-?\d+(\.\d+)?\s*(€|EUR)$/.test(cell)) {
                // Currency cell
                previewHTML += `<td class="border p-2 text-right">${cell}</td>`;
              } else if (/^(\d{1,2}\.\d{1,2}\.\d{4}|\d{4}-\d{1,2}-\d{1,2})$/.test(cell)) {
                // Date cell
                previewHTML += `<td class="border p-2">${cell}</td>`;
              } else {
                previewHTML += `<td class="border p-2">${cell}</td>`;
              }
            });
            previewHTML += '</tr>';
          });

          previewHTML += '</table>';
          excelPreview.innerHTML = previewHTML;
        };

        // Initial preview
        generatePreview();

        // Handle cancel
        cancelExcelExport.onclick = () => {
          excelModal.classList.add("hidden");
        };

        // Handle confirm export with improved formula and format support
        confirmExcelExport.onclick = () => {
          const wb = XLSX.utils.book_new();
          const data = [];

          // Add title
          const title = document.getElementById("tableTitle").value;
          if (title) {
            data.push([title]);
            data.push([]); // Empty row after title
          }

          // Get headers
          const headers = [...document.querySelectorAll("#tableHead th")].map(
            (th) => th.textContent.replace("❌", "").trim()
          );
          data.push(headers);

          // Detect cost column index (Maksumus)
          const costColumnIndex = headers.findIndex(header =>
            header.toLowerCase().includes('maksumus'));

          // Process data rows with improved type detection
          document.querySelectorAll("#tableBody tr").forEach((row) => {
            const rowData = [...row.querySelectorAll("td:not(.delete-row)")].map((td, colIndex) => {
              const content = td.textContent.trim();

              // Handle empty cells
              if (!content) return '';

              // Handle formulas (must start with =)
              if (content.startsWith('=')) {
                // Convert Estonian formula formats to Excel format if needed
                // For example, replace decimal comma with decimal point
                let formula = content;
                // Replace Estonian formula format with Excel format if needed
                formula = formula.replace(/,/g, '.'); // Replace decimal commas with points

                return { f: formula }; // Keep the = sign
              }

              // Special handling for the cost column (Maksumus)
              if (colIndex === costColumnIndex && costColumnIndex !== -1) {
                // Extract number from the content, handling € symbol and spaces
                const cleanContent = content.replace(/[€\s]/g, '').replace(/,/g, '.');
                const num = parseFloat(cleanContent);

                if (!isNaN(num)) {
                  return { v: num, t: 'n', z: '#,##0.00 €' };
                }
              }

              // Handle currencies (€ symbol)
              if (/^-?\d+(\.\d+)?\s*(€|EUR)$/.test(content)) {
                const numPart = content.replace(/[^\d.-]/g, '');
                const num = parseFloat(numPart.replace(',', '.'));
                return { v: num, t: 'n', z: '#,##0.00 €' };
              }

              // Handle percentages
              if (/^-?\d+(\.\d+)?%$/.test(content)) {
                const numPart = content.replace(/%/g, '');
                const num = parseFloat(numPart.replace(',', '.')) / 100;
                return { v: num, t: 'n', z: '0.00%' };
              }

              // Handle numbers (must be a valid number and not just a string of digits)
              if (/^-?\d+(\.\d+)?$/.test(content)) {
                const num = parseFloat(content.replace(',', '.'));
                // Check if it's an integer or has decimal places
                if (Number.isInteger(num)) {
                  return { v: num, t: 'n', z: '#,##0' };
                } else {
                  return { v: num, t: 'n', z: '#,##0.00' };
                }
              }

              // Handle dates (Estonian format: dd.mm.yyyy)
              if (/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(content)) {
                const [day, month, year] = content.split('.').map(part => parseInt(part, 10));
                const date = new Date(year, month - 1, day);
                if (!isNaN(date.getTime())) {
                  return { v: date, t: 'd', z: 'dd.mm.yyyy' };
                }
              }

              // Handle ISO dates (yyyy-mm-dd)
              if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(content)) {
                const date = new Date(content);
                if (!isNaN(date.getTime())) {
                  return { v: date, t: 'd', z: 'dd.mm.yyyy' };
                }
              }

              return content;
            });
            data.push(rowData);
          });

          const ws = XLSX.utils.aoa_to_sheet(data);

          // Set column widths based on content with more precise calculations
          const colWidths = headers.map((header, colIndex) => {
            // Start with the header width
            let maxLength = header?.length || 0;

            // Check each row's content length
            document.querySelectorAll("#tableBody tr").forEach(row => {
              const cells = row.querySelectorAll("td:not(.delete-row)");
              if (colIndex < cells.length) {
                const content = cells[colIndex].textContent.trim();
                // Adjust width based on content type
                if (/^-?\d+(\.\d+)?$/.test(content)) {
                  // Numbers take less space
                  maxLength = Math.max(maxLength, content.length * 0.8);
                } else if (content.startsWith('=')) {
                  // Formulas need more space
                  maxLength = Math.max(maxLength, content.length * 1.2);
                } else {
                  maxLength = Math.max(maxLength, content.length);
                }
              }
            });

            // Calculate width: min 8 chars, max 50 chars
            // Add 1 for padding and 1 for border
            return { wch: Math.min(Math.max(maxLength + 2, 8), 50) };
          });

          ws['!cols'] = colWidths;

          // Add full styling
          const range = XLSX.utils.decode_range(ws['!ref']);

          // Style title if exists
          if (title) {
            const titleCell = XLSX.utils.encode_cell({ r: 0, c: 0 });
            if (ws[titleCell]) {
              ws[titleCell].s = {
                font: { bold: true, sz: 14 },
                alignment: { horizontal: 'center', vertical: 'center' },
                fill: { fgColor: { rgb: "E6F0FF" } }
              };
              // Merge title cells
              ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: headers.length - 1 } }];
            }
          }

          // Style headers - now with border and better formatting
          const headerRowIndex = title ? 2 : 0;
          for (let C = 0; C <= range.e.c; ++C) {
            const headerCell = XLSX.utils.encode_cell({ r: headerRowIndex, c: C });
            if (ws[headerCell]) {
              ws[headerCell].s = {
                font: { bold: true, color: { rgb: "333333" } },
                alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
                fill: { fgColor: { rgb: "E6E6E6" } },
                border: {
                  top: { style: 'thin', color: { rgb: "CCCCCC" } },
                  bottom: { style: 'thin', color: { rgb: "CCCCCC" } },
                  left: { style: 'thin', color: { rgb: "CCCCCC" } },
                  right: { style: 'thin', color: { rgb: "CCCCCC" } }
                }
              };
            }
          }

          // Style data cells
          for (let R = (headerRowIndex + 1); R <= range.e.r; ++R) {
            for (let C = 0; C <= range.e.c; ++C) {
              const cell_ref = XLSX.utils.encode_cell({ c: C, r: R });

              if (!ws[cell_ref]) continue;

              // Get cell content type
              const cellType = ws[cell_ref].t || 's';
              const cellValue = ws[cell_ref].v;

              // Basic style for all cells
              const cellStyle = {
                border: {
                  top: { style: 'thin', color: { rgb: "CCCCCC" } },
                  bottom: { style: 'thin', color: { rgb: "CCCCCC" } },
                  left: { style: 'thin', color: { rgb: "CCCCCC" } },
                  right: { style: 'thin', color: { rgb: "CCCCCC" } }
                },
                alignment: { vertical: 'center', wrapText: true }
              };

              // Adjust alignment based on content type
              if (cellType === 'n') {
                // Numbers are right-aligned
                cellStyle.alignment.horizontal = 'right';
              } else if (cellType === 'd') {
                // Dates are center-aligned
                cellStyle.alignment.horizontal = 'center';
              } else if (ws[cell_ref].f) {
                // Formulas get special handling
                cellStyle.font = { color: { rgb: "0000FF" } };
              }

              // Special styling for cost column
              if (C === costColumnIndex && costColumnIndex !== -1) {
                cellStyle.alignment.horizontal = 'right';

                // Add subtle background for cost column
                cellStyle.fill = { fgColor: { rgb: "F5F5F5" } };
              } else {
                // Regular zebra striping for other columns
                if (R % 2 === 1) {
                  cellStyle.fill = { fgColor: { rgb: "F9F9F9" } };
                }
              }

              ws[cell_ref].s = cellStyle;
            }
          }

          // Use file name from input or generate a default using title or "Maksumuse esildis"
          const fileName = excelFileName.value.trim() ||
            title ||
            "Maksumuse esildis";

          // Use sheet name based on the content
          const sheetName = "Maksumuse esildis";

          XLSX.utils.book_append_sheet(wb, ws, sheetName);
          XLSX.writeFile(wb, `${fileName}.xlsx`);

          // Close modal
          excelModal.classList.add("hidden");

          // Show success message
          showToast("Excel on eksporditud!", "success");
        };
      };

      // Export to PDF with improved styling and options
      exportPdf.onclick = () => {
        // Close any existing modals
        document.querySelectorAll('.fixed.inset-0.bg-black.bg-opacity-50').forEach(modal => {
          modal.classList.add('hidden');
        });

        // Show PDF export modal with options
        const pdfModal = document.getElementById("pdfExportModal") || createPdfExportModal();
        pdfModal.classList.remove("hidden");

        // Handle PDF export options
        document.getElementById("confirmPdfExport").onclick = () => {
          generateAndDownloadPdf();
          pdfModal.classList.add("hidden");
        };

        document.getElementById("cancelPdfExport").onclick = () => {
          pdfModal.classList.add("hidden");
        };
      };

      // Create PDF export modal if it doesn't exist
      function createPdfExportModal() {
        const modal = document.createElement('div');
        modal.id = "pdfExportModal";
        modal.className = "fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 hidden";

        modal.innerHTML = `
          <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b border-gray-200">
              <div class="flex items-center justify-between">
                <h3 class="text-2xl font-bold text-gray-900">PDF eksport</h3>
                <button id="cancelPdfExport" class="text-gray-500 hover:text-gray-700">
                  <i class="fas fa-times text-xl"></i>
                </button>
              </div>
            </div>
            <div class="p-6">
              <div class="space-y-4">
                <div>
                  <label for="pdfFileName" class="block text-sm font-medium text-gray-700 mb-2">Faili nimi</label>
                  <input type="text" id="pdfFileName" placeholder="Maksumuse esildis.pdf" value="Maksumuse esildis.pdf"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Paberiformaat</label>
                  <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                      <input type="radio" name="pdfSize" value="a4" checked class="mr-2">
                      <span>A4</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                      <input type="radio" name="pdfSize" value="letter" class="mr-2">
                      <span>Letter</span>
                    </label>
                  </div>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Orientatsioon</label>
                  <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                      <input type="radio" name="pdfOrientation" value="portrait" checked class="mr-2">
                      <span>Portree</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                      <input type="radio" name="pdfOrientation" value="landscape" class="mr-2">
                      <span>Maastik</span>
                    </label>
                  </div>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Valikud</label>
                  <div class="space-y-2">
                    <label class="flex items-center">
                      <input type="checkbox" id="pdfIncludeHeader" checked class="mr-2">
                      <span>Lisa tabeli päis</span>
                    </label>
                    <label class="flex items-center">
                      <input type="checkbox" id="pdfFitToPage" checked class="mr-2">
                      <span>Mahuta lehele</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <div class="p-6 border-t border-gray-200 bg-gray-50 flex justify-end space-x-3">
              <button id="cancelPdfExport" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-100">
                Tühista
              </button>
              <button id="confirmPdfExport" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                Ekspordi PDF
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
        return modal;
      }

      // Generate and download PDF with options
      function generateAndDownloadPdf() {
        try {
          // Get options from the form
          const fileName = document.getElementById("pdfFileName").value.trim() || "Maksumuse esildis.pdf";
          const format = document.querySelector('input[name="pdfSize"]:checked').value;
          const orientation = document.querySelector('input[name="pdfOrientation"]:checked').value;
          const includeHeader = document.getElementById("pdfIncludeHeader").checked;
          const fitToPage = document.getElementById("pdfFitToPage").checked;

          // Clone the table for manipulation
          const element = document.getElementById("dynamicTable").cloneNode(true);
          const title = document.getElementById("tableTitle").value || "Maksumuse esildis";

          // Completely strip all tailwind classes that might use problematic colors
          element.querySelectorAll('*').forEach(el => {
            // Store original content and attributes we want to keep
            const content = el.innerHTML;
            const contentEditable = el.contentEditable;
            const tagName = el.tagName;

            // Clear all classes that could have color-related issues
            el.className = '';

            // Apply basic styling directly with standard colors using inline styles
            if (tagName === 'TH') {
              el.style.backgroundColor = '#f2f2f2';
              el.style.color = '#333333';
              el.style.borderColor = '#dddddd';
              el.style.border = '1px solid #dddddd';
              el.style.padding = '8px';
              el.style.fontWeight = 'bold';
              el.style.textAlign = 'left';
            } else if (tagName === 'TD') {
              el.style.backgroundColor = '#ffffff';
              el.style.color = '#333333';
              el.style.borderColor = '#dddddd';
              el.style.border = '1px solid #dddddd';
              el.style.padding = '8px';
            } else if (tagName === 'TABLE') {
              el.style.width = '100%';
              el.style.borderCollapse = 'collapse';
              el.style.marginBottom = '20px';
            } else if (tagName === 'BUTTON' || tagName === 'INPUT') {
              // Hide buttons and inputs from the PDF
              el.style.display = 'none';
            }

            // Restore content and essential attributes
            el.contentEditable = contentEditable;
          });

          // Create a container for the PDF content
          const container = document.createElement("div");
          container.className = "pdf-container";
          container.style.fontFamily = "'Arial', sans-serif";
          container.style.color = "#333333";
          container.style.maxWidth = "100%";

          // Add title if present
          if (title && includeHeader) {
            const titleElem = document.createElement("h2");
            titleElem.textContent = title;
            titleElem.style.color = "#333333";
            titleElem.style.fontSize = "18px";
            titleElem.style.marginBottom = "10px";
            titleElem.style.textAlign = "center";
            container.appendChild(titleElem);
          }

          // Add the table (clone it to avoid modifying the original)
          container.appendChild(element);

          // Remove delete buttons from the clone
          container.querySelectorAll('.delete-row, .delete-col').forEach(el => el.remove());

          // Find the cost column
          const headers = [...container.querySelectorAll('th')];
          const costColumnIndex = headers.findIndex(th =>
            th.textContent.toLowerCase().includes('maksumus'));
          const quantityColumnIndex = headers.findIndex(th =>
            th.textContent.toLowerCase().includes('kogus'));

          // Apply special styling to specific columns
          if (costColumnIndex !== -1) {
            // Apply to header
            const costHeader = headers[costColumnIndex];
            costHeader.style.textAlign = "right";
            costHeader.style.backgroundColor = "#f5f5f5";

            // Apply to all cells in that column
            const rows = container.querySelectorAll('tbody tr');
            rows.forEach(row => {
              const cells = [...row.querySelectorAll('td')];
              if (cells[costColumnIndex]) {
                const cell = cells[costColumnIndex];
                cell.style.textAlign = "right";
                cell.style.backgroundColor = "#f5f5f5";

                // Format the cost with € if it doesn't already have it
                const content = cell.textContent.trim();
                if (/^-?\d+(\.\d+)?$/.test(content)) {
                  cell.textContent = `${content} €`;
                }
              }
            });
          }

          // Format quantity column as right-aligned
          if (quantityColumnIndex !== -1) {
            // Apply to all cells in quantity column
            const rows = container.querySelectorAll('tbody tr');
            rows.forEach(row => {
              const cells = [...row.querySelectorAll('td')];
              if (cells[quantityColumnIndex]) {
                cells[quantityColumnIndex].style.textAlign = "right";
              }
            });
          }

          // Apply zebra striping with standard colors
          container.querySelectorAll('tbody tr:nth-child(even) td').forEach(cell => {
            cell.style.backgroundColor = "#f9f9f9";
          });

          // Create PDF generation options
          const opt = {
            margin: 10,
            filename: fileName.endsWith('.pdf') ? fileName : `${fileName}.pdf`,
            image: { type: "jpeg", quality: 0.98 },
            html2canvas: {
              scale: 2,
              useCORS: true,
              letterRendering: true,
              backgroundColor: "#ffffff" // Use standard white
            },
            jsPDF: {
              unit: "mm",
              format: format,
              orientation: orientation
            }
          };

          // Add fit to page option if selected
          if (fitToPage) {
            // Calculate the optimal scale based on the table size and page size
            const tableWidth = element.offsetWidth;
            const pageWidth = format === 'a4' ? 210 : 216; // A4 or Letter width in mm
            const margin = 20; // 10mm margins on each side
            const availableWidth = pageWidth - (margin * 2);

            // Convert px to mm (approx 3.8px = 1mm)
            const tableWidthMm = tableWidth / 3.8;
            const scale = Math.min(1, availableWidth / tableWidthMm);

            opt.html2canvas.scale = 2 * scale; // Adjust scale for high resolution
          }

          // Try primary method first with html2pdf
          generatePdfWithHtml2Pdf(container, opt)
            .catch(error => {
              console.error("Primary PDF generation failed:", error);
              showToast("Proovin alternatiivset meetodit...", "info");

              // Fall back to jsPDF direct method
              generatePdfWithJsPdf(container, opt);
            });
        } catch (error) {
          console.error("PDF generation setup error:", error);
          showToast("Viga PDF-i seadistamisel: " + error.message, "error");
        }
      }

      // Primary PDF generation method
      function generatePdfWithHtml2Pdf(container, opt) {
        return html2pdf()
          .set(opt)
          .from(container)
          .save()
          .then(() => {
            showToast("PDF on eksporditud!", "success");
            return true;
          });
      }

      // Fallback PDF generation method
      function generatePdfWithJsPdf(container, opt) {
        try {
          // Create a new jsPDF instance
          const pdf = new jspdf.jsPDF({
            orientation: opt.jsPDF.orientation,
            unit: opt.jsPDF.unit,
            format: opt.jsPDF.format
          });

          // Extract table data
          const table = container.querySelector('table');
          const rows = Array.from(table.querySelectorAll('tr'));

          // Get table headers
          const headers = Array.from(rows[0].querySelectorAll('th')).map(th => th.textContent.trim());

          // Get table data
          const data = [];
          for (let i = 1; i < rows.length; i++) {
            const rowData = Array.from(rows[i].querySelectorAll('td')).map(td => td.textContent.trim());
            if (rowData.some(cell => cell)) { // Skip empty rows
              data.push(rowData);
            }
          }

          // Title if included
          let startY = 15;
          const title = container.querySelector('h2');
          if (title) {
            pdf.setFontSize(16);
            pdf.text(title.textContent, pdf.internal.pageSize.width / 2, startY, { align: 'center' });
            startY += 10;
          }

          // Create the table in PDF
          pdf.autoTable({
            head: [headers],
            body: data,
            startY: startY,
            theme: 'grid',
            styles: {
              fontSize: 10,
              cellPadding: 3,
              lineColor: [221, 221, 221],
              lineWidth: 0.1
            },
            headStyles: {
              fillColor: [242, 242, 242],
              textColor: [51, 51, 51],
              fontStyle: 'bold'
            },
            alternateRowStyles: {
              fillColor: [249, 249, 249]
            },
            // Custom styling for specific columns
            columnStyles: {
              [headers.findIndex(h => h.toLowerCase().includes('maksumus'))]: {
                halign: 'right',
                fillColor: [245, 245, 245]
              },
              [headers.findIndex(h => h.toLowerCase().includes('kogus'))]: {
                halign: 'right'
              }
            }
          });

          // Save the PDF
          pdf.save(opt.filename);
          showToast("PDF on eksporditud alternatiivse meetodiga!", "success");
        } catch (error) {
          console.error("Fallback PDF generation failed:", error);
          showToast("Viga PDF-i loomisel: " + error.message, "error");
        }
      }

      // Toast notification function
      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white shadow-lg transition-all duration-300 ${type === "success" ? "bg-green-500" : type === "error" ? "bg-red-500" : "bg-blue-500"
          }`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.classList.add("opacity-0");
          setTimeout(() => toast.remove(), 3000);
        }, 3000);
      }
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const tableHead = document.getElementById("tableHead");
      const tableBody = document.getElementById("tableBody");

      document.getElementById("addColumn").onclick = () => {
        const newTh = document.createElement("th");
        newTh.className = "p-3 border border-gray-200 bg-gray-50";
        newTh.contentEditable = "true"; // redigeeritav nimi
        newTh.textContent = `Uus veerg`;

        tableHead.appendChild(newTh);

        [...tableBody.rows].forEach((row) => {
          const newTd = document.createElement("td");
          newTd.className = "p-3 border border-gray-200";
          newTd.contentEditable = "true";
          row.insertBefore(newTd, row.lastElementChild);
        });
      };

      // Siia võid lisada ka addRow, eksport jne
    });
  </script>
</head>

<body class="backdrop-blur-2xl min-h-screen flex flex-col" x-data="formData" x-cloak :class="{'dark': isDarkMode}">
  <!-- Login Modal -->
  <div x-show="showLoginModal" x-cloak x-transition:enter="transition duration-300 ease-out"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition duration-200 ease-in" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-50 overflow-y-auto bg-black/30 backdrop-blur-sm flex items-center justify-center p-4">
    <div
      class="fixed left-1/2 transform -translate-x-1/2 top-8 md:top-24 w-full max-w-md rounded-2xl shadow-2xl border border-white/40 bg-white"
      @click.stop>
      <!-- Close Button -->
      <div class="flex justify-between items-center p-6 border-b border-gray-100/30">
        <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-700">
          Logi sisse
        </h2>
        <button @click="showLoginModal = false"
          class="rounded-full p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="p-6">
        <!-- Add form wrapper here -->
        <form id="loginForm" @submit.prevent="login()">
          <div class="space-y-5">
            <!-- Email Input -->
            <div class="relative">
              <label class="text-gray-700 font-medium text-sm mb-1 block" for="emailLogin">E-post</label>
              <div class="relative flex items-center">
                <div class="absolute left-3 text-gray-400">
                  <i class="fas fa-envelope"></i>
                </div>
                <input type="email" id="emailLogin" placeholder="Sisesta oma e-post"
                  class="input w-full pl-10 pr-4 py-3 border border-gray-200 text-gray-900 rounded-xl focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-300"
                  required autocomplete="email" />
              </div>
            </div>

            <!-- Password Input -->
            <div class="relative">
              <label class="text-gray-700 font-medium text-sm mb-1 block" for="passwordLogin">Parool</label>
              <div class="relative flex items-center">
                <div class="absolute left-3 text-gray-400">
                  <i class="fas fa-lock"></i>
                </div>
                <input type="password" id="passwordLogin" placeholder="Sisesta oma parool"
                  class="input w-full pl-10 pr-4 py-3 border border-gray-200 text-gray-900 rounded-xl focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-300"
                  required autocomplete="current-password" />
              </div>
            </div>

            <div class="flex items-center justify-between mt-2">
              <div class="flex items-center">
                <input type="checkbox" id="rememberMe" class="mr-2 rounded-md" />
                <label for="rememberMe" class="text-gray-700 text-sm">Pea meeles mind</label>
              </div>
              <a href="#" class="text-sm text-indigo-600 hover:text-indigo-800">Unustasid parooli?</a>
            </div>
          </div>

          <!-- Changed button to submit type -->
          <button type="submit"
            class="w-full mt-6 py-3 px-4 bg-gradient-to-r from-indigo-600 to-indigo-800 text-white rounded-xl flex items-center justify-center transition-all duration-300 hover:shadow-lg hover:shadow-indigo-500/30 transform hover:-translate-y-1">
            <i class="fas fa-sign-in-alt mr-2"></i> Logi sisse
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="fixed top-0 left-0 right-0 z-50 glassmorphism py-3">
    <div class="max-w-7xl mx-auto px-6">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-6">
          <a href="om.html" class="text-xl font-bold bg-clip-text text-transparent bg-black">
          </a>
          <div class="hidden md:flex md:space-x-4">
            <a href="../index.html"
              class="flex items-center space-x-2 text-gray-800 hover:text-indigo-600 bg-white/30 hover:bg-white/50 px-4 py-2 rounded-full transition-all">
              <i class="fas fa-home"></i>
              <span>Avalehele</span>
            </a>
            <a href="om.html"
              class="flex items-center space-x-2 text-gray-800 hover:text-indigo-600 bg-white/30 hover:bg-white/50 px-4 py-2 rounded-full transition-all">
              <i class="fas fa-file-alt"></i>
              <span>Kutse</span>
            </a>
            <!-- Tabeli loomise nupp -->
            <button id="openTableModal"
              class="flex items-center space-x-2 text-gray-800 hover:text-indigo-600 bg-white/30 hover:bg-white/50 px-4 py-2 rounded-full transition-all">
              <i class="fas fa-table"></i>
              <span>Loo tabel</span>
            </button>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <!-- Settings Button -->
          <button @click="showSettingsModal = true" x-show="currentUser"
            class="flex items-center space-x-2 text-gray-800 hover:text-indigo-600 bg-white/30 hover:bg-white/50 px-4 py-2 rounded-full transition-all">
            <i class="fas fa-cog"></i>
            <span class="hidden md:inline">Seaded</span>
          </button>

          <div class="relative">
            <button @click="currentUser ? toggleUserMenu() : showLoginModal = true"
              class="flex items-center space-x-2 text-gray-800 hover:text-indigo-600 bg-white/30 hover:bg-white/50 px-4 py-2 rounded-full transition-all">
              <i class="fas fa-user-circle"></i>
              <span x-text="currentUser ? currentUser.email?.split('@')[0] : 'Logi sisse'"
                class="hidden md:inline"></span>
              <i class="fas fa-chevron-down text-xs ml-1"></i>
            </button>
            <div x-show="showUserMenu && currentUser" @click.away="showUserMenu = false"
              x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95"
              x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-150"
              x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
              class="absolute right-0 mt-2 w-48 rounded-xl shadow-xl glassmorphism ring-1 ring-black ring-opacity-5 z-50 border border-white/20">
              <div class="py-1">
                <a href="#" @click.prevent="logout()"
                  class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-red-50 hover:text-red-700">
                  <i class="fas fa-sign-out-alt mr-3 text-red-500"></i> Logi
                  välja
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Add padding to main content to account for fixed navbar -->
  <div class="pt-20">
    <!-- Main Content -->
    <div class="container mx-auto max-w-7xl p-6">
      <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-center text-transparent bg-clip-text bg-black">
          Ostumenetluse kutse koostamine
        </h1>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
        <!-- Left: Data Input -->
        <div class="space-y-6">
          <!-- Form Header Card -->
          <div class="card transition-all" x-data="{ isOpen: true }">
            <div class="flex items-center justify-between mb-4 cursor-pointer" @click="isOpen = !isOpen">
              <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                  <i class="fas fa-file-contract text-indigo-600"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800">Ostumenetluse nimi ja kirjeldus</h2>
              </div>
              <button class="p-2 rounded-full hover:bg-indigo-100 transition-all">
                <i class="fas transition-transform duration-300"
                  :class="isOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
              </button>
            </div>

            <div x-show="isOpen" x-transition:enter="transition ease-out duration-50"
              x-transition:enter-start="opacity-0 transform -translate-y-2"
              x-transition:enter-end="opacity-100 transform translate-y-0"
              x-transition:leave="transition ease-in duration-50"
              x-transition:leave-start="opacity-100 transform translate-y-0"
              x-transition:leave-end="opacity-0 transform -translate-y-2">
              <!-- Ostumenetluse nimi -->
              <div class="mb-4">
                <label class="block text-sm font-semibold mb-2 text-gray-700">Ostumenetluse nimi</label>
                <input type="text" x-model="form.name" class="w-full border rounded-xl px-4 py-3 shadow-sm"
                  placeholder="Näiteks: Haljasala rajamine" />
              </div>

              <!-- Ostumenetluse kirjeldus -->
              <div>
                <label class="block text-sm font-semibold mb-2 text-gray-700">Ostumenetluse kutse lühikirjeldus</label>
                <textarea x-model="form.intro" class="w-full border rounded-xl px-4 py-3 h-40 shadow-sm"></textarea>
              </div>
            </div>
          </div>

          <!-- Põhiandmed Card -->
          <div class="card transition-all" x-data="{ isOpen: true }">
            <div class="flex items-center justify-between mb-6 cursor-pointer" @click="isOpen = !isOpen">
              <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                  <i class="fas fa-sliders-h text-indigo-600"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800">Ostumenetluse andmed</h2>
              </div>
              <button class="p-2 rounded-full hover:bg-indigo-100 transition-all">
                <i class="fas transition-transform duration-300"
                  :class="isOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
              </button>
            </div>

            <div x-show="isOpen" x-transition:enter="transition ease-out duration-200"
              x-transition:enter-start="opacity-0 transform -translate-y-2"
              x-transition:enter-end="opacity-100 transform translate-y-0"
              x-transition:leave="transition ease-in duration-150"
              x-transition:leave-start="opacity-100 transform translate-y-0"
              x-transition:leave-end="opacity-0 transform -translate-y-2">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <template x-for="field in standardFields" :key="field.key">
                  <div class="group">
                    <label class="block text-sm font-semibold mb-2 text-gray-700" x-text="field.label"></label>
                    <div class="relative">
                      <input type="text" x-model="form.fields[field.key]"
                        class="w-full border rounded-xl px-4 py-3 shadow-sm transition-all focus:shadow-md"
                        :placeholder="field.placeholder" />
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- Sections 1-7 Card -->
          <div class="card transition-all" x-data="{ isOpen: true }">
            <div class="flex items-center justify-between mb-6 cursor-pointer" @click="isOpen = !isOpen">
              <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                  <i class="fas fa-list-check text-indigo-600"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800">
                  Ostumenetluse tingimused
                </h2>
              </div>
              <button class="p-2 rounded-full hover:bg-indigo-100 transition-all">
                <i class="fas transition-transform duration-300"
                  :class="isOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
              </button>
            </div>

            <div x-show="isOpen" x-transition:enter="transition ease-out duration-200"
              x-transition:enter-start="opacity-0 transform -translate-y-2"
              x-transition:enter-end="opacity-100 transform translate-y-0"
              x-transition:leave="transition ease-in duration-150"
              x-transition:leave-start="opacity-100 transform translate-y-0"
              x-transition:leave-end="opacity-0 transform -translate-y-2">
              <div class="flex gap-2 mb-6">
                <button @click="selectAllOptions"
                  class="flex items-center text-sm bg-emer hover:bg-indigo-200 text-indigo-700 px-3 py-2 rounded-lg transition-colors">
                  <i class="fas mr-1"
                    :class="form.sections.some(section => section.options.some(option => !option.checked)) ? 'fa-check-double' : 'fa-times'"></i>
                  <span
                    x-text="form.sections.some(section => section.options.some(option => !option.checked)) ? 'Lisa kõik' : 'Eemalda kõik'"></span>
                </button>
                <button @click="toggleAllSections"
                  class="flex items-center text-sm bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-2 rounded-lg transition-colors">
                  <i class="fas mr-1"
                    :class="form.sections.some(section => !section.open) ? 'fa-chevron-down' : 'fa-chevron-up'"></i>
                  <span x-text="form.sections.some(section => !section.open) ? 'Ava kõik' : 'Sulge kõik'"></span>
                </button>

                <!-- Eelsätete dropdown -->
                <div class="relative" x-data="{ showTooltip: false }">
                  <button @click="loadFormPresets(); showPresetDropdown = !showPresetDropdown"
                    class="flex items-center text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded-lg transition-colors"
                    @mouseenter="showTooltip = true" @mouseleave="showTooltip = false">
                    <i class="fas fa-list mr-1"></i>
                    <span>Kutse mallid</span>
                    <i class="fas fa-chevron-down ml-1 text-xs"
                      :class="{'transform rotate-180': showPresetDropdown}"></i>
                  </button>

                  <!-- Tooltip -->
                  <div x-show="showTooltip && !showPresetDropdown" x-transition
                    class="absolute z-10 bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded shadow-lg whitespace-nowrap">
                    Vali administraatori loodud vormimall
                    <div
                      class="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-1/2 rotate-45 w-2 h-2 bg-gray-900">
                    </div>
                  </div>

                  <!-- Dropdown -->
                  <div x-show="showPresetDropdown" x-transition @click.away="showPresetDropdown = false"
                    class="absolute z-10 left-0 mt-2 w-64 md:w-80 bg-white rounded-xl shadow-xl border border-gray-200 py-2 overflow-hidden">
                    <div class="px-4 py-2 bg-gray-50 border-b border-gray-200">
                      <h3 class="font-medium text-gray-800 text-sm">Mallid on eelvalitud tingimustega</h3>
                      <p class="text-xs text-gray-500 mt-1">

                      </p>
                    </div>

                    <!-- Laadimise indikaator -->
                    <div x-show="isLoadingPresets" class="flex justify-center py-4">
                      <div class="animate-spin rounded-full h-6 w-6 border-t-2 border-b-2 border-blue-500"></div>
                    </div>

                    <!-- Puuduvad eelsätted -->
                    <div x-show="!isLoadingPresets && formPresets.length === 0" class="px-4 py-3 text-center">
                      <p class="text-sm text-gray-500">Ühtegi vormimalli pole veel loodud</p>
                    </div>

                    <!-- Eelsätete nimekiri -->
                    <div x-show="!isLoadingPresets && formPresets.length > 0" class="max-h-64 overflow-y-auto">
                      <template x-for="preset in formPresets" :key="preset.id">
                        <div @click="applyFormPreset(preset)"
                          class="px-4 py-3 hover:bg-gray-50 cursor-pointer transition-colors border-b border-gray-100 last:border-b-0">
                          <div class="flex justify-between items-start">
                            <div>
                              <h4 class="font-medium text-gray-800 text-sm" x-text="preset.name"></h4>
                              <p class="text-xs text-gray-500 mt-1" x-text="preset.description || 'Kirjeldus puudub'">
                              </p>
                            </div>
                            <span class="text-blue-600 hover:text-blue-800 text-xs">Vali</span>
                          </div>
                          <div class="flex justify-between mt-2">
                            <span class="text-xs text-gray-500" x-text="'Autor: ' + preset.createdBy"></span>
                            <span class="text-xs text-gray-500" x-text="preset.createdAt"></span>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>
              </div>

              <div id="draggableSections" x-ref="draggableSections" class="space-y-4">
                <template x-for="(section, index) in form.sections" :key="index">
                  <div
                    class="mb-4 border bg-white/50 backdrop-blur-sm border-gray-200 rounded-xl overflow-hidden shadow-sm transition-all hover:shadow-md"
                    x-data="{ section }" :class="{ 'active-section': section.enabled }">
                    <div class="section-header" @click="section.open = !section.open">
                      <input type="checkbox" x-model="section.enabled" class="mr-3" @click.stop />
                      <span class="drag-handle cursor-move mr-3 text-gray-400 hover:text-indigo-500 transition-colors">
                        <i class="fas fa-grip-lines"></i>
                      </span>
                      <span x-text="section.title" class="flex-grow"></span>
                      <i class="fas transition-transform duration-300"
                        :class="section.open ? 'fa-chevron-down transform rotate-180' : 'fa-chevron-right'"></i>
                    </div>
                    <div x-show="section.open" x-transition:enter="transition ease-out duration-200"
                      x-transition:enter-start="opacity-0 transform -translate-y-4"
                      x-transition:enter-end="opacity-100 transform translate-y-0"
                      x-transition:leave="transition ease-in duration-150"
                      x-transition:leave-start="opacity-100 transform translate-y-0"
                      x-transition:leave-end="opacity-0 transform -translate-y-4" class="section-content">
                      <template x-for="(opt, i) in section.options" :key="i">
                        <label class="block p-3 hover:bg-white/50 rounded-lg transition-colors mb-2">
                          <div class="flex items-start">
                            <input type="checkbox" x-model="opt.checked" class="mt-1 mr-3 rounded" />
                            <template x-if="opt.isEditing">
                              <input type="text" x-model="opt.text" @blur="opt.isEditing = false"
                                @keydown.enter="opt.isEditing = false"
                                class="flex-grow border rounded-lg px-3 py-2 text-sm shadow-sm" x-ref="editInput" />
                            </template>
                            <template x-if="!opt.isEditing">
                              <span x-text="opt.text" class="text-sm cursor-pointer hover:text-indigo-600"
                                @dblclick="opt.isEditing = true; $nextTick(() => $refs.editInput?.focus())">
                              </span>
                            </template>
                          </div>
                        </label>
                      </template>
                    </div>
                  </div>
                </template>
              </div>

              <div class="flex flex-wrap justify-between items-center gap-4 mt-8">

                <!-- Lisa uus punkt nupp -->
                <button @click="addNewSection"
                  class="flex items-center gap-2 text-sm font-medium text-emerald-600 hover:text-white border border-emerald-600 hover:bg-emerald-600 px-4 py-2 rounded-xl shadow-sm transition-all duration-200">
                  <i class="fas fa-plus-circle"></i> Lisa uus tingimus
                </button>

                <!-- Alapunkti / lisa / punkti lisamise nupud -->
                <template x-for="(section, index) in form.sections" :key="index">
                  <button @click="addOption(index)" x-show="section.open"
                    class="flex items-center gap-2 text-sm font-medium text-indigo-600 hover:text-white border border-indigo-600 hover:bg-indigo-600 px-4 py-2 rounded-xl shadow-sm transition-all duration-200">
                    <i class="fas fa-plus-circle"></i>
                    <span x-text="index === 0 ? 'Lisa alapunkt' : 
                              index === 6 ? 'Lisa lisa' : 
                              'Lisa punkt'"></span>
                  </button>
                </template>

              </div>
            </div>
          </div>

          <!-- File Upload Section -->
          <div class="card transition-all" x-data="{ isOpen: false }">
            <div class="flex items-center justify-between mb-2 cursor-pointer" @click="isOpen = !isOpen">
              <div class="flex items-center">
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                  <i class="fas fa-paperclip text-indigo-600 text-sm"></i>
                </div>
                <h2 class="text-lg font-bold text-gray-800">Manused</h2>
              </div>
              <button class="p-1 rounded-full hover:bg-indigo-100 transition-all">
                <i class="fas transition-transform duration-300 text-sm"
                  :class="isOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
              </button>
            </div>

            <div x-show="isOpen" x-transition:enter="transition ease-out duration-200"
              x-transition:enter-start="opacity-0 transform -translate-y-2"
              x-transition:enter-end="opacity-100 transform translate-y-0"
              x-transition:leave="transition ease-in duration-150"
              x-transition:leave-start="opacity-100 transform translate-y-0"
              x-transition:leave-end="opacity-0 transform -translate-y-2">
              <div @dragover="handleDragOver" @dragleave="handleDragLeave" @drop="handleDrop"
                :class="{'border-indigo-500 bg-indigo-50/50': isDragging}"
                class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center cursor-pointer transition-colors hover:border-indigo-400">
                <input type="file" id="fileInput" class="hidden" @change="handleFileInput" multiple />
                <label for="fileInput" class="cursor-pointer block">
                  <i class="fas fa-cloud-upload-alt text-xl text-indigo-500 mb-2"></i>
                  <p class="text-gray-700 font-medium text-sm mb-1">
                    Lohista failid siia või
                    <span class="text-indigo-600 underline">kliki valimiseks</span>
                  </p>
                  <p class="text-xs text-gray-500">Max 10MB fail</p>
                </label>
              </div>

              <div class="mt-3 space-y-2" x-show="files.length > 0">
                <template x-for="(file, index) in files" :key="index">
                  <div class="file-item hover-scale py-2 px-3">
                    <div class="flex items-center truncate max-w-[80%]">
                      <div class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center mr-2">
                        <i class="fas fa-file-alt text-indigo-500 text-xs"></i>
                      </div>
                      <div class="truncate">
                        <div x-text="file.name" class="truncate text-gray-800 font-medium text-sm"></div>
                        <div class="text-xs text-gray-500" x-text="formatFileSize(file.size)"></div>
                      </div>
                    </div>
                    <button @click="removeFile(index)"
                      class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50 transition-colors">
                      <i class="fas fa-trash-alt text-xs"></i>
                    </button>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-nowrap gap-5 mt-4">
            <button @click="generatePDF" x-show="currentUser"
              class="relative overflow-hidden group flex items-center gap-3 px-5 py-2.5 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-emerald-500/30 hover:-translate-y-1">
              <div
                class="absolute inset-0 w-full h-full bg-gradient-to-r from-emerald-600 to-emerald-700 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              </div>
              <div class="w-7 h-7 flex items-center justify-center bg-white/20 rounded-full relative">
                <i
                  class="fas fa-file-pdf text-white text-sm group-hover:rotate-12 transition-transform duration-300"></i>
              </div>
              <span class="relative">
                <span class="inline-block group-hover:-translate-y-px transition-transform duration-300">Kutse
                  PDF</span>
                <span class="block h-0.5 w-0 group-hover:w-full bg-white transition-all duration-300 mt-0.5"></span>
              </span>
            </button>

            <button @click="manualSave" x-show="currentUser"
              class="relative overflow-hidden group flex items-center gap-3 px-5 py-2.5 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-indigo-500/30 hover:-translate-y-1">
              <div
                class="absolute inset-0 w-full h-full bg-gradient-to-r from-indigo-600 to-indigo-700 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              </div>
              <div class="w-7 h-7 flex items-center justify-center bg-white/20 rounded-full relative">
                <i class="fas fa-save text-white text-sm group-hover:rotate-12 transition-transform duration-300"></i>
              </div>
              <span class="relative">
                <span class="inline-block group-hover:-translate-y-px transition-transform duration-300">Salvesta</span>
                <span class="block h-0.5 w-0 group-hover:w-full bg-white transition-all duration-300 mt-0.5"></span>
              </span>
            </button>

            <button @click="resetForm" x-show="currentUser"
              class="relative overflow-hidden group flex items-center gap-3 px-5 py-2.5 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-red-500/30 hover:-translate-y-1">
              <div
                class="absolute inset-0 w-full h-full bg-gradient-to-r from-red-600 to-red-700 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              </div>
              <div class="w-7 h-7 flex items-center justify-center bg-white/20 rounded-full relative">
                <i
                  class="fas fa-trash-alt text-white text-sm group-hover:rotate-12 transition-transform duration-300"></i>
              </div>
              <span class="relative">
                <span class="inline-block group-hover:-translate-y-px transition-transform duration-300">Kustuta</span>
                <span class="block h-0.5 w-0 group-hover:w-full bg-white transition-all duration-300 mt-0.5"></span>
              </span>
            </button>

          </div>
        </div>

        <!-- Right: PDF Preview -->
        <div>
          <div class="sticky top-24">
            <div class="flex items-center mb-4">
              <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                <i class="fas fa-eye text-indigo-600"></i>
              </div>
              <h2 class="text-lg font-bold text-gray-800">
                Reaalajas eelvaade
              </h2>
            </div>

            <div id="pdfPreview"
              class="border-0 card rounded-2xl space-y-6 min-h-[70vh] max-h-[80vh] overflow-auto backdrop-blur-md transition-all scroll-smooth scrollbar-thin scrollbar-thumb-indigo-500 scrollbar-track-indigo-100">
              <!-- Header -->
              <div
                class="bg-gradient-to-r from-indigo-600 to-indigo-800 backdrop-blur-sm text-white p-5 rounded-t-2xl -mx-6 -mt-6 mb-6">
                <h1 class="text-2xl font-bold text-center" x-text="form.name || 'Ostumenetluse kutse'"></h1>
              </div>

              <!-- Intro text -->
              <div class="text-gray-800 font-medium text-sm leading-relaxed p-2" x-text="form.intro"></div>

              <!-- Standard fields -->
              <div class="space-y-3">
                <template x-for="field in standardFields">
                  <div x-show="form.fields[field.key]"
                    class="bg-white/40 backdrop-blur-sm p-3 rounded-xl shadow-sm transition-all hover:shadow-md">
                    <div class="flex items-start">
                      <span class="font-semibold text-indigo-700 mr-2" x-text="field.label + ':'"></span>
                      <span class="text-gray-800 font-medium" x-text="form.fields[field.key] || ''"></span>
                    </div>
                  </div>
                </template>
              </div>

              <!-- Sections -->
              <template x-for="(section, idx) in visibleSections" :key="idx">
                <div class="mt-8">
                  <!-- Section title -->
                  <div class="flex items-center mb-4">
                    <h2 class="text-lg font-bold text-indigo-700"
                      x-text="(idx + 1) + ' ' + section.title.split(' ').slice(1).join(' ')"></h2>
                    <div class="flex-grow h-0.5 bg-gradient-to-r from-indigo-500 to-indigo-300 ml-3 rounded-full"></div>
                  </div>

                  <!-- Section options -->
                  <ul class="space-y-3 pl-2">
                    <template x-for="(opt, i) in section.options.filter(o => o.checked)" :key="i">
                      <li class="flex items-start p-2 bg-white/30 rounded-lg shadow-sm hover:shadow-md transition-all">
                        <div
                          class="min-w-8 h-6 bg-indigo-100 rounded-full flex items-center justify-center text-xs font-bold text-indigo-700 mr-3">
                          <span x-text="(idx + 1) + '.' + (i+1)"></span>
                        </div>
                        <span class="text-sm text-gray-800" x-text="opt.text"></span>
                      </li>
                    </template>
                  </ul>
                </div>
              </template>

              <!-- Footer -->
              <div class="mt-10 pt-5 border-t border-gray-200">
                <div class="flex justify-between text-sm">
                  <div class="text-indigo-700 font-semibold">
                    <p>
                      Kuupäev:
                      <span class="text-gray-800" x-text="today"></span>
                    </p>
                  </div>
                  <div class="text-indigo-700 font-semibold">
                    <p>
                      Vastutav isik:
                      <span class="text-gray-800" x-text="form.fields.responsible || ''"></span>
                    </p>
                  </div>
                </div>
              </div>

              <!-- Attachments -->
              <template x-if="files.length > 0">
                <div class="mt-8">
                  <div class="flex items-center mb-4">
                    <h3 class="text-lg font-bold text-indigo-700">Manused</h3>
                    <div class="flex-grow h-0.5 bg-gradient-to-r from-indigo-500 to-indigo-300 ml-3 rounded-full"></div>
                  </div>

                  <div class="space-y-2">
                    <template x-for="(file, index) in files" :key="index">
                      <div class="flex items-center p-3 bg-white/40 rounded-xl transition-all hover:bg-white/60">
                        <div class="w-8 h-8 flex items-center justify-center bg-indigo-100 rounded-full mr-3">
                          <i class="fas fa-file-alt text-indigo-600"></i>
                        </div>
                        <span class="text-sm text-gray-800">
                          <span x-text="index + 1 + '. '"></span>
                          <span x-text="file.name" class="font-medium"></span>
                          <span class="text-gray-500" x-text="' (' + formatFileSize(file.size) + ')'"></span>
                          <span x-show="file.comment" class="text-gray-500" x-text="' - ' + file.comment"></span>
                        </span>
                      </div>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div class="fixed bottom-4 right-4 space-y-3 z-50" x-show="toasts.length > 0">
    <template x-for="toast in toasts" :key="toast.id">
      <div x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-2"
        x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 translate-y-2" :class="{
                    'toast-success': toast.type === 'success',
                    'toast-error': toast.type === 'error',
                    'toast-info': toast.type === 'info'
                }"
        :style="toast.type === 'clear' ? 'background-image: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%); box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3)' : ''"
        class="text-white px-6 py-4 rounded-xl shadow-lg flex items-center backdrop-blur-sm max-w-md">
        <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-white/20 mr-3">
          <i class="fas" :class="{
                        'fa-check': toast.type === 'success',
                        'fa-exclamation': toast.type === 'error',
                        'fa-info': toast.type === 'info',
                        'fa-trash-alt': toast.type === 'clear'
                    }"></i>
        </div>
        <div class="flex-1">
          <p class="font-medium" x-text="toast.message"></p>
        </div>
        <div class="flex items-center space-x-2 ml-auto">
          <button x-show="toast.actionText"
            @click="toast.actionCallback(); toasts = toasts.filter(t => t.id !== toast.id)" class="toast-action-button">
            <span x-text="toast.actionText"></span>
          </button>
          <button @click="toasts = toasts.filter(t => t.id !== toast.id)" class="text-white/80 hover:text-white p-1">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    </template>
  </div>

  <!-- Settings Modal -->
  <div x-show="showSettingsModal" x-cloak x-transition:enter="transition duration-300 ease-out"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition duration-200 ease-in" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0" class="fixed inset-0 z-50 bg-black/70 backdrop-blur-md"
    @click.self="showSettingsModal = false" x-data="{ 
            activeTab: 'info',
            async handleTabClick(tab) {
                console.log('Tab clicked:', tab);
                this.activeTab = tab;
                if (tab === 'history') {
                    console.log('Loading PDF history for history tab');
                    await this.loadPdfHistory();
                } else if (tab === 'basicInfo') {
                    console.log('Loading user settings for basic info tab');
                    await this.loadUserSettings();
                }
            },
            async loadUserSettings() {
                try {
                    console.log('Loading user settings...');
                    if (window.currentUser && window.userData) {
                        console.log('User is logged in, loading from global data');
                        if (window.userData.settings) {
                            console.log('Loading settings from global data');
                            Object.keys(window.userData.settings).forEach(key => {
                                if (this.userSettings.hasOwnProperty(key)) {
                                    this.userSettings[key] = window.userData.settings[key];
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error('Settings load error:', error);
                    this.showToast('Viga seadete laadimisel: ' + error.message, 'error');
                }
            },
            async loadPdfHistory() {
                if (window.currentUser && window.userData && window.userData.pdfHistory) {
                    this.userSettings.generatedPdfs = window.userData.pdfHistory;
                }
            }
        }" x-init="loadUserSettings()">
    <div
      class="fixed left-1/2 transform -translate-x-1/2 top-8 md:top-24 w-full max-w-3xl rounded-2xl shadow-2xl border border-white/40 max-h-[85vh] overflow-y-auto mx-auto bg-white/90 backdrop-blur-xl"
      @click.stop>
      <!-- Header -->
      <div class="sticky top-0 p-6 border-b border-gray-100/30 bg-gradient-to-r from-indigo-600 to-indigo-800 z-10">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-bold text-white flex items-center">
            <i class="fas fa-cog mr-3"></i>Seaded
          </h2>
          <button @click="showSettingsModal = false"
            class="text-white/80 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <!-- Tabs -->
        <div class="flex space-x-1 mt-5">
          <button @click="handleTabClick('info')"
            :class="activeTab === 'info' ? 'text-white bg-white/20 border-b-2 border-white' : 'text-white/70 hover:text-white hover:bg-white/10'"
            class="px-4 py-2 rounded-t-lg font-medium transition-colors">
            Info
          </button>
          <button @click="handleTabClick('basicInfo')"
            :class="activeTab === 'basicInfo' ? 'text-white bg-white/20 border-b-2 border-white' : 'text-white/70 hover:text-white hover:bg-white/10'"
            class="px-4 py-2 rounded-t-lg font-medium transition-colors">
            Põhiandmed
          </button>
          <button @click="handleTabClick('history')"
            :class="activeTab === 'history' ? 'text-white bg-white/20 border-b-2 border-white' : 'text-white/70 hover:text-white hover:bg-white/10'"
            class="px-4 py-2 rounded-t-lg font-medium transition-colors">
            Ajalugu
          </button>
        </div>
      </div>

      <!-- Content -->
      <div class="p-6 bg-white/90">
        <!-- Info Tab Content -->
        <div x-show="activeTab === 'info'" x-transition:enter="transition ease-out duration-200"
          x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
          <div class="space-y-8">
            <div class="flex items-center space-x-3 mb-6">
              <i class="fas fa-cog text-2xl text-gray-700"></i>
              <h3 class="text-2xl font-bold text-gray-800">Seadete info</h3>
            </div>

            <!-- Põhiandmed Info -->
            <div
              class="bg-gradient-to-br from-indigo-50 to-white rounded-2xl p-8 border border-indigo-100 shadow-sm hover:shadow-md transition-shadow duration-200">
              <div class="flex items-start">
                <div class="w-12 h-12 rounded-xl bg-indigo-100 flex items-center justify-center mr-4">
                  <i class="fas fa-info-circle text-xl text-indigo-600"></i>
                </div>
                <div class="flex-1">
                  <h4 class="text-xl font-semibold text-gray-800 mb-3">
                    Põhiandmed
                  </h4>
                  <p class="text-gray-600 mb-4">
                    Salvestage oma põhiteave, mida saab automaatselt täita
                    vormi avamisel.
                  </p>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white/80 rounded-xl p-4 border border-indigo-100">
                      <h5 class="font-medium text-gray-700 mb-2">
                        Salvestatav info
                      </h5>
                      <ul class="space-y-2 text-gray-600">
                        <li class="flex items-center">
                          <i class="fas fa-check-circle text-indigo-500 mr-2"></i>
                          Hankija info
                        </li>
                        <li class="flex items-center">
                          <i class="fas fa-check-circle text-indigo-500 mr-2"></i>
                          Pakkumise aeg ja koht
                        </li>
                        <li class="flex items-center">
                          <i class="fas fa-check-circle text-indigo-500 mr-2"></i>
                          Jõusoleku aeg
                        </li>
                      </ul>
                    </div>
                    <div class="bg-white/80 rounded-xl p-4 border border-indigo-100">
                      <h5 class="font-medium text-gray-700 mb-2">
                        Täiendav info
                      </h5>
                      <ul class="space-y-2 text-gray-600">
                        <li class="flex items-center">
                          <i class="fas fa-check-circle text-indigo-500 mr-2"></i>
                          Nõuded pakkujale
                        </li>
                        <li class="flex items-center">
                          <i class="fas fa-check-circle text-indigo-500 mr-2"></i>
                          Väljavaliku alused
                        </li>
                        <li class="flex items-center">
                          <i class="fas fa-check-circle text-indigo-500 mr-2"></i>
                          Vastutav isik
                        </li>
                      </ul>
                    </div>
                  </div>

                  <div class="bg-indigo-50 rounded-xl p-4 border border-indigo-100">
                    <div class="flex items-start">
                      <i class="fas fa-lightbulb text-indigo-500 text-xl mt-1 mr-3"></i>
                      <div>
                        <h5 class="font-medium text-gray-700 mb-1">
                          Automaatne täitmine
                        </h5>
                        <p class="text-sm text-gray-600">
                          Lülitage sisse "Automaatne täitmine" lüliti
                          Põhiandmete sektsioonis, et põhiandmed täidetaksid
                          vormi automaatselt.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Ajalugu Info -->
            <div
              class="bg-gradient-to-br from-emerald-50 to-white rounded-2xl p-8 border border-emerald-100 shadow-sm hover:shadow-md transition-shadow duration-200">
              <div class="flex items-start">
                <div class="w-12 h-12 rounded-xl bg-emerald-100 flex items-center justify-center mr-4">
                  <i class="fas fa-history text-xl text-emerald-600"></i>
                </div>
                <div class="flex-1">
                  <h4 class="text-xl font-semibold text-gray-800 mb-3">
                    Ajalugu
                  </h4>
                  <p class="text-gray-600 mb-4">
                    Vaadake ja hallake kõiki teie genereeritud PDF-e.
                  </p>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white/80 rounded-xl p-4 border border-emerald-100">
                      <h5 class="font-medium text-gray-700 mb-2">PDF info</h5>
                      <ul class="space-y-2 text-gray-600">
                        <li class="flex items-center">
                          <i class="fas fa-check-circle text-emerald-500 mr-2"></i>
                          PDF-i nimi
                        </li>
                        <li class="flex items-center">
                          <i class="fas fa-check-circle text-emerald-500 mr-2"></i>
                          Loomise kuupäev
                        </li>
                        <li class="flex items-center">
                          <i class="fas fa-check-circle text-emerald-500 mr-2"></i>
                          Vastutava isiku info
                        </li>
                      </ul>
                    </div>
                    <div class="bg-white/80 rounded-xl p-4 border border-emerald-100">
                      <h5 class="font-medium text-gray-700 mb-2">
                        Tegevused
                      </h5>
                      <ul class="space-y-2 text-gray-600">
                        <li class="flex items-center">
                          <i class="fas fa-eye text-emerald-500 mr-2"></i>
                          Vaata PDF-i
                        </li>
                        <li class="flex items-center">
                          <i class="fas fa-download text-emerald-500 mr-2"></i>
                          Lae alla
                        </li>
                        <li class="flex items-center">
                          <i class="fas fa-trash text-emerald-500 mr-2"></i>
                          Kustuta ajalugu
                        </li>
                      </ul>
                    </div>
                  </div>

                  <div class="bg-emerald-50 rounded-xl p-4 border border-emerald-100">
                    <div class="flex items-start">
                      <i class="fas fa-info-circle text-emerald-500 text-xl mt-1 mr-3"></i>
                      <div>
                        <h5 class="font-medium text-gray-700 mb-1">
                          Tähelepanu
                        </h5>
                        <p class="text-sm text-gray-600">
                          "Tühjenda" nupp kustutab kogu ajaloo jäädavalt. Enne
                          kustutamist veenduge, et olete salvestanud vajalikud
                          PDF-id.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Põhiandmed Tab Content -->
        <div x-show="activeTab === 'basicInfo'" x-transition:enter="transition ease-out duration-200"
          x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
          <form @submit.prevent="saveUserSettings" class="space-y-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
              Põhiandmete seaded
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Hankija</label>
                <div class="relative">
                  <i class="fas fa-building absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  <input type="text" x-model="userSettings.buyer"
                    class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl bg-white text-gray-900 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                    placeholder="Nimi, aadress, registrikood" />
                </div>
              </div>

              <div class="group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Pakkumise esitamise aeg ja koht</label>
                <div class="relative">
                  <i class="fas fa-calendar absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  <input type="text" x-model="userSettings.submission"
                    class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl bg-white text-gray-900 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                    placeholder="nt 10. aprill, e-post" />
                </div>
              </div>

              <div class="group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Pakkumuse jõusoleku aeg</label>
                <div class="relative">
                  <i class="fas fa-clock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  <input type="text" x-model="userSettings.validity"
                    class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl bg-white text-gray-900 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                    placeholder="nt 30 päeva" />
                </div>
              </div>

              <div class="group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Nõuded pakkujale</label>
                <div class="relative">
                  <i class="fas fa-list-check absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  <input type="text" x-model="userSettings.requirements"
                    class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl bg-white text-gray-900 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                    placeholder="nt kogemus 3 aastat" />
                </div>
              </div>

              <div class="group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Väljavaliku alused</label>
                <div class="relative">
                  <i class="fas fa-scale-balanced absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  <input type="text" x-model="userSettings.criteria"
                    class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl bg-white text-gray-900 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                    placeholder="Majanduslikult soodsaim" />
                </div>
              </div>

              <div class="group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Vastutav isik</label>
                <div class="relative">
                  <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  <input type="text" x-model="userSettings.responsible"
                    class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl bg-white text-gray-900 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                    placeholder="Nimi" />
                </div>
              </div>
            </div>
          </form>
          <!-- Autofill Toggle -->
          <div
            class="flex items-center justify-between p-5 bg-indigo-50 rounded-xl mt-6 border border-indigo-100 shadow-sm">
            <div class="flex items-center">
              <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center mr-3">
                <i class="fas fa-magic text-indigo-600"></i>
              </div>
              <div>
                <label class="text-lg font-medium text-gray-800">
                  Automaatne täitmine
                </label>
                <p class="text-sm text-gray-500">
                  Põhiandmete automaatne täitmine vormi avamisel
                </p>
              </div>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" x-model="userSettings.autofillEnabled" class="sr-only peer" />
              <div
                class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-indigo-600">
              </div>
            </label>
          </div>
          <div class="flex flex-col-4 gap-2 mt-8 pt-6 border-t border-gray-200">
            <button type="button" @click="showSettingsModal = false"
              class="px-5 py-3 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all shadow-sm hover:shadow">Tühista</button>
            <button type="button" @click="saveUserSettings()"
              class="px-5 py-3 text-sm font-medium text-white bg-blue-500 border border-transparent rounded-xl hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all shadow-sm hover:shadow-md"><i
                class="fas fa-save mr-2"></i> Salvesta seaded</button>
            <button @click="restoreDraftFromFirestore"
              class="px-5 py-3 text-sm font-medium text-white bg-green-500 border border-transparent rounded-xl hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all shadow-sm hover:shadow-md"><i
                class="fas fa-undo mr-2"></i> Taasta salvestatud vorm</button>
          </div>
        </div>

        <!-- History Tab Content -->
        <div x-show="activeTab === 'history'" x-transition:enter="transition ease-out duration-200"
          x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
          <div class="space-y-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
              Ajalugu ja tehtud PDF-id
            </h3>

            <div class="border border-gray-200 rounded-xl overflow-hidden">
              <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                <div class="flex justify-between items-center">
                  <h4 class="font-medium text-gray-700">
                    Viimased genereeritud PDF-id
                  </h4>
                  <button @click="clearPdfHistory()"
                    class="group flex items-center space-x-1 text-red-600 hover:text-red-800 text-sm font-medium bg-white/50 hover:bg-white/80 transition-all duration-200 px-3 py-1.5 rounded-lg shadow-sm hover:shadow-md">
                    <i class="fas fa-trash-alt mr-1 group-hover:rotate-12 transition-transform duration-300"></i>
                    <span class="relative">Tühjenda</span>
                  </button>
                </div>
              </div>

              <div class="divide-y divide-gray-200">
                <template x-if="userSettings.generatedPdfs && userSettings.generatedPdfs.length > 0">
                  <template x-for="pdf in userSettings.generatedPdfs" :key="pdf.id">
                    <div class="p-4 hover:bg-gray-50 transition-colors">
                      <div class="flex justify-between items-center">
                        <div>
                          <p class="font-medium text-gray-800" x-text="pdf.name"></p>
                          <p class="text-sm text-gray-500"
                            x-text="'Genereeritud: ' + new Date(pdf.createdAt).toLocaleDateString('et-EE')"></p>
                          <p class="text-sm text-gray-500" x-show="pdf.responsible"
                            x-text="'Vastutav: ' + pdf.responsible"></p>
                          <p class="text-sm text-gray-500" x-show="pdf.submissionDate"
                            x-text="'Esitamise tähtaeg: ' + pdf.submissionDate"></p>
                        </div>
                        <div class="flex space-x-3">
                          <button @click="downloadSavedPdf(pdf.pdfData, pdf.name + '.pdf')"
                            class="flex items-center px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors duration-200 shadow-sm hover:shadow-md">
                            <i class="fas fa-download mr-2"></i>
                            <span>Laadi alla</span>
                          </button>
                          <button @click="previewPdf(pdf)"
                            class="flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200 shadow-sm hover:shadow-md">
                            <i class="fas fa-eye mr-2"></i>
                            <span>Vaata</span>
                          </button>
                          <button @click="sendPdfToOutlook(pdf.pdfData, pdf.name + '.pdf')"
                            class="flex items-center px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors duration-200 shadow-sm hover:shadow-md">
                            <i class="fas fa-envelope mr-2"></i>
                            <span>Saada e-mailiga</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </template>
                </template>
                <template x-if="!userSettings.generatedPdfs || userSettings.generatedPdfs.length === 0">
                  <div class="p-4 text-center text-gray-500">
                    <i class="fas fa-file-pdf text-2xl mb-2"></i>
                    <p>Pole veel genereeritud PDF-e</p>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
</body>



<!-- Tabeli modal -->
<div id="tableModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
    <div class="p-6 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h3 class="text-2xl font-bold text-gray-900">Loo uus tabel</h3>
        <button id="closeTableModal" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
    </div>

    <div class="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
      <div class="space-y-6">
        <!-- Table Title -->
        <div>
          <label for="tableTitle" class="block text-sm font-medium text-gray-700 mb-2">Tabeli pealkiri</label>
          <input type="text" id="tableTitle" placeholder="Maksumuse esildis"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200">
        </div>

        <!-- Table Customization -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Veergude arv</label>
            <input type="number" id="columnCount" min="1" max="10" value="3"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Ridade arv</label>
            <input type="number" id="rowCount" min="1" max="50" value="5"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200">
          </div>
        </div>

        <!-- Table Preview -->
        <div class="mt-6">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-medium text-gray-900">Tabeli eelvaade</h4>
            <div class="flex space-x-2">
              <button id="addColumn"
                class="hidden px-3 py-1 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors">
                <i class="fas fa-plus mr-1"></i> Lisa veerg
              </button>
              <button id="addRow"
                class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors">
                <i class="fas fa-plus mr-1"></i> Lisa rida
              </button>
            </div>
          </div>

          <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table id="dynamicTable" class="min-w-full divide-y divide-gray-200">
              <thead id="tableHead" class="bg-gray-50">
                <tr>
                  <th
                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider group relative">
                    Veerg 1
                  </th>
                  <th
                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider group relative">
                    Veerg 2
                  </th>
                  <th
                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider group relative">
                    Veerg 3
                  </th>
                </tr>
              </thead>
              <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                <!-- Rows will be added here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="p-6 border-t border-gray-200 bg-gray-50">
      <div class="flex items-center justify-between">
        <div class="flex space-x-3">
          <button id="exportExcelBtn"
            class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors">
            <i class="fas fa-file-excel mr-2"></i> Ekspordi Excel
          </button>
          <button id="exportPdfBtn"
            class="hidden px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors">
            <i class="fas fa-file-pdf mr-2"></i> Ekspordi PDF
          </button>
        </div>
        <div class="flex space-x-3">
          <button id="previewBtn"
            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
            <i class="fas fa-eye mr-2"></i> Eelvaade
          </button>
          <button id="saveTableBtn"
            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
            <i class="fas fa-save mr-2"></i> Salvesta
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
    <div class="p-6 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h3 class="text-2xl font-bold text-gray-900">Tabeli eelvaade</h3>
        <button id="closePreviewBtn" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
    </div>
    <div class="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
      <div id="previewContent"></div>
    </div>
  </div>
</div>

<!-- PDF Preview Modal -->
<div id="pdfPreviewModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-50">
  <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-6xl h-[80vh] p-6">
    <div class="bg-white rounded-2xl shadow-2xl p-8 border border-gray-200 h-full flex flex-col">
      <!-- Header -->
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-900" x-text="previewPdfName"></h2>
        <button @click="closePdfPreview" class="text-gray-500 hover:text-red-600 transition p-2">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <!-- PDF Preview -->
      <div class="flex-1 overflow-hidden">
        <iframe :src="previewPdfUrl" class="w-full h-full border-0" title="PDF Preview"></iframe>
      </div>
    </div>
  </div>
</div>

<!-- Add this modal markup near your other modals -->
<div x-show="showNewSectionModal" x-cloak x-transition:enter="transition duration-300 ease-out"
  x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
  x-transition:leave="transition duration-200 ease-in" x-transition:leave-start="opacity-100"
  x-transition:leave-end="opacity-0"
  class="fixed inset-0 z-50 overflow-y-auto bg-black/30 backdrop-blur-sm flex items-center justify-center p-4">

  <div class="relative w-full max-w-md rounded-2xl shadow-2xl border border-white/40 bg-white" @click.stop
    x-transition:enter="transition duration-300 ease-out" x-transition:enter-start="opacity-0 scale-95"
    x-transition:enter-end="opacity-100 scale-100">

    <!-- Header -->
    <div class="flex justify-between items-center p-6 border-b border-gray-100">
      <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-700">
        Lisa uus tingimus
      </h2>
      <button @click="showNewSectionModal = false"
        class="rounded-full p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition-colors">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Content -->
    <div class="p-6">
      <div class="space-y-4">
        <div>
          <label for="sectionTitle" class="block text-sm font-medium text-gray-700 mb-1">
            Tingimuse pealkiri
          </label>
          <div class="relative">
            <input type="text" id="sectionTitle" x-model="newSectionTitle" placeholder="Sisesta pealkiri"
              class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-300"
              @keyup.enter="handleNewSection()" />
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex space-x-3 mt-6">
        <button @click="showNewSectionModal = false"
          class="flex-1 px-4 py-3 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 transition-all duration-300">
          Tühista
        </button>
        <button @click="handleNewSection()"
          class="flex-1 px-4 py-3 bg-gradient-to-r from-indigo-600 to-indigo-800 text-white rounded-xl hover:shadow-lg hover:shadow-indigo-500/30 transform hover:-translate-y-0.5 transition-all duration-300">
          Lisa
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Update your Alpine.js data and methods -->

<!-- Reset Form Confirmation Modal -->
<div x-show="showResetConfirmModal" x-cloak x-transition:enter="transition duration-300 ease-out"
  x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
  x-transition:leave="transition duration-200 ease-in" x-transition:leave-start="opacity-100"
  x-transition:leave-end="opacity-0"
  class="fixed inset-0 z-50 overflow-y-auto bg-black/30 backdrop-blur-sm flex items-center justify-center p-4">

  <div class="relative w-full max-w-md rounded-2xl shadow-2xl border border-white/40 bg-white" @click.stop
    x-transition:enter="transition duration-300 ease-out" x-transition:enter-start="opacity-0 scale-95"
    x-transition:enter-end="opacity-100 scale-100">

    <!-- Header -->
    <div class="flex justify-between items-center p-6 border-b border-gray-100">
      <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-red-600 to-red-800">
        Kinnita kustutamine
      </h2>
      <button @click="showResetConfirmModal = false"
        class="rounded-full p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition-colors">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Content -->
    <div class="p-6">
      <p class="text-gray-700 mb-6">
        Kas oled kindel, et soovid kõik andmed kustutada? Seda tegevust ei saa tagasi võtta.
      </p>

      <!-- Actions -->
      <div class="flex space-x-3">
        <button @click="showResetConfirmModal = false"
          class="flex-1 px-4 py-3 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 transition-all duration-300">
          Tühista
        </button>
        <button @click="handleResetConfirm()"
          class="flex-1 px-4 py-3 bg-gradient-to-r from-red-600 to-red-800 text-white rounded-xl hover:shadow-lg hover:shadow-red-500/30 transform hover:-translate-y-0.5 transition-all duration-300">
          Kustuta
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Excel Export Modal -->
<div id="excelExportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden">
  <div class="fixed inset-0 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
      <h2 class="text-xl font-bold mb-4">Excel Export Options</h2>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">File Name</label>
        <input type="text" id="excelFileName" class="w-full px-3 py-2 border rounded-md" placeholder="Enter file name"
          value="tabel">
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Preview</label>
        <div id="excelPreview" class="border rounded-md p-4 max-h-60 overflow-auto">
          <!-- Preview content will be inserted here -->
        </div>
      </div>

      <div class="flex justify-end space-x-2">
        <button id="cancelExcelExport" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">
          Cancel
        </button>
        <button id="confirmExcelExport" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
          Export
        </button>
      </div>
    </div>
  </div>
</div>

</html>