<!DOCTYPE html>
<html lang="et">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ostumenetluse kutse - Hankest.ee</title>

    <!-- Only include jsPDF -->
    <script src="../assets/js/jspdf.umd.min.js"></script>
    <script>
        // Wait for jsPDF to be fully loaded
        window.addEventListener('DOMContentLoaded', function () {
            // Check if jsPDF is already available
            if (typeof window.jspdf !== 'undefined') {
                console.log('jsPDF loaded successfully');
                return;
            }

            // Try to initialize jsPDF from the UMD bundle
            if (typeof window.jspdf === 'undefined' && typeof window.jsPDF !== 'undefined') {
                window.jspdf = { jsPDF: window.jsPDF };
                console.log('jsPDF initialized from window.jsPDF');
            } else {
                console.error('jsPDF not found. Please check if the script is properly loaded.');
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="../dist/output.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5.0.0/themes.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #6366F1;
            --primary-hover: #4F46E5;
            --success-color: #10B981;
            --error-color: #EF4444;
            --info-color: #3B82F6;
            --card-bg: rgba(255, 255, 255, 0.8);
            --text-color: #1F2937;
            --background-color: transparent;
        }

        body {
            background-image: url('../src/tornid_ja_linnamuur_kaupo_kalda_2016.jpg') !important;
            background-size: cover !important;
            background-position: center !important;
            background-attachment: fixed !important;
            background-repeat: no-repeat !important;
            color: var(--text-color) !important;
            font-family: 'Inter', sans-serif !important;
            min-height: 100vh !important;
            line-height: 1.6 !important;
        }

        .btn {
            @apply rounded-xl font-semibold transition-all duration-300 transform px-5 py-2.5 focus:outline-none focus:ring-2 focus:ring-opacity-50 backdrop-blur-sm shadow-lg hover:scale-105;
        }

        .btn-primary {
            @apply bg-indigo-600/90 hover:bg-indigo-700/90 text-white focus:ring-indigo-500;
        }

        .btn-success {
            @apply bg-emerald-600/90 hover:bg-emerald-700/90 text-white focus:ring-emerald-500;
        }

        .btn-danger {
            @apply bg-red-500/90 hover:bg-red-600/90 text-white focus:ring-red-400;
        }

        .card {
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            padding: 18px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(12px);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .toast-success {
            background-color: var(--success-color);
            @apply shadow-lg rounded-xl shadow-green-500/20;
        }

        .toast-error {
            background-color: var(--error-color);
            @apply shadow-lg rounded-xl shadow-red-500/20;
        }

        .toast-info {
            background-color: var(--info-color);
            @apply shadow-lg rounded-xl shadow-blue-500/20;
        }

        .drag-active {
            border-color: var(--primary-color);
            background-color: #EFF6FF;
        }

        input[type="text"],
        textarea {
            @apply bg-white/80 backdrop-blur-sm rounded-xl border-gray-200 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition-all duration-200 text-black shadow-md !important;
        }

        input[type="checkbox"] {
            @apply w-5 h-5 rounded-md text-indigo-600 focus:ring-indigo-500 transition-all duration-200 cursor-pointer;
        }

        .section-header {
            @apply flex items-center p-4 font-semibold cursor-pointer bg-white/60 hover:bg-white/70 backdrop-blur-sm rounded-xl transition-all duration-200 !important;
        }

        .section-content {
            @apply ml-8 mt-4 space-y-4 p-4 bg-white/30 backdrop-blur-sm rounded-xl !important;
        }

        [x-cloak] {
            display: none !important;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #pdfPreview,
            #pdfPreview * {
                visibility: visible;
            }

            #pdfPreview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }

        #pdfPreview {
            @apply bg-white/50 backdrop-blur-lg rounded-2xl shadow-xl !important;
        }

        #pdfPreview * {
            @apply text-black !important;
        }

        #pdfPreview .bg-indigo-600 {
            @apply bg-gradient-to-r from-indigo-600 to-indigo-800 backdrop-blur-lg text-white p-6 rounded-t-2xl shadow-md !important;
        }

        #pdfPreview h1,
        #pdfPreview h2,
        #pdfPreview h3 {
            @apply text-white !important;
        }

        .highlight-points li {
            @apply text-black font-semibold mb-3 leading-relaxed !important;
        }

        label {
            @apply text-black font-semibold mb-2 block !important;
        }

        nav {
            @apply bg-white/40 backdrop-blur-xl shadow-lg sticky top-0 z-50 border-b border-white/20 !important;
        }

        .nav-link {
            @apply text-black font-medium hover:text-indigo-600 transition-colors duration-200 text-base !important;
        }

        .file-item {
            @apply flex items-center justify-between bg-white/50 p-2 rounded-lg transition-all duration-200 hover:bg-white/70 backdrop-blur-sm border border-white/20;
        }

        .glassmorphism {
            @apply bg-white/70 backdrop-blur-xl border border-white/20 rounded-xl shadow-lg;
        }

        .hover-scale {
            @apply transition-transform duration-300 hover:scale-105;
        }

        .active-section {
            @apply ring-2 ring-indigo-500 ring-opacity-50;
        }

        @media (max-width: 768px) {
            .card {
                @apply p-4;
            }

            .section-content {
                @apply ml-4;
            }
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

        // Make Firestore functions available globally
        window.firestoreFunctions = { doc, getDoc, setDoc };

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCyT8XLIwrmsYgMYalK9I_lp6OfQucBLR0",
            authDomain: "kalkulaator-9f3d1.firebaseapp.com",
            projectId: "kalkulaator-9f3d1",
            storageBucket: "kalkulaator-9f3d1.appspot.com",
            messagingSenderId: "127234313724",
            appId: "1:127234313724:web:1f333fb8f3ff2995bcb679",
            measurementId: "G-91VSY43W50"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Set persistence to LOCAL
        setPersistence(auth, browserLocalPersistence)
            .catch((error) => {
                console.error("Auth persistence error:", error);
            });

        // Make auth and db available globally
        window.auth = auth;
        window.db = db;

        // Make logout function available globally
        window.handleLogout = async () => {
            try {
                // Sign out from Firebase
                await signOut(auth);

                // Clear all authentication related data from localStorage
                localStorage.removeItem('currentUser');
                localStorage.removeItem('rememberedUser');
                localStorage.removeItem('previousPage');

                // Force page reload to reset all state
                window.location.reload();
            } catch (error) {
                console.error('Error signing out:', error);
                // Even if there's an error, try to clear local state and reload
                localStorage.removeItem('currentUser');
                localStorage.removeItem('rememberedUser');
                localStorage.removeItem('previousPage');
                window.location.reload();
            }
        };

        // Check authentication state
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // Check if there's a remembered user in localStorage
                const rememberedUser = localStorage.getItem('rememberedUser');
                if (rememberedUser) {
                    try {
                        const { username, password } = JSON.parse(rememberedUser);
                        await signInWithEmailAndPassword(auth, username, password);
                        return; // The onAuthStateChanged will be triggered again
                    } catch (error) {
                        console.error('Auto-login failed:', error);
                        localStorage.removeItem('rememberedUser');
                    }
                }

                // Show login modal and update state
                const formApp = document.querySelector('[x-data="formApp"]')?.__x;
                if (formApp) {
                    formApp.$data.showLoginModal = true;
                    formApp.$data.currentUser = null;
                    formApp.$data.isAdmin = false;
                    formApp.$data.showUserMenu = false;
                    formApp.$data.showToast('Palun logi sisse', 'info');
                }
            } else {
                // Get user data from Firestore
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                const userData = userDoc.data();

                // Update Alpine.js state
                const formApp = document.querySelector('[x-data="formApp"]')?.__x;
                if (formApp) {
                    formApp.$data.currentUser = {
                        id: user.uid,
                        email: user.email,
                        ...userData
                    };
                    formApp.$data.isAdmin = userData?.isAdmin || false;
                    formApp.$data.showLoginModal = false;
                    formApp.$data.showToast('Edukalt sisse logitud', 'success');
                }

                // Store current user in localStorage
                localStorage.setItem('currentUser', JSON.stringify({
                    id: user.uid,
                    email: user.email,
                    isAdmin: userData?.isAdmin || false
                }));
            }
        });

        // Make login function available globally
        window.handleLogin = async (email, password) => {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Get or create user document in Firestore
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (!userDoc.exists()) {
                    // Create new user document
                    await setDoc(doc(db, 'users', user.uid), {
                        email: user.email,
                        isAdmin: user.email.endsWith('@hankest.ee'),
                        createdAt: new Date().toISOString(),
                        lastLogin: new Date().toISOString()
                    });
                } else {
                    // Update last login
                    await setDoc(doc(db, 'users', user.uid), {
                        lastLogin: new Date().toISOString()
                    }, { merge: true });
                }

                // Store user in localStorage
                localStorage.setItem('currentUser', JSON.stringify({
                    id: user.uid,
                    email: user.email,
                    isAdmin: user.email.endsWith('@hankest.ee')
                }));

                return user;
            } catch (error) {
                console.error('Login error:', error);
                throw error;
            }
        };
    </script>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('formApp', () => {
                const standardFields = [
                    { key: 'buyer', label: 'Hankija', placeholder: 'Nimi, aadress, registrikood' },
                    { key: 'submission', label: 'Pakkumise esitamise aeg ja koht', placeholder: 'nt 10. aprill, e-post' },
                    { key: 'validity', label: 'Pakkumuse jõusoleku aeg', placeholder: 'nt 30 päeva' },
                    { key: 'requirements', label: 'Nõuded pakkujale', placeholder: 'nt kogemus 3 aastat' },
                    { key: 'criteria', label: 'Väljavaliku alused', placeholder: 'Majanduslikult soodsaim' },
                    { key: 'responsible', label: 'Vastutav isik', placeholder: 'Nimi' }
                ];

                const defaultFields = {};
                standardFields.forEach(field => {
                    defaultFields[field.key] = '';
                });

                return {
                    standardFields,
                    form: {
                        name: '',
                        intro: 'Lisa hankija nimi teeb Teile ettepaneku esitada pakkumus "Lisa ostetav ese/teenus" ostumenetluse kutses sätestatud tingimustele. Ostumenetluse eesmärk on... ',
                        fields: { ...defaultFields },
                        sections: [
                            {
                                title: '1 Üldised tingimused',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Ettevõtjatel on õigus küsida kutse kohta selgitusi, esitades küsimused e-posti teel ostumenetluse eest vastutavale isikule. Hankija vastab ettevõtja küsimustele kolme tööpäeva jooksul. Hankija edastab esitatud küsimused ja antud vastused samaaegselt kõigile ettevõtjatele, kellele tehti ettepanek pakkumuse esitamiseks. Telefoni teel esitatud küsimustele ei vastata.', checked: false },
                                    { text: 'Hankijal on õigus enne pakkumuste esitamise tähtaega muuta vajadusel kutset. Kutse muutmisel teavitab hankija sellest kõiki ettevõtjaid, kellele on tehtud ettepanek pakkumuste esitamiseks ja edastab ettevõtjatele muudetud kutse. Hankija võib pikendada pakkumuste esitamise tähtaega.', checked: false },
                                    { text: 'Iga viidet, mille hankija teeb kutses mõnele standardile, tehnilisele tunnusele, kontrollsüsteemile, ostuallikale, protsessile, kaubamärgile, patendile, tüübile, päritolule või tootmisviisile, tuleb lugeda selliselt, et see on täiendatud märkega „või sellega samaväärne".', checked: false },
                                    { text: 'Hankija ei sõlmi hankelepingut pakkujaga, kellel on maksuvõlg (kohalikud maksud Tallinna linnale ja riiklik maksuvõlg)...', checked: false },
                                    { text: 'Hankija jätab endale õiguse tellida teenust lähtudes oma eelarvelistest vahenditest. Teenuse hankija ei hüvita pakkujale teenuse tellimata jätmise eest tekkinud kahju.', checked: false },
                                    { text: 'Arve maksetähtaeg peab olema vähemalt 21 päeva.', checked: true }
                                ]
                            },
                            {
                                title: '2 Ostumenetluse tehniline kirjeldus',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: '"Hankija lisab siia tehnilise kirjelduse" - Lisada kas viide eraldi failile kui TK on eraldi või kopeerida siia lihtsalt tehniline kirjeldus teenuse/asja kohta, mida soovitakse osta.', checked: false, editable: true }
                                ]
                            },
                            {
                                title: '3 Nõuded pakkumusele',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Pakkumus on pakkuja tahteavaldus tellimuse täitmiseks ja on selle esitamisel pakkujale siduv alates esitamisest kuni pakkumuse jõusoleku minimaalse tähtaja lõpuni. Hankijal on õigus teha ettepanek pakkumuse jõusoleku tähtaja pikendamiseks. Tingimusliku pakkumuse esitamine on keelatud.', checked: false },
                                    { text: 'Hilinenud pakkumusi hankija vastu ei võta.', checked: false },
                                    { text: 'Pakkumus peab sisaldama: Pakkumuse maksumust vastavalt lisale 1;', checked: false },
                                    { text: 'Pakkumus peab sisaldama: Pakkumuse kirjeldust, mis võimaldab hankijal kontrollida kutse punktis 2 sätestatud tingimustele vastavust.', checked: false },
                                    { text: 'Pakkuja kannab kõik pakkumuse ettevalmistamise ja esitamisega seotud kulud ning pakkumuse tähtaegse esitamise riski.', checked: false },
                                    { text: 'Pakkumus on konfidentsiaalne kuni tellimuse tegemiseni.', checked: false },
                                    { text: 'Pakkuja märgib pakkumuses, milline teave pakkumusest on ärisaladus ning põhjendab ärisaladuseks määramist... Hankija ei avalikusta pakkumuse sisu ärisaladusega kaetud osas.', checked: false }
                                ]
                            },
                            {
                                title: '4 Pakkumuste kontrollimine, hindamine ja eduka pakkumuse valik',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Hankija kontrollib tähtaegselt esitatud pakkumuste vastavust kutses esitatud tingimustele...', checked: false },
                                    { text: 'Hankijal on õigus küsida pakkujalt esitatud pakkumuse kohta täpsustavaid andmeid ja täpsustavaid selgitusi.', checked: false },
                                    { text: 'Kutses esitatud tingimustele vastavate pakkumuste seast valib hankija eduka pakkumuse välja madalaima hinna alusel...', checked: false },
                                    { text: 'Kui edukas pakkuja võtab hankijast mitteolenevatel põhjustel oma pakkumuse tagasi...', checked: false },
                                    { text: 'Hankija ei ole kohustatud korra punktis 4.5 nimetatud alusel pakkumusi uuesti hindama...', checked: false }
                                ]
                            },
                            {
                                title: '5 Läbirääkimiste pidamine',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Hankijal on õigus pidada läbirääkimisi esitatud pakkumuse sisu ja maksumuse ning tellimuse tingimuste üle.', checked: false },
                                    { text: 'Hankijal on õigus loobuda ühest või mitmest pakkumuses kirjeldatud teenusest, tööst või asjast või vähendada nende mahtusid või koguseid...', checked: false },
                                    { text: 'Vastavalt läbirääkimiste pidamise vajadusele teatab hankija pakkujatele läbirääkimiste aja... Läbirääkimised on konfidentsiaalsed.', checked: false },
                                    { text: 'Pärast läbirääkimiste toimumist esitab pakkuja vajadusel uue kohandatud pakkumuse...', checked: false }
                                ]
                            },
                            {
                                title: '6 Pakkumuste tagasi lükkamine ja ostumenetluse kehtetuks tunnistamine',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Hankijal on õigus kõik esitatud või kutses toodud tingimustele vastavad pakkumused tagasi lükata...', checked: false },
                                    { text: 'Kui hankijal on tekkinud vajadus pärast pakkumuste esitamise tähtpäeva kutses esitatud tingimusi olulisel määral muuta...', checked: false },
                                    { text: 'Hankija võib ostumenetluse kehtetuks tunnistada, kui peale pakkumuste esitamise tähtpäeva selgub, et hankija on teinud vea...', checked: false }
                                ]
                            },
                            {
                                title: '7 Lisad',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Lisa 1. ', checked: false, editable: true }
                                ]
                            }
                        ]
                    },
                    today: new Date().toLocaleDateString('et-EE'),
                    toasts: [],
                    files: [],
                    isDragging: false,
                    isGeneratingPDF: false,
                    saveTimeout: null,
                    isLoading: false,
                    errorMessage: '',
                    showError: false,
                    isDarkMode: false,
                    currentUser: null,
                    isAdmin: false,
                    showUserMenu: false,
                    showLoginModal: false,
                    showSettingsModal: false,
                    userSettings: {
                        buyer: '',
                        submission: '',
                        validity: '',
                        requirements: '',
                        criteria: '',
                        responsible: '',
                        autofillEnabled: false,
                        // Design settings
                        theme: 'indigo', // Default theme color
                        font: 'Inter', // Default font
                        buttonStyle: 'rounded', // Default button style
                        // History settings
                        generatedPdfs: []
                    },

                    async login() {
                        const email = document.getElementById('emailLogin').value;
                        const password = document.getElementById('passwordLogin').value;
                        const rememberMe = document.getElementById('rememberMe').checked;

                        try {
                            await window.handleLogin(email, password);

                            // Handle remember me
                            if (rememberMe) {
                                localStorage.setItem('rememberedUser', JSON.stringify({
                                    username: email,
                                    password: password
                                }));
                            } else {
                                localStorage.removeItem('rememberedUser');
                            }

                            this.showToast('Sisselogimine õnnestus', 'success');
                            this.showLoginModal = false;
                            // Force Alpine.js to update the state
                            this.$nextTick(() => {
                                this.currentUser = window.auth.currentUser ? {
                                    id: window.auth.currentUser.uid,
                                    email: window.auth.currentUser.email,
                                    isAdmin: window.auth.currentUser.email.endsWith('@hankest.ee')
                                } : null;
                                this.isAdmin = this.currentUser?.isAdmin || false;
                            });
                        } catch (error) {
                            this.showToast(this.getErrorMessage(error.code), 'error');
                        }
                    },

                    getErrorMessage(errorCode) {
                        const errorMessages = {
                            'auth/invalid-email': 'Vigane e-posti aadress',
                            'auth/user-disabled': 'Kasutaja on deaktiveeritud',
                            'auth/user-not-found': 'Kasutajat ei leitud',
                            'auth/wrong-password': 'Vale parool',
                            'auth/too-many-requests': 'Liiga palju katsetusi. Palun proovige hiljem uuesti',
                            'auth/network-request-failed': 'Võrgu viga. Palun kontrollige oma internetiühendust'
                        };
                        return errorMessages[errorCode] || 'Sisselogimisel tekkis viga';
                    },

                    checkLocalStorage() {
                        try {
                            // Test if localStorage is available
                            if (typeof localStorage === 'undefined') {
                                this.showToast('localStorage ei ole saadaval', 'error');
                                return false;
                            }

                            // Test writing and reading
                            localStorage.setItem('test', 'test');
                            if (localStorage.getItem('test') !== 'test') {
                                this.showToast('localStorage ei tööta korralikult', 'error');
                                return false;
                            }
                            localStorage.removeItem('test');

                            // Check available space (estimate)
                            let totalSize = 0;
                            for (let key in localStorage) {
                                if (localStorage.hasOwnProperty(key)) {
                                    totalSize += (localStorage[key].length || 0) * 2; // UTF-16 characters = 2 bytes
                                }
                            }

                            const availableSpace = 5 * 1024 * 1024 - totalSize; // 5MB is a common limit
                            if (availableSpace < 500000) { // If less than 500KB available
                                this.showToast('Hoiatus: localStorage on peaaegu täis', 'info');
                            }

                            return true;
                        } catch (error) {
                            console.error('localStorage check failed:', error);
                            this.showToast('Viga localStorage kontrollimisel: ' + error.message, 'error');
                            return false;
                        }
                    },

                    init() {
                        // Check localStorage availability
                        this.checkLocalStorage();

                        // Check for remembered user
                        const rememberedUser = localStorage.getItem('rememberedUser');
                        if (rememberedUser) {
                            const { username } = JSON.parse(rememberedUser);
                            document.getElementById('emailLogin').value = username;
                            document.getElementById('rememberMe').checked = true;
                        }

                        // Check for current user
                        const currentUser = localStorage.getItem('currentUser');
                        if (currentUser) {
                            const userData = JSON.parse(currentUser);
                            this.currentUser = userData;
                            this.isAdmin = userData.isAdmin;
                            this.showLoginModal = false;
                        }

                        // Initialize Sortable for the sections
                        this.$nextTick(() => {
                            if (this.$refs.draggableSections) {
                                new Sortable(this.$refs.draggableSections, {
                                    animation: 150,
                                    handle: '.drag-handle',
                                    onEnd: (evt) => {
                                        const newOrder = Array.from(evt.from.children).map(child => {
                                            return child.__x.$data.section;
                                        });
                                        this.form.sections = newOrder;
                                        // Save changes after reordering
                                        this.saveToStorage();
                                    }
                                });
                            }
                        });

                        // Load data from storage initially
                        this.loadFromStorage();

                        // Set up manual watcher for form changes instead of using Alpine.effect
                        this.setupFormWatcher();

                        // Veateadete automaatne peitmine
                        setInterval(() => {
                            if (this.showError) {
                                this.showError = false;
                            }
                        }, 5000);

                        this.loadUserSettings();
                    },

                    setupFormWatcher() {
                        // Watch for changes to form inputs
                        document.addEventListener('input', (e) => {
                            if (e.target.hasAttribute('x-model') ||
                                e.target.closest('[x-model]') ||
                                e.target.closest('[x-data]')) {
                                this.debouncedSave();
                            }
                        });

                        // Also watch for checkbox changes
                        document.addEventListener('change', (e) => {
                            if (e.target.type === 'checkbox') {
                                this.debouncedSave();
                            }
                        });
                    },

                    get visibleSections() {
                        return this.form.sections.filter(s => s.enabled && s.options.some(o => o.checked));
                    },

                    validateForm() {
                        if (!this.form.name?.trim()) {
                            this.showToast('Palun sisesta ostumenetluse nimi', 'error');
                            return false;
                        }
                        if (!this.form.fields?.buyer?.trim()) {
                            this.showToast('Palun täida hankija andmed', 'error');
                            return false;
                        }
                        return true;
                    },

                    async generatePDF() {
                        if (!this.validateForm()) return;

                        try {
                            this.isGeneratingPDF = true;
                            this.isLoading = true;

                            // Check if jsPDF is properly loaded
                            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                                if (typeof window.jsPDF !== 'undefined') {
                                    window.jspdf = { jsPDF: window.jsPDF };
                                } else {
                                    throw new Error('jsPDF not properly loaded');
                                }
                            }

                            const { jsPDF } = window.jspdf;
                            const doc = new jsPDF('p', 'mm', 'a4');

                            // Add header with logo and title
                            doc.setFillColor(79, 70, 229); // Indigo color
                            doc.rect(0, 0, 210, 30, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(24);
                            doc.setFont(undefined, 'bold');
                            doc.text(this.form.name || 'Ostumenetluse kutse', 105, 20, { align: 'center' });

                            // Add intro text with modern styling
                            doc.setFontSize(11);
                            doc.setTextColor(0, 0, 0);
                            let yPos = 40;
                            const introLines = doc.splitTextToSize(this.form.intro, 170);
                            doc.text(introLines, 20, yPos);
                            yPos += (introLines.length * 6) + 10;

                            // Add standard fields with modern styling
                            doc.setFontSize(11);
                            this.standardFields.forEach(field => {
                                const fieldValue = this.form.fields[field.key] || '';
                                if (fieldValue.trim() !== '') {
                                    // Add field label with background
                                    doc.setFillColor(243, 244, 246); // Light gray background
                                    doc.rect(20, yPos - 2, 170, 6, 'F');

                                    doc.setFont(undefined, 'bold');
                                    doc.setTextColor(79, 70, 229); // Indigo color for labels
                                    doc.text(`${field.label}: `, 22, yPos);
                                    const textWidth = doc.getTextWidth(`${field.label}: `);

                                    doc.setFont(undefined, 'normal');
                                    doc.setTextColor(0, 0, 0);
                                    const valueLines = doc.splitTextToSize(fieldValue, 150);
                                    doc.text(valueLines, 22 + textWidth, yPos);

                                    yPos += (valueLines.length * 6) + 4;
                                }
                            });

                            // Add sections with modern styling
                            let sectionNumber = 1;
                            this.visibleSections.forEach((section) => {
                                yPos += 5;

                                // Section title with modern styling
                                doc.setFontSize(14);
                                doc.setFont(undefined, 'bold');
                                doc.setTextColor(79, 70, 229); // Indigo color for section titles
                                const originalTitle = section.title;
                                const newTitle = `${sectionNumber} ${originalTitle.split(' ').slice(1).join(' ')}`;

                                // Add underline for section title
                                doc.text(newTitle, 20, yPos);
                                doc.setLineWidth(0.5);
                                doc.line(20, yPos + 1, 190, yPos + 1);

                                yPos += 10;

                                // Section options with modern styling
                                doc.setFontSize(11);
                                doc.setFont(undefined, 'normal');
                                doc.setTextColor(0, 0, 0);

                                section.options.filter(o => o.checked).forEach((opt, i) => {
                                    const optionText = `${sectionNumber}.${i + 1} ${opt.text}`;
                                    const optLines = doc.splitTextToSize(optionText, 160);

                                    // Add bullet point with custom styling
                                    doc.setFillColor(79, 70, 229);
                                    doc.circle(22, yPos + 2, 1.5, 'F');
                                    doc.text(optLines, 25, yPos);

                                    // Calculate total height needed for this option
                                    const optionHeight = optLines.length * 5; // Reduced from 6 to 5
                                    yPos += optionHeight + 2; // Reduced spacing from 5 to 2

                                    // Check if we need a new page
                                    if (yPos > 270) {
                                        doc.addPage();
                                        yPos = 20;
                                    }
                                });

                                sectionNumber++;
                            });

                            // Add footer with modern styling
                            yPos = Math.min(yPos + 10, 270); // Reduced from 15 to 10
                            doc.setLineWidth(0.5);
                            doc.line(20, yPos, 190, yPos);
                            yPos += 10;

                            doc.setFontSize(10);
                            doc.setFont(undefined, 'bold');
                            doc.setTextColor(79, 70, 229);
                            doc.text(`Kuupäev: ${this.today}`, 20, yPos);
                            yPos += 6;
                            doc.text(`Vastutav isik: ${this.form.fields.responsible || ''}`, 20, yPos);

                            // Add attachments with modern styling
                            if (this.files?.length > 0) {
                                yPos += 10;
                                doc.setFontSize(12);
                                doc.setFont(undefined, 'bold');
                                doc.setTextColor(79, 70, 229);
                                doc.text('Manused:', 20, yPos);
                                yPos += 5;

                                doc.setFontSize(10);
                                doc.setFont(undefined, 'normal');
                                doc.setTextColor(0, 0, 0);
                                this.files.forEach((file, i) => {
                                    // Add file icon
                                    doc.setFillColor(79, 70, 229);
                                    doc.rect(22, yPos - 1, 1.5, 1.5, 'F');
                                    doc.text(`${i + 1}. ${file.name} (${this.formatFileSize(file.size)}) ${file.comment || ''}`, 25, yPos);
                                    yPos += 6;
                                });
                            }

                            // Save the PDF
                            const pdfName = `${this.form.name || 'ostumenetlus'}.pdf`;
                            doc.save(pdfName);

                            // Track PDF generation in dashboard stats
                            const recentPdfs = JSON.parse(localStorage.getItem('recentPdfs')) || [];
                            recentPdfs.unshift({
                                id: Date.now(),
                                name: this.form.name || 'Ostumenetlus',
                                responsible: this.form.fields.responsible || '',
                                submissionDate: this.form.fields.submission || '',
                                createdAt: this.today,
                                createdBy: this.currentUser.username,
                                role: this.currentUser.role
                            });

                            // Keep only last 50 PDFs
                            if (recentPdfs.length > 50) {
                                recentPdfs.pop();
                            }

                            localStorage.setItem('recentPdfs', JSON.stringify(recentPdfs));

                            this.showToast('PDF edukalt loodud', 'success');
                        } catch (error) {
                            this.showToast('PDF loomisel tekkis viga: ' + error.message, 'error');
                        } finally {
                            this.isGeneratingPDF = false;
                            this.isLoading = false;
                        }
                    },

                    saveToStorage() {
                        try {
                            // Create a deep clone of the form data to avoid reference issues
                            const formToSave = JSON.parse(JSON.stringify(this.form));

                            const payload = {
                                form: formToSave,
                                timestamp: Date.now(),
                                version: '1.4',
                                lastModified: new Date().toISOString(),
                                files: this.files.length > 0 ? this.files : []
                            };

                            // Save to localStorage
                            localStorage.setItem('OM_DRAFT', JSON.stringify(payload));
                            console.log('Form data saved successfully:', formToSave);
                            this.showToast('Salvestatud!', 'success');
                            return true;
                        } catch (error) {
                            console.error('Failed to save to storage:', error);
                            this.showToast('Salvestamine ebaõnnestus: ' + error.message, 'error');
                            return false;
                        }
                    },

                    loadFromStorage() {
                        try {
                            const raw = localStorage.getItem('OM_DRAFT');
                            if (!raw) {
                                console.log('No saved data found in localStorage');
                                return false;
                            }

                            const data = JSON.parse(raw);
                            if (data.version === '1.4' && data.form) {
                                console.log('Loading saved form data:', data.form);

                                // Create a fresh default form
                                const freshDefaultFields = {};
                                this.standardFields.forEach(field => {
                                    freshDefaultFields[field.key] = '';
                                });

                                // Apply saved data to the form
                                this.form = {
                                    name: data.form.name || '',
                                    intro: data.form.intro || 'Lisa hankija nimi teeb Teile ettepaneku esitada pakkumus "Lisa ostetav ese/teenus" ostumenetluse kutses sätestatud tingimustele. Ostumenetluse eesmärk on... ',
                                    fields: {
                                        ...freshDefaultFields,
                                        ...(data.form.fields || {})
                                    },
                                    sections: data.form.sections || this.form.sections
                                };

                                // Load files if present
                                if (data.files && Array.isArray(data.files) && data.files.length > 0) {
                                    this.files = data.files;
                                }

                                this.showToast('Laaditud salvestatud andmed', 'success');
                                return true;
                            } else {
                                console.warn('Incompatible data version or missing form data');
                                localStorage.removeItem('OM_DRAFT');
                                this.showToast('Vana versiooni andmed, algandmed laetud', 'info');
                                return false;
                            }
                        } catch (error) {
                            console.error('Failed to load from storage:', error, error.stack);
                            localStorage.removeItem('OM_DRAFT');
                            this.showToast('Viga andmete laadimisel: ' + error.message, 'error');
                            return false;
                        }
                    },

                    manualSave() {
                        // This is called directly from the save button click
                        clearTimeout(this.saveTimeout); // Clear any pending save
                        const success = this.saveToStorage();
                        if (success) {
                            this.showToast('Andmed edukalt salvestatud!', 'success');
                        }
                    },

                    addAttachment() {
                        const lisaCount = this.form.sections[6].options.length + 1;
                        this.form.sections[6].options.push({
                            text: `Lisa ${lisaCount}. `,
                            checked: false,
                            editable: true
                        });
                        this.showToast('Lisa lisatud', 'success');
                    },

                    addNewSection() {
                        const nextNum = this.form.sections.length + 1;
                        const title = prompt(`Lisa punktile pealkiri (${nextNum}):`);

                        if (title) {
                            this.form.sections.push({
                                title: `${nextNum} ${title}`,
                                enabled: false,
                                open: true,
                                options: [{ text: 'Lisa tingimus', checked: false, editable: true, isEditing: true }]
                            });
                            this.showToast('Uus sektsioon lisatud', 'success');
                        }
                    },

                    toggleAllSections() {
                        const hasClosedSections = this.form.sections.some(section => !section.open);
                        this.form.sections.forEach(section => {
                            section.open = hasClosedSections;
                        });
                        this.showToast(hasClosedSections ? 'Kõik sektsioonid avatud' : 'Kõik sektsioonid suletud', 'success');
                    },

                    selectAllOptions() {
                        const hasUncheckedOptions = this.form.sections.some(section =>
                            section.options.some(option => !option.checked)
                        );

                        this.form.sections.forEach(section => {
                            section.enabled = true;
                            section.options.forEach(option => {
                                option.checked = hasUncheckedOptions;
                            });
                        });
                        this.showToast(hasUncheckedOptions ? 'Kõik valikud valitud' : 'Kõik valikud eemaldatud', 'success');
                    },

                    showToast(message, type = 'info', duration = 3000) {
                        const toast = {
                            id: Date.now(),
                            message,
                            type,
                            duration
                        };
                        this.toasts.push(toast);
                        setTimeout(() => {
                            this.toasts = this.toasts.filter(t => t.id !== toast.id);
                        }, duration);
                    },

                    handleDragOver(e) {
                        e.preventDefault();
                        this.isDragging = true;
                    },

                    handleDragLeave() {
                        this.isDragging = false;
                    },

                    handleDrop(e) {
                        e.preventDefault();
                        this.isDragging = false;
                        const files = Array.from(e.dataTransfer.files);
                        this.processFiles(files);
                    },

                    handleFileInput(e) {
                        const files = Array.from(e.target.files);
                        this.processFiles(files);
                        e.target.value = ''; // Reset input
                    },

                    processFiles(files) {
                        const maxFileSize = 10 * 1024 * 1024; // 10MB
                        const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/gif'];

                        Array.from(files).forEach(file => {
                            if (file.size > maxFileSize) {
                                this.showToast(`Fail ${file.name} on liiga suur. Maksimaalne suurus on 10MB.`, 'error');
                                return;
                            }

                            if (!allowedTypes.includes(file.type)) {
                                this.showToast(`Fail ${file.name} on sobimatu tüüp. Lubatud on PDF ja pildifailid.`, 'error');
                                return;
                            }

                            const reader = new FileReader();
                            reader.onload = (e) => {
                                this.files.push({
                                    name: file.name,
                                    size: file.size,
                                    type: file.type,
                                    data: e.target.result,
                                    comment: ''
                                });
                                this.showToast('Fail lisatud', 'success');
                            };
                            reader.onerror = () => {
                                this.showToast(`Faili ${file.name} lugemisel tekkis viga`, 'error');
                            };
                            reader.readAsDataURL(file);
                        });
                    },

                    removeFile(index) {
                        const fileName = this.files[index].name;
                        this.files.splice(index, 1);
                        this.showToast(`Fail ${fileName} eemaldatud`, 'info');
                    },

                    formatFileSize(bytes) {
                        if (bytes === 0) return '0 Bytes';
                        const k = 1024;
                        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                        const i = Math.floor(Math.log(bytes) / Math.log(k));
                        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                    },

                    resetForm() {
                        if (confirm('Kas oled kindel, et soovid kõik andmed kustutada? Seda tegevust ei saa tagasi võtta.')) {
                            // Reset to default form structure
                            this.form = {
                                name: '',
                                intro: 'Lisa hankija nimi teeb Teile ettepaneku esitada pakkumus "Lisa ostetav ese/teenus" ostumenetluse kutses sätestatud tingimustele. Ostumenetluse eesmärk on... ',
                                fields: { ...defaultFields },
                                sections: [
                                    {
                                        title: '1 Üldised tingimused',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: '111Ettevõtjatel on õigus küsida kutse kohta selgitusi, esitades küsimused e-posti teel ostumenetluse eest vastutavale isikule. Hankija vastab ettevõtja küsimustele kolme tööpäeva jooksul. Hankija edastab esitatud küsimused ja antud vastused samaaegselt kõigile ettevõtjatele, kellele tehti ettepanek pakkumuse esitamiseks. Telefoni teel esitatud küsimustele ei vastata.', checked: false },
                                            { text: 'Hankijal on õigus enne pakkumuste esitamise tähtaega muuta vajadusel kutset. Kutse muutmisel teavitab hankija sellest kõiki ettevõtjaid, kellele on tehtud ettepanek pakkumuste esitamiseks ja edastab ettevõtjatele muudetud kutse. Hankija võib pikendada pakkumuste esitamise tähtaega.', checked: false },
                                            { text: 'Iga viidet, mille hankija teeb kutses mõnele standardile, tehnilisele tunnusele, kontrollsüsteemile, ostuallikale, protsessile, kaubamärgile, patendile, tüübile, päritolule või tootmisviisile, tuleb lugeda selliselt, et see on täiendatud märkega „või sellega samaväärne".', checked: false },
                                            { text: 'Hankija ei sõlmi hankelepingut pakkujaga, kellel on maksuvõlg (kohalikud maksud Tallinna linnale ja riiklik maksuvõlg)...', checked: false },
                                            { text: 'Hankija jätab endale õiguse tellida teenust lähtudes oma eelarvelistest vahenditest. Teenuse hankija ei hüvita pakkujale teenuse tellimata jätmise eest tekkinud kahju.', checked: false },

                                        ]
                                    },
                                    {
                                        title: '2 Ostumenetluse tehniline kirjeldus',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: '"Hankija lisab siia tehnilise kirjelduse" - Lisada kas viide eraldi failile kui TK on eraldi või kopeerida siia lihtsalt tehniline kirjeldus teenuse/asja kohta, mida soovitakse osta.', checked: false, editable: true }
                                        ]
                                    },
                                    {
                                        title: '3 Nõuded pakkumusele',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: 'Pakkumus on pakkuja tahteavaldus tellimuse täitmiseks ja on selle esitamisel pakkujale siduv alates esitamisest kuni pakkumuse jõusoleku minimaalse tähtaja lõpuni. Hankijal on õigus teha ettepanek pakkumuse jõusoleku tähtaja pikendamiseks. Tingimusliku pakkumuse esitamine on keelatud.', checked: false },
                                            { text: 'Hilinenud pakkumusi hankija vastu ei võta.', checked: false },
                                            { text: 'Pakkumus peab sisaldama: Pakkumuse maksumust vastavalt lisale 1;', checked: false },
                                            { text: 'Pakkumus peab sisaldama: Pakkumuse kirjeldust, mis võimaldab hankijal kontrollida kutse punktis 2 sätestatud tingimustele vastavust.', checked: false },
                                            { text: 'Pakkuja kannab kõik pakkumuse ettevalmistamise ja esitamisega seotud kulud ning pakkumuse tähtaegse esitamise riski.', checked: false },
                                            { text: 'Pakkumus on konfidentsiaalne kuni tellimuse tegemiseni.', checked: false },
                                            { text: 'Pakkuja märgib pakkumuses, milline teave pakkumusest on ärisaladus ning põhjendab ärisaladuseks määramist... Hankija ei avalikusta pakkumuse sisu ärisaladusega kaetud osas.', checked: false }
                                        ]
                                    },
                                    {
                                        title: '4 Pakkumuste kontrollimine, hindamine ja eduka pakkumuse valik',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: 'Hankija kontrollib tähtaegselt esitatud pakkumuste vastavust kutses esitatud tingimustele...', checked: false },
                                            { text: 'Hankijal on õigus küsida pakkujalt esitatud pakkumuse kohta täpsustavaid andmeid ja täpsustavaid selgitusi.', checked: false },
                                            { text: 'Kutses esitatud tingimustele vastavate pakkumuste seast valib hankija eduka pakkumuse välja madalaima hinna alusel...', checked: false },
                                            { text: 'Kui edukas pakkuja võtab hankijast mitteolenevatel põhjustel oma pakkumuse tagasi...', checked: false },
                                            { text: 'Hankija ei ole kohustatud korra punktis 4.5 nimetatud alusel pakkumusi uuesti hindama...', checked: false }
                                        ]
                                    },
                                    {
                                        title: '5 Läbirääkimiste pidamine',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: 'Hankijal on õigus pidada läbirääkimisi esitatud pakkumuse sisu ja maksumuse ning tellimuse tingimuste üle.', checked: false },
                                            { text: 'Hankijal on õigus loobuda ühest või mitmest pakkumuses kirjeldatud teenusest, tööst või asjast või vähendada nende mahtusid või koguseid...', checked: false },
                                            { text: 'Vastavalt läbirääkimiste pidamise vajadusele teatab hankija pakkujatele läbirääkimiste aja... Läbirääkimised on konfidentsiaalsed.', checked: false },
                                            { text: 'Pärast läbirääkimiste toimumist esitab pakkuja vajadusel uue kohandatud pakkumuse...', checked: false }
                                        ]
                                    },
                                    {
                                        title: '6 Pakkumuste tagasi lükkamine ja ostumenetluse kehtetuks tunnistamine',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: 'Hankijal on õigus kõik esitatud või kutses toodud tingimustele vastavad pakkumused tagasi lükata...', checked: false },
                                            { text: 'Kui hankijal on tekkinud vajadus pärast pakkumuste esitamise tähtpäeva kutses esitatud tingimusi olulisel määral muuta...', checked: false },
                                            { text: 'Hankija võib ostumenetluse kehtetuks tunnistada, kui peale pakkumuste esitamise tähtpäeva selgub, et hankija on teinud vea...', checked: false }
                                        ]
                                    },
                                    {
                                        title: '7 Lisad',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: 'Lisa 1. ', checked: false, editable: true }
                                        ]
                                    }
                                ]
                            };

                            // Clear files
                            this.files = [];

                            // Remove from local storage
                            localStorage.removeItem('OM_DRAFT');

                            // Show success message
                            this.showToast('Vorm on tühjendatud', 'info');
                        }
                    },

                    removeSection(index) {
                        if (confirm('Kas olete kindel, et soovite selle sektsiooni kustutada?')) {
                            this.form.sections.splice(index, 1);
                            this.showToast('Sektsioon kustutatud', 'success');
                        }
                    },

                    debouncedSave() {
                        clearTimeout(this.saveTimeout);
                        this.saveTimeout = setTimeout(() => {
                            this.saveToStorage();
                        }, 2000);
                    },

                    addOption(sectionIndex) {
                        const section = this.form.sections[sectionIndex];
                        const optionCount = section.options.length + 1;

                        let newOption;
                        if (sectionIndex === 6) { // Lisad section
                            newOption = {
                                text: `Lisa ${optionCount}. `,
                                checked: false,
                                editable: true,
                                isEditing: true
                            };
                        } else if (sectionIndex === 0) { // Üldised tingimused section
                            newOption = {
                                text: `${optionCount}. `,
                                checked: false,
                                checked: true,
                                editable: true,
                                isEditing: true
                            };
                        } else { // Other sections
                            newOption = {
                                text: `${optionCount}. `,
                                checked: false,
                                editable: true,
                                isEditing: true
                            };
                        }

                        section.options.push(newOption);
                        this.showToast('Punkt lisatud', 'success');
                    },

                    toggleUserMenu() {
                        if (this.currentUser) {
                            this.showUserMenu = !this.showUserMenu;
                        }
                    },

                    logout() {
                        window.handleLogout();
                    },

                    async saveUserSettings() {
                        try {
                            // Apply theme changes immediately
                            this.applyTheme();

                            // Try to save to Firestore if logged in
                            if (window.auth?.currentUser) {
                                const { doc, setDoc } = window.firestoreFunctions;
                                const userRef = doc(window.db, "users", window.auth.currentUser.uid);
                                await setDoc(userRef, {
                                    settings: this.userSettings
                                }, { merge: true });
                            } else {
                                // Fallback: Save to localStorage if not logged in
                                localStorage.setItem('userSettings', JSON.stringify(this.userSettings));
                                console.log('Settings saved to localStorage since user is not logged in');
                            }

                            // If autofill is enabled, update the form fields
                            if (this.userSettings.autofillEnabled) {
                                this.form.fields = {
                                    ...this.form.fields,
                                    buyer: this.userSettings.buyer,
                                    submission: this.userSettings.submission,
                                    validity: this.userSettings.validity,
                                    requirements: this.userSettings.requirements,
                                    criteria: this.userSettings.criteria,
                                    responsible: this.userSettings.responsible
                                };
                            }

                            this.showSettingsModal = false;
                            this.showToast('Seaded salvestatud!', 'success');
                        } catch (error) {
                            console.error('Settings save error:', error);
                            this.showToast('Viga seadete salvestamisel: ' + error.message, 'error');
                        }
                    },

                    applyTheme() {
                        // Apply current theme settings to the UI
                        const html = document.documentElement;

                        // Apply font setting
                        if (this.userSettings.font) {
                            html.style.fontFamily = this.userSettings.font;
                        }

                        // Apply button style
                        // This would normally be implemented with CSS classes or custom properties

                        // You could also change gradient colors based on theme
                        const gradientElements = document.querySelectorAll('.bg-gradient-to-r');
                        const theme = this.userSettings.theme;

                        gradientElements.forEach(el => {
                            el.classList.remove(
                                'from-indigo-600', 'to-indigo-700',
                                'from-blue-600', 'to-blue-700',
                                'from-emerald-600', 'to-emerald-700',
                                'from-purple-600', 'to-purple-700'
                            );

                            switch (theme) {
                                case 'indigo':
                                    el.classList.add('from-indigo-600', 'to-indigo-700');
                                    break;
                                case 'blue':
                                    el.classList.add('from-blue-600', 'to-blue-700');
                                    break;
                                case 'emerald':
                                    el.classList.add('from-emerald-600', 'to-emerald-700');
                                    break;
                                case 'purple':
                                    el.classList.add('from-purple-600', 'to-purple-700');
                                    break;
                                default:
                                    el.classList.add('from-indigo-600', 'to-indigo-700');
                            }
                        });
                    },

                    async loadUserSettings() {
                        try {
                            // Try to load from Firestore if logged in
                            if (window.auth?.currentUser) {
                                const { doc, getDoc } = window.firestoreFunctions;
                                const userRef = doc(window.db, "users", window.auth.currentUser.uid);
                                const userDoc = await getDoc(userRef);

                                if (userDoc.exists()) {
                                    const data = userDoc.data();
                                    if (data.settings) {
                                        // Only update fields that exist in the saved settings
                                        Object.keys(data.settings).forEach(key => {
                                            if (this.userSettings.hasOwnProperty(key)) {
                                                this.userSettings[key] = data.settings[key];
                                            }
                                        });
                                    }
                                }
                            } else {
                                // Fallback: Try to load from localStorage if not logged in
                                const savedSettings = localStorage.getItem('userSettings');
                                if (savedSettings) {
                                    const settings = JSON.parse(savedSettings);
                                    // Only update fields that exist in the saved settings
                                    Object.keys(settings).forEach(key => {
                                        if (this.userSettings.hasOwnProperty(key)) {
                                            this.userSettings[key] = settings[key];
                                        }
                                    });
                                    console.log('Settings loaded from localStorage since user is not logged in');
                                }
                            }

                            // If autofill is enabled, populate only the fields that have values
                            if (this.userSettings.autofillEnabled) {
                                const updatedFields = { ...this.form.fields };

                                // Only update fields that have values in settings
                                if (this.userSettings.buyer) updatedFields.buyer = this.userSettings.buyer;
                                if (this.userSettings.submission) updatedFields.submission = this.userSettings.submission;
                                if (this.userSettings.validity) updatedFields.validity = this.userSettings.validity;
                                if (this.userSettings.requirements) updatedFields.requirements = this.userSettings.requirements;
                                if (this.userSettings.criteria) updatedFields.criteria = this.userSettings.criteria;
                                if (this.userSettings.responsible) updatedFields.responsible = this.userSettings.responsible;

                                this.form.fields = updatedFields;
                            }

                            // Apply theme settings after loading
                            this.$nextTick(() => {
                                this.applyTheme();
                            });
                        } catch (error) {
                            console.error('Settings load error:', error);
                            this.showToast('Viga seadete laadimisel: ' + error.message, 'error');
                        }
                    }
                }
            });
        });

        // Remove these lines (around line 1098)
        // Show settings modal
        let showSettingsModal = false;

        // Function to load user basic data
        async function loadUserBasicData() {
            // ... remove this entire block
        }

        // Call this function when the page loads
        loadUserBasicData();
    </script>
</head>

<body class="backdrop-blur-2xl min-h-screen flex flex-col" x-data="formApp" x-cloak :class="{'dark': isDarkMode}">
    <!-- Login Modal -->
    <div x-show="showLoginModal" x-cloak x-transition:enter="transition duration-300 ease-out"
        x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
        x-transition:leave="transition duration-200 ease-in" x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 z-50 overflow-y-auto bg-black/30 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="fixed left-1/2 transform -translate-x-1/2 top-8 md:top-24 w-full max-w-md rounded-2xl shadow-2xl border border-white/40 bg-white"
            @click.stop>
            <!-- Close Button -->
            <div class="flex justify-between items-center p-6 border-b border-gray-100/30">
                <h2
                    class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-700">
                    Logi sisse</h2>
                <button @click="showLoginModal = false"
                    class="rounded-full p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="p-6">
                <!-- Email Input -->
                <div class="space-y-5">
                    <div class="relative">
                        <label class="text-gray-700 font-medium text-sm mb-1 block">E-post</label>
                        <div class="relative flex items-center">
                            <div class="absolute left-3 text-gray-400">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <input type="email" id="emailLogin" placeholder="Sisesta oma e-post"
                                class="input w-full pl-10 pr-4 py-3 border border-gray-200 text-gray-900 rounded-xl focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-300" />
                        </div>
                    </div>

                    <!-- Password Input -->
                    <div class="relative">
                        <label class="text-gray-700 font-medium text-sm mb-1 block">Parool</label>
                        <div class="relative flex items-center">
                            <div class="absolute left-3 text-gray-400">
                                <i class="fas fa-lock"></i>
                            </div>
                            <input type="password" id="passwordLogin" placeholder="Sisesta oma parool"
                                class="input w-full pl-10 pr-4 py-3 border border-gray-200 text-gray-900 rounded-xl focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-300" />
                        </div>
                    </div>

                    <div class="flex items-center justify-between mt-2">
                        <div class="flex items-center">
                            <input type="checkbox" id="rememberMe" class="mr-2 rounded-md">
                            <label for="rememberMe" class="text-gray-700 text-sm">Pea meeles mind</label>
                        </div>
                        <a href="#" class="text-sm text-indigo-600 hover:text-indigo-800">Unustasid parooli?</a>
                    </div>
                </div>

                <!-- Login Button -->
                <button @click="login()"
                    class="w-full mt-6 py-3 px-4 bg-gradient-to-r from-indigo-600 to-indigo-800 text-white rounded-xl flex items-center justify-center transition-all duration-300 hover:shadow-lg hover:shadow-indigo-500/30 transform hover:-translate-y-1">
                    <i class="fas fa-sign-in-alt mr-2"></i> Logi sisse
                </button>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="glassmorphism sticky top-0 z-50 py-3">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-6">
                    <a href="om.html" class="text-xl font-bold bg-clip-text text-transparent bg-black">

                    </a>
                    <div class="hidden md:flex md:space-x-6">
                        <a href="om.html"
                            class="nav-link flex items-center px-3 py-2 rounded-lg bg-indigo-100/50 text-black">
                            <i class="fas fa-file-alt mr-2"></i> Kutse koostamine
                        </a>
                        <a href="../index.html"
                            class="nav-link flex items-center px-3 py-2 rounded-lg hover:bg-white/30">
                            <i class="fas fa-home mr-2"></i> Avalehele
                        </a>
                        <a href="users.html"
                            class="hidden nav-link flex items-center px-3 py-2 rounded-lg hover:bg-white/30"
                            x-show="isAdmin">
                            <i class="fas fa-users mr-2"></i> Kasutajad
                        </a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button @click="isDarkMode = !isDarkMode"
                        class="p-2 rounded-full text-gray-700 bg-white/30 hover:bg-white/50 transition-all">
                        <i class="fas" :class="isDarkMode ? 'fa-sun' : 'fa-moon'"></i>
                    </button>

                    <!-- Settings Button -->
                    <button @click="showSettingsModal = true" x-show="currentUser"
                        class="flex items-center space-x-2 text-gray-800 hover:text-indigo-600 bg-white/30 hover:bg-white/50 px-4 py-2 rounded-full transition-all">
                        <i class="fas fa-cog"></i>
                        <span class="hidden md:inline">Seaded</span>
                    </button>

                    <div class="relative">
                        <button @click="currentUser ? toggleUserMenu() : showLoginModal = true"
                            class="flex items-center space-x-2 text-gray-800 hover:text-indigo-600 bg-white/30 hover:bg-white/50 px-4 py-2 rounded-full transition-all">
                            <i class="fas fa-user-circle"></i>
                            <span x-text="currentUser ? currentUser.email?.split('@')[0] : 'Logi sisse'"
                                class="hidden md:inline"></span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div x-show="showUserMenu && currentUser" @click.away="showUserMenu = false"
                            x-transition:enter="transition ease-out duration-200"
                            x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                            x-transition:leave="transition ease-in duration-150"
                            x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
                            class="absolute right-0 mt-2 w-48 rounded-xl shadow-xl glassmorphism ring-1 ring-black ring-opacity-5 z-50 border border-white/20">
                            <div class="py-1">
                                <a href="#" @click.prevent="logout()"
                                    class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-red-50 hover:text-red-700">
                                    <i class="fas fa-sign-out-alt mr-3 text-red-500"></i> Logi välja
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu (can be expanded as needed) -->
    <!-- End Navbar -->

    <!-- Main Content -->
    <div class="container mx-auto max-w-7xl p-6">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-center text-transparent bg-clip-text bg-black">
                Ostumenetluse kutse koostamine</h1>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
            <!-- Left: Data Input -->
            <div class="space-y-6">
                <!-- Form Header Card -->
                <div class="card transition-all" x-data="{ isOpen: true }">
                    <div class="flex items-center justify-between mb-4 cursor-pointer" @click="isOpen = !isOpen">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                                <i class="fas fa-file-contract text-indigo-600"></i>
                            </div>
                            <h2 class="text-xl font-bold text-gray-800">Põhiandmed</h2>
                        </div>
                        <button class="p-2 rounded-full hover:bg-indigo-100 transition-all">
                            <i class="fas transition-transform duration-300"
                                :class="isOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </button>
                    </div>

                    <div x-show="isOpen" x-transition:enter="transition ease-out duration-200"
                        x-transition:enter-start="opacity-0 transform -translate-y-2"
                        x-transition:enter-end="opacity-100 transform translate-y-0"
                        x-transition:leave="transition ease-in duration-150"
                        x-transition:leave-start="opacity-100 transform translate-y-0"
                        x-transition:leave-end="opacity-0 transform -translate-y-2">
                        <!-- Ostumenetluse nimi -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Ostumenetluse nimi</label>
                            <input type="text" x-model="form.name" class="w-full border rounded-xl px-4 py-3 shadow-sm"
                                placeholder="Näiteks: Haljasala rajamine" />
                        </div>

                        <!-- Ostumenetluse kirjeldus -->
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Ostumenetluse kutse
                                lühikirjeldus</label>
                            <textarea x-model="form.intro"
                                class="w-full border rounded-xl px-4 py-3 h-28 shadow-sm"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Põhiandmed Card -->
                <div class="card transition-all" x-data="{ isOpen: true }">
                    <div class="flex items-center justify-between mb-6 cursor-pointer" @click="isOpen = !isOpen">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                                <i class="fas fa-sliders-h text-indigo-600"></i>
                            </div>
                            <h2 class="text-xl font-bold text-gray-800">Põhiandmed</h2>
                        </div>
                        <button class="p-2 rounded-full hover:bg-indigo-100 transition-all">
                            <i class="fas transition-transform duration-300"
                                :class="isOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </button>
                    </div>

                    <div x-show="isOpen" x-transition:enter="transition ease-out duration-200"
                        x-transition:enter-start="opacity-0 transform -translate-y-2"
                        x-transition:enter-end="opacity-100 transform translate-y-0"
                        x-transition:leave="transition ease-in duration-150"
                        x-transition:leave-start="opacity-100 transform translate-y-0"
                        x-transition:leave-end="opacity-0 transform -translate-y-2">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <template x-for="field in standardFields" :key="field.key">
                                <div class="group">
                                    <label class="block text-sm font-semibold mb-2 text-gray-700"
                                        x-text="field.label"></label>
                                    <div class="relative">
                                        <input type="text" x-model="form.fields[field.key]"
                                            class="w-full border rounded-xl px-4 py-3 shadow-sm transition-all focus:shadow-md"
                                            :placeholder="field.placeholder" />
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Sections 1-7 Card -->
                <div class="card transition-all" x-data="{ isOpen: true }">
                    <div class="flex items-center justify-between mb-6 cursor-pointer" @click="isOpen = !isOpen">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                                <i class="fas fa-list-check text-indigo-600"></i>
                            </div>
                            <h2 class="text-xl font-bold text-gray-800">Vali punktid (1–7)</h2>
                        </div>
                        <button class="p-2 rounded-full hover:bg-indigo-100 transition-all">
                            <i class="fas transition-transform duration-300"
                                :class="isOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </button>
                    </div>

                    <div x-show="isOpen" x-transition:enter="transition ease-out duration-200"
                        x-transition:enter-start="opacity-0 transform -translate-y-2"
                        x-transition:enter-end="opacity-100 transform translate-y-0"
                        x-transition:leave="transition ease-in duration-150"
                        x-transition:leave-start="opacity-100 transform translate-y-0"
                        x-transition:leave-end="opacity-0 transform -translate-y-2">
                        <div class="flex gap-2 mb-6">
                            <button @click="selectAllOptions"
                                class="flex items-center text-sm bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-2 rounded-lg transition-colors">
                                <i class="fas mr-1"
                                    :class="form.sections.some(section => section.options.some(option => !option.checked)) ? 'fa-check-double' : 'fa-times'"></i>
                                <span
                                    x-text="form.sections.some(section => section.options.some(option => !option.checked)) ? 'Lisa kõik' : 'Eemalda kõik'"></span>
                            </button>
                            <button @click="toggleAllSections"
                                class="flex items-center text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg transition-colors">
                                <i class="fas mr-1"
                                    :class="form.sections.some(section => !section.open) ? 'fa-chevron-down' : 'fa-chevron-up'"></i>
                                <span
                                    x-text="form.sections.some(section => !section.open) ? 'Ava kõik' : 'Sulge kõik'"></span>
                            </button>
                        </div>

                        <div id="draggableSections" x-ref="draggableSections" class="space-y-4">
                            <template x-for="(section, index) in form.sections" :key="index">
                                <div class="mb-4 border bg-white/50 backdrop-blur-sm border-gray-200 rounded-xl overflow-hidden shadow-sm transition-all hover:shadow-md"
                                    x-data="{ section }" :class="{ 'active-section': section.enabled }">
                                    <div class="section-header" @click="section.open = !section.open">
                                        <input type="checkbox" x-model="section.enabled" class="mr-3" @click.stop>
                                        <span
                                            class="drag-handle cursor-move mr-3 text-gray-400 hover:text-indigo-500 transition-colors">
                                            <i class="fas fa-grip-lines"></i>
                                        </span>
                                        <span x-text="section.title" class="flex-grow"></span>
                                        <i class="fas transition-transform duration-300"
                                            :class="section.open ? 'fa-chevron-down transform rotate-180' : 'fa-chevron-right'"></i>
                                    </div>
                                    <div x-show="section.open" x-transition:enter="transition ease-out duration-200"
                                        x-transition:enter-start="opacity-0 transform -translate-y-4"
                                        x-transition:enter-end="opacity-100 transform translate-y-0"
                                        x-transition:leave="transition ease-in duration-150"
                                        x-transition:leave-start="opacity-100 transform translate-y-0"
                                        x-transition:leave-end="opacity-0 transform -translate-y-4"
                                        class="section-content">
                                        <template x-for="(opt, i) in section.options" :key="i">
                                            <label
                                                class="block p-3 hover:bg-white/50 rounded-lg transition-colors mb-2">
                                                <div class="flex items-start">
                                                    <input type="checkbox" x-model="opt.checked"
                                                        class="mt-1 mr-3 rounded">
                                                    <template x-if="opt.isEditing">
                                                        <input type="text" x-model="opt.text"
                                                            @blur="opt.isEditing = false"
                                                            @keydown.enter="opt.isEditing = false"
                                                            class="flex-grow border rounded-lg px-3 py-2 text-sm shadow-sm"
                                                            x-ref="editInput">
                                                    </template>
                                                    <template x-if="!opt.isEditing">
                                                        <span x-text="opt.text"
                                                            class="text-sm cursor-pointer hover:text-indigo-600"
                                                            @dblclick="opt.isEditing = true; $nextTick(() => $refs.editInput?.focus())">
                                                        </span>
                                                    </template>
                                                </div>
                                            </label>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div class="flex justify-between mt-6">
                            <button @click="addNewSection"
                                class="text-indigo-600 hover:text-indigo-800 flex items-center text-sm px-3 py-2 rounded-lg hover:bg-indigo-50 transition-colors">
                                <i class="fas fa-plus-circle mr-1"></i> Lisa uus punkt
                            </button>
                            <template x-for="(section, index) in form.sections" :key="index">
                                <button @click="addOption(index)" x-show="section.open"
                                    class="text-indigo-600 hover:text-indigo-800 flex items-center text-sm px-3 py-2 rounded-lg hover:bg-indigo-50 transition-colors">
                                    <i class="fas fa-plus-circle mr-1"></i>
                                    <span x-text="index === 0 ? 'Lisa tingimus' : 
                                                index === 6 ? 'Lisa lisa' : 
                                                'Lisa punkt'"></span>
                                </button>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- File Upload Section -->
                <div class="card transition-all" x-data="{ isOpen: true }">
                    <div class="flex items-center justify-between mb-2 cursor-pointer" @click="isOpen = !isOpen">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                                <i class="fas fa-paperclip text-indigo-600 text-sm"></i>
                            </div>
                            <h2 class="text-lg font-bold text-gray-800">Manused</h2>
                        </div>
                        <button class="p-1 rounded-full hover:bg-indigo-100 transition-all">
                            <i class="fas transition-transform duration-300 text-sm"
                                :class="isOpen ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </button>
                    </div>

                    <div x-show="isOpen" x-transition:enter="transition ease-out duration-200"
                        x-transition:enter-start="opacity-0 transform -translate-y-2"
                        x-transition:enter-end="opacity-100 transform translate-y-0"
                        x-transition:leave="transition ease-in duration-150"
                        x-transition:leave-start="opacity-100 transform translate-y-0"
                        x-transition:leave-end="opacity-0 transform -translate-y-2">
                        <div @dragover="handleDragOver" @dragleave="handleDragLeave" @drop="handleDrop"
                            :class="{'border-indigo-500 bg-indigo-50/50': isDragging}"
                            class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center cursor-pointer transition-colors hover:border-indigo-400">
                            <input type="file" id="fileInput" class="hidden" @change="handleFileInput" multiple>
                            <label for="fileInput" class="cursor-pointer block">
                                <i class="fas fa-cloud-upload-alt text-xl text-indigo-500 mb-2"></i>
                                <p class="text-gray-700 font-medium text-sm mb-1">Lohista failid siia või <span
                                        class="text-indigo-600 underline">kliki
                                        valimiseks</span></p>
                                <p class="text-xs text-gray-500">Max 10MB fail</p>
                            </label>
                        </div>

                        <div class="mt-3 space-y-2" x-show="files.length > 0">
                            <template x-for="(file, index) in files" :key="index">
                                <div class="file-item hover-scale py-2 px-3">
                                    <div class="flex items-center truncate max-w-[80%]">
                                        <div
                                            class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center mr-2">
                                            <i class="fas fa-file-alt text-indigo-500 text-xs"></i>
                                        </div>
                                        <div class="truncate">
                                            <div x-text="file.name" class="truncate text-gray-800 font-medium text-sm">
                                            </div>
                                            <div class="text-xs text-gray-500" x-text="formatFileSize(file.size)"></div>
                                        </div>
                                    </div>
                                    <button @click="removeFile(index)"
                                        class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50 transition-colors">
                                        <i class="fas fa-trash-alt text-xs"></i>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-5 mt-8">
                    <button @click="generatePDF" x-show="currentUser"
                        class="relative overflow-hidden group flex items-center gap-3 px-5 py-2.5 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-emerald-500/30 hover:-translate-y-1">
                        <div
                            class="absolute inset-0 w-full h-full bg-gradient-to-r from-emerald-600 to-emerald-700 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        </div>
                        <div class="w-7 h-7 flex items-center justify-center bg-white/20 rounded-full relative">
                            <i class="fas fa-file-pdf text-white text-sm"></i>
                        </div>
                        <span class="relative">Loo PDF</span>
                    </button>

                    <button @click="manualSave" x-show="currentUser"
                        class="relative overflow-hidden group flex items-center gap-3 px-5 py-2.5 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-indigo-500/30 hover:-translate-y-1">
                        <div
                            class="absolute inset-0 w-full h-full bg-gradient-to-r from-indigo-600 to-indigo-700 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        </div>
                        <div class="w-7 h-7 flex items-center justify-center bg-white/20 rounded-full relative">
                            <i class="fas fa-save text-white text-sm"></i>
                        </div>
                        <span class="relative">Salvesta</span>
                    </button>

                    <button @click="resetForm" x-show="currentUser"
                        class="relative overflow-hidden group flex items-center gap-3 px-5 py-2.5 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-red-500/30 hover:-translate-y-1">
                        <div
                            class="absolute inset-0 w-full h-full bg-gradient-to-r from-red-600 to-red-700 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        </div>
                        <div class="w-7 h-7 flex items-center justify-center bg-white/20 rounded-full relative">
                            <i class="fas fa-trash-alt text-white text-sm"></i>
                        </div>
                        <span class="relative">Tühjenda</span>
                    </button>
                </div>
            </div>

            <!-- Right: PDF Preview -->
            <div>
                <div class="sticky top-24">
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                            <i class="fas fa-eye text-indigo-600"></i>
                        </div>
                        <h2 class="text-lg font-bold text-gray-800">Reaalajas eelvaade</h2>
                    </div>

                    <div id="pdfPreview"
                        class="border-0 card space-y-6 min-h-[70vh] max-h-[80vh] overflow-auto backdrop-blur-md transition-all scroll-smooth">
                        <!-- Header -->
                        <div
                            class="bg-gradient-to-r from-indigo-600 to-indigo-800 backdrop-blur-sm text-white p-5 rounded-t-2xl -mx-6 -mt-6 mb-6">
                            <h1 class="text-2xl font-bold text-center" x-text="form.name || 'Ostumenetluse kutse'"></h1>
                        </div>

                        <!-- Intro text -->
                        <div class="text-gray-800 font-medium text-sm leading-relaxed p-2" x-text="form.intro"></div>

                        <!-- Standard fields -->
                        <div class="space-y-3">
                            <template x-for="field in standardFields">
                                <div x-show="form.fields[field.key]"
                                    class="bg-white/40 backdrop-blur-sm p-3 rounded-xl shadow-sm transition-all hover:shadow-md">
                                    <div class="flex items-start">
                                        <span class="font-semibold text-indigo-700 mr-2"
                                            x-text="field.label + ':'"></span>
                                        <span class="text-gray-800 font-medium"
                                            x-text="form.fields[field.key] || ''"></span>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Sections -->
                        <template x-for="(section, idx) in visibleSections" :key="idx">
                            <div class="mt-8">
                                <!-- Section title -->
                                <div class="flex items-center mb-4">
                                    <h2 class="text-lg font-bold text-indigo-700"
                                        x-text="(idx + 1) + ' ' + section.title.split(' ').slice(1).join(' ')"></h2>
                                    <div
                                        class="flex-grow h-0.5 bg-gradient-to-r from-indigo-500 to-indigo-300 ml-3 rounded-full">
                                    </div>
                                </div>

                                <!-- Section options -->
                                <ul class="space-y-3 pl-2">
                                    <template x-for="(opt, i) in section.options.filter(o => o.checked)" :key="i">
                                        <li
                                            class="flex items-start p-2 bg-white/30 rounded-lg shadow-sm hover:shadow-md transition-all">
                                            <div
                                                class="min-w-8 h-6 bg-indigo-100 rounded-full flex items-center justify-center text-xs font-bold text-indigo-700 mr-3">
                                                <span x-text="(idx + 1) + '.' + (i+1)"></span>
                                            </div>
                                            <span class="text-sm text-gray-800" x-text="opt.text"></span>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </template>

                        <!-- Footer -->
                        <div class="mt-10 pt-5 border-t border-gray-200">
                            <div class="flex justify-between text-sm">
                                <div class="text-indigo-700 font-semibold">
                                    <p>Kuupäev: <span class="text-gray-800" x-text="today"></span></p>
                                </div>
                                <div class="text-indigo-700 font-semibold">
                                    <p>Vastutav isik: <span class="text-gray-800"
                                            x-text="form.fields.responsible || ''"></span></p>
                                </div>
                            </div>
                        </div>

                        <!-- Attachments -->
                        <template x-if="files.length > 0">
                            <div class="mt-8">
                                <div class="flex items-center mb-4">
                                    <h3 class="text-lg font-bold text-indigo-700">Manused</h3>
                                    <div
                                        class="flex-grow h-0.5 bg-gradient-to-r from-indigo-500 to-indigo-300 ml-3 rounded-full">
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <template x-for="(file, index) in files" :key="index">
                                        <div
                                            class="flex items-center p-3 bg-white/40 rounded-xl transition-all hover:bg-white/60">
                                            <div
                                                class="w-8 h-8 flex items-center justify-center bg-indigo-100 rounded-full mr-3">
                                                <i class="fas fa-file-alt text-indigo-600"></i>
                                            </div>
                                            <span class="text-sm text-gray-800">
                                                <span x-text="index + 1 + '. '"></span>
                                                <span x-text="file.name" class="font-medium"></span>
                                                <span class="text-gray-500"
                                                    x-text="' (' + formatFileSize(file.size) + ')'"></span>
                                                <span x-show="file.comment" class="text-gray-500"
                                                    x-text="' - ' + file.comment"></span>
                                            </span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="fixed bottom-4 right-4 space-y-3 z-50" x-show="toasts.length > 0">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 translate-y-2"
                :class="{
                    'toast-success': toast.type === 'success',
                    'toast-error': toast.type === 'error',
                    'toast-info': toast.type === 'info'
                }" class="text-white px-6 py-4 rounded-xl shadow-lg flex items-center backdrop-blur-sm max-w-md">
                <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-white/20 mr-3">
                    <i class="fas" :class="{
                        'fa-check': toast.type === 'success',
                        'fa-exclamation': toast.type === 'error',
                        'fa-info': toast.type === 'info'
                    }"></i>
                </div>
                <div>
                    <p class="font-medium" x-text="toast.message"></p>
                </div>
                <button @click="toasts = toasts.filter(t => t.id !== toast.id)"
                    class="ml-auto text-white/80 hover:text-white p-1">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </template>
    </div>

    <!-- Settings Modal -->
    <div x-show="showSettingsModal" x-cloak x-transition:enter="transition duration-300 ease-out"
        x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
        x-transition:leave="transition duration-200 ease-in" x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0" class="fixed inset-0 z-50 bg-black/70 backdrop-blur-md"
        @click.self="showSettingsModal = false" x-data="{ activeTab: 'basicInfo' }">
        <div class="fixed left-1/2 transform -translate-x-1/2 top-8 md:top-24 w-full max-w-3xl rounded-2xl shadow-2xl border border-white/40 max-h-[85vh] overflow-y-auto mx-auto bg-white/90 backdrop-blur-xl"
            @click.stop>
            <!-- Header -->
            <div
                class="sticky top-0 p-6 border-b border-gray-100/30 bg-gradient-to-r from-indigo-600 to-indigo-800 z-10">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-white flex items-center">
                        <i class="fas fa-cog mr-3"></i>Seaded
                    </h2>
                    <button @click="showSettingsModal = false"
                        class="text-white/80 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Tabs -->
                <div class="flex space-x-1 mt-5">
                    <button @click="activeTab = 'basicInfo'"
                        :class="activeTab === 'basicInfo' ? 'text-white bg-white/20 border-b-2 border-white' : 'text-white/70 hover:text-white hover:bg-white/10'"
                        class="px-4 py-2 rounded-t-lg font-medium transition-colors">
                        Põhiandmed
                    </button>
                    <button @click="activeTab = 'design'"
                        :class="activeTab === 'design' ? 'text-white bg-white/20 border-b-2 border-white' : 'text-white/70 hover:text-white hover:bg-white/10'"
                        class="px-4 py-2 rounded-t-lg font-medium transition-colors">
                        Kujundus
                    </button>
                    <button @click="activeTab = 'history'"
                        :class="activeTab === 'history' ? 'text-white bg-white/20 border-b-2 border-white' : 'text-white/70 hover:text-white hover:bg-white/10'"
                        class="px-4 py-2 rounded-t-lg font-medium transition-colors">
                        Ajalugu
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="p-6 bg-white/90">
                <!-- Põhiandmed Tab Content -->
                <div x-show="activeTab === 'basicInfo'" x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
                    <form @submit.prevent="saveUserSettings" class="space-y-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Põhiandmete seaded</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hankija</label>
                                <div class="relative">
                                    <i
                                        class="fas fa-building absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" x-model="userSettings.buyer" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl 
                                        bg-white text-gray-900 shadow-sm
                                        focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                                        placeholder="Nimi, aadress, registrikood">
                                </div>
                            </div>

                            <div class="group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pakkumise esitamise aeg ja
                                    koht</label>
                                <div class="relative">
                                    <i
                                        class="fas fa-calendar absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" x-model="userSettings.submission" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl 
                                        bg-white text-gray-900 shadow-sm
                                        focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                                        placeholder="nt 10. aprill, e-post">
                                </div>
                            </div>

                            <div class="group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pakkumuse jõusoleku
                                    aeg</label>
                                <div class="relative">
                                    <i
                                        class="fas fa-clock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" x-model="userSettings.validity" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl 
                                        bg-white text-gray-900 shadow-sm
                                        focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                                        placeholder="nt 30 päeva">
                                </div>
                            </div>

                            <div class="group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nõuded pakkujale</label>
                                <div class="relative">
                                    <i
                                        class="fas fa-list-check absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" x-model="userSettings.requirements" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl 
                                        bg-white text-gray-900 shadow-sm
                                        focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                                        placeholder="nt kogemus 3 aastat">
                                </div>
                            </div>

                            <div class="group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Väljavaliku alused</label>
                                <div class="relative">
                                    <i
                                        class="fas fa-scale-balanced absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" x-model="userSettings.criteria" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl 
                                        bg-white text-gray-900 shadow-sm
                                        focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                                        placeholder="Majanduslikult soodsaim">
                                </div>
                            </div>

                            <div class="group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Vastutav isik</label>
                                <div class="relative">
                                    <i
                                        class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" x-model="userSettings.responsible" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl 
                                        bg-white text-gray-900 shadow-sm
                                        focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                                        placeholder="Nimi">
                                </div>
                            </div>
                        </div>

                        <!-- Autofill Toggle -->
                        <div
                            class="flex items-center justify-between p-5 bg-indigo-50 rounded-xl mt-6 border border-indigo-100 shadow-sm">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-magic text-indigo-600"></i>
                                </div>
                                <div>
                                    <label class="text-lg font-medium text-gray-800">
                                        Automaatne täitmine
                                    </label>
                                    <p class="text-sm text-gray-500">Põhiandmete automaatne täitmine vormi avamisel</p>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" x-model="userSettings.autofillEnabled" class="sr-only peer">
                                <div
                                    class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-indigo-600">
                                </div>
                            </label>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-end gap-3 mt-8 pt-6 border-t border-gray-200">
                            <button type="button" @click="showSettingsModal = false" class="px-5 py-3 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-xl 
                                hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 
                                transition-all shadow-sm hover:shadow">
                                Tühista
                            </button>
                            <button type="button" @click="saveUserSettings()" class="px-5 py-3 text-sm font-medium text-white bg-gradient-to-r from-indigo-600 to-indigo-700 border border-transparent 
                                rounded-xl hover:from-indigo-700 hover:to-indigo-800 focus:outline-none focus:ring-2 focus:ring-offset-2 
                                focus:ring-indigo-500 transition-all shadow-sm hover:shadow-md">
                                <i class="fas fa-save mr-2"></i> Salvesta seaded
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Design Tab Content -->
                <div x-show="activeTab === 'design'" x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
                    <div class="space-y-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Kujunduse seaded</h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Theme Options -->
                            <div class="col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-3">Värvipalett</label>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                    <div @click="userSettings.theme = 'indigo'"
                                        :class="userSettings.theme === 'indigo' ? 'ring-2 ring-indigo-500 shadow-md' : ''"
                                        class="flex flex-col items-center space-y-2 p-4 border border-gray-200 rounded-xl hover:shadow-md transition-all cursor-pointer">
                                        <div class="w-full h-6 bg-indigo-600 rounded-t-lg"></div>
                                        <div class="w-full h-6 bg-indigo-400 rounded-b-lg"></div>
                                        <span class="text-sm font-medium text-gray-700">Indigo</span>
                                    </div>
                                    <div @click="userSettings.theme = 'blue'"
                                        :class="userSettings.theme === 'blue' ? 'ring-2 ring-blue-500 shadow-md' : ''"
                                        class="flex flex-col items-center space-y-2 p-4 border border-gray-200 rounded-xl hover:shadow-md transition-all cursor-pointer">
                                        <div class="w-full h-6 bg-blue-600 rounded-t-lg"></div>
                                        <div class="w-full h-6 bg-blue-400 rounded-b-lg"></div>
                                        <span class="text-sm font-medium text-gray-700">Sinine</span>
                                    </div>
                                    <div @click="userSettings.theme = 'emerald'"
                                        :class="userSettings.theme === 'emerald' ? 'ring-2 ring-emerald-500 shadow-md' : ''"
                                        class="flex flex-col items-center space-y-2 p-4 border border-gray-200 rounded-xl hover:shadow-md transition-all cursor-pointer">
                                        <div class="w-full h-6 bg-emerald-600 rounded-t-lg"></div>
                                        <div class="w-full h-6 bg-emerald-400 rounded-b-lg"></div>
                                        <span class="text-sm font-medium text-gray-700">Emerald</span>
                                    </div>
                                    <div @click="userSettings.theme = 'purple'"
                                        :class="userSettings.theme === 'purple' ? 'ring-2 ring-purple-500 shadow-md' : ''"
                                        class="flex flex-col items-center space-y-2 p-4 border border-gray-200 rounded-xl hover:shadow-md transition-all cursor-pointer">
                                        <div class="w-full h-6 bg-purple-600 rounded-t-lg"></div>
                                        <div class="w-full h-6 bg-purple-400 rounded-b-lg"></div>
                                        <span class="text-sm font-medium text-gray-700">Lilla</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Font Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fondid</label>
                                <select x-model="userSettings.font"
                                    class="w-full border border-gray-200 rounded-xl bg-white text-gray-900 shadow-sm px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                                    <option value="Inter">Inter (Vaikimisi)</option>
                                    <option value="Roboto">Roboto</option>
                                    <option value="Open Sans">Open Sans</option>
                                    <option value="Poppins">Poppins</option>
                                </select>
                            </div>

                            <!-- Button Style -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nuppude stiil</label>
                                <select x-model="userSettings.buttonStyle"
                                    class="w-full border border-gray-200 rounded-xl bg-white text-gray-900 shadow-sm px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                                    <option value="rounded">Ümarad (Vaikimisi)</option>
                                    <option value="square">Kandilised</option>
                                    <option value="soft">Pehmed nurgad</option>
                                </select>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-end gap-3 mt-8 pt-6 border-t border-gray-200">
                            <button type="button" @click="showSettingsModal = false" class="px-5 py-3 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-xl 
                                hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 
                                transition-all shadow-sm hover:shadow">
                                Tühista
                            </button>
                            <button type="button" @click="saveUserSettings()" class="px-5 py-3 text-sm font-medium text-white bg-gradient-to-r from-indigo-600 to-indigo-700 border border-transparent 
                                rounded-xl hover:from-indigo-700 hover:to-indigo-800 focus:outline-none focus:ring-2 focus:ring-offset-2 
                                focus:ring-indigo-500 transition-all shadow-sm hover:shadow-md">
                                <i class="fas fa-save mr-2"></i> Salvesta seaded
                            </button>
                        </div>
                    </div>
                </div>

                <!-- History Tab Content -->
                <div x-show="activeTab === 'history'" x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
                    <div class="space-y-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Ajalugu ja tehtud PDF-id</h3>

                        <div class="border border-gray-200 rounded-xl overflow-hidden">
                            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                                <div class="flex justify-between items-center">
                                    <h4 class="font-medium text-gray-700">Viimased genereeritud PDF-id</h4>
                                    <button class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                        <i class="fas fa-trash-alt mr-1"></i> Tühjenda
                                    </button>
                                </div>
                            </div>

                            <div class="divide-y divide-gray-200">
                                <div class="p-4 hover:bg-gray-50 transition-colors">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="font-medium text-gray-800">Haljasala rajamine</p>
                                            <p class="text-sm text-gray-500">Genereeritud: 15.04.2023</p>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button
                                                class="p-2 text-indigo-600 hover:text-indigo-800 hover:bg-indigo-50 rounded-full transition-colors">
                                                <i class="fas fa-download"></i>
                                            </button>
                                            <button
                                                class="p-2 text-indigo-600 hover:text-indigo-800 hover:bg-indigo-50 rounded-full transition-colors">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="p-4 hover:bg-gray-50 transition-colors">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="font-medium text-gray-800">Lumekoristus 2023</p>
                                            <p class="text-sm text-gray-500">Genereeritud: 12.04.2023</p>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button
                                                class="p-2 text-indigo-600 hover:text-indigo-800 hover:bg-indigo-50 rounded-full transition-colors">
                                                <i class="fas fa-download"></i>
                                            </button>
                                            <button
                                                class="p-2 text-indigo-600 hover:text-indigo-800 hover:bg-indigo-50 rounded-full transition-colors">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-4 flex justify-center border-t border-gray-200">
                                <button class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                    Näita rohkem <i class="fas fa-chevron-down ml-1"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>