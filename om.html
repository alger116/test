<!DOCTYPE html>
<html lang="et">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ostumenetluse kutse</title>

    <!-- Only include jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Ensure jsPDF is initialized
        window.addEventListener('DOMContentLoaded', function () {
            if (typeof window.jspdf === 'undefined') {
                console.warn('jsPDF not loaded correctly. Attempting to initialize it.');
                try {
                    window.jspdf = { jsPDF: window.jspdf.jsPDF || window.jsPDF };
                } catch (e) {
                    console.error('Failed to initialize jsPDF:', e);
                }
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <style>
        .toast-success {
            background-color: #10B981;
        }

        .toast-error {
            background-color: #EF4444;
        }

        .toast-info {
            background-color: #3B82F6;
        }

        .drag-active {
            border-color: #3B82F6;
            background-color: #EFF6FF;
        }

        [x-cloak] {
            display: none !important;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #pdfPreview,
            #pdfPreview * {
                visibility: visible;
            }

            #pdfPreview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('formApp', () => {
                const standardFields = [
                    { key: 'buyer', label: 'Hankija', placeholder: 'Nimi, aadress, registrikood' },
                    { key: 'submission', label: 'Pakkumise esitamise aeg ja koht', placeholder: 'nt 10. aprill, e-post' },
                    { key: 'validity', label: 'Pakkumuse jõusoleku aeg', placeholder: 'nt 30 päeva' },
                    { key: 'requirements', label: 'Nõuded pakkujale', placeholder: 'nt kogemus 3 aastat' },
                    { key: 'criteria', label: 'Väljavaliku alused', placeholder: 'Majanduslikult soodsaim' },
                    { key: 'responsible', label: 'Vastutav isik', placeholder: 'Nimi' }
                ];

                const defaultFields = {};
                standardFields.forEach(field => {
                    defaultFields[field.key] = '';
                });

                return {
                    standardFields,
                    form: {
                        name: '',
                        intro: 'Lisa hankija nimi teeb Teile ettepaneku esitada pakkumus "Lisa ostetav ese/teenus" ostumenetluse kutses sätestatud tingimustele. Ostumenetluse eesmärk on... ',
                        fields: { ...defaultFields },
                        sections: [
                            {
                                title: '1 Üldised tingimused',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Ettevõtjatel on õigus küsida kutse kohta selgitusi, esitades küsimused e-posti teel ostumenetluse eest vastutavale isikule. Hankija vastab ettevõtja küsimustele kolme tööpäeva jooksul. Hankija edastab esitatud küsimused ja antud vastused samaaegselt kõigile ettevõtjatele, kellele tehti ettepanek pakkumuse esitamiseks. Telefoni teel esitatud küsimustele ei vastata.', checked: false },
                                    { text: 'Hankijal on õigus enne pakkumuste esitamise tähtaega muuta vajadusel kutset. Kutse muutmisel teavitab hankija sellest kõiki ettevõtjaid, kellele on tehtud ettepanek pakkumuste esitamiseks ja edastab ettevõtjatele muudetud kutse. Hankija võib pikendada pakkumuste esitamise tähtaega.', checked: false },
                                    { text: 'Iga viidet, mille hankija teeb kutses mõnele standardile, tehnilisele tunnusele, kontrollsüsteemile, ostuallikale, protsessile, kaubamärgile, patendile, tüübile, päritolule või tootmisviisile, tuleb lugeda selliselt, et see on täiendatud märkega „või sellega samaväärne".', checked: false },
                                    { text: 'Hankija ei sõlmi hankelepingut pakkujaga, kellel on maksuvõlg (kohalikud maksud Tallinna linnale ja riiklik maksuvõlg)...', checked: false },
                                    { text: 'Hankija jätab endale õiguse tellida teenust lähtudes oma eelarvelistest vahenditest. Teenuse hankija ei hüvita pakkujale teenuse tellimata jätmise eest tekkinud kahju.', checked: false }
                                ]
                            },
                            {
                                title: '2 Ostumenetluse tehniline kirjeldus',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: '"Hankija lisab siia tehnilise kirjelduse" - Lisada kas viide eraldi failile kui TK on eraldi või kopeerida siia lihtsalt tehniline kirjeldus teenuse/asja kohta, mida soovitakse osta.', checked: false, editable: true }
                                ]
                            },
                            {
                                title: '3 Nõuded pakkumusele',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Pakkumus on pakkuja tahteavaldus tellimuse täitmiseks ja on selle esitamisel pakkujale siduv alates esitamisest kuni pakkumuse jõusoleku minimaalse tähtaja lõpuni. Hankijal on õigus teha ettepanek pakkumuse jõusoleku tähtaja pikendamiseks. Tingimusliku pakkumuse esitamine on keelatud.', checked: false },
                                    { text: 'Hilinenud pakkumusi hankija vastu ei võta.', checked: false },
                                    { text: 'Pakkumus peab sisaldama: Pakkumuse maksumust vastavalt lisale 1;', checked: false },
                                    { text: 'Pakkumus peab sisaldama: Pakkumuse kirjeldust, mis võimaldab hankijal kontrollida kutse punktis 2 sätestatud tingimustele vastavust.', checked: false },
                                    { text: 'Pakkuja kannab kõik pakkumuse ettevalmistamise ja esitamisega seotud kulud ning pakkumuse tähtaegse esitamise riski.', checked: false },
                                    { text: 'Pakkumus on konfidentsiaalne kuni tellimuse tegemiseni.', checked: false },
                                    { text: 'Pakkuja märgib pakkumuses, milline teave pakkumusest on ärisaladus ning põhjendab ärisaladuseks määramist... Hankija ei avalikusta pakkumuse sisu ärisaladusega kaetud osas.', checked: false }
                                ]
                            },
                            {
                                title: '4 Pakkumuste kontrollimine, hindamine ja eduka pakkumuse valik',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Hankija kontrollib tähtaegselt esitatud pakkumuste vastavust kutses esitatud tingimustele...', checked: false },
                                    { text: 'Hankijal on õigus küsida pakkujalt esitatud pakkumuse kohta täpsustavaid andmeid ja täpsustavaid selgitusi.', checked: false },
                                    { text: 'Kutses esitatud tingimustele vastavate pakkumuste seast valib hankija eduka pakkumuse välja madalaima hinna alusel...', checked: false },
                                    { text: 'Kui edukas pakkuja võtab hankijast mitteolenevatel põhjustel oma pakkumuse tagasi...', checked: false },
                                    { text: 'Hankija ei ole kohustatud korra punktis 4.5 nimetatud alusel pakkumusi uuesti hindama...', checked: false }
                                ]
                            },
                            {
                                title: '5 Läbirääkimiste pidamine',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Hankijal on õigus pidada läbirääkimisi esitatud pakkumuse sisu ja maksumuse ning tellimuse tingimuste üle.', checked: false },
                                    { text: 'Hankijal on õigus loobuda ühest või mitmest pakkumuses kirjeldatud teenusest, tööst või asjast või vähendada nende mahtusid või koguseid...', checked: false },
                                    { text: 'Vastavalt läbirääkimiste pidamise vajadusele teatab hankija pakkujatele läbirääkimiste aja... Läbirääkimised on konfidentsiaalsed.', checked: false },
                                    { text: 'Pärast läbirääkimiste toimumist esitab pakkuja vajadusel uue kohandatud pakkumuse...', checked: false }
                                ]
                            },
                            {
                                title: '6 Pakkumuste tagasi lükkamine ja ostumenetluse kehtetuks tunnistamine',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Hankijal on õigus kõik esitatud või kutses toodud tingimustele vastavad pakkumused tagasi lükata...', checked: false },
                                    { text: 'Kui hankijal on tekkinud vajadus pärast pakkumuste esitamise tähtpäeva kutses esitatud tingimusi olulisel määral muuta...', checked: false },
                                    { text: 'Hankija võib ostumenetluse kehtetuks tunnistada, kui peale pakkumuste esitamise tähtpäeva selgub, et hankija on teinud vea...', checked: false }
                                ]
                            },
                            {
                                title: '7 Lisad',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Lisa 1. Kui on lisad, siis lisatakse siia.', checked: false }
                                ]
                            }
                        ]
                    },
                    today: new Date().toLocaleDateString('et-EE'),
                    toasts: [],
                    files: [],
                    isDragging: false,

                    init() {
                        this.loadFromStorage();

                        // Initialize Sortable for the sections
                        this.$nextTick(() => {
                            if (this.$refs.draggableSections) {
                                new Sortable(this.$refs.draggableSections, {
                                    animation: 150,
                                    handle: '.drag-handle',
                                    onEnd: (evt) => {
                                        const newOrder = Array.from(evt.from.children).map(child => {
                                            return child.__x.$data.section;
                                        });
                                        this.form.sections = newOrder;
                                    }
                                });
                            }
                        });
                    },

                    get visibleSections() {
                        return this.form.sections.filter(s => s.enabled && s.options.some(o => o.checked));
                    },

                    generatePDF() {
                        try {
                            // Check if jsPDF is properly loaded
                            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                                if (typeof window.jsPDF !== 'undefined') {
                                    // Try to use the global jsPDF constructor
                                    window.jspdf = { jsPDF: window.jsPDF };
                                } else {
                                    throw new Error('jsPDF not properly loaded');
                                }
                            }

                            // Create a new jsPDF instance
                            const { jsPDF } = window.jspdf;
                            const doc = new jsPDF('p', 'mm', 'a4');

                            // Add title
                            doc.setFontSize(18);
                            doc.setTextColor(0, 0, 0);
                            doc.text(this.form.name || 'Ostumenetluse kutse', 105, 20, { align: 'center' });

                            // Add intro text
                            doc.setFontSize(12);
                            let yPos = 35;
                            const introLines = doc.splitTextToSize(this.form.intro, 170);
                            doc.text(introLines, 20, yPos);
                            yPos += (introLines.length * 7) + 10;

                            // Add standard fields
                            doc.setFontSize(12);
                            this.standardFields.forEach(field => {
                                const fieldValue = this.form.fields[field.key] || '';
                                if (fieldValue.trim() !== '') {
                                    doc.setFont(undefined, 'bold');
                                    doc.text(`${field.label}: `, 20, yPos);
                                    const textWidth = doc.getTextWidth(`${field.label}: `);

                                    doc.setFont(undefined, 'normal');
                                    const valueLines = doc.splitTextToSize(fieldValue, 150);
                                    doc.text(valueLines, 20 + textWidth, yPos);

                                    yPos += (valueLines.length * 7) + 5;
                                }
                            });

                            // Add sections
                            this.visibleSections.forEach((section, index) => {
                                yPos += 5;

                                // Section title
                                doc.setFontSize(14);
                                doc.setFont(undefined, 'bold');
                                doc.text(section.title, 20, yPos);
                                yPos += 8;

                                // Section options
                                doc.setFontSize(12);
                                doc.setFont(undefined, 'normal');

                                section.options.filter(o => o.checked).forEach((opt, i) => {
                                    const optionText = `${section.title.split(' ')[0]}.${i + 1} ${opt.text}`;
                                    const optLines = doc.splitTextToSize(optionText, 160);

                                    doc.text('• ', 20, yPos);
                                    doc.text(optLines, 25, yPos);

                                    yPos += (optLines.length * 7) + 5;

                                    // Check if we need a new page
                                    if (yPos > 270) {
                                        doc.addPage();
                                        yPos = 20;
                                    }
                                });
                            });

                            // Add footer
                            yPos = Math.min(yPos + 15, 270);
                            doc.setFontSize(12);
                            doc.setFont(undefined, 'bold');
                            doc.text(`Kuupäev: ${this.today}`, 20, yPos);
                            yPos += 7;
                            doc.text(`Vastutav isik: ${this.form.fields.responsible || ''}`, 20, yPos);

                            // Save the PDF
                            doc.save(`${this.form.name || 'ostumenetlus'}.pdf`);
                            this.showToast('PDF loodud edukalt!', 'success');
                        } catch (err) {
                            console.error('PDF generation failed:', err);
                            this.showToast('PDF genereerimine ebaõnnestus', 'error');

                            // As a last resort, offer direct print option
                            if (confirm('PDF genereerimine ebaõnnestus. Kas soovid kasutada brauseri printimisfunktsiooni?')) {
                                window.print();
                            }
                        }
                    },

                    saveToStorage() {
                        try {
                            const payload = {
                                form: this.form,
                                timestamp: Date.now(),
                                version: '1.4'
                            };
                            localStorage.setItem('OM_DRAFT', JSON.stringify(payload));
                            this.showToast('Salvestatud!', 'success');
                        } catch (error) {
                            console.error('Failed to save to storage:', error);
                            this.showToast('Salvestamine ebaõnnestus', 'error');
                        }
                    },

                    loadFromStorage() {
                        try {
                            const raw = localStorage.getItem('OM_DRAFT');
                            if (raw) {
                                const data = JSON.parse(raw);
                                if (data.version === '1.4') {
                                    this.form = {
                                        ...data.form,
                                        fields: {
                                            ...defaultFields,
                                            ...data.form.fields
                                        }
                                    };
                                    this.showToast('Laaditud salvestatud andmed', 'success');
                                } else {
                                    localStorage.removeItem('OM_DRAFT');
                                    this.showToast('Vana versiooni andmed, algandmed laetud', 'info');
                                }
                            }
                        } catch (error) {
                            console.error('Failed to load from storage:', error);
                            localStorage.removeItem('OM_DRAFT');
                        }
                    },

                    addAttachment() {
                        const lisaCount = this.form.sections[6].options.length + 1;
                        this.form.sections[6].options.push({
                            text: `Lisa ${lisaCount}. Lisa kirjeldus`,
                            checked: false
                        });
                        this.showToast('Lisa lisatud', 'success');
                    },

                    addNewSection() {
                        const nextNum = this.form.sections.length + 1;
                        this.form.sections.push({
                            title: `${nextNum} Uus punkt`,
                            enabled: false,
                            open: true,
                            options: [{ text: 'Lisa tingimus', checked: false }]
                        });
                        this.showToast('Uus sektsioon lisatud', 'success');
                    },

                    toggleAllSections(open) {
                        this.form.sections.forEach(section => {
                            section.open = open;
                        });
                    },

                    showToast(message, type = 'info', duration = 3000) {
                        const toast = {
                            id: Date.now(),
                            message,
                            type,
                            duration
                        };
                        this.toasts.push(toast);
                        setTimeout(() => {
                            this.toasts = this.toasts.filter(t => t.id !== toast.id);
                        }, duration);
                    },

                    handleDragOver(e) {
                        e.preventDefault();
                        this.isDragging = true;
                    },

                    handleDragLeave() {
                        this.isDragging = false;
                    },

                    handleDrop(e) {
                        e.preventDefault();
                        this.isDragging = false;
                        const files = Array.from(e.dataTransfer.files);
                        this.processFiles(files);
                    },

                    handleFileInput(e) {
                        const files = Array.from(e.target.files);
                        this.processFiles(files);
                        e.target.value = ''; // Reset input
                    },

                    processFiles(files) {
                        files.forEach(file => {
                            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                                this.showToast(`Fail ${file.name} on liiga suur (max 5MB)`, 'error');
                                return;
                            }

                            const reader = new FileReader();
                            reader.onload = (e) => {
                                this.files.push({
                                    name: file.name,
                                    size: file.size,
                                    type: file.type,
                                    data: e.target.result
                                });
                                this.showToast(`Fail ${file.name} lisatud`, 'success');
                            };
                            reader.readAsDataURL(file);
                        });
                    },

                    removeFile(index) {
                        const fileName = this.files[index].name;
                        this.files.splice(index, 1);
                        this.showToast(`Fail ${fileName} eemaldatud`, 'info');
                    },

                    formatFileSize(bytes) {
                        if (bytes === 0) return '0 Bytes';
                        const k = 1024;
                        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                        const i = Math.floor(Math.log(bytes) / Math.log(k));
                        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                    }
                }
            });
        });
    </script>
</head>

<body class="bg-gray-50 text-gray-800" x-data="formApp" x-cloak>
    <div class="flex flex-col md:flex-row p-4 gap-4 min-h-screen">
        <!-- Left: Data Input -->
        <div class="w-full md:w-1/2 space-y-4">
            <div class="bg-white p-4 rounded-lg shadow border">
                <label class="block text-sm font-semibold mb-1">Ostumenetluse nimi</label>
                <input type="text" x-model="form.name" class="w-full border rounded px-3 py-2"
                    placeholder="Näiteks: Haljasala rajamine" />
            </div>

            <div class="bg-white p-4 rounded-lg shadow border space-y-2">
                <label class="block text-sm font-semibold">Üldsõnaline kutse tekst</label>
                <textarea x-model="form.intro" class="w-full border rounded px-3 py-2 h-24"></textarea>
            </div>

            <div class="bg-white p-4 rounded-lg shadow border grid grid-cols-1 gap-2">
                <template x-for="field in standardFields" :key="field.key">
                    <div>
                        <label class="text-sm font-semibold" x-text="field.label"></label>
                        <input type="text" x-model="form.fields[field.key]" class="w-full border rounded px-3 py-2 mt-1"
                            :placeholder="field.placeholder" />
                    </div>
                </template>
            </div>

            <!-- File Upload Section -->
            <div class="bg-white p-4 rounded-lg shadow border">
                <label class="block text-sm font-semibold mb-2">Manused</label>
                <div @dragover="handleDragOver" @dragleave="handleDragLeave" @drop="handleDrop"
                    :class="{'drag-active': isDragging}"
                    class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer transition-colors">
                    <input type="file" id="fileInput" class="hidden" @change="handleFileInput" multiple>
                    <label for="fileInput" class="cursor-pointer">
                        <p>Lohista failid siia või <span class="text-blue-600 underline">kliki valimiseks</span></p>
                        <p class="text-sm text-gray-500 mt-1">Max 5MB fail</p>
                    </label>
                </div>

                <div class="mt-2 space-y-2" x-show="files.length > 0">
                    <template x-for="(file, index) in files" :key="index">
                        <div class="flex items-center justify-between bg-gray-100 p-2 rounded">
                            <div class="truncate">
                                <span x-text="file.name" class="truncate"></span>
                                <span class="text-xs text-gray-500 ml-2" x-text="formatFileSize(file.size)"></span>
                            </div>
                            <button @click="removeFile(index)" class="text-red-500 hover:text-red-700 ml-2">
                                ×
                            </button>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Sections 1-7 -->
            <div class="bg-white p-4 rounded-lg shadow border">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-sm font-semibold">Vali punktid (1–7)</label>
                    <div class="flex gap-2">
                        <button @click="toggleAllSections(true)"
                            class="text-sm bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded transition-colors">
                            Ava kõik
                        </button>
                        <button @click="toggleAllSections(false)"
                            class="text-sm bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded transition-colors">
                            Sulge kõik
                        </button>
                    </div>
                </div>
                <div id="draggableSections" x-ref="draggableSections" class="space-y-2">
                    <template x-for="(section, index) in form.sections" :key="index">
                        <div class="mb-2 border rounded p-2" x-data="{ section }">
                            <div class="font-medium cursor-pointer flex items-center"
                                @click="section.open = !section.open">
                                <input type="checkbox" x-model="section.enabled" class="mr-2">
                                <span class="drag-handle cursor-move mr-2">☰</span>
                                <span x-text="section.title" class="flex-grow"></span>
                                <span x-text="section.open ? '−' : '+'"></span>
                            </div>
                            <div x-show="section.open" class="ml-8 mt-1 space-y-1" x-transition>
                                <template x-for="(opt, i) in section.options" :key="i">
                                    <label class="block">
                                        <input type="checkbox" x-model="opt.checked" class="mr-2">
                                        <span x-text="opt.text"></span>
                                        <template x-if="opt.editable">
                                            <div class="mt-1">
                                                <textarea x-model="opt.text"
                                                    class="w-full border rounded px-2 py-1 text-sm"></textarea>
                                            </div>
                                        </template>
                                    </label>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
                <div class="flex justify-between mt-2">
                    <button @click="addNewSection" class="text-blue-600 hover:underline text-sm">+ Lisa uus
                        punkt</button>
                    <button @click="addAttachment" class="text-blue-600 hover:underline text-sm">+ Lisa lisa</button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-4">
                <button @click="generatePDF"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition-colors">
                    Loo PDF
                </button>
                <button @click="saveToStorage"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition-colors">
                    Salvesta
                </button>
            </div>
        </div>

        <!-- Right: PDF Preview -->
        <div class="w-full md:w-1/2">
            <div id="pdfPreview" class="bg-white p-6 rounded-lg shadow border space-y-4">
                <h1 class="text-center text-xl font-bold" x-text="form.name"></h1>
                <p x-text="form.intro"></p>

                <template x-for="field in standardFields">
                    <div>
                        <strong x-text="field.label + ':'"></strong>
                        <span x-text="form.fields[field.key] || ''"></span>
                    </div>
                </template>

                <template x-for="(section, idx) in visibleSections" :key="idx">
                    <div>
                        <h2 class="font-semibold" x-text="section.title"></h2>
                        <ul class="list-disc ml-5">
                            <template x-for="(opt, i) in section.options.filter(o => o.checked)" :key="i">
                                <li x-text="section.title.split(' ')[0] + '.' + (i+1) + ' ' + opt.text"></li>
                            </template>
                        </ul>
                    </div>
                </template>

                <div class="text-sm pt-4">
                    <p><strong>Kuupäev:</strong> <span x-text="today"></span></p>
                    <p><strong>Vastutav isik:</strong> <span x-text="form.fields.responsible || ''"></span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="fixed bottom-4 right-4 space-y-2 z-50">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 translate-y-2"
                :class="{
                     'toast-success': toast.type === 'success',
                     'toast-error': toast.type === 'error',
                     'toast-info': toast.type === 'info'
                 }" class="text-white px-4 py-2 rounded shadow-lg">
                <span x-text="toast.message"></span>
            </div>
        </template>
    </div>
</body>

</html>