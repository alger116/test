<!DOCTYPE html>
<html lang="et">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ostumenetluse kutse</title>

    <!-- Only include jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Ensure jsPDF is initialized
        window.addEventListener('DOMContentLoaded', function () {
            if (typeof window.jspdf === 'undefined') {
                console.warn('jsPDF not loaded correctly. Attempting to initialize it.');
                try {
                    window.jspdf = { jsPDF: window.jspdf.jsPDF || window.jsPDF };
                } catch (e) {
                    console.error('Failed to initialize jsPDF:', e);
                }
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #4F46E5;
            --primary-hover: #4338CA;
            --success-color: #10B981;
            --error-color: #EF4444;
            --info-color: #3B82F6;
            --card-bg: #ffffff;
        }

        body {
            background-color: #f9fafb;
            color: #1f2937;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .btn {
            @apply rounded-lg font-medium transition-all duration-200 transform px-4 py-2 focus:outline-none focus:ring-2 focus:ring-opacity-50;
        }

        .btn-primary {
            @apply bg-indigo-600 hover:bg-indigo-700 text-white focus:ring-indigo-500;
        }

        .btn-success {
            @apply bg-green-600 hover:bg-green-700 text-white focus:ring-green-500;
        }

        .btn-danger {
            @apply bg-red-500 hover:bg-red-600 text-white focus:ring-red-400;
        }

        .card {
            @apply bg-white rounded-xl shadow-md border border-gray-100 transition-all duration-200 hover:shadow-lg;
        }

        .toast-success {
            background-color: var(--success-color);
            @apply shadow-lg rounded-lg;
        }

        .toast-error {
            background-color: var(--error-color);
            @apply shadow-lg rounded-lg;
        }

        .toast-info {
            background-color: var(--info-color);
            @apply shadow-lg rounded-lg;
        }

        .drag-active {
            border-color: var(--primary-color);
            background-color: #EFF6FF;
        }

        input[type="text"],
        textarea {
            @apply rounded-lg border-gray-300 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition-all duration-200;
        }

        input[type="checkbox"] {
            @apply rounded text-indigo-600 focus:ring-indigo-500 transition-all duration-200;
        }

        .section-header {
            @apply flex items-center p-3 font-medium cursor-pointer bg-gray-50 hover:bg-gray-100 rounded-lg;
        }

        .section-content {
            @apply ml-8 mt-2 space-y-2 p-2;
        }

        [x-cloak] {
            display: none !important;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #pdfPreview,
            #pdfPreview * {
                visibility: visible;
            }

            #pdfPreview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('formApp', () => {
                const standardFields = [
                    { key: 'buyer', label: 'Hankija', placeholder: 'Nimi, aadress, registrikood' },
                    { key: 'submission', label: 'Pakkumise esitamise aeg ja koht', placeholder: 'nt 10. aprill, e-post' },
                    { key: 'validity', label: 'Pakkumuse jõusoleku aeg', placeholder: 'nt 30 päeva' },
                    { key: 'requirements', label: 'Nõuded pakkujale', placeholder: 'nt kogemus 3 aastat' },
                    { key: 'criteria', label: 'Väljavaliku alused', placeholder: 'Majanduslikult soodsaim' },
                    { key: 'responsible', label: 'Vastutav isik', placeholder: 'Nimi' }
                ];

                const defaultFields = {};
                standardFields.forEach(field => {
                    defaultFields[field.key] = '';
                });

                return {
                    standardFields,
                    form: {
                        name: '',
                        intro: 'Lisa hankija nimi teeb Teile ettepaneku esitada pakkumus "Lisa ostetav ese/teenus" ostumenetluse kutses sätestatud tingimustele. Ostumenetluse eesmärk on... ',
                        fields: { ...defaultFields },
                        sections: [
                            {
                                title: '1 Üldised tingimused',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Ettevõtjatel on õigus küsida kutse kohta selgitusi, esitades küsimused e-posti teel ostumenetluse eest vastutavale isikule. Hankija vastab ettevõtja küsimustele kolme tööpäeva jooksul. Hankija edastab esitatud küsimused ja antud vastused samaaegselt kõigile ettevõtjatele, kellele tehti ettepanek pakkumuse esitamiseks. Telefoni teel esitatud küsimustele ei vastata.', checked: false },
                                    { text: 'Hankijal on õigus enne pakkumuste esitamise tähtaega muuta vajadusel kutset. Kutse muutmisel teavitab hankija sellest kõiki ettevõtjaid, kellele on tehtud ettepanek pakkumuste esitamiseks ja edastab ettevõtjatele muudetud kutse. Hankija võib pikendada pakkumuste esitamise tähtaega.', checked: false },
                                    { text: 'Iga viidet, mille hankija teeb kutses mõnele standardile, tehnilisele tunnusele, kontrollsüsteemile, ostuallikale, protsessile, kaubamärgile, patendile, tüübile, päritolule või tootmisviisile, tuleb lugeda selliselt, et see on täiendatud märkega „või sellega samaväärne".', checked: false },
                                    { text: 'Hankija ei sõlmi hankelepingut pakkujaga, kellel on maksuvõlg (kohalikud maksud Tallinna linnale ja riiklik maksuvõlg)...', checked: false },
                                    { text: 'Hankija jätab endale õiguse tellida teenust lähtudes oma eelarvelistest vahenditest. Teenuse hankija ei hüvita pakkujale teenuse tellimata jätmise eest tekkinud kahju.', checked: false }
                                ]
                            },
                            {
                                title: '2 Ostumenetluse tehniline kirjeldus',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: '"Hankija lisab siia tehnilise kirjelduse" - Lisada kas viide eraldi failile kui TK on eraldi või kopeerida siia lihtsalt tehniline kirjeldus teenuse/asja kohta, mida soovitakse osta.', checked: false, editable: true }
                                ]
                            },
                            {
                                title: '3 Nõuded pakkumusele',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Pakkumus on pakkuja tahteavaldus tellimuse täitmiseks ja on selle esitamisel pakkujale siduv alates esitamisest kuni pakkumuse jõusoleku minimaalse tähtaja lõpuni. Hankijal on õigus teha ettepanek pakkumuse jõusoleku tähtaja pikendamiseks. Tingimusliku pakkumuse esitamine on keelatud.', checked: false },
                                    { text: 'Hilinenud pakkumusi hankija vastu ei võta.', checked: false },
                                    { text: 'Pakkumus peab sisaldama: Pakkumuse maksumust vastavalt lisale 1;', checked: false },
                                    { text: 'Pakkumus peab sisaldama: Pakkumuse kirjeldust, mis võimaldab hankijal kontrollida kutse punktis 2 sätestatud tingimustele vastavust.', checked: false },
                                    { text: 'Pakkuja kannab kõik pakkumuse ettevalmistamise ja esitamisega seotud kulud ning pakkumuse tähtaegse esitamise riski.', checked: false },
                                    { text: 'Pakkumus on konfidentsiaalne kuni tellimuse tegemiseni.', checked: false },
                                    { text: 'Pakkuja märgib pakkumuses, milline teave pakkumusest on ärisaladus ning põhjendab ärisaladuseks määramist... Hankija ei avalikusta pakkumuse sisu ärisaladusega kaetud osas.', checked: false }
                                ]
                            },
                            {
                                title: '4 Pakkumuste kontrollimine, hindamine ja eduka pakkumuse valik',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Hankija kontrollib tähtaegselt esitatud pakkumuste vastavust kutses esitatud tingimustele...', checked: false },
                                    { text: 'Hankijal on õigus küsida pakkujalt esitatud pakkumuse kohta täpsustavaid andmeid ja täpsustavaid selgitusi.', checked: false },
                                    { text: 'Kutses esitatud tingimustele vastavate pakkumuste seast valib hankija eduka pakkumuse välja madalaima hinna alusel...', checked: false },
                                    { text: 'Kui edukas pakkuja võtab hankijast mitteolenevatel põhjustel oma pakkumuse tagasi...', checked: false },
                                    { text: 'Hankija ei ole kohustatud korra punktis 4.5 nimetatud alusel pakkumusi uuesti hindama...', checked: false }
                                ]
                            },
                            {
                                title: '5 Läbirääkimiste pidamine',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Hankijal on õigus pidada läbirääkimisi esitatud pakkumuse sisu ja maksumuse ning tellimuse tingimuste üle.', checked: false },
                                    { text: 'Hankijal on õigus loobuda ühest või mitmest pakkumuses kirjeldatud teenusest, tööst või asjast või vähendada nende mahtusid või koguseid...', checked: false },
                                    { text: 'Vastavalt läbirääkimiste pidamise vajadusele teatab hankija pakkujatele läbirääkimiste aja... Läbirääkimised on konfidentsiaalsed.', checked: false },
                                    { text: 'Pärast läbirääkimiste toimumist esitab pakkuja vajadusel uue kohandatud pakkumuse...', checked: false }
                                ]
                            },
                            {
                                title: '6 Pakkumuste tagasi lükkamine ja ostumenetluse kehtetuks tunnistamine',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Hankijal on õigus kõik esitatud või kutses toodud tingimustele vastavad pakkumused tagasi lükata...', checked: false },
                                    { text: 'Kui hankijal on tekkinud vajadus pärast pakkumuste esitamise tähtpäeva kutses esitatud tingimusi olulisel määral muuta...', checked: false },
                                    { text: 'Hankija võib ostumenetluse kehtetuks tunnistada, kui peale pakkumuste esitamise tähtpäeva selgub, et hankija on teinud vea...', checked: false }
                                ]
                            },
                            {
                                title: '7 Lisad',
                                enabled: true,
                                open: false,
                                options: [
                                    { text: 'Lisa 1. Kui on lisad, siis lisatakse siia.', checked: false }
                                ]
                            }
                        ]
                    },
                    today: new Date().toLocaleDateString('et-EE'),
                    toasts: [],
                    files: [],
                    isDragging: false,

                    init() {
                        this.loadFromStorage();

                        // Initialize Sortable for the sections
                        this.$nextTick(() => {
                            if (this.$refs.draggableSections) {
                                new Sortable(this.$refs.draggableSections, {
                                    animation: 150,
                                    handle: '.drag-handle',
                                    onEnd: (evt) => {
                                        const newOrder = Array.from(evt.from.children).map(child => {
                                            return child.__x.$data.section;
                                        });
                                        this.form.sections = newOrder;
                                    }
                                });
                            }
                        });
                    },

                    get visibleSections() {
                        return this.form.sections.filter(s => s.enabled && s.options.some(o => o.checked));
                    },

                    generatePDF() {
                        try {
                            // Check if jsPDF is properly loaded
                            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                                if (typeof window.jsPDF !== 'undefined') {
                                    // Try to use the global jsPDF constructor
                                    window.jspdf = { jsPDF: window.jsPDF };
                                } else {
                                    throw new Error('jsPDF not properly loaded');
                                }
                            }

                            // Create a new jsPDF instance
                            const { jsPDF } = window.jspdf;
                            const doc = new jsPDF('p', 'mm', 'a4');

                            // Add title
                            doc.setFontSize(18);
                            doc.setTextColor(0, 0, 0);
                            doc.text(this.form.name || 'Ostumenetluse kutse', 105, 20, { align: 'center' });

                            // Add intro text
                            doc.setFontSize(12);
                            let yPos = 35;
                            const introLines = doc.splitTextToSize(this.form.intro, 170);
                            doc.text(introLines, 20, yPos);
                            yPos += (introLines.length * 7) + 10;

                            // Add standard fields
                            doc.setFontSize(12);
                            this.standardFields.forEach(field => {
                                const fieldValue = this.form.fields[field.key] || '';
                                if (fieldValue.trim() !== '') {
                                    doc.setFont(undefined, 'bold');
                                    doc.text(`${field.label}: `, 20, yPos);
                                    const textWidth = doc.getTextWidth(`${field.label}: `);

                                    doc.setFont(undefined, 'normal');
                                    const valueLines = doc.splitTextToSize(fieldValue, 150);
                                    doc.text(valueLines, 20 + textWidth, yPos);

                                    yPos += (valueLines.length * 7) + 5;
                                }
                            });

                            // Add sections
                            this.visibleSections.forEach((section, index) => {
                                yPos += 5;

                                // Section title
                                doc.setFontSize(14);
                                doc.setFont(undefined, 'bold');
                                doc.text(section.title, 20, yPos);
                                yPos += 8;

                                // Section options
                                doc.setFontSize(12);
                                doc.setFont(undefined, 'normal');

                                section.options.filter(o => o.checked).forEach((opt, i) => {
                                    const optionText = `${section.title.split(' ')[0]}.${i + 1} ${opt.text}`;
                                    const optLines = doc.splitTextToSize(optionText, 160);

                                    doc.text('• ', 20, yPos);
                                    doc.text(optLines, 25, yPos);

                                    yPos += (optLines.length * 7) + 5;

                                    // Check if we need a new page
                                    if (yPos > 270) {
                                        doc.addPage();
                                        yPos = 20;
                                    }
                                });
                            });

                            // Add footer
                            yPos = Math.min(yPos + 15, 270);
                            doc.setFontSize(12);
                            doc.setFont(undefined, 'bold');
                            doc.text(`Kuupäev: ${this.today}`, 20, yPos);
                            yPos += 7;
                            doc.text(`Vastutav isik: ${this.form.fields.responsible || ''}`, 20, yPos);

                            // Save the PDF
                            doc.save(`${this.form.name || 'ostumenetlus'}.pdf`);
                            this.showToast('PDF loodud edukalt!', 'success');
                        } catch (err) {
                            console.error('PDF generation failed:', err);
                            this.showToast('PDF genereerimine ebaõnnestus', 'error');

                            // As a last resort, offer direct print option
                            if (confirm('PDF genereerimine ebaõnnestus. Kas soovid kasutada brauseri printimisfunktsiooni?')) {
                                window.print();
                            }
                        }
                    },

                    saveToStorage() {
                        try {
                            const payload = {
                                form: this.form,
                                timestamp: Date.now(),
                                version: '1.4'
                            };
                            localStorage.setItem('OM_DRAFT', JSON.stringify(payload));
                            this.showToast('Salvestatud!', 'success');
                        } catch (error) {
                            console.error('Failed to save to storage:', error);
                            this.showToast('Salvestamine ebaõnnestus', 'error');
                        }
                    },

                    loadFromStorage() {
                        try {
                            const raw = localStorage.getItem('OM_DRAFT');
                            if (raw) {
                                const data = JSON.parse(raw);
                                if (data.version === '1.4') {
                                    this.form = {
                                        ...data.form,
                                        fields: {
                                            ...defaultFields,
                                            ...data.form.fields
                                        }
                                    };
                                    this.showToast('Laaditud salvestatud andmed', 'success');
                                } else {
                                    localStorage.removeItem('OM_DRAFT');
                                    this.showToast('Vana versiooni andmed, algandmed laetud', 'info');
                                }
                            }
                        } catch (error) {
                            console.error('Failed to load from storage:', error);
                            localStorage.removeItem('OM_DRAFT');
                        }
                    },

                    addAttachment() {
                        const lisaCount = this.form.sections[6].options.length + 1;
                        this.form.sections[6].options.push({
                            text: `Lisa ${lisaCount}. Lisa kirjeldus`,
                            checked: false
                        });
                        this.showToast('Lisa lisatud', 'success');
                    },

                    addNewSection() {
                        const nextNum = this.form.sections.length + 1;
                        this.form.sections.push({
                            title: `${nextNum} Uus punkt`,
                            enabled: false,
                            open: true,
                            options: [{ text: 'Lisa tingimus', checked: false }]
                        });
                        this.showToast('Uus sektsioon lisatud', 'success');
                    },

                    toggleAllSections(open) {
                        this.form.sections.forEach(section => {
                            section.open = open;
                        });
                    },

                    showToast(message, type = 'info', duration = 3000) {
                        const toast = {
                            id: Date.now(),
                            message,
                            type,
                            duration
                        };
                        this.toasts.push(toast);
                        setTimeout(() => {
                            this.toasts = this.toasts.filter(t => t.id !== toast.id);
                        }, duration);
                    },

                    handleDragOver(e) {
                        e.preventDefault();
                        this.isDragging = true;
                    },

                    handleDragLeave() {
                        this.isDragging = false;
                    },

                    handleDrop(e) {
                        e.preventDefault();
                        this.isDragging = false;
                        const files = Array.from(e.dataTransfer.files);
                        this.processFiles(files);
                    },

                    handleFileInput(e) {
                        const files = Array.from(e.target.files);
                        this.processFiles(files);
                        e.target.value = ''; // Reset input
                    },

                    processFiles(files) {
                        files.forEach(file => {
                            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                                this.showToast(`Fail ${file.name} on liiga suur (max 5MB)`, 'error');
                                return;
                            }

                            const reader = new FileReader();
                            reader.onload = (e) => {
                                this.files.push({
                                    name: file.name,
                                    size: file.size,
                                    type: file.type,
                                    data: e.target.result
                                });
                                this.showToast(`Fail ${file.name} lisatud`, 'success');
                            };
                            reader.readAsDataURL(file);
                        });
                    },

                    removeFile(index) {
                        const fileName = this.files[index].name;
                        this.files.splice(index, 1);
                        this.showToast(`Fail ${fileName} eemaldatud`, 'info');
                    },

                    formatFileSize(bytes) {
                        if (bytes === 0) return '0 Bytes';
                        const k = 1024;
                        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                        const i = Math.floor(Math.log(bytes) / Math.log(k));
                        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                    },

                    resetForm() {
                        if (confirm('Kas oled kindel, et soovid kõik andmed kustutada? Seda tegevust ei saa tagasi võtta.')) {
                            // Reset to default form structure
                            this.form = {
                                name: '',
                                intro: 'Lisa hankija nimi teeb Teile ettepaneku esitada pakkumus "Lisa ostetav ese/teenus" ostumenetluse kutses sätestatud tingimustele. Ostumenetluse eesmärk on... ',
                                fields: { ...defaultFields },
                                sections: [
                                    {
                                        title: '1 Üldised tingimused',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: 'Ettevõtjatel on õigus küsida kutse kohta selgitusi, esitades küsimused e-posti teel ostumenetluse eest vastutavale isikule. Hankija vastab ettevõtja küsimustele kolme tööpäeva jooksul. Hankija edastab esitatud küsimused ja antud vastused samaaegselt kõigile ettevõtjatele, kellele tehti ettepanek pakkumuse esitamiseks. Telefoni teel esitatud küsimustele ei vastata.', checked: false },
                                            { text: 'Hankijal on õigus enne pakkumuste esitamise tähtaega muuta vajadusel kutset. Kutse muutmisel teavitab hankija sellest kõiki ettevõtjaid, kellele on tehtud ettepanek pakkumuste esitamiseks ja edastab ettevõtjatele muudetud kutse. Hankija võib pikendada pakkumuste esitamise tähtaega.', checked: false },
                                            { text: 'Iga viidet, mille hankija teeb kutses mõnele standardile, tehnilisele tunnusele, kontrollsüsteemile, ostuallikale, protsessile, kaubamärgile, patendile, tüübile, päritolule või tootmisviisile, tuleb lugeda selliselt, et see on täiendatud märkega „või sellega samaväärne".', checked: false },
                                            { text: 'Hankija ei sõlmi hankelepingut pakkujaga, kellel on maksuvõlg (kohalikud maksud Tallinna linnale ja riiklik maksuvõlg)...', checked: false },
                                            { text: 'Hankija jätab endale õiguse tellida teenust lähtudes oma eelarvelistest vahenditest. Teenuse hankija ei hüvita pakkujale teenuse tellimata jätmise eest tekkinud kahju.', checked: false }
                                        ]
                                    },
                                    {
                                        title: '2 Ostumenetluse tehniline kirjeldus',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: '"Hankija lisab siia tehnilise kirjelduse" - Lisada kas viide eraldi failile kui TK on eraldi või kopeerida siia lihtsalt tehniline kirjeldus teenuse/asja kohta, mida soovitakse osta.', checked: false, editable: true }
                                        ]
                                    },
                                    {
                                        title: '3 Nõuded pakkumusele',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: 'Pakkumus on pakkuja tahteavaldus tellimuse täitmiseks ja on selle esitamisel pakkujale siduv alates esitamisest kuni pakkumuse jõusoleku minimaalse tähtaja lõpuni. Hankijal on õigus teha ettepanek pakkumuse jõusoleku tähtaja pikendamiseks. Tingimusliku pakkumuse esitamine on keelatud.', checked: false },
                                            { text: 'Hilinenud pakkumusi hankija vastu ei võta.', checked: false },
                                            { text: 'Pakkumus peab sisaldama: Pakkumuse maksumust vastavalt lisale 1;', checked: false },
                                            { text: 'Pakkumus peab sisaldama: Pakkumuse kirjeldust, mis võimaldab hankijal kontrollida kutse punktis 2 sätestatud tingimustele vastavust.', checked: false },
                                            { text: 'Pakkuja kannab kõik pakkumuse ettevalmistamise ja esitamisega seotud kulud ning pakkumuse tähtaegse esitamise riski.', checked: false },
                                            { text: 'Pakkumus on konfidentsiaalne kuni tellimuse tegemiseni.', checked: false },
                                            { text: 'Pakkuja märgib pakkumuses, milline teave pakkumusest on ärisaladus ning põhjendab ärisaladuseks määramist... Hankija ei avalikusta pakkumuse sisu ärisaladusega kaetud osas.', checked: false }
                                        ]
                                    },
                                    {
                                        title: '4 Pakkumuste kontrollimine, hindamine ja eduka pakkumuse valik',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: 'Hankija kontrollib tähtaegselt esitatud pakkumuste vastavust kutses esitatud tingimustele...', checked: false },
                                            { text: 'Hankijal on õigus küsida pakkujalt esitatud pakkumuse kohta täpsustavaid andmeid ja täpsustavaid selgitusi.', checked: false },
                                            { text: 'Kutses esitatud tingimustele vastavate pakkumuste seast valib hankija eduka pakkumuse välja madalaima hinna alusel...', checked: false },
                                            { text: 'Kui edukas pakkuja võtab hankijast mitteolenevatel põhjustel oma pakkumuse tagasi...', checked: false },
                                            { text: 'Hankija ei ole kohustatud korra punktis 4.5 nimetatud alusel pakkumusi uuesti hindama...', checked: false }
                                        ]
                                    },
                                    {
                                        title: '5 Läbirääkimiste pidamine',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: 'Hankijal on õigus pidada läbirääkimisi esitatud pakkumuse sisu ja maksumuse ning tellimuse tingimuste üle.', checked: false },
                                            { text: 'Hankijal on õigus loobuda ühest või mitmest pakkumuses kirjeldatud teenusest, tööst või asjast või vähendada nende mahtusid või koguseid...', checked: false },
                                            { text: 'Vastavalt läbirääkimiste pidamise vajadusele teatab hankija pakkujatele läbirääkimiste aja... Läbirääkimised on konfidentsiaalsed.', checked: false },
                                            { text: 'Pärast läbirääkimiste toimumist esitab pakkuja vajadusel uue kohandatud pakkumuse...', checked: false }
                                        ]
                                    },
                                    {
                                        title: '6 Pakkumuste tagasi lükkamine ja ostumenetluse kehtetuks tunnistamine',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: 'Hankijal on õigus kõik esitatud või kutses toodud tingimustele vastavad pakkumused tagasi lükata...', checked: false },
                                            { text: 'Kui hankijal on tekkinud vajadus pärast pakkumuste esitamise tähtpäeva kutses esitatud tingimusi olulisel määral muuta...', checked: false },
                                            { text: 'Hankija võib ostumenetluse kehtetuks tunnistada, kui peale pakkumuste esitamise tähtpäeva selgub, et hankija on teinud vea...', checked: false }
                                        ]
                                    },
                                    {
                                        title: '7 Lisad',
                                        enabled: true,
                                        open: false,
                                        options: [
                                            { text: 'Lisa 1. Kui on lisad, siis lisatakse siia.', checked: false }
                                        ]
                                    }
                                ]
                            };

                            // Clear files
                            this.files = [];

                            // Remove from local storage
                            localStorage.removeItem('OM_DRAFT');

                            // Show success message
                            this.showToast('Vorm on tühjendatud', 'info');
                        }
                    }
                }
            });
        });
    </script>
</head>

<body class="bg-gray-50 text-gray-800" x-data="formApp" x-cloak>
    <div class="container mx-auto max-w-7xl p-4">
        <h1 class="text-2xl font-bold text-center text-indigo-700 mb-6">Ostumenetluse kutse koostamine</h1>

        <div class="flex flex-col md:flex-row gap-6 min-h-screen">
            <!-- Left: Data Input -->
            <div class="w-full md:w-1/2 space-y-5">
                <div class="card p-5">
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Ostumenetluse nimi</label>
                    <input type="text" x-model="form.name" class="w-full border rounded-lg px-3 py-2"
                        placeholder="Näiteks: Haljasala rajamine" />
                </div>

                <div class="card p-5">
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Üldsõnaline kutse tekst</label>
                    <textarea x-model="form.intro" class="w-full border rounded-lg px-3 py-2 h-24"></textarea>
                </div>

                <div class="card p-5">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700">Põhiandmed</h2>
                    <div class="grid grid-cols-1 gap-4">
                        <template x-for="field in standardFields" :key="field.key">
                            <div>
                                <label class="block text-sm font-semibold mb-1 text-gray-700"
                                    x-text="field.label"></label>
                                <input type="text" x-model="form.fields[field.key]"
                                    class="w-full border rounded-lg px-3 py-2 mt-1" :placeholder="field.placeholder" />
                            </div>
                        </template>
                    </div>
                </div>

                <!-- File Upload Section -->
                <div class="card p-5">
                    <label class="block text-sm font-semibold mb-3 text-gray-700">Manused</label>
                    <div @dragover="handleDragOver" @dragleave="handleDragLeave" @drop="handleDrop"
                        :class="{'drag-active': isDragging}"
                        class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer transition-colors">
                        <input type="file" id="fileInput" class="hidden" @change="handleFileInput" multiple>
                        <label for="fileInput" class="cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-3xl text-indigo-500 mb-2"></i>
                            <p class="text-gray-600">Lohista failid siia või <span
                                    class="text-indigo-600 underline">kliki valimiseks</span></p>
                            <p class="text-sm text-gray-500 mt-1">Max 5MB fail</p>
                        </label>
                    </div>

                    <div class="mt-3 space-y-2" x-show="files.length > 0">
                        <template x-for="(file, index) in files" :key="index">
                            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                                <div class="flex items-center truncate">
                                    <i class="fas fa-file-alt text-indigo-500 mr-2"></i>
                                    <span x-text="file.name" class="truncate"></span>
                                    <span class="text-xs text-gray-500 ml-2" x-text="formatFileSize(file.size)"></span>
                                </div>
                                <button @click="removeFile(index)"
                                    class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Sections 1-7 -->
                <div class="card p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-700">Vali punktid (1–7)</h2>
                        <div class="flex gap-2">
                            <button @click="toggleAllSections(true)"
                                class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg transition-colors">
                                <i class="fas fa-chevron-down mr-1"></i> Ava kõik
                            </button>
                            <button @click="toggleAllSections(false)"
                                class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg transition-colors">
                                <i class="fas fa-chevron-up mr-1"></i> Sulge kõik
                            </button>
                        </div>
                    </div>
                    <div id="draggableSections" x-ref="draggableSections" class="space-y-3">
                        <template x-for="(section, index) in form.sections" :key="index">
                            <div class="mb-3 border border-gray-200 rounded-lg overflow-hidden" x-data="{ section }">
                                <div class="section-header" @click="section.open = !section.open">
                                    <input type="checkbox" x-model="section.enabled" class="mr-3" @click.stop>
                                    <span class="drag-handle cursor-move mr-3 text-gray-400"><i
                                            class="fas fa-grip-lines"></i></span>
                                    <span x-text="section.title" class="flex-grow"></span>
                                    <i class="fas" :class="section.open ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
                                </div>
                                <div x-show="section.open" class="section-content" x-transition>
                                    <template x-for="(opt, i) in section.options" :key="i">
                                        <label class="block p-2 hover:bg-gray-50 rounded-md">
                                            <div class="flex items-start">
                                                <input type="checkbox" x-model="opt.checked" class="mt-1 mr-3">
                                                <span x-text="opt.text" class="text-sm"></span>
                                            </div>
                                            <template x-if="opt.editable">
                                                <div class="mt-2 ml-8">
                                                    <textarea x-model="opt.text"
                                                        class="w-full border rounded-lg px-3 py-2 text-sm"></textarea>
                                                </div>
                                            </template>
                                        </label>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div class="flex justify-between mt-4">
                        <button @click="addNewSection"
                            class="text-indigo-600 hover:text-indigo-800 flex items-center text-sm">
                            <i class="fas fa-plus-circle mr-1"></i> Lisa uus punkt
                        </button>
                        <button @click="addAttachment"
                            class="text-indigo-600 hover:text-indigo-800 flex items-center text-sm">
                            <i class="fas fa-paperclip mr-1"></i> Lisa lisa
                        </button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-4 mt-6">
                    <button @click="generatePDF" class="btn btn-success flex items-center">
                        <i class="fas fa-file-pdf mr-2"></i> Loo PDF
                    </button>
                    <button @click="saveToStorage" class="btn btn-primary flex items-center">
                        <i class="fas fa-save mr-2"></i> Salvesta
                    </button>
                    <button @click="resetForm" class="btn btn-danger flex items-center">
                        <i class="fas fa-trash mr-2"></i> Tühjenda
                    </button>
                </div>
            </div>

            <!-- Right: PDF Preview -->
            <div class="w-full md:w-1/2">
                <div class="sticky top-4">
                    <div class="flex items-center mb-3">
                        <h2 class="text-lg font-semibold text-gray-700">Eelvaade</h2>
                        <span
                            class="ml-2 px-2 py-1 bg-gray-100 text-gray-600 text-xs font-medium rounded-full">automaatne</span>
                    </div>
                    <div id="pdfPreview" class="card p-6 space-y-4 min-h-[70vh] max-h-[85vh] overflow-auto">
                        <h1 class="text-center text-xl font-bold" x-text="form.name || 'Ostumenetluse kutse'"></h1>
                        <p x-text="form.intro"></p>

                        <template x-for="field in standardFields">
                            <div x-show="form.fields[field.key]" class="py-1">
                                <strong x-text="field.label + ':'"></strong>
                                <span x-text="form.fields[field.key] || ''"></span>
                            </div>
                        </template>

                        <template x-for="(section, idx) in visibleSections" :key="idx">
                            <div class="mt-4">
                                <h2 class="font-semibold text-lg" x-text="section.title"></h2>
                                <ul class="list-disc ml-6 mt-2 space-y-1">
                                    <template x-for="(opt, i) in section.options.filter(o => o.checked)" :key="i">
                                        <li class="text-sm"
                                            x-text="section.title.split(' ')[0] + '.' + (i+1) + ' ' + opt.text"></li>
                                    </template>
                                </ul>
                            </div>
                        </template>

                        <div class="text-sm pt-4 border-t mt-4">
                            <p><strong>Kuupäev:</strong> <span x-text="today"></span></p>
                            <p><strong>Vastutav isik:</strong> <span x-text="form.fields.responsible || ''"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="fixed bottom-4 right-4 space-y-2 z-50">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 translate-y-2"
                :class="{
                     'toast-success': toast.type === 'success',
                     'toast-error': toast.type === 'error',
                     'toast-info': toast.type === 'info'
                 }" class="text-white px-4 py-3 rounded shadow-lg flex items-center">
                <i class="fas mr-2" :class="{
                    'fa-check-circle': toast.type === 'success',
                    'fa-exclamation-circle': toast.type === 'error',
                    'fa-info-circle': toast.type === 'info'
                }"></i>
                <span x-text="toast.message"></span>
            </div>
        </template>
    </div>
</body>

</html>