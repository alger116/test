rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'mainAdmin'];
    }
    
    function isMainAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'mainAdmin';
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow create: if isAdmin();
      allow update: if isAdmin() || (isAuthenticated() && request.auth.uid == userId);
      allow delete: if isMainAdmin();
    }

    // Audit Log collection
    match /auditLog/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow delete: if isMainAdmin();
    }

    // System settings
    match /system/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isMainAdmin();
    }

    // API keys
    match /apiKeys/{keyId} {
      allow read: if isAdmin();
      allow create, update, delete: if isMainAdmin();
    }

    // Email templates
    match /emailTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Document templates
    match /documentTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Workflows
    match /workflows/{workflowId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Permissions
    match /permissions/{permissionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Expiration rules
    match /expirationRules/{ruleId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Documents collection
    match /documents/{documentId} {
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        resource.data.sharedWith[request.auth.uid] == true ||
        isAdmin()
      );
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
    }

    // Error logs
    match /errorLogs/{logId} {
      allow read, write: if isAdmin();
    }
    
    // Settings collection
    match /settings/{settingId} {
      allow read: if isAuthenticated();  // Any authenticated user can read settings
      allow write: if 
        ((settingId == "maintenance" || settingId == "procurement") && isAdmin()) ||  // Both admin and mainAdmin can write these
        (settingId == "sessionTimeout" && isMainAdmin());  // Only mainAdmin can write session timeout
    }
    
    // Procurements collection
    match /procurements/{procurementId} {
      allow read, write: if isAdmin();
    }

    // Statistika kollektsioonid ja OM komponendid
    
    // Põhiväljad
    match /omStandardFields/{fieldId} {
      allow read: if true;  // Kõik võivad lugeda
      allow write: if isMainAdmin();  // Ainult mainadmin võib muuta
    }

    // Peatükid
    match /omSections/{sectionId} {
      allow read: if true;
      allow write: if isMainAdmin();
      
      match /options/{optionId} {
        allow read: if true;
        allow write: if isMainAdmin();
      }
    }

    // Näidistingimused
    match /omTemplates/{templateId} {
      allow read: if request.auth != null && 
                 resource.data.accessRoles.hasAny(get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles);
      allow write: if isMainAdmin();
    }

    // Ajalugu
    match /omHistory/{historyId} {
      allow read: if isAdmin();
      allow write: if isMainAdmin();
    }

    // Varundused
    match /omBackups/{backupId} {
      allow read: if isMainAdmin();
      allow write: if isMainAdmin();
    }
  
    // FIELD SETTINGS
    match /fieldSettings/{docId} {
      allow read: if isMainAdmin();
      allow write: if isMainAdmin();
    }

    // BACKUP & LOGID
    match /fieldSettingsBackup/{docId} {
      allow read: if isMainAdmin();
      allow write: if isMainAdmin();
    }

    match /fieldSettingsLogs/{docId} {
      allow read: if isMainAdmin();
      allow write: if isMainAdmin();
    }
    
    // FORM SETTINGS - need puudusid või olid valesti defineeritud
    match /formSettings/{document} {
      allow read: if true;
      allow write: if isMainAdmin();
    }
   
    match /formSettingsBackup/{document} {
      allow read: if true;
      allow write: if isMainAdmin();
    }
    
    match /purchaseForms/{document} {
      allow read: if isAuthenticated();
      allow write: if isMainAdmin();
    }
   
    match /formSettingsLogs/{document} {
      allow read: if true;
      allow write: if isMainAdmin();
    }
    
    // Vormimallid (formPresets)
    match /formPresets/{document} {
      allow read: if isAuthenticated();  // Kõik autenditud kasutajad saavad lugeda vormimalle
      allow write: if isMainAdmin();     // Ainult peaadministraator saab vormimalle luua/muuta/kustutada
    }
  }
}
